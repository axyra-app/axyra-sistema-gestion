<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Dashboard</title>
    <link rel="icon" href="nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- AXYRA Core Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/axyra-notifications.js"></script>
    <script src="js/axyra-auth.js"></script>
    <script src="js/axyra-realtime.js"></script>
    <script src="js/axyra-push-notifications.js"></script>
    <script src="js/axyra-reports.js"></script>
    <script src="js/axyra-backup.js"></script>
    <script src="js/axyra-analytics.js"></script>
    <script src="js/axyra-lazy-loading.js"></script>
    <script src="js/axyra-cache.js"></script>
    <script src="js/axyra-compression.js"></script>
    <script src="js/axyra-cdn.js"></script>

    <!-- AXYRA Security Scripts -->
    <script src="js/axyra-2fa.js"></script>
    <script src="js/axyra-encryption.js"></script>
    <script src="js/axyra-security-monitoring.js"></script>
    <script src="js/axyra-rbac.js"></script>
    <script src="js/axyra-security-audit.js"></script>

    <!-- AXYRA Integration Scripts -->
    <script src="js/axyra-payment-integration.js"></script>
    <script src="js/axyra-email-integration.js"></script>
    <script src="js/axyra-sms-integration.js"></script>
    <script src="js/axyra-cloud-storage.js"></script>
    <script src="js/axyra-api-management.js"></script>

    <!-- AXYRA Third Party Services Scripts -->
    <script src="js/axyra-google-workspace.js"></script>
    <script src="js/axyra-microsoft-365.js"></script>
    <script src="js/axyra-third-party-manager.js"></script>

    <!-- AXYRA Testing Scripts -->
    <script src="js/axyra-testing-suite.js"></script>

    <!-- AXYRA Final Optimization Scripts -->
    <script src="js/axyra-optimizer.js"></script>
    <script src="js/axyra-validator.js"></script>
    <script src="js/axyra-cleanup.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        color: #1f2937;
        line-height: 1.6;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-header h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .sidebar-header p {
        font-size: 14px;
        opacity: 0.8;
      }

      .sidebar-nav {
        padding: 20px 0;
      }

      .nav-item {
        display: block;
        padding: 12px 20px;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }

      .nav-item:hover,
      .nav-item.active {
        background: rgba(255, 255, 255, 0.1);
        border-left-color: #ffffff;
      }

      .nav-item i {
        width: 20px;
        margin-right: 12px;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        transition: margin-left 0.3s ease;
      }

      .main-content.expanded {
        margin-left: 0;
      }

      /* Header */
      .header {
        background: white;
        padding: 20px 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .sidebar-toggle {
        background: none;
        border: none;
        font-size: 20px;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .sidebar-toggle:hover {
        background: #f3f4f6;
        color: #1e3c72;
      }

      .header-title h1 {
        font-size: 28px;
        font-weight: 700;
        color: #1e3c72;
        margin: 0;
      }

      .header-title p {
        color: #6b7280;
        margin: 0;
        font-size: 14px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .membership-indicator {
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        padding: 8px 16px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
        transition: all 0.3s ease;
      }

      .membership-indicator i {
        font-size: 16px;
      }

      .membership-text {
        font-weight: 600;
        font-size: 14px;
      }

      .upgrade-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upgrade-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .user-menu {
        position: relative;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
      }

      /* Dashboard Content */
      .dashboard-content {
        padding: 30px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .stat-title {
        font-size: 14px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .stat-icon.primary {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: white;
      }

      .stat-icon.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .stat-icon.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .stat-icon.info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .stat-change {
        font-size: 14px;
        font-weight: 500;
      }

      .stat-change.positive {
        color: #10b981;
      }

      .stat-change.negative {
        color: #ef4444;
      }

      .stat-change.neutral {
        color: #6b7280;
      }

      /* Charts Section */
      .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      /* Quick Actions */
      .quick-actions {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        margin-bottom: 30px;
      }

      .quick-actions h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 20px;
      }

      .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .action-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        text-decoration: none;
        color: #374151;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .action-btn:hover {
        background: #1e3c72;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
      }

      .action-btn i {
        font-size: 20px;
      }

      .action-text {
        font-weight: 500;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .charts-section {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .actions-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Loading States */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #1e3c72;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>AXYRA</h2>
          <p>Sistema de Gestión</p>
        </div>
        <div class="sidebar-nav">
          <a href="#" class="nav-item active">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </a>
          <a href="modulos/gestion_personal/gestion_personal.html" class="nav-item">
            <i class="fas fa-users"></i>
            Gestión Personal
          </a>
          <a href="modulos/inventario/inventario.html" class="nav-item">
            <i class="fas fa-box"></i>
            Inventario
          </a>
          <a href="modulos/cuadre_caja/cuadre_caja.html" class="nav-item">
            <i class="fas fa-calculator"></i>
            Cuadre de Caja
          </a>
          <a href="modulos/configuracion/configuracion.html" class="nav-item">
            <i class="fas fa-cog"></i>
            Configuración
          </a>
          <a href="#" class="nav-item" onclick="showIntegrationsModal()">
            <i class="fas fa-plug"></i>
            Integraciones
          </a>
          <a href="#" class="nav-item" onclick="runSystemTests()">
            <i class="fas fa-vial"></i>
            Tests del Sistema
          </a>
          <a href="#" class="nav-item" onclick="runSystemOptimization()">
            <i class="fas fa-tools"></i>
            Optimización Final
          </a>
          <a href="membresias.html" class="nav-item">
            <i class="fas fa-crown"></i>
            Membresías
          </a>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
          <div class="header-left">
            <button class="sidebar-toggle" id="sidebarToggle">
              <i class="fas fa-bars"></i>
            </button>
            <div class="header-title">
              <h1>Dashboard</h1>
              <p>Bienvenido al sistema AXYRA</p>
            </div>
          </div>
          <div class="header-right">
            <div class="membership-indicator" id="membershipIndicator">
              <i class="fas fa-gift" id="membershipIcon"></i>
              <span class="membership-text" id="membershipText">Plan Gratuito</span>
              <button class="upgrade-btn" id="upgradeBtn" onclick="window.location.href='membresias.html'">
                Actualizar
              </button>
            </div>
            <div class="user-menu">
              <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
                <i class="fas fa-user"></i>
              </div>
            </div>
          </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Total Empleados</div>
                <div class="stat-icon primary">
                  <i class="fas fa-users"></i>
                </div>
              </div>
              <div class="stat-value" id="totalEmpleados">0</div>
              <div class="stat-change positive" id="empleadosChange">+0 este mes</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Horas Trabajadas</div>
                <div class="stat-icon success">
                  <i class="fas fa-clock"></i>
                </div>
              </div>
              <div class="stat-value" id="totalHoras">0</div>
              <div class="stat-change positive" id="horasChange">+0 este mes</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Productos en Stock</div>
                <div class="stat-icon warning">
                  <i class="fas fa-box"></i>
                </div>
              </div>
              <div class="stat-value" id="totalProductos">0</div>
              <div class="stat-change neutral" id="productosChange">En inventario</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">Ingresos del Mes</div>
                <div class="stat-icon info">
                  <i class="fas fa-dollar-sign"></i>
                </div>
              </div>
              <div class="stat-value" id="totalIngresos">$0</div>
              <div class="stat-change positive" id="ingresosChange">+0% vs mes anterior</div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="charts-section">
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Actividad de Empleados</h3>
              </div>
              <div class="chart-container">
                <canvas id="empleadosChart"></canvas>
              </div>
            </div>

            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Distribución de Horas</h3>
              </div>
              <div class="chart-container">
                <canvas id="horasChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <h3>Acciones Rápidas</h3>
            <div class="actions-grid">
              <a href="modulos/gestion_personal/gestion_personal.html" class="action-btn">
                <i class="fas fa-user-plus"></i>
                <span class="action-text">Agregar Empleado</span>
              </a>
              <a href="modulos/gestion_personal/gestion_personal.html" class="action-btn">
                <i class="fas fa-clock"></i>
                <span class="action-text">Registrar Horas</span>
              </a>
              <a href="modulos/inventario/inventario.html" class="action-btn">
                <i class="fas fa-box"></i>
                <span class="action-text">Gestionar Inventario</span>
              </a>
              <a href="modulos/cuadre_caja/cuadre_caja.html" class="action-btn">
                <i class="fas fa-calculator"></i>
                <span class="action-text">Cuadre de Caja</span>
              </a>
              <a href="modulos/configuracion/configuracion.html" class="action-btn">
                <i class="fas fa-cog"></i>
                <span class="action-text">Configuración</span>
              </a>
              <a href="membresias.html" class="action-btn">
                <i class="fas fa-crown"></i>
                <span class="action-text">Actualizar Plan</span>
              </a>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Dashboard System
      class AxyraDashboard {
        constructor() {
          this.charts = {};
          this.stats = {};
          this.init();
        }

        async init() {
          console.log('📊 Inicializando Dashboard AXYRA...');

          try {
            // Verificar autenticación
            if (window.axyraAuth && !window.axyraAuth.isUserAuthenticated()) {
              window.location.href = 'login-optimized.html';
              return;
            }

            // Cargar datos
            await this.loadDashboardData();

            // Inicializar gráficos
            this.initializeCharts();

            // Configurar eventos
            this.setupEventListeners();

            // Actualizar indicador de membresía
            this.updateMembershipIndicator();

            console.log('✅ Dashboard AXYRA inicializado');
          } catch (error) {
            console.error('❌ Error inicializando dashboard:', error);
            if (window.axyraNotifications) {
              window.axyraNotifications.showError('Error cargando el dashboard');
            }
          }
        }

        async loadDashboardData() {
          try {
            // Cargar datos de empleados
            const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
            const productos = JSON.parse(localStorage.getItem('axyra_inventario_productos') || '[]');

            // Calcular estadísticas
            this.stats = {
              totalEmpleados: empleados.length,
              empleadosActivos: empleados.filter((emp) => emp.estado === 'activo').length,
              totalHoras: horas.reduce((sum, hora) => sum + (hora.totalHoras || 0), 0),
              totalProductos: productos.length,
              productosStockBajo: productos.filter((prod) => prod.stock <= prod.stockMinimo).length,
              totalIngresos: this.calcularIngresos(horas, empleados),
            };

            // Actualizar elementos del DOM
            this.updateStatsDisplay();
          } catch (error) {
            console.error('Error cargando datos del dashboard:', error);
          }
        }

        calcularIngresos(horas, empleados) {
          let total = 0;
          horas.forEach((hora) => {
            if (hora.totalSalario) {
              total += hora.totalSalario;
            }
          });
          return total;
        }

        updateStatsDisplay() {
          const elementos = {
            totalEmpleados: this.stats.totalEmpleados,
            totalHoras: this.stats.totalHoras.toFixed(1),
            totalProductos: this.stats.totalProductos,
            totalIngresos: this.formatCurrency(this.stats.totalIngresos),
          };

          Object.entries(elementos).forEach(([id, valor]) => {
            const elemento = document.getElementById(id);
            if (elemento) {
              elemento.textContent = valor;
            }
          });
        }

        initializeCharts() {
          // Gráfico de empleados
          const empleadosCtx = document.getElementById('empleadosChart');
          if (empleadosCtx) {
            this.charts.empleados = new Chart(empleadosCtx, {
              type: 'line',
              data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [
                  {
                    label: 'Empleados Activos',
                    data: [12, 19, 3, 5, 2, 3],
                    borderColor: '#1e3c72',
                    backgroundColor: 'rgba(30, 60, 114, 0.1)',
                    tension: 0.4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                  },
                },
              },
            });
          }

          // Gráfico de horas
          const horasCtx = document.getElementById('horasChart');
          if (horasCtx) {
            this.charts.horas = new Chart(horasCtx, {
              type: 'doughnut',
              data: {
                labels: ['Ordinarias', 'Extras', 'Nocturnas'],
                datasets: [
                  {
                    data: [70, 20, 10],
                    backgroundColor: ['#1e3c72', '#2a5298', '#3b82f6'],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                  },
                },
              },
            });
          }
        }

        updateMembershipIndicator() {
          const membershipPlan = localStorage.getItem('axyra_membership_plan') || 'free';
          const membershipIndicator = document.getElementById('membershipIndicator');
          const membershipText = document.getElementById('membershipText');
          const membershipIcon = document.getElementById('membershipIcon');
          const upgradeBtn = document.getElementById('upgradeBtn');

          if (!membershipIndicator) return;

          const plans = {
            free: { text: 'Plan Gratuito', icon: 'fas fa-gift', showUpgrade: true },
            basic: { text: 'Plan Básico', icon: 'fas fa-star', showUpgrade: true },
            professional: { text: 'Plan Profesional', icon: 'fas fa-crown', showUpgrade: true },
            enterprise: { text: 'Plan Empresarial', icon: 'fas fa-building', showUpgrade: false },
          };

          const plan = plans[membershipPlan] || plans.free;

          membershipText.textContent = plan.text;
          membershipIcon.className = plan.icon;
          upgradeBtn.style.display = plan.showUpgrade ? 'block' : 'none';
        }

        setupEventListeners() {
          // Toggle sidebar
          const sidebarToggle = document.getElementById('sidebarToggle');
          const sidebar = document.getElementById('sidebar');
          const mainContent = document.getElementById('mainContent');

          if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
              sidebar.classList.toggle('collapsed');
              mainContent.classList.toggle('expanded');
            });
          }

          // Responsive sidebar
          window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
              sidebar.classList.add('collapsed');
              mainContent.classList.add('expanded');
            } else {
              sidebar.classList.remove('collapsed');
              mainContent.classList.remove('expanded');
            }
          });
        }

        formatCurrency(value) {
          return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(value);
        }
      }

      // Inicializar dashboard
      document.addEventListener('DOMContentLoaded', function () {
        try {
          window.axyraDashboard = new AxyraDashboard();
        } catch (error) {
          console.error('❌ Error inicializando dashboard:', error);
        }
      });

      // Función para toggle del menú de usuario
      function toggleUserMenu() {
        if (window.axyraAuth) {
          if (confirm('¿Deseas cerrar sesión?')) {
            window.axyraAuth.logout();
          }
        }
      }

      // Función para mostrar modal de integraciones
      function showIntegrationsModal() {
        const modal = document.getElementById('integrationsModal');
        if (modal) {
          modal.style.display = 'block';
          loadIntegrationsStatus();
        }
      }

      // Función para cargar estado de integraciones
      async function loadIntegrationsStatus() {
        try {
          if (window.axyraThirdPartyManager) {
            const status = await window.axyraThirdPartyManager.getIntegrationsStatus();
            updateIntegrationsUI(status);
          }
        } catch (error) {
          console.error('❌ Error cargando estado de integraciones:', error);
        }
      }

      // Función para actualizar UI de integraciones
      function updateIntegrationsUI(status) {
        const googleStatus = status.integrations.googleWorkspace;
        const microsoftStatus = status.integrations.microsoft365;

        // Actualizar Google Workspace
        if (googleStatus) {
          const googleCard = document.getElementById('googleWorkspaceCard');
          if (googleCard) {
            const statusBadge = googleCard.querySelector('.status-badge');
            const connectBtn = googleCard.querySelector('.connect-btn');

            if (googleStatus.connected) {
              statusBadge.textContent = 'Conectado';
              statusBadge.className = 'status-badge connected';
              connectBtn.textContent = 'Desconectar';
              connectBtn.onclick = () => disconnectIntegration('googleWorkspace');
            } else {
              statusBadge.textContent = 'Desconectado';
              statusBadge.className = 'status-badge disconnected';
              connectBtn.textContent = 'Conectar';
              connectBtn.onclick = () => connectIntegration('googleWorkspace');
            }
          }
        }

        // Actualizar Microsoft 365
        if (microsoftStatus) {
          const microsoftCard = document.getElementById('microsoft365Card');
          if (microsoftCard) {
            const statusBadge = microsoftCard.querySelector('.status-badge');
            const connectBtn = microsoftCard.querySelector('.connect-btn');

            if (microsoftStatus.connected) {
              statusBadge.textContent = 'Conectado';
              statusBadge.className = 'status-badge connected';
              connectBtn.textContent = 'Desconectar';
              connectBtn.onclick = () => disconnectIntegration('microsoft365');
            } else {
              statusBadge.textContent = 'Desconectado';
              statusBadge.className = 'status-badge disconnected';
              connectBtn.textContent = 'Conectar';
              connectBtn.onclick = () => connectIntegration('microsoft365');
            }
          }
        }
      }

      // Función para conectar integración
      async function connectIntegration(integrationName) {
        try {
          if (window.axyraThirdPartyManager) {
            await window.axyraThirdPartyManager.connectIntegration(integrationName);
            await loadIntegrationsStatus();
          }
        } catch (error) {
          console.error(`❌ Error conectando ${integrationName}:`, error);
        }
      }

      // Función para desconectar integración
      async function disconnectIntegration(integrationName) {
        try {
          if (window.axyraThirdPartyManager) {
            await window.axyraThirdPartyManager.disconnectIntegration(integrationName);
            await loadIntegrationsStatus();
          }
        } catch (error) {
          console.error(`❌ Error desconectando ${integrationName}:`, error);
        }
      }

      // Función para ejecutar tests del sistema
      async function runSystemTests() {
        try {
          if (window.axyraTestingSuite) {
            // Mostrar modal de testing
            showTestingModal();

            // Ejecutar tests
            await window.axyraTestingSuite.runAllTests();

            // Actualizar resultados
            updateTestingResults();
          } else {
            alert('Suite de testing no está disponible');
          }
        } catch (error) {
          console.error('❌ Error ejecutando tests:', error);
          alert('Error ejecutando tests: ' + error.message);
        }
      }

      // Función para mostrar modal de testing
      function showTestingModal() {
        const modal = document.getElementById('testingModal');
        if (modal) {
          modal.style.display = 'block';
        }
      }

      // Función para actualizar resultados de testing
      function updateTestingResults() {
        const report = window.axyraTestingSuite.getTestReport();
        if (report) {
          const resultsContainer = document.getElementById('testingResults');
          if (resultsContainer) {
            resultsContainer.innerHTML = generateTestingHTML(report);
          }
        }
      }

      // Función para generar HTML de resultados
      function generateTestingHTML(report) {
        const { summary, results } = report;

        return `
          <div class="testing-summary">
            <h3>Resumen de Tests</h3>
            <div class="summary-stats">
              <div class="stat">
                <span class="stat-label">Total:</span>
                <span class="stat-value">${summary.total}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Exitosos:</span>
                <span class="stat-value success">${summary.passed}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Fallidos:</span>
                <span class="stat-value error">${summary.failed}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Tasa de Éxito:</span>
                <span class="stat-value">${summary.successRate}%</span>
              </div>
            </div>
          </div>
          <div class="testing-results">
            <h3>Resultados Detallados</h3>
            <div class="results-list">
              ${results
                .map(
                  (result) => `
                <div class="test-result ${result.status}">
                  <div class="test-info">
                    <span class="test-name">${result.name}</span>
                    <span class="test-duration">${result.duration}ms</span>
                  </div>
                  <div class="test-status">
                    ${result.status === 'passed' ? '✅' : '❌'}
                  </div>
                  ${result.error ? `<div class="test-error">${result.error}</div>` : ''}
                </div>
              `
                )
                .join('')}
            </div>
          </div>
        `;
      }

      // Función para ejecutar optimización final del sistema
      async function runSystemOptimization() {
        try {
          if (window.axyraSystemOptimizer && window.axyraSystemValidator && window.axyraSystemCleanup) {
            // Mostrar modal de optimización
            showOptimizationModal();

            // Ejecutar optimización completa
            await window.axyraSystemOptimizer.runFullOptimization();

            // Ejecutar validación completa
            await window.axyraSystemValidator.runFullValidation();

            // Ejecutar limpieza completa
            await window.axyraSystemCleanup.runFullCleanup();

            // Actualizar resultados
            updateOptimizationResults();
          } else {
            alert('Herramientas de optimización no están disponibles');
          }
        } catch (error) {
          console.error('❌ Error ejecutando optimización:', error);
          alert('Error ejecutando optimización: ' + error.message);
        }
      }

      // Función para mostrar modal de optimización
      function showOptimizationModal() {
        const modal = document.getElementById('optimizationModal');
        if (modal) {
          modal.style.display = 'block';
        }
      }

      // Función para actualizar resultados de optimización
      function updateOptimizationResults() {
        const optimizerReport = window.axyraSystemOptimizer.getOptimizationReport();
        const validatorReport = window.axyraSystemValidator.getValidationReport();
        const cleanupReport = window.axyraSystemCleanup.getCleanupReport();

        if (optimizerReport || validatorReport || cleanupReport) {
          const resultsContainer = document.getElementById('optimizationResults');
          if (resultsContainer) {
            resultsContainer.innerHTML = generateOptimizationHTML(optimizerReport, validatorReport, cleanupReport);
          }
        }
      }

      // Función para generar HTML de resultados de optimización
      function generateOptimizationHTML(optimizerReport, validatorReport, cleanupReport) {
        return `
          <div class="optimization-summary">
            <h3>Resumen de Optimización Final</h3>
            <div class="summary-stats">
              <div class="stat">
                <span class="stat-label">Archivos Optimizados:</span>
                <span class="stat-value">${optimizerReport?.results?.filesOptimized || 0}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Archivos Removidos:</span>
                <span class="stat-value">${cleanupReport?.results?.filesRemoved || 0}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Validaciones Exitosas:</span>
                <span class="stat-value success">${validatorReport?.results?.passed || 0}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Tasa de Éxito:</span>
                <span class="stat-value">${validatorReport?.summary?.successRate || 0}%</span>
              </div>
            </div>
          </div>
          <div class="optimization-details">
            <h3>Detalles de Optimización</h3>
            <div class="details-grid">
              ${
                optimizerReport
                  ? `
                <div class="detail-card">
                  <h4>Optimización de Recursos</h4>
                  <p>Archivos optimizados: ${optimizerReport.results.filesOptimized}</p>
                  <p>Reducción de tamaño: ${optimizerReport.results.sizeReduction}MB</p>
                </div>
              `
                  : ''
              }
              ${
                validatorReport
                  ? `
                <div class="detail-card">
                  <h4>Validación del Sistema</h4>
                  <p>Total de validaciones: ${validatorReport.results.total}</p>
                  <p>Exitosas: ${validatorReport.results.passed}</p>
                  <p>Fallidas: ${validatorReport.results.failed}</p>
                </div>
              `
                  : ''
              }
              ${
                cleanupReport
                  ? `
                <div class="detail-card">
                  <h4>Limpieza del Sistema</h4>
                  <p>Archivos removidos: ${cleanupReport.results.filesRemoved}</p>
                  <p>Archivos optimizados: ${cleanupReport.results.filesOptimized}</p>
                </div>
              `
                  : ''
              }
            </div>
          </div>
        `;
      }
    </script>

    <!-- Modal de Integraciones -->
    <div id="integrationsModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-plug"></i> Integraciones de Servicios</h2>
          <span class="close" onclick="document.getElementById('integrationsModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
          <div class="integrations-grid">
            <!-- Google Workspace -->
            <div class="integration-card" id="googleWorkspaceCard">
              <div class="integration-header">
                <div class="integration-icon">
                  <i class="fab fa-google"></i>
                </div>
                <div class="integration-info">
                  <h3>Google Workspace</h3>
                  <p>Gmail, Drive, Calendar, Meet, Docs</p>
                </div>
                <div class="status-badge disconnected">Desconectado</div>
              </div>
              <div class="integration-services">
                <span class="service-tag">Gmail</span>
                <span class="service-tag">Drive</span>
                <span class="service-tag">Calendar</span>
                <span class="service-tag">Meet</span>
                <span class="service-tag">Docs</span>
              </div>
              <div class="integration-actions">
                <button class="connect-btn" onclick="connectIntegration('googleWorkspace')">Conectar</button>
              </div>
            </div>

            <!-- Microsoft 365 -->
            <div class="integration-card" id="microsoft365Card">
              <div class="integration-header">
                <div class="integration-icon">
                  <i class="fab fa-microsoft"></i>
                </div>
                <div class="integration-info">
                  <h3>Microsoft 365</h3>
                  <p>Outlook, OneDrive, Teams, SharePoint, Power BI</p>
                </div>
                <div class="status-badge disconnected">Desconectado</div>
              </div>
              <div class="integration-services">
                <span class="service-tag">Outlook</span>
                <span class="service-tag">OneDrive</span>
                <span class="service-tag">Teams</span>
                <span class="service-tag">SharePoint</span>
                <span class="service-tag">Power BI</span>
              </div>
              <div class="integration-actions">
                <button class="connect-btn" onclick="connectIntegration('microsoft365')">Conectar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Testing -->
    <div id="testingModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-vial"></i> Tests del Sistema</h2>
          <span class="close" onclick="document.getElementById('testingModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
          <div id="testingResults">
            <div class="testing-loading">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Ejecutando tests del sistema...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Optimización Final -->
    <div id="optimizationModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-tools"></i> Optimización Final del Sistema</h2>
          <span class="close" onclick="document.getElementById('optimizationModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
          <div class="optimization-container">
            <div class="optimization-section">
              <h3>Proceso de Optimización</h3>
              <div class="optimization-steps">
                <div class="step">
                  <i class="fas fa-cog"></i>
                  <span>Optimizando recursos...</span>
                </div>
                <div class="step">
                  <i class="fas fa-check-circle"></i>
                  <span>Validando configuración...</span>
                </div>
                <div class="step">
                  <i class="fas fa-broom"></i>
                  <span>Limpiando archivos...</span>
                </div>
              </div>
              <div class="optimization-results" id="optimizationResults">
                <!-- Los resultados se mostrarán aquí -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Modal Styles */
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        color: #1e3c72;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #6b7280;
      }

      .close:hover {
        color: #374151;
      }

      .modal-body {
        padding: 20px;
      }

      /* Integration Cards */
      .integrations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }

      .integration-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        background: #f9fafb;
        transition: all 0.3s ease;
      }

      .integration-card:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .integration-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .integration-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .integration-icon i.fa-google {
        background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
      }

      .integration-icon i.fa-microsoft {
        background: linear-gradient(45deg, #00a4ef, #7fba00, #ffb900, #f25022);
      }

      .integration-info h3 {
        margin: 0 0 5px 0;
        color: #1e3c72;
        font-size: 18px;
      }

      .integration-info p {
        margin: 0;
        color: #6b7280;
        font-size: 14px;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-badge.connected {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.disconnected {
        background: #fee2e2;
        color: #991b1b;
      }

      .integration-services {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
      }

      .service-tag {
        background: #e5e7eb;
        color: #374151;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
      }

      .integration-actions {
        display: flex;
        gap: 10px;
      }

      .connect-btn {
        background: #1e3c72;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .connect-btn:hover {
        background: #1a365d;
        transform: translateY(-1px);
      }

      @media (max-width: 768px) {
        .integrations-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
          margin: 10px;
        }
      }

      /* Testing Modal Styles */
      .testing-loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .testing-loading i {
        font-size: 24px;
        margin-bottom: 10px;
      }

      /* Optimization Modal Styles */
      .optimization-container {
        padding: 1rem;
      }

      .optimization-section h3 {
        color: #333;
        margin-bottom: 1.5rem;
        font-size: 1.2rem;
      }

      .optimization-steps {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .step {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }

      .step i {
        font-size: 1.2rem;
        color: #007bff;
      }

      .step span {
        font-weight: 500;
        color: #333;
      }

      .optimization-results {
        margin-top: 2rem;
      }

      .optimization-summary {
        background: #e8f5e8;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
      }

      .optimization-summary h3 {
        color: #28a745;
        margin-bottom: 1rem;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: white;
        border-radius: 4px;
      }

      .stat-label {
        font-weight: 500;
        color: #666;
      }

      .stat-value {
        font-weight: bold;
        color: #333;
      }

      .stat-value.success {
        color: #28a745;
      }

      .optimization-details h3 {
        color: #333;
        margin-bottom: 1rem;
      }

      .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }

      .detail-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      .detail-card h4 {
        color: #007bff;
        margin-bottom: 1rem;
        font-size: 1.1rem;
      }

      .detail-card p {
        margin: 0.5rem 0;
        color: #666;
      }

      .testing-summary {
        margin-bottom: 20px;
        padding: 20px;
        background: #f9fafb;
        border-radius: 8px;
      }

      .testing-summary h3 {
        margin: 0 0 15px 0;
        color: #1e3c72;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stat-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #1e3c72;
      }

      .stat-value.success {
        color: #10b981;
      }

      .stat-value.error {
        color: #ef4444;
      }

      .testing-results h3 {
        margin: 0 0 15px 0;
        color: #1e3c72;
      }

      .results-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .test-result {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 4px solid;
      }

      .test-result.passed {
        background: #f0fdf4;
        border-left-color: #10b981;
      }

      .test-result.failed {
        background: #fef2f2;
        border-left-color: #ef4444;
      }

      .test-info {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .test-name {
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
      }

      .test-duration {
        font-size: 12px;
        color: #6b7280;
      }

      .test-status {
        font-size: 18px;
        margin-left: 10px;
      }

      .test-error {
        margin-top: 8px;
        padding: 8px;
        background: #fef2f2;
        border-radius: 4px;
        font-size: 12px;
        color: #dc2626;
        border: 1px solid #fecaca;
      }
    </style>
  </body>
</html>
