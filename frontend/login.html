<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Iniciar Sesión</title>
    <link rel="icon" href="nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="static/firebase-config.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- AXYRA Systems -->
    <script src="static/emailjs-config.js"></script>
    <script src="static/auth-system.js"></script>
    <script src="static/error-handler.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .login-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 450px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      }

      .logo {
        margin-bottom: 30px;
      }

      .logo img {
        width: 60px;
        height: 60px;
        margin-bottom: 15px;
      }

      .logo h1 {
        color: #2d3748;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .logo p {
        color: #718096;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
        font-size: 16px;
        padding: 5px;
        transition: color 0.3s ease;
      }

      .password-toggle:hover {
        color: #667eea;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .checkbox-group input[type='checkbox'] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      .checkbox-group label {
        font-size: 14px;
        color: #4a5568;
        cursor: pointer;
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s ease;
        margin-bottom: 20px;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-google {
        background: #4285f4;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .divider {
        display: flex;
        align-items: center;
        margin: 20px 0;
        color: #718096;
        font-size: 14px;
      }

      .divider::before,
      .divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e2e8f0;
      }

      .divider span {
        padding: 0 15px;
      }

      .links {
        text-align: center;
        margin-top: 20px;
      }

      .links a {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        margin: 0 10px;
      }

      .links a:hover {
        text-decoration: underline;
      }

      .error-message {
        background: #fed7d7;
        color: #c53030;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      .success-message {
        background: #c6f6d5;
        color: #2f855a;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      @media (max-width: 480px) {
        .login-container {
          padding: 30px 20px;
          margin: 10px;
        }
      }
    </style>
  </head>

  <body>
    <div class="login-container">
      <div class="logo">
        <img src="logo.png" alt="AXYRA" />
        <h1>AXYRA</h1>
        <p>Accede a tu panel de control empresarial</p>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <!-- Formulario de Email -->
      <form id="loginForm">
        <div class="form-group">
          <label for="email" class="form-label">Correo Electrónico</label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-input"
            placeholder="tu@email.com"
            value="axyra.app@gmail.com"
            required
          />
        </div>

        <button type="submit" class="btn" id="loginBtn">
          <i class="fas fa-paper-plane"></i>
          Enviar Código de Acceso
        </button>

        <div class="divider">
          <span>o</span>
        </div>

        <button type="button" class="btn btn-google" onclick="loginWithGoogle()">
          <i class="fab fa-google"></i>
          Continuar con Google
        </button>
      </form>

      <!-- Formulario de Código -->
      <form id="codeForm" style="display: none;">
        <div class="form-group">
          <label class="form-label">Código de Acceso</label>
          <p class="form-description">Ingresa el código de 6 dígitos que enviamos a tu email</p>
          <input
            type="text"
            id="loginCode"
            name="loginCode"
            class="form-input"
            placeholder="123456"
            maxlength="6"
            pattern="[0-9]{6}"
            required
          />
          <input type="hidden" id="userEmail" name="userEmail" />
        </div>

        <button type="submit" class="btn" id="verifyBtn">
          <i class="fas fa-check"></i>
          Verificar Código
        </button>

        <button type="button" class="btn btn-secondary" onclick="axyraAuth.showLoginForm()">
          <i class="fas fa-arrow-left"></i>
          Volver
        </button>
      </form>

      <div class="links">
        <a href="register.html">¿No tienes cuenta? Regístrate</a>
        <a href="#" onclick="resetPassword()">¿Olvidaste tu contraseña?</a>
      </div>
    </div>

    <script>
      // Variables globales
      let isPasswordVisible = false;

      // Función para alternar visibilidad de contraseña
      function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.getElementById('passwordToggleIcon');

        if (isPasswordVisible) {
          passwordInput.type = 'password';
          toggleIcon.className = 'fas fa-eye';
          isPasswordVisible = false;
        } else {
          passwordInput.type = 'text';
          toggleIcon.className = 'fas fa-eye-slash';
          isPasswordVisible = true;
        }
      }

      // Función para mostrar mensajes
      function showMessage(message, type = 'error') {
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');

        if (type === 'error') {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
          successDiv.style.display = 'none';
        } else {
          successDiv.textContent = message;
          successDiv.style.display = 'block';
          errorDiv.style.display = 'none';
        }

        setTimeout(() => {
          errorDiv.style.display = 'none';
          successDiv.style.display = 'none';
        }, 5000);
      }

      // Función para login con Google
      async function loginWithGoogle() {
        try {
          if (typeof firebase === 'undefined') {
            showMessage('Firebase no está disponible. Recarga la página.', 'error');
            return;
          }

          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await firebase.auth().signInWithPopup(provider);

          showMessage('¡Inicio de sesión exitoso!', 'success');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
        } catch (error) {
          console.error('Error en login con Google:', error);
          showMessage('Error al iniciar sesión con Google: ' + error.message, 'error');
        }
      }

      // Función para reset de contraseña
      async function resetPassword() {
        const email = document.getElementById('email').value;

        if (!email) {
          showMessage('Por favor ingresa tu correo electrónico', 'error');
          return;
        }

        try {
          if (typeof firebase === 'undefined') {
            showMessage('Firebase no está disponible. Recarga la página.', 'error');
            return;
          }

          await firebase.auth().sendPasswordResetEmail(email);
          showMessage('Se ha enviado un enlace de recuperación a tu correo', 'success');
        } catch (error) {
          console.error('Error enviando email de recuperación:', error);
          showMessage('Error al enviar email de recuperación: ' + error.message, 'error');
        }
      }

      // Función principal de login
      async function handleLogin(event) {
        event.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const remember = document.getElementById('remember').checked;
        const loginBtn = document.getElementById('loginBtn');

        if (!email || !password) {
          showMessage('Por favor completa todos los campos', 'error');
          return;
        }

        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';

        try {
          if (typeof firebase === 'undefined') {
            showMessage('Firebase no está disponible. Recarga la página.', 'error');
            return;
          }

          // Configurar persistencia
          const persistence = remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;

          await firebase.auth().setPersistence(persistence);

          // Intentar login
          const result = await firebase.auth().signInWithEmailAndPassword(email, password);

          showMessage('¡Inicio de sesión exitoso!', 'success');

          // Redirigir después de un breve delay
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
        } catch (error) {
          console.error('Error en login:', error);

          let errorMessage = 'Error al iniciar sesión';

          switch (error.code) {
            case 'auth/user-not-found':
              errorMessage = 'No existe una cuenta con este correo electrónico';
              break;
            case 'auth/wrong-password':
              errorMessage = 'Contraseña incorrecta';
              break;
            case 'auth/invalid-email':
              errorMessage = 'Correo electrónico inválido';
              break;
            case 'auth/user-disabled':
              errorMessage = 'Esta cuenta ha sido deshabilitada';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'Demasiados intentos fallidos. Intenta más tarde';
              break;
            default:
              errorMessage = error.message;
          }

          showMessage(errorMessage, 'error');
        } finally {
          loginBtn.disabled = false;
          loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
        }
      }

      // Event listeners
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      // Verificar si ya está autenticado
      document.addEventListener('DOMContentLoaded', function () {
        if (typeof firebase !== 'undefined' && firebase.auth) {
          firebase.auth().onAuthStateChanged((user) => {
            if (user) {
              // Usuario ya autenticado, redirigir
              window.location.href = 'index.html';
            }
          });
        }
      });
    </script>
  </body>
</html>
