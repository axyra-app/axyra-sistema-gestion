<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gestión de Empleados</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="stylesheet" href="../../static/modal-positioning-fix.css" />
    <link rel="stylesheet" href="../../static/modal-emergency-fix.css" />
    <link rel="stylesheet" href="../../static/header-fixes.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>

    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>

    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>
    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
    <!-- HEADER COMPARTIDO AXYRA -->
    <script src="../../static/include-header.js"></script>

    <!-- Sistema Unificado de Autenticación AXYRA -->
    <script src="../../static/unified-auth-system.js"></script>

    <!-- Sistema Unificado de Reportes Avanzados AXYRA -->
    <script src="../../static/advanced-reports-unified.js"></script>

    <!-- Sistema Unificado de Backup AXYRA -->
    <script src="../../static/backup-system-unified.js"></script>

    <!-- Sistema Unificado de Auditoría AXYRA -->
    <script src="../../static/audit-system-unified.js"></script>

    <!-- Sistema de Sincronización Firebase ↔ localStorage -->
    <script src="../../static/firebase-sync-manager.js"></script>

    <!-- Sistema de Diagnóstico AXYRA -->
    <script src="../../static/axyra-diagnostic.js"></script>

    <style>
      /* Responsive Design - Optimización para móviles */
      @media (max-width: 768px) {
        .axyra-nav {
          flex-direction: column;
          gap: 0.5rem;
        }

        .axyra-nav-link {
          padding: 0.75rem;
          text-align: center;
          font-size: 0.9rem;
        }

        .axyra-actions-bar {
          flex-direction: column;
          gap: 1rem;
        }

        .axyra-filters {
          flex-direction: column;
          gap: 1rem;
        }

        .axyra-table-container {
          overflow-x: auto;
        }

        .axyra-table {
          min-width: 800px;
        }

        .axyra-action-buttons {
          flex-direction: column;
          gap: 0.5rem;
        }
      }

      @media (max-width: 480px) {
        .axyra-page-header h1 {
          font-size: 1.5rem;
        }

        .axyra-page-subtitle {
          font-size: 0.9rem;
        }

        .axyra-btn {
          padding: 0.75rem 1rem;
          font-size: 0.9rem;
        }
      }

      /* Estilos para notificaciones en tiempo real */
      .axyra-notificacion-tiempo-real {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid #667eea;
      }

      .axyra-notificacion-tiempo-real.axyra-notificacion-success {
        border-left-color: #48bb78;
      }

      .axyra-notificacion-tiempo-real.axyra-notificacion-info {
        border-left-color: #4299e1;
      }

      .axyra-notificacion-tiempo-real.axyra-notificacion-warning {
        border-left-color: #ed8936;
      }

      .axyra-notificacion-tiempo-real.axyra-notificacion-error {
        border-left-color: #f56565;
      }

      .axyra-notificacion-cerrar {
        background: none;
        border: none;
        color: #718096;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: all 0.2s;
        margin-left: auto;
      }

      .axyra-notificacion-cerrar:hover {
        background: #f7fafc;
        color: #4a5568;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Estilos para historial de cambios */
      .axyra-historial-filtros {
        display: flex;
        gap: 1rem;
        margin-bottom: 20px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .axyra-historial-filtros select,
      .axyra-historial-filtros input {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
      }

      .axyra-historial-lista {
        max-height: 400px;
        overflow-y: auto;
      }

      .axyra-historial-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s;
      }

      .axyra-historial-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .axyra-historial-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .axyra-historial-accion {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: white;
      }

      .axyra-historial-create {
        background: #48bb78;
      }

      .axyra-historial-update {
        background: #4299e1;
      }

      .axyra-historial-delete {
        background: #f56565;
      }

      .axyra-historial-fecha {
        color: #718096;
        font-size: 12px;
      }

      .axyra-historial-detalles {
        color: #4a5568;
        font-size: 14px;
        line-height: 1.5;
      }

      /* Estilos para importación masiva */
      .axyra-importacion-instrucciones {
        background: #f0fff4;
        border: 1px solid #9ae6b4;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }

      .axyra-importacion-instrucciones h4 {
        color: #22543d;
        margin-bottom: 12px;
      }

      .axyra-importacion-instrucciones ul {
        margin: 0;
        padding-left: 20px;
        color: #2f855a;
      }

      .axyra-importacion-instrucciones li {
        margin-bottom: 4px;
      }

      .axyra-importacion-archivo {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
      }

      .axyra-importacion-archivo input[type='file'] {
        flex: 1;
        padding: 8px;
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        background: #f7fafc;
      }

      .axyra-importacion-resultado {
        margin-top: 20px;
      }

      .axyra-importacion-exito {
        background: #f0fff4;
        border: 1px solid #9ae6b4;
        border-radius: 8px;
        padding: 16px;
        color: #22543d;
      }

      .axyra-importacion-lista {
        margin-top: 12px;
      }

      .axyra-importacion-lista h5 {
        margin-bottom: 8px;
        color: #22543d;
      }

      .axyra-importacion-lista ul {
        margin: 0;
        padding-left: 20px;
      }

      .axyra-importacion-lista li {
        margin-bottom: 4px;
        color: #2f855a;
      }

      /* Estilos para organigrama visual */
      .axyra-organigrama {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        padding: 20px;
      }

      .axyra-departamento-grupo {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s;
      }

      .axyra-departamento-grupo:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      /* Estilos para departamentos */
      .axyra-department-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 12px;
        background: white;
        transition: all 0.2s ease;
      }

      .axyra-department-item:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      }

      .axyra-department-info {
        flex: 1;
      }

      .axyra-department-name {
        display: block;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
        color: #1f2937;
      }

      .axyra-department-descripcion {
        display: block;
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .axyra-department-count {
        display: block;
        color: #9ca3af;
        font-size: 12px;
        font-weight: 500;
      }

      .axyra-department-actions {
        display: flex;
        gap: 8px;
      }

      .axyra-btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        min-height: 36px;
        min-width: 36px;
      }

      .axyra-departamento-header {
        color: white;
        padding: 16px 20px;
        text-align: center;
      }

      .axyra-departamento-header h4 {
        margin: 0 0 8px 0;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .axyra-empleados-count {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .axyra-empleados-grid {
        padding: 20px;
        display: grid;
        gap: 12px;
      }

      .axyra-empleado-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
      }

      .axyra-empleado-card:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .axyra-empleado-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .axyra-empleado-info {
        flex: 1;
      }

      .axyra-empleado-info strong {
        display: block;
        color: #2d3748;
        font-size: 14px;
        margin-bottom: 2px;
      }

      .axyra-empleado-info span {
        display: block;
        color: #4a5568;
        font-size: 12px;
        margin-bottom: 2px;
      }

      .axyra-empleado-info small {
        color: #718096;
        font-size: 11px;
      }
    </style>

    <style>
      /* Estilos para sistema de fotos de empleados */
      .axyra-fotos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .axyra-foto-empleado {
        text-align: center;
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
      }

      .axyra-foto-empleado:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .axyra-foto-container {
        position: relative;
        margin-bottom: 12px;
      }

      .axyra-foto-empleado-img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #e2e8f0;
        transition: all 0.3s;
      }

      .axyra-foto-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .axyra-foto-empleado:hover .axyra-foto-overlay {
        opacity: 1;
      }

      .axyra-btn-foto {
        background: #667eea;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .axyra-btn-foto:hover {
        background: #5a67d8;
        transform: scale(1.1);
      }

      .axyra-foto-info strong {
        display: block;
        color: #2d3748;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .axyra-foto-info span {
        color: #718096;
        font-size: 12px;
      }

      /* Estilos para modales */
      .axyra-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .axyra-modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .axyra-modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-modal-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .axyra-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.3s;
      }

      .axyra-modal-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .axyra-modal-body {
        padding: 30px;
      }

      .axyra-modal-text {
        line-height: 1.6;
      }

      .axyra-modal-text ul {
        margin: 15px 0;
        padding-left: 20px;
      }

      .axyra-modal-text li {
        margin: 8px 0;
        color: #555;
      }

      .axyra-modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
      }

      /* Estilos para información del empleado */
      .axyra-empleado-info {
        display: grid;
        gap: 15px;
      }

      .axyra-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .axyra-info-label {
        font-weight: 600;
        color: #495057;
        min-width: 120px;
      }

      .axyra-info-value {
        color: #212529;
        font-weight: 500;
        text-align: right;
        flex: 1;
      }

      /* Mejorar botones de acción */
      .axyra-btn-action {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        margin: 2px;
      }

      .axyra-btn-view {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
      }

      .axyra-btn-view:hover {
        background: linear-gradient(135deg, #218838, #1ea085);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      }

      .axyra-btn-edit {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: white;
      }

      .axyra-btn-edit:hover {
        background: linear-gradient(135deg, #e0a800, #e8590c);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      }

      .axyra-btn-delete {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
      }

      .axyra-btn-delete:hover {
        background: linear-gradient(135deg, #c82333, #a71e2a);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      }

      /* Mejorar formularios */
      .axyra-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .axyra-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .axyra-form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .axyra-form-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
      }

      .axyra-form-input,
      .axyra-form-select {
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background-color: #fff;
      }

      .axyra-form-input:focus,
      .axyra-form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* Botones del modal */
      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      }

      .axyra-btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .axyra-btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd8, #6a4190);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .axyra-btn-secondary {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
      }

      .axyra-btn-secondary:hover {
        background: linear-gradient(135deg, #5a6268, #343a40);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
      }

      .axyra-btn-error {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
      }

      .axyra-btn-error:hover {
        background: linear-gradient(135deg, #c82333, #a71e2a);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .axyra-modal-content {
          width: 95%;
          margin: 10% auto;
        }

        .axyra-form-row {
          grid-template-columns: 1fr;
        }

        .axyra-modal-footer {
          flex-direction: column;
        }

        .axyra-info-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }

        .axyra-info-value {
          text-align: left;
        }

        /* Estilos para el organigrama */
        .axyra-organigrama {
          display: flex;
          flex-direction: column;
          gap: 24px;
          padding: 20px;
        }

        .axyra-departamento-grupo {
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .axyra-departamento-header {
          padding: 16px 20px;
          color: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .axyra-departamento-header h4 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
        }

        .axyra-empleados-count {
          background: rgba(255, 255, 255, 0.2);
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 14px;
          font-weight: 500;
        }

        .axyra-empleados-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 16px;
          padding: 20px;
          background: #f9fafb;
        }

        .axyra-empleado-card {
          background: white;
          border-radius: 8px;
          padding: 16px;
          display: flex;
          align-items: center;
          gap: 12px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }

        .axyra-empleado-avatar {
          width: 48px;
          height: 48px;
          background: #e5e7eb;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #6b7280;
          font-size: 20px;
        }

        .axyra-empleado-info {
          flex: 1;
        }

        .axyra-empleado-info strong {
          display: block;
          font-size: 16px;
          color: #111827;
          margin-bottom: 4px;
        }

        .axyra-empleado-info span {
          display: block;
          font-size: 14px;
          color: #6b7280;
          margin-bottom: 2px;
        }

        .axyra-empleado-info small {
          font-size: 12px;
          color: #9ca3af;
        }

        /* Estilos para mensaje de no datos */
        .axyra-no-data {
          text-align: center;
          padding: 60px 20px;
          color: #6b7280;
        }

        .axyra-no-data h3 {
          margin: 16px 0 8px;
          color: #374151;
        }

        .axyra-no-data p {
          margin-bottom: 24px;
          color: #9ca3af;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header compartido se incluye automáticamente -->

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gestión de Empleados</h1>
          <p class="axyra-page-subtitle">Administra la información de todos los empleados de tu empresa</p>
        </div>

        <!-- Botones de Acción -->
        <div class="axyra-actions-bar">
          <button class="axyra-btn axyra-btn-primary" onclick="mostrarModal('modalAgregarEmpleado')">
            <i class="fas fa-plus"></i> Agregar Empleado
          </button>
          <button class="axyra-btn axyra-btn-secondary" onclick="gestionarDepartamentos()">
            <i class="fas fa-building"></i> Gestionar Departamentos
          </button>
          <button class="axyra-btn axyra-btn-info" onclick="exportarEmpleados()">
            <i class="fas fa-download"></i> Exportar a Excel
          </button>
          <button class="axyra-btn axyra-btn-warning" onclick="mostrarHistorialCambios()">
            <i class="fas fa-history"></i> Historial
          </button>
          <button class="axyra-btn axyra-btn-success" onclick="mostrarModalImportacion()">
            <i class="fas fa-upload"></i> Importar
          </button>
          <button class="axyra-btn axyra-btn-info" onclick="mostrarOrganigrama()">
            <i class="fas fa-sitemap"></i> Organigrama
          </button>
          <button class="axyra-btn axyra-btn-secondary" onclick="mostrarModalFotos()">
            <i class="fas fa-camera"></i> Fotos
          </button>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="axyra-filters">
          <div class="axyra-search-box">
            <input type="text" id="searchInput" class="axyra-form-input" placeholder="Buscar empleados..." />
            <i class="fas fa-search"></i>
          </div>
          <select id="filterDepartamento" class="axyra-form-select">
            <option value="">Todos los departamentos</option>
            <option value="Administración">Administración</option>
            <option value="Ventas">Ventas</option>
            <option value="Producción">Producción</option>
            <option value="Recursos Humanos">Recursos Humanos</option>
            <option value="Tecnología">Tecnología</option>
          </select>
          <select id="filterEstado" class="axyra-form-select">
            <option value="">Todos los estados</option>
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
            <option value="Vacaciones">Vacaciones</option>
            <option value="Licencia">Licencia</option>
          </select>
        </div>

        <!-- Tabla de Empleados -->
        <div class="axyra-table-container">
          <table class="axyra-table" id="empleadosTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Foto</th>
                <th>Nombre</th>
                <th>Departamento</th>
                <th>Cargo</th>
                <th>Salario</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="empleadosTableBody">
              <!-- Los empleados se cargarán dinámicamente -->
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="axyra-pagination">
          <button class="axyra-btn axyra-btn-outline" onclick="cambiarPagina(-1)">
            <i class="fas fa-chevron-left"></i> Anterior
          </button>
          <span id="paginaInfo">Página 1 de 1</span>
          <button class="axyra-btn axyra-btn-outline" onclick="cambiarPagina(1)">
            Siguiente <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </main>

    <!-- Modal Agregar/Editar Empleado -->
    <div id="modalAgregarEmpleado" class="axyra-modal">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3 class="axyra-modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> Agregar Empleado</h3>
          <button class="axyra-modal-close" onclick="cerrarModal('modalAgregarEmpleado')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="axyra-modal-body">
          <form id="formEmpleado" class="axyra-form">
            <input type="hidden" id="empleadoId" name="id" />

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="nombre" class="axyra-form-label">Nombre Completo *</label>
                <input type="text" id="nombre" name="nombre" class="axyra-form-input" required />
              </div>
              <div class="axyra-form-group">
                <label for="cedula" class="axyra-form-label">Cédula *</label>
                <input type="text" id="cedula" name="cedula" class="axyra-form-input" required />
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="telefono" class="axyra-form-label">Teléfono</label>
                <input type="tel" id="telefono" name="telefono" class="axyra-form-input" />
              </div>
              <div class="axyra-form-group">
                <label for="email" class="axyra-form-label">Email *</label>
                <input type="email" id="email" name="email" class="axyra-form-input" required />
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="direccion" class="axyra-form-label">Dirección</label>
                <input type="text" id="direccion" name="direccion" class="axyra-form-input" />
              </div>
              <div class="axyra-form-group">
                <label for="tipoContrato" class="axyra-form-label">Tipo de Contrato *</label>
                <select id="tipoContrato" name="tipoContrato" class="axyra-form-select" required>
                  <option value="">Seleccionar tipo</option>
                  <option value="por horas">Por Horas</option>
                  <option value="fijo">Fijo</option>
                </select>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="departamento" class="axyra-form-label">Departamento *</label>
                <select id="departamento" name="departamento" class="axyra-form-select" required>
                  <option value="">Seleccionar departamento</option>
                  <!-- Los departamentos se cargarán dinámicamente -->
                </select>
              </div>
              <div class="axyra-form-group">
                <label for="cargo" class="axyra-form-label">Cargo *</label>
                <input type="text" id="cargo" name="cargo" class="axyra-form-input" required />
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="salario" class="axyra-form-label">Salario Base *</label>
                <input type="number" id="salario" name="salario" class="axyra-form-input" step="0.01" required />
              </div>
              <div class="axyra-form-group">
                <label for="fechaContratacion" class="axyra-form-label">Fecha de Contratación *</label>
                <input type="date" id="fechaContratacion" name="fechaContratacion" class="axyra-form-input" required />
              </div>
            </div>

            <div class="axyra-form-group">
              <label for="estado" class="axyra-form-label">Estado *</label>
              <select id="estado" name="estado" class="axyra-form-select" required>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
                <option value="Vacaciones">Vacaciones</option>
                <option value="Licencia">Licencia</option>
              </select>
            </div>

            <div class="axyra-modal-footer">
              <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModal('modalAgregarEmpleado')">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button type="submit" class="axyra-btn axyra-btn-primary">
                <i class="fas fa-save"></i> Guardar Empleado
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="modalConfirmacion" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3 class="axyra-modal-title"><i class="fas fa-question-circle"></i> Confirmar Acción</h3>
          <button class="axyra-modal-close" onclick="cerrarModal('modalConfirmacion')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="axyra-modal-body">
          <p id="confirmacionMensaje">¿Estás seguro de que deseas realizar esta acción?</p>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal('modalConfirmacion')">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button id="btnConfirmar" class="axyra-btn axyra-btn-error"><i class="fas fa-check"></i> Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="modalEliminarEmpleado" class="axyra-modal">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3 class="axyra-modal-title"><i class="fas fa-user-times"></i> Eliminar Empleado</h3>
          <button class="axyra-modal-close" onclick="cerrarModalEliminar()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="axyra-modal-body">
          <div class="axyra-modal-text">
            <p>⚠️ <strong>¿Estás seguro de que deseas eliminar este empleado?</strong></p>
            <p>Esta acción:</p>
            <ul>
              <li>❌ Eliminará permanentemente al empleado del sistema</li>
              <li>🗑️ Borrará todo su historial de horas trabajadas</li>
              <li>📋 Eliminará todas las nóminas asociadas</li>
              <li>🚫 <strong>NO SE PUEDE DESHACER</strong></li>
            </ul>
            <p><strong>Empleado a eliminar:</strong> <span id="nombreEmpleadoEliminar"></span></p>
          </div>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalEliminar()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="axyra-btn axyra-btn-error" onclick="confirmarEliminacionEmpleado()">
            <i class="fas fa-trash-alt"></i> Eliminar Definitivamente
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Edición de Empleado -->
    <div id="modalEditarEmpleado" class="axyra-modal">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3 class="axyra-modal-title"><i class="fas fa-user-edit"></i> Editar Empleado</h3>
          <button class="axyra-modal-close" onclick="cerrarModalEditar()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="axyra-modal-body">
          <form id="formEditarEmpleado" class="axyra-form">
            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="editNombre" class="axyra-form-label">Nombre Completo</label>
                <input type="text" id="editNombre" name="nombre" class="axyra-form-input" required />
              </div>
              <div class="axyra-form-group">
                <label for="editCedula" class="axyra-form-label">Cédula</label>
                <input type="text" id="editCedula" name="cedula" class="axyra-form-input" required />
              </div>
            </div>
            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="editTelefono" class="axyra-form-label">Teléfono</label>
                <input type="tel" id="editTelefono" name="telefono" class="axyra-form-input" />
              </div>
              <div class="axyra-form-group">
                <label for="editEmail" class="axyra-form-label">Email</label>
                <input type="email" id="editEmail" name="email" class="axyra-form-input" />
              </div>
            </div>
            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="editDireccion" class="axyra-form-label">Dirección</label>
                <input type="text" id="editDireccion" name="direccion" class="axyra-form-input" />
              </div>
              <div class="axyra-form-group">
                <label for="editSalario" class="axyra-form-label">Salario Base</label>
                <input type="number" id="editSalario" name="salario" class="axyra-form-input" required />
              </div>
            </div>
            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="editTipoContrato" class="axyra-form-label">Tipo de Contrato</label>
                <select id="editTipoContrato" name="tipoContrato" class="axyra-form-select" required>
                  <option value="por horas">Por Horas</option>
                  <option value="fijo">Fijo</option>
                </select>
              </div>
              <div class="axyra-form-group">
                <label for="editFechaContratacion" class="axyra-form-label">Fecha de Contratación</label>
                <input
                  type="date"
                  id="editFechaContratacion"
                  name="fechaContratacion"
                  class="axyra-form-input"
                  required
                />
              </div>
            </div>
          </form>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalEditar()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="axyra-btn axyra-btn-primary" onclick="guardarEdicionEmpleado()">
            <i class="fas fa-save"></i> Guardar Cambios
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Vista Previa de Empleado -->
    <div id="modalVistaEmpleado" class="axyra-modal">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3 class="axyra-modal-title"><i class="fas fa-user"></i> Información del Empleado</h3>
          <button class="axyra-modal-close" onclick="cerrarModalVista()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="axyra-modal-body">
          <div class="axyra-empleado-info">
            <div class="axyra-info-row">
              <span class="axyra-info-label">Nombre:</span>
              <span id="vistaNombre" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Cédula:</span>
              <span id="vistaCedula" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Teléfono:</span>
              <span id="vistaTelefono" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Email:</span>
              <span id="vistaEmail" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Dirección:</span>
              <span id="vistaDireccion" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Salario Base:</span>
              <span id="vistaSalario" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Tipo de Contrato:</span>
              <span id="vistaTipoContrato" class="axyra-info-value"></span>
            </div>
            <div class="axyra-info-row">
              <span class="axyra-info-label">Fecha de Contratación:</span>
              <span id="vistaFechaContratacion" class="axyra-info-value"></span>
            </div>
          </div>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-primary" onclick="cerrarModalVista()">
            <i class="fas fa-check"></i> Entendido
          </button>
        </div>
      </div>
    </div>

    <script>
      // Variables globales
      let empleados = [];
      let empleadoEditando = null;
      let paginaActual = 1;
      const empleadosPorPagina = 10;
      let currentUser = null;

      // Sistema de organigrama visual - Estructura de la empresa
      async function mostrarOrganigrama() {
        try {
          console.log('🚀 Iniciando carga del organigrama...');

          let departamentos = [];
          let empleados = [];

          // Usar el sistema de sincronización si está disponible
          if (window.firebaseSyncManager) {
            try {
              console.log('🔄 Usando sistema de sincronización para organigrama...');
              departamentos = (await window.firebaseSyncManager.getDepartamentos()) || [];
              empleados = (await window.firebaseSyncManager.getEmpleados()) || [];

              console.log('✅ Datos cargados desde Firebase Sync Manager:', {
                departamentos: departamentos.length,
                empleados: empleados.length,
              });
            } catch (syncError) {
              console.warn('⚠️ Error con sistema de sincronización, usando método directo:', syncError);
            }
          }

          // Si no hay datos del sync manager, intentar método directo
          if (departamentos.length === 0 || empleados.length === 0) {
            // Intentar obtener datos de Firebase directamente
            if (firebase && firebase.firestore && firebase.auth().currentUser) {
              try {
                console.log('🔥 Intentando cargar desde Firebase directamente...');
                const db = firebase.firestore();
                const currentUser = firebase.auth().currentUser;

                const departamentosSnapshot = await db
                  .collection('departamentos')
                  .where('userId', '==', currentUser.uid)
                  .get();

                const empleadosSnapshot = await db.collection('empleados').where('userId', '==', currentUser.uid).get();

                departamentos = departamentosSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
                empleados = empleadosSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));

                console.log('✅ Datos cargados desde Firebase directamente:', {
                  departamentos: departamentos.length,
                  empleados: empleados.length,
                });
              } catch (firebaseError) {
                console.warn('⚠️ Error en Firebase, usando localStorage:', firebaseError);
              }
            }

            // Fallback a localStorage si no hay datos de Firebase
            if (departamentos.length === 0 || empleados.length === 0) {
              console.log('💾 Cargando datos desde localStorage...');

              // Cargar departamentos desde localStorage
              const departamentosStorage = localStorage.getItem('axyra_departamentos');
              if (departamentosStorage) {
                try {
                  departamentos = JSON.parse(departamentosStorage);
                  console.log('📁 Departamentos cargados desde localStorage:', departamentos.length);
                } catch (e) {
                  console.warn('⚠️ Error parseando departamentos del localStorage');
                }
              }

              // Cargar empleados desde localStorage
              const empleadosStorage = localStorage.getItem('axyra_empleados');
              if (empleadosStorage) {
                try {
                  empleados = JSON.parse(empleadosStorage);
                  console.log('👥 Empleados cargados desde localStorage:', empleados.length);
                } catch (e) {
                  console.warn('⚠️ Error parseando empleados del localStorage');
                }
              }
            }
          }

          // Si no hay datos, mostrar mensaje
          if (departamentos.length === 0 && empleados.length === 0) {
            mostrarNotificacionTiempoReal('ℹ️ No hay datos para mostrar el organigrama', 'info');
            return;
          }

          // Crear estructura del organigrama
          const estructura = {};

          // Crear estructura del organigrama basada en departamentos
          if (departamentos.length === 0) {
            // Si no hay departamentos, crear uno por defecto
            estructura['Sin Departamento'] = {
              empleados: empleados,
              color: generarColorDepartamento('Sin Departamento'),
            };
          } else {
            // Agrupar empleados por departamento
            departamentos.forEach((dept) => {
              const deptEmpleados = empleados.filter((emp) => {
                // Verificar que el empleado tenga departamento y que sea válido
                if (!emp.departamento || !dept.nombre) return false;

                // Convertir a string y hacer la comparación de forma segura
                const empDept = String(emp.departamento).toLowerCase();
                const deptNombre = String(dept.nombre).toLowerCase();

                return empDept === deptNombre;
              });

              estructura[dept.nombre] = {
                empleados: deptEmpleados,
                color: generarColorDepartamento(dept.nombre),
              };
            });

            // Agregar empleados sin departamento asignado
            const empleadosSinDept = empleados.filter(
              (emp) =>
                !emp.departamento ||
                emp.departamento === '' ||
                emp.departamento === 'Sin Departamento' ||
                emp.departamento === null ||
                emp.departamento === undefined
            );
            if (empleadosSinDept.length > 0) {
              estructura['Sin Departamento'] = {
                empleados: empleadosSinDept,
                color: generarColorDepartamento('Sin Departamento'),
              };
            }
          }

          console.log('🏗️ Estructura del organigrama creada:', estructura);

          const organigramaHTML = `
            <div id="modalOrganigrama" class="axyra-modal">
              <div class="axyra-modal-content" style="max-width: 90%; max-height: 90%;">
                <div class="axyra-modal-header">
                  <h3><i class="fas fa-sitemap"></i> Organigrama de la Empresa</h3>
                  <button class="axyra-modal-close" onclick="cerrarModal('modalOrganigrama')">&times;</button>
                </div>
                <div class="axyra-modal-body">
                  <div class="axyra-organigrama-container">
                    ${generarHTMLOrganigrama(estructura)}
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', organigramaHTML);
          document.getElementById('modalOrganigrama').style.display = 'block';

          console.log('✅ Organigrama cargado exitosamente');
        } catch (error) {
          console.error('❌ Error cargando organigrama:', error);
          mostrarNotificacionTiempoReal('❌ Error cargando organigrama: ' + error.message, 'error');
        }
      }

      // Generar HTML del organigrama
      function generarHTMLOrganigrama(estructura) {
        let html = '<div class="axyra-organigrama">';

        if (Object.keys(estructura).length === 0) {
          html += `
            <div class="axyra-no-data">
              <i class="fas fa-info-circle" style="font-size: 48px; color: #6b7280; margin-bottom: 16px;"></i>
              <h3>No hay datos para mostrar</h3>
              <p>No se encontraron departamentos o empleados para generar el organigrama.</p>
              <button class="axyra-btn axyra-btn-primary" onclick="crearDatosEjemplo()">
                <i class="fas fa-database"></i> Crear Datos de Ejemplo
              </button>
            </div>
          `;
        } else {
          Object.entries(estructura).forEach(([departamento, data]) => {
            html += `
              <div class="axyra-departamento-grupo">
                <div class="axyra-departamento-header" style="background: ${data.color}">
                  <h4>${departamento}</h4>
                  <span class="axyra-empleados-count">${data.empleados.length} empleado${
              data.empleados.length !== 1 ? 's' : ''
            }</span>
                </div>
                <div class="axyra-empleados-grid">
                  ${data.empleados
                    .map(
                      (emp) => `
                    <div class="axyra-empleado-card">
                      <div class="axyra-empleado-avatar">
                        <i class="fas fa-user"></i>
                      </div>
                      <div class="axyra-empleado-info">
                        <strong>${emp.nombre || 'Sin nombre'}</strong>
                        <span>${emp.cargo || 'Sin cargo'}</span>
                        <small>$${(emp.salario || 0).toFixed(2)}</small>
                      </div>
                    </div>
                  `
                    )
                    .join('')}
                </div>
              </div>
            `;
          });
        }

        html += '</div>';
        return html;
      }

      // Generar color único para cada departamento
      function generarColorDepartamento(nombre) {
        // Validar que el nombre sea una cadena válida
        if (!nombre || typeof nombre !== 'string' || nombre.trim() === '') {
          nombre = 'Sin Departamento';
        }

        const colores = [
          '#667eea',
          '#764ba2',
          '#48bb78',
          '#ed8936',
          '#f56565',
          '#4299e1',
          '#805ad5',
          '#38a169',
          '#dd6b20',
          '#e53e3e',
        ];

        const hash = nombre.split('').reduce((a, b) => {
          a = (a << 5) - a + b.charCodeAt(0);
          return a & a;
        }, 0);

        return colores[Math.abs(hash) % colores.length];
      }

      // Sistema de fotos de empleados - Avatares y gestión de imágenes
      async function mostrarModalFotos() {
        try {
          console.log('📸 Iniciando carga de la galería de fotos...');

          let empleados = [];

          // Intentar obtener datos de Firebase primero
          if (firebase && firebase.firestore && firebase.auth().currentUser) {
            try {
              console.log('🔥 Intentando cargar empleados desde Firebase...');
              const db = firebase.firestore();
              const currentUser = firebase.auth().currentUser;

              const empleadosSnapshot = await db.collection('empleados').where('userId', '==', currentUser.uid).get();

              empleados = empleadosSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              console.log('✅ Empleados cargados desde Firebase:', empleados.length);
            } catch (firebaseError) {
              console.warn('⚠️ Error en Firebase, usando localStorage:', firebaseError);
            }
          }

          // Fallback a localStorage si no hay datos de Firebase
          if (empleados.length === 0) {
            console.log('💾 Cargando empleados desde localStorage...');

            const empleadosStorage = localStorage.getItem('axyra_empleados');
            if (empleadosStorage) {
              try {
                empleados = JSON.parse(empleadosStorage);
                console.log('👥 Empleados cargados desde localStorage:', empleados.length);
              } catch (e) {
                console.warn('⚠️ Error parseando empleados del localStorage');
              }
            }
          }

          // Si no hay empleados, mostrar mensaje
          if (empleados.length === 0) {
            mostrarNotificacionTiempoReal('ℹ️ No hay empleados para mostrar en la galería', 'info');
            return;
          }

          console.log('👥 Empleados cargados para la galería:', empleados.length);

          const fotosHTML = `
          <div id="modalFotos" class="axyra-modal">
            <div class="axyra-modal-content" style="max-width: 90%; max-height: 90%;">
              <div class="axyra-modal-header">
                <h3><i class="fas fa-camera"></i> Galería de Fotos de Empleados</h3>
                <button class="axyra-modal-close" onclick="cerrarModal('modalFotos')">&times;</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-fotos-grid">
                  ${empleados
                    .map(
                      (emp) => `
                    <div class="axyra-foto-empleado">
                      <div class="axyra-foto-avatar">
                        <i class="fas fa-user"></i>
                      </div>
                      <div class="axyra-foto-info">
                        <strong>${emp.nombre || 'Sin nombre'}</strong>
                        <span>${emp.cargo || 'Sin cargo'}</span>
                        <small>${emp.departamento || 'Sin departamento'}</small>
                      </div>
                      <button class="axyra-btn axyra-btn-outline" onclick="cambiarFoto('${emp.id}')">
                        <i class="fas fa-camera"></i> Cambiar
                      </button>
                    </div>
                  `
                    )
                    .join('')}
                </div>
              </div>
            </div>
          </div>
        `;

          document.body.insertAdjacentHTML('beforeend', fotosHTML);
          document.getElementById('modalFotos').style.display = 'block';

          console.log('✅ Modal de fotos cargado exitosamente');
        } catch (error) {
          console.error('❌ Error cargando modal de fotos:', error);
          mostrarNotificacionTiempoReal('❌ Error cargando fotos de empleados: ' + error.message, 'error');
        }
      }

      // Función para cambiar foto de empleado
      function cambiarFoto(empleadoId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              // Aquí se procesaría la imagen
              mostrarNotificacionTiempoReal('📸 Foto actualizada correctamente', 'success');
            };
            reader.readAsDataURL(file);
          }
        };
        input.click();
      }

      // Función para cambiar foto de empleado (alias para compatibilidad)
      function cambiarFotoEmpleado(empleadoId) {
        cambiarFoto(empleadoId);
      }

      // Función para crear datos de ejemplo si no hay ninguno
      function crearDatosEjemplo() {
        console.log('🎯 Creando datos de ejemplo...');

        // Crear departamentos de ejemplo
        const departamentosEjemplo = [
          { id: 'dept1', nombre: 'Administración', descripcion: 'Departamento administrativo' },
          { id: 'dept2', nombre: 'Ventas', descripcion: 'Departamento de ventas' },
          { id: 'dept3', nombre: 'Producción', descripcion: 'Departamento de producción' },
          { id: 'dept4', nombre: 'Recursos Humanos', descripcion: 'Departamento de RRHH' },
        ];

        // Crear empleados de ejemplo
        const empleadosEjemplo = [
          {
            id: 'emp1',
            nombre: 'Juan Pérez',
            cedula: '12345678',
            cargo: 'Gerente General',
            departamento: 'Administración',
            salario: 5000000,
            fechaIngreso: '2023-01-15',
            estado: 'Activo',
          },
          {
            id: 'emp2',
            nombre: 'María González',
            cedula: '87654321',
            cargo: 'Vendedora Senior',
            departamento: 'Ventas',
            salario: 2500000,
            fechaIngreso: '2023-03-20',
            estado: 'Activo',
          },
          {
            id: 'emp3',
            nombre: 'Carlos Rodríguez',
            cedula: '11223344',
            cargo: 'Operario',
            departamento: 'Producción',
            salario: 1500000,
            fechaIngreso: '2023-02-10',
            estado: 'Activo',
          },
          {
            id: 'emp4',
            nombre: 'Ana Martínez',
            cedula: '44332211',
            cargo: 'Reclutadora',
            departamento: 'Recursos Humanos',
            salario: 2000000,
            fechaIngreso: '2023-04-05',
            estado: 'Activo',
          },
          {
            id: 'emp5',
            nombre: 'Luis Fernández',
            cedula: '55667788',
            cargo: 'Asistente Administrativo',
            departamento: 'Administración',
            salario: 1800000,
            fechaIngreso: '2023-05-12',
            estado: 'Activo',
          },
        ];

        // Guardar en localStorage
        localStorage.setItem('axyra_departamentos', JSON.stringify(departamentosEjemplo));
        localStorage.setItem('axyra_empleados', JSON.stringify(empleadosEjemplo));

        console.log('✅ Datos de ejemplo creados:', {
          departamentos: departamentosEjemplo.length,
          empleados: empleadosEjemplo.length,
        });

        mostrarNotificacionTiempoReal('✅ Datos de ejemplo creados exitosamente', 'success');

        return { departamentos: departamentosEjemplo, empleados: empleadosEjemplo };
      }

      // Función para mostrar modal de importación masiva
      function mostrarModalImportacion() {
        const importacionHTML = `
          <div id="modalImportacion" class="axyra-modal">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3><i class="fas fa-file-import"></i> Importación Masiva de Empleados</h3>
                <button class="axyra-modal-close" onclick="cerrarModal('modalImportacion')">&times;</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-import-section">
                  <h4>📁 Seleccionar archivo Excel/CSV</h4>
                  <input type="file" id="archivoImportacion" accept=".xlsx,.xls,.csv" class="axyra-file-input">
                  <p class="axyra-help-text">Formatos soportados: Excel (.xlsx, .xls) y CSV</p>
                </div>
                <div class="axyra-import-section">
                  <h4>📋 Vista previa de datos</h4>
                  <div id="vistaPreviaImportacion" class="axyra-vista-previa"></div>
                </div>
                <div class="axyra-import-section">
                  <h4>⚙️ Opciones de importación</h4>
                  <label class="axyra-checkbox">
                    <input type="checkbox" id="sobrescribirExistentes" checked>
                    <span>Sobrescribir empleados existentes</span>
                  </label>
                  <label class="axyra-checkbox">
                    <input type="checkbox" id="validarDatos" checked>
                    <span>Validar datos antes de importar</span>
                  </label>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal('modalImportacion')">Cancelar</button>
                <button class="axyra-btn axyra-btn-primary" onclick="procesarImportacion()">Importar Empleados</button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', importacionHTML);
        document.getElementById('modalImportacion').style.display = 'block';

        // Configurar evento para archivo
        document.getElementById('archivoImportacion').addEventListener('change', procesarArchivoImportacion);
      }

      // Función para mostrar historial de cambios
      function mostrarHistorialCambios() {
        const historialHTML = `
          <div id="modalHistorial" class="axyra-modal">
            <div class="axyra-modal-content" style="max-width: 90%; max-height: 90%;">
              <div class="axyra-modal-header">
                <h3><i class="fas fa-history"></i> Historial de Cambios</h3>
                <button class="axyra-modal-close" onclick="cerrarModal('modalHistorial')">&times;</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-historial-container">
                  <div class="axyra-historial-filtros">
                    <select id="filtroAccion" class="axyra-select">
                      <option value="">Todas las acciones</option>
                      <option value="create">Crear</option>
                      <option value="update">Actualizar</option>
                      <option value="delete">Eliminar</option>
                    </select>
                    <input type="date" id="filtroFecha" class="axyra-input">
                    <button class="axyra-btn axyra-btn-outline" onclick="filtrarHistorial()">Filtrar</button>
                  </div>
                  <div id="listaHistorial" class="axyra-lista-historial"></div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', historialHTML);
        document.getElementById('modalHistorial').style.display = 'block';
        cargarHistorialCambios();
      }

      // Función para gestionar departamentos
      function gestionarDepartamentos() {
        const departamentosHTML = `
          <div id="modalDepartamentos" class="axyra-modal">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3><i class="fas fa-building"></i> Gestión de Departamentos</h3>
                <button class="axyra-modal-close" onclick="cerrarModal('modalDepartamentos')">&times;</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-departamentos-form">
                  <div class="axyra-form-group">
                    <label>Nombre del departamento:</label>
                    <input type="text" id="nombreDepartamento" class="axyra-input" placeholder="Ej: Recursos Humanos">
                  </div>
                  <div class="axyra-form-group">
                    <label>Descripción:</label>
                    <textarea id="descripcionDepartamento" class="axyra-textarea" placeholder="Descripción del departamento"></textarea>
                  </div>
                  <div class="axyra-form-group">
                    <label>Color:</label>
                    <input type="color" id="colorDepartamento" class="axyra-color-input" value="#667eea">
                  </div>
                  <button class="axyra-btn axyra-btn-primary" onclick="agregarDepartamento()">Agregar Departamento</button>
                </div>
                <div class="axyra-departamentos-lista">
                  <h4>Departamentos existentes:</h4>
                  <div id="listaDepartamentos" class="axyra-lista-departamentos"></div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', departamentosHTML);
        document.getElementById('modalDepartamentos').style.display = 'block';
        cargarDepartamentos().catch((error) => {
          console.error('Error cargando departamentos:', error);
        });
      }

      // Función para mostrar modal genérico
      function mostrarModal(tipo, empleadoId = null) {
        let modalHTML = '';

        switch (tipo) {
          case 'agregar':
            modalHTML = `
              <div id="modalEmpleado" class="axyra-modal">
                <div class="axyra-modal-content">
                  <div class="axyra-modal-header">
                    <h3><i class="fas fa-user-plus"></i> Agregar Nuevo Empleado</h3>
                    <button class="axyra-modal-close" onclick="cerrarModal('modalEmpleado')">&times;</button>
                  </div>
                  <div class="axyra-modal-body">
                    <form id="formEmpleado" class="axyra-form">
                      <div class="axyra-form-row">
                        <div class="axyra-form-group">
                          <label>Nombre completo:</label>
                          <input type="text" id="nombre" name="nombre" class="axyra-input" required>
                        </div>
                        <div class="axyra-form-group">
                          <label>Cédula:</label>
                          <input type="text" id="cedula" name="cedula" class="axyra-input" required>
                        </div>
                      </div>
                      <div class="axyra-form-row">
                        <div class="axyra-form-group">
                          <label>Cargo:</label>
                          <input type="text" id="cargo" name="cargo" class="axyra-input" required>
                        </div>
                        <div class="axyra-form-group">
                          <label>Departamento:</label>
                          <select id="departamento" name="departamento" class="axyra-select" required>
                            <option value="">Seleccionar departamento</option>
                          </select>
                        </div>
                      </div>
                      <div class="axyra-form-row">
                        <div class="axyra-form-group">
                          <label>Salario base:</label>
                          <input type="number" id="salario" name="salario" class="axyra-input" required>
                        </div>
                        <div class="axyra-form-group">
                          <label>Tipo de contrato:</label>
                          <select id="tipoContrato" name="tipoContrato" class="axyra-select" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="FIJO">Fijo</option>
                            <option value="POR_HORAS">Por Horas</option>
                          </select>
                        </div>
                      </div>
                    </form>
                  </div>
                  <div class="axyra-modal-footer">
                    <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal('modalEmpleado')">Cancelar</button>
                    <button class="axyra-btn axyra-btn-primary" onclick="guardarEmpleado()">Guardar Empleado</button>
                  </div>
                </div>
              </div>
            `;
            break;
          case 'editar':
            // Modal para editar empleado existente
            modalHTML = `
              <div id="modalEmpleado" class="axyra-modal">
                <div class="axyra-modal-content">
                  <div class="axyra-modal-header">
                    <h3><i class="fas fa-user-edit"></i> Editar Empleado</h3>
                    <button class="axyra-modal-close" onclick="cerrarModal('modalEmpleado')">&times;</button>
                  </div>
                  <div class="axyra-modal-body">
                    <p>Cargando datos del empleado...</p>
                  </div>
                </div>
              </div>
            `;
            break;
        }

        if (modalHTML) {
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          document.getElementById('modalEmpleado').style.display = 'block';

          if (tipo === 'editar' && empleadoId) {
            cargarDatosEmpleado(empleadoId);
          }
        }
      }

      // Ejecutar cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        inicializarNotificacionesTiempoReal();

        // Inicializar header compartido si no se ha hecho
        setTimeout(() => {
          if (typeof AxyraSharedHeader !== 'undefined' && !window.axyraSharedHeaderInstance) {
            try {
              window.axyraSharedHeaderInstance = new AxyraSharedHeader();
              console.log('✅ Header compartido inicializado desde empleados.html');
            } catch (error) {
              console.error('❌ Error inicializando header desde empleados.html:', error);
            }
          }
        }, 500);
      });

      // Sistema de notificaciones en tiempo real
      function inicializarNotificacionesTiempoReal() {
        // Escuchar cambios en localStorage para notificaciones
        window.addEventListener('storage', function (e) {
          if (e.key === 'axyra_empleados') {
            mostrarNotificacionTiempoReal('🔄 Lista de empleados actualizada', 'info');
          }
        });

        // Escuchar eventos personalizados
        window.addEventListener('axyraEmpleadosCambiados', function (e) {
          const { action, empleadoId } = e.detail;
          let mensaje = '';

          switch (action) {
            case 'create':
              mensaje = '✅ Nuevo empleado agregado';
              break;
            case 'update':
              mensaje = '🔄 Empleado actualizado';
              break;
            case 'delete':
              mensaje = '🗑️ Empleado eliminado';
              break;
            default:
              mensaje = '📝 Cambio en empleados';
          }

          mostrarNotificacionTiempoReal(mensaje, 'success');
        });

        console.log('✅ Notificaciones en tiempo real inicializadas');
      }

      // Mostrar notificación en tiempo real
      function mostrarNotificacionTiempoReal(mensaje, tipo = 'info') {
        const notificacion = document.createElement('div');
        notificacion.className = `axyra-notificacion-tiempo-real axyra-notificacion-${tipo}`;
        notificacion.innerHTML = `
          <i class="fas fa-bell"></i>
          <span>${mensaje}</span>
          <button onclick="this.parentElement.remove()" class="axyra-notificacion-cerrar">
            <i class="fas fa-times"></i>
          </button>
        `;

        document.body.appendChild(notificacion);

        // Auto-remover después de 5 segundos
        setTimeout(() => {
          if (notificacion.parentElement) {
            notificacion.remove();
          }
        }, 5000);
      }

      // Sistema de historial de cambios - Auditoría de modificaciones
      function registrarCambio(accion, empleadoId, detalles, usuario = null) {
        const historial = JSON.parse(localStorage.getItem('axyra_historial_empleados') || '[]');
        const cambio = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          accion: accion,
          empleadoId: empleadoId,
          detalles: detalles,
          usuario: usuario || (currentUser ? currentUser.username || currentUser.email : 'Sistema'),
          ip: 'localhost', // En producción se obtendría del servidor
          userAgent: navigator.userAgent,
        };

        historial.unshift(cambio);

        // Mantener solo los últimos 1000 cambios
        if (historial.length > 1000) {
          historial.splice(1000);
        }

        localStorage.setItem('axyra_historial_empleados', JSON.stringify(historial));
        console.log('📝 Cambio registrado en historial:', cambio);
      }

      // Función para mostrar historial de cambios
      function mostrarHistorialCambios() {
        const historial = JSON.parse(localStorage.getItem('axyra_historial_empleados') || '[]');

        let historialHTML = `
          <div class="axyra-modal-header">
            <h3><i class="fas fa-history"></i> Historial de Cambios</h3>
            <button class="axyra-modal-close" onclick="cerrarModal('modalHistorial')">&times;</button>
          </div>
          <div class="axyra-modal-body">
            <div class="axyra-historial-filtros">
              <select id="filtroAccion" onchange="filtrarHistorial()">
                <option value="">Todas las acciones</option>
                <option value="create">Crear</option>
                <option value="update">Actualizar</option>
                <option value="delete">Eliminar</option>
              </select>
              <input type="date" id="filtroFecha" onchange="filtrarHistorial()" />
            </div>
            <div class="axyra-historial-lista">
        `;

        if (historial.length === 0) {
          historialHTML += '<p class="axyra-text-center">No hay cambios registrados</p>';
        } else {
          historial.forEach((cambio) => {
            const fecha = new Date(cambio.timestamp).toLocaleString('es-ES');
            historialHTML += `
              <div class="axyra-historial-item">
                <div class="axyra-historial-header">
                  <span class="axyra-historial-accion axyra-historial-${cambio.accion}">
                    ${cambio.accion.toUpperCase()}
                  </span>
                  <span class="axyra-historial-fecha">${fecha}</span>
                </div>
                <div class="axyra-historial-detalles">
                  <strong>Empleado ID:</strong> ${cambio.empleadoId}<br>
                  <strong>Detalles:</strong> ${cambio.detalles}<br>
                  <strong>Usuario:</strong> ${cambio.usuario}
                </div>
              </div>
            `;
          });
        }

        historialHTML += `
            </div>
          </div>
        `;

        // Crear modal de historial
        const modalHistorial = document.createElement('div');
        modalHistorial.id = 'modalHistorial';
        modalHistorial.className = 'axyra-modal';
        modalHistorial.innerHTML = `
          <div class="axyra-modal-content">
            ${historialHTML}
          </div>
        `;

        document.body.appendChild(modalHistorial);
        modalHistorial.style.display = 'block';
      }

      // Función para filtrar historial
      function filtrarHistorial() {
        const filtroAccion = document.getElementById('filtroAccion').value;
        const filtroFecha = document.getElementById('filtroFecha').value;
        const historial = JSON.parse(localStorage.getItem('axyra_historial_empleados') || '[]');

        let historialFiltrado = historial;

        if (filtroAccion) {
          historialFiltrado = historialFiltrado.filter((c) => c.accion === filtroAccion);
        }

        if (filtroFecha) {
          const fechaFiltro = new Date(filtroFecha);
          historialFiltrado = historialFiltrado.filter((c) => {
            const fechaCambio = new Date(c.timestamp);
            return fechaCambio.toDateString() === fechaFiltro.toDateString();
          });
        }

        // Actualizar vista del historial
        const historialLista = document.querySelector('.axyra-historial-lista');
        if (historialLista) {
          historialLista.innerHTML = historialFiltrado
            .map((cambio) => {
              const fecha = new Date(cambio.timestamp).toLocaleString('es-ES');
              return `
              <div class="axyra-historial-item">
                <div class="axyra-historial-header">
                  <span class="axyra-historial-accion axyra-historial-${cambio.accion}">
                    ${cambio.accion.toUpperCase()}
                  </div>
                  <span class="axyra-historial-fecha">${fecha}</span>
                </div>
                <div class="axyra-historial-detalles">
                  <strong>Empleado ID:</strong> ${cambio.empleadoId}<br>
                  <strong>Detalles:</strong> ${cambio.detalles}<br>
                  <strong>Usuario:</strong> ${cambio.usuario}
                </div>
              </div>
            `;
            })
            .join('');
        }
      }

      // Sistema de importación masiva desde Excel/CSV
      function mostrarModalImportacion() {
        const modalHTML = `
          <div id="modalImportacion" class="axyra-modal">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3><i class="fas fa-upload"></i> Importar Empleados</h3>
                <button class="axyra-modal-close" onclick="cerrarModal('modalImportacion')">&times;</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-importacion-instrucciones">
                  <h4>Instrucciones:</h4>
                  <ul>
                    <li>El archivo debe ser Excel (.xlsx) o CSV</li>
                    <li>Las columnas deben ser: Nombre, Email, Teléfono, Departamento, Cargo, Salario, Estado</li>
                    <li>La primera fila debe contener los nombres de las columnas</li>
                    <li>Los empleados se agregarán automáticamente</li>
                  </ul>
                </div>
                <div class="axyra-importacion-archivo">
                  <input type="file" id="archivoImportacion" accept=".xlsx,.csv" />
                  <button class="axyra-btn axyra-btn-primary" onclick="procesarImportacion()">
                    <i class="fas fa-upload"></i> Procesar Archivo
                  </button>
                </div>
                <div id="resultadoImportacion" class="axyra-importacion-resultado" style="display: none;">
                  <!-- Resultados de la importación -->
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.getElementById('modalImportacion').style.display = 'block';
      }

      // Procesar archivo de importación
      async function procesarImportacion() {
        const archivo = document.getElementById('archivoImportacion').files[0];
        if (!archivo) {
          mostrarMensaje('❌ Por favor selecciona un archivo', 'error');
          return;
        }

        try {
          const data = await leerArchivoExcel(archivo);
          const empleadosImportados = procesarDatosExcel(data);

          if (empleadosImportados.length > 0) {
            // Agregar empleados al sistema
            for (const empleado of empleadosImportados) {
              await agregarEmpleado(empleado);
              registrarCambio('create', empleado.id || 'N/A', `Empleado importado: ${empleado.nombre}`);
            }

            mostrarResultadoImportacion(empleadosImportados.length, empleadosImportados);
            cargarEmpleados(); // Recargar la tabla
          } else {
            mostrarMensaje('❌ No se encontraron datos válidos en el archivo', 'error');
          }
        } catch (error) {
          console.error('❌ Error procesando importación:', error);
          mostrarMensaje('Error procesando archivo: ' + error.message, 'error');
        }
      }

      // Leer archivo Excel
      async function leerArchivoExcel(archivo) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
              resolve(jsonData);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(archivo);
        });
      }

      // Procesar datos del Excel
      function procesarDatosExcel(data) {
        if (data.length < 2) return [];

        const headers = data[0];
        const empleados = [];

        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row.length >= 7) {
            const empleado = {
              nombre: row[0] || '',
              email: row[1] || '',
              telefono: row[2] || '',
              departamento: row[3] || 'General',
              cargo: row[4] || 'Empleado',
              salario: parseFloat(row[5]) || 0,
              estado: row[6] || 'Activo',
              fechaIngreso: new Date().toISOString(),
              createdAt: new Date().toISOString(),
            };

            if (empleado.nombre && empleado.email) {
              empleados.push(empleado);
            }
          }
        }

        return empleados;
      }

      // Mostrar resultado de la importación
      function mostrarResultadoImportacion(cantidad, empleados) {
        const resultadoDiv = document.getElementById('resultadoImportacion');
        resultadoDiv.style.display = 'block';
        resultadoDiv.innerHTML = `
          <div class="axyra-importacion-exito">
            <h4>✅ Importación Exitosa</h4>
            <p>Se importaron ${cantidad} empleados correctamente</p>
            <div class="axyra-importacion-lista">
              <h5>Empleados importados:</h5>
              <ul>
                ${empleados.map((emp) => `<li>${emp.nombre} - ${emp.cargo}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }

      // Verificar autenticación
      async function checkAuth() {
        try {
          console.log('🔐 Verificando autenticación...');

          // Verificar sesión usando localStorage
          const user = localStorage.getItem('axyra_isolated_user');
          if (user) {
            try {
              const userData = JSON.parse(user);
              if (userData && (userData.username || userData.email)) {
                console.log('✅ Usuario autenticado con localStorage:', userData.username || userData.email);
                return true;
              }
            } catch (error) {
              console.error('Error parseando sesión de localStorage:', error);
            }
          }

          // No hay sesión activa
          console.log('⚠️ No hay sesión activa - redirigiendo al login');
          window.location.href = '../../login.html';
          return false;
        } catch (error) {
          console.error('❌ Error al verificar sesión:', error);
          window.location.href = '../../login.html';
          return false;
        }
      }

      // Cerrar sesión - SISTEMA AISLADO
      function logout() {
        console.log('🔄 Cerrando sesión desde gestión de empleados...');

        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }

        console.log('✅ Sesión cerrada desde gestión de empleados');
        window.location.href = '../../login.html';
      }

      // Cargar empleados desde Firebase
      async function cargarEmpleados() {
        try {
          console.log('👥 Cargando empleados...');

          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.log('⚠️ No hay usuario autenticado');
            empleados = [];
            mostrarEmpleados();
            return;
          }

          // Usar el sistema de sincronización si está disponible
          if (window.firebaseSyncManager) {
            try {
              console.log('🔄 Usando sistema de sincronización Firebase ↔ localStorage...');
              empleados = await window.firebaseSyncManager.getEmpleados();

              // Filtrar solo empleados del usuario actual
              empleados = empleados.filter(
                (emp) =>
                  emp.userId === currentUser.username ||
                  emp.userId === currentUser.email ||
                  emp.userId === currentUser.id
              );

              console.log(`✅ ${empleados.length} empleados sincronizados`);

              // Actualizar la interfaz
              mostrarEmpleados();
              return empleados;
            } catch (syncError) {
              console.warn('⚠️ Error con sistema de sincronización, usando método directo:', syncError);
            }
          }

          // Método directo - intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('🔥 Cargando empleados desde Firebase...');
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              if (!empleadosSnapshot.empty) {
                empleados = [];
                empleadosSnapshot.forEach((doc) => {
                  empleados.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`✅ Empleados cargados desde Firebase: ${empleados.length}`);

                // Sincronizar con localStorage
                localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
              } else {
                console.log('ℹ️ No hay empleados en Firebase para este usuario');
                empleados = [];
                // Limpiar localStorage también
                localStorage.removeItem('axyra_empleados');
              }
            } catch (firebaseError) {
              console.warn('⚠️ Error cargando desde Firebase, usando localStorage como fallback:', firebaseError);
              // Solo usar localStorage como fallback si Firebase falla
              const empleadosGuardados = localStorage.getItem('axyra_empleados');
              if (empleadosGuardados) {
                try {
                  const empleadosLocal = JSON.parse(empleadosGuardados);
                  // Filtrar solo empleados del usuario actual
                  empleados = empleadosLocal.filter(
                    (emp) =>
                      emp.userId === currentUser.username ||
                      emp.userId === currentUser.email ||
                      emp.userId === currentUser.id
                  );
                  console.log(`✅ Empleados cargados desde localStorage (filtrados): ${empleados.length}`);
                } catch (error) {
                  console.error('Error parseando empleados de localStorage:', error);
                  empleados = [];
                  localStorage.removeItem('axyra_empleados');
                }
              } else {
                empleados = [];
                console.log('ℹ️ No hay empleados registrados. El usuario debe crear empleados reales.');
              }
            }
          } else {
            console.log('ℹ️ Firebase no disponible, usando localStorage');
            const empleadosGuardados = localStorage.getItem('axyra_empleados');
            if (empleadosGuardados) {
              try {
                const empleadosLocal = JSON.parse(empleadosGuardados);
                // Filtrar solo empleados del usuario actual
                empleados = empleadosLocal.filter(
                  (emp) =>
                    emp.userId === currentUser.username ||
                    emp.userId === currentUser.email ||
                    emp.userId === currentUser.id
                );
                console.log(`✅ Empleados cargados desde localStorage (filtrados): ${empleados.length}`);
              } catch (error) {
                console.error('Error parseando empleados de localStorage:', error);
                empleados = [];
                localStorage.removeItem('axyra_empleados');
              }
            } else {
              empleados = [];
              console.log('ℹ️ No hay empleados registrados. El usuario debe crear empleados reales.');
            }
          }

          // Verificar que no haya empleados duplicados o inconsistentes
          const empleadosUnicos = [];
          const idsVistos = new Set();

          for (const empleado of empleados) {
            if (empleado.id && !idsVistos.has(empleado.id)) {
              idsVistos.add(empleado.id);
              empleadosUnicos.push(empleado);
            }
          }

          if (empleadosUnicos.length !== empleados.length) {
            console.log(
              `⚠️ Se encontraron empleados duplicados. Limpiando de ${empleados.length} a ${empleadosUnicos.length}`
            );
            empleados = empleadosUnicos;
            // Guardar la versión limpia
            if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
              localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
            }
          }

          mostrarEmpleados();

          // Cargar departamentos para poblar los selects
          try {
            await cargarDepartamentos();
          } catch (deptError) {
            console.warn('⚠️ Error cargando departamentos:', deptError);
          }
        } catch (error) {
          console.error('❌ Error cargando empleados:', error);
          empleados = [];
          mostrarEmpleados();
        }
      }

      // Guardar empleados en Firebase y localStorage
      async function guardarEmpleados() {
        try {
          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.log('⚠️ No hay usuario autenticado');
            return;
          }

          // Intentar guardar en Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('🔥 Guardando empleados en Firebase...');

              // Obtener todos los empleados actuales del usuario en Firebase
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              // Crear un mapa de IDs existentes en Firebase
              const empleadosExistentes = new Map();
              empleadosSnapshot.forEach((doc) => {
                empleadosExistentes.set(doc.id, doc.data());
              });

              // Procesar cada empleado local
              for (const empleado of empleados) {
                if (empleado.id && typeof empleado.id === 'string' && empleado.id.length > 10) {
                  // Es un ID de Firebase, actualizar
                  if (empleadosExistentes.has(empleado.id)) {
                    await firebase
                      .firestore()
                      .collection('empleados')
                      .doc(empleado.id)
                      .update({
                        ...empleado,
                        updatedAt: new Date().toISOString(),
                      });
                  }
                } else {
                  // Es un nuevo empleado, crear
                  const docRef = await firebase
                    .firestore()
                    .collection('empleados')
                    .add({
                      ...empleado,
                      userId: currentUser.id,
                      createdAt: new Date().toISOString(),
                      updatedAt: new Date().toISOString(),
                    });
                  // Actualizar el ID local con el ID de Firebase
                  empleado.id = docRef.id;
                }
              }

              // Eliminar empleados que ya no están en la lista local
              for (const [firebaseId, empleadoFirebase] of empleadosExistentes) {
                const empleadoLocal = empleados.find((e) => e.id === firebaseId);
                if (!empleadoLocal) {
                  console.log('🗑️ Eliminando empleado obsoleto de Firebase:', firebaseId);
                  await firebase.firestore().collection('empleados').doc(firebaseId).delete();
                }
              }

              console.log('✅ Empleados sincronizados con Firebase');
            } catch (firebaseError) {
              console.warn('⚠️ Error guardando en Firebase, usando localStorage:', firebaseError);
            }
          }

          // Guardar en localStorage como respaldo
          console.log('💾 Guardando empleados en localStorage...');
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          console.log('✅ Empleados guardados en localStorage');

          // Notificar a otros módulos sobre el cambio de datos
          notificarCambioEmpleados();
        } catch (error) {
          console.error('❌ Error guardando empleados:', error);
        }
      }

      // Mostrar empleados en la tabla
      function mostrarEmpleados() {
        const tbody = document.getElementById('empleadosTableBody');
        const inicio = (paginaActual - 1) * empleadosPorPagina;
        const fin = inicio + empleadosPorPagina;
        const empleadosPaginados = empleados.slice(inicio, fin);

        tbody.innerHTML = '';

        if (empleados.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="axyra-text-center">
                <div style="padding: 40px; text-align: center; color: #64748b;">
                  <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                  <p>No hay empleados registrados</p>
                  <p>Haz clic en "Agregar Empleado" para comenzar</p>
                </div>
              </td>
            </tr>
          `;
        } else {
          empleadosPaginados.forEach((empleado) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td>${empleado.id}</td>
                    <td>
                        <div class="axyra-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </td>
                    <td>${empleado.nombre}</td>
                    <td>${empleado.departamento}</td>
                    <td>${empleado.cargo}</td>
              <td>$${(empleado.salario || 0).toFixed(2)}</td>
                    <td>
                <span class="axyra-status axyra-status-${empleado.estado.toLowerCase()}">
                            ${empleado.estado}
                        </span>
                    </td>
                    <td>
                <div class="axyra-action-buttons">
                  <button class="axyra-btn-action axyra-btn-edit" onclick="editarEmpleado(${
                    empleado.id
                  })" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                  <button class="axyra-btn-action axyra-btn-view" onclick="verEmpleado(${
                    empleado.id
                  })" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                  <button class="axyra-btn-action axyra-btn-delete" onclick="eliminarEmpleado(${
                    empleado.id
                  })" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            tbody.appendChild(tr);
          });
        }

        actualizarPaginacion();
      }

      // Actualizar información de paginación
      function actualizarPaginacion() {
        const totalPaginas = Math.ceil(empleados.length / empleadosPorPagina);
        document.getElementById('paginaInfo').textContent = `Página ${paginaActual} de ${totalPaginas}`;
      }

      // Cambiar página
      function cambiarPagina(direccion) {
        const totalPaginas = Math.ceil(empleados.length / empleadosPorPagina);
        const nuevaPagina = paginaActual + direccion;

        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
          paginaActual = nuevaPagina;
          mostrarEmpleados();
        }
      }

      // Mostrar modal
      function mostrarModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
      }

      // Cerrar modal
      function cerrarModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        if (modalId === 'modalAgregarEmpleado') {
          resetearFormulario();
        }
      }

      // Resetear formulario
      function resetearFormulario() {
        document.getElementById('formEmpleado').reset();
        document.getElementById('empleadoId').value = '';
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Agregar Empleado';
        empleadoEditando = null;
      }

      // Agregar empleado
      function agregarEmpleado(empleado) {
        empleado.id = empleados.length > 0 ? Math.max(...empleados.map((e) => e.id)) + 1 : 1;
        empleado.createdAt = new Date().toISOString();
        empleados.push(empleado);

        console.log('✅ Empleado agregado:', empleado);

        // Registrar cambio en historial
        registrarCambio('create', empleado.id, `Empleado agregado: ${empleado.nombre}`);

        guardarEmpleados();
        mostrarEmpleados();
        mostrarMensaje('✅ Empleado agregado correctamente', 'success');
      }

      // Editar empleado
      function editarEmpleado(id) {
        try {
          const empleado = empleados.find((emp) => emp.id === id);
          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          // Llenar el formulario con los datos del empleado
          document.getElementById('editNombre').value = empleado.nombre || '';
          document.getElementById('editCedula').value = empleado.cedula || '';
          document.getElementById('editTelefono').value = empleado.telefono || '';
          document.getElementById('editEmail').value = empleado.email || '';
          document.getElementById('editDireccion').value = empleado.direccion || '';
          document.getElementById('editSalario').value = empleado.salario || '';
          document.getElementById('editTipoContrato').value = empleado.tipoContrato || 'por horas';
          document.getElementById('editFechaContratacion').value = empleado.fechaContratacion || '';

          // Guardar el ID del empleado a editar
          window.empleadoAEditar = id;

          // Mostrar el modal
          document.getElementById('modalEditarEmpleado').style.display = 'flex';
        } catch (error) {
          console.error('❌ Error preparando edición:', error);
          mostrarMensaje('Error al preparar edición: ' + error.message, 'error');
        }
      }

      // Actualizar empleado
      function actualizarEmpleado(empleado) {
        const index = empleados.findIndex((e) => e.id === empleado.id);
        if (index !== -1) {
          empleados[index] = { ...empleados[index], ...empleado };
          guardarEmpleados();
          mostrarEmpleados();
          mostrarMensaje('✅ Empleado actualizado correctamente', 'success');
        }
      }

      // Función para eliminar empleado
      async function eliminarEmpleado(id) {
        try {
          // Buscar el empleado para mostrar su nombre en el modal
          const empleado = empleados.find((emp) => emp.id === id);
          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          // Mostrar el modal de confirmación
          document.getElementById('nombreEmpleadoEliminar').textContent = empleado.nombre;
          document.getElementById('modalEliminarEmpleado').style.display = 'flex';

          // Guardar el ID del empleado a eliminar
          window.empleadoAEliminar = id;
        } catch (error) {
          console.error('❌ Error preparando eliminación:', error);
          mostrarMensaje('Error al preparar eliminación: ' + error.message, 'error');
        }
      }

      // Función para confirmar eliminación (llamada desde el modal)
      async function confirmarEliminacionEmpleado() {
        try {
          const id = window.empleadoAEliminar;
          if (!id) {
            mostrarMensaje('❌ ID de empleado no válido', 'error');
            return;
          }

          // Cerrar el modal
          cerrarModalEliminar();

          // Mostrar notificación de eliminación
          mostrarMensaje('🗑️ Eliminando empleado...', 'info');

          // Eliminar de Firebase si está disponible
          try {
            if (typeof firebase !== 'undefined' && firebase.firestore) {
              const db = firebase.firestore();

              // Obtener usuario actual
              const currentUser = localStorage.getItem('axyra_isolated_user');
              let userId = 'admin';
              if (currentUser) {
                try {
                  const userData = JSON.parse(currentUser);
                  userId = userData.username || userData.email || 'admin';
                } catch (e) {
                  console.warn('No se pudo parsear usuario actual');
                }
              }

              // Buscar y eliminar el empleado de Firebase
              const empleadosRef = db.collection('empleados');
              const query = empleadosRef.where('id', '==', id);
              const snapshot = await query.get();

              if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                  batch.delete(doc.ref);
                });
                await batch.commit();
                console.log('✅ Empleado eliminado de Firebase');
              }
            }
          } catch (firebaseError) {
            console.warn('⚠️ Error eliminando de Firebase:', firebaseError);
          }

          // Eliminar del localStorage y limpiar datos relacionados
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const empleadosFiltrados = empleados.filter((emp) => emp.id !== id);
          localStorage.setItem('axyra_empleados', JSON.stringify(empleadosFiltrados));

          // Eliminar horas asociadas al empleado
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const horasFiltradas = horas.filter((h) => h.empleadoId !== id);
          localStorage.setItem('axyra_horas', JSON.stringify(horasFiltradas));

          // Eliminar nóminas asociadas al empleado
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const nominasFiltradas = nominas.filter((n) => n.empleado_id !== id);
          localStorage.setItem('axyra_nominas', JSON.stringify(nominasFiltradas));

          // Limpiar datos del sistema de sincronización si está disponible
          if (window.firebaseSyncManager) {
            try {
              // Limpiar datos pendientes de sincronización para este empleado
              const pendingSync = JSON.parse(localStorage.getItem('axyra_pending_sync') || '[]');
              const pendingSyncFiltrado = pendingSync.filter(
                (item) => !(item.collection === 'empleados' && item.data.id === id)
              );
              localStorage.setItem('axyra_pending_sync', JSON.stringify(pendingSyncFiltrado));
            } catch (error) {
              console.warn('⚠️ Error limpiando datos de sincronización:', error);
            }
          }

          // Actualizar la tabla
          await cargarEmpleados();

          // Registrar cambio en historial
          const empleadoEliminado = empleados.find((emp) => emp.id === id);
          if (empleadoEliminado) {
            registrarCambio('delete', id, `Empleado eliminado: ${empleadoEliminado.nombre}`);
          }

          // Disparar evento de cambio para actualizar dashboard
          const event = new CustomEvent('axyraEmpleadosCambiados', {
            detail: {
              action: 'delete',
              empleadoId: id,
              userId: 'axyra',
            },
          });
          window.dispatchEvent(event);

          // Notificar cambio vía localStorage para compatibilidad
          localStorage.setItem(
            'axyra_last_employee_change',
            JSON.stringify({
              action: 'delete',
              empleadoId: id,
              userId: 'axyra',
              timestamp: Date.now(),
            })
          );

          mostrarMensaje('✅ Empleado eliminado correctamente', 'success');

          // Forzar recarga del dashboard después de 1 segundo
          setTimeout(() => {
            if (window.location.pathname.includes('dashboard')) {
              window.location.reload();
            }
          }, 1000);
        } catch (error) {
          console.error('❌ Error eliminando empleado:', error);
          mostrarMensaje('Error al eliminar empleado: ' + error.message, 'error');
        }
      }

      // Funciones para cerrar modales
      function cerrarModalEliminar() {
        document.getElementById('modalEliminarEmpleado').style.display = 'none';
        window.empleadoAEliminar = null;
      }

      function cerrarModalEditar() {
        document.getElementById('modalEditarEmpleado').style.display = 'none';
      }

      function cerrarModalVista() {
        document.getElementById('modalVistaEmpleado').style.display = 'none';
      }

      // Ver empleado
      function verEmpleado(id) {
        try {
          const empleado = empleados.find((emp) => emp.id === id);
          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          // Llenar el modal con la información del empleado
          document.getElementById('vistaNombre').textContent = empleado.nombre || 'N/A';
          document.getElementById('vistaCedula').textContent = empleado.cedula || 'N/A';
          document.getElementById('vistaTelefono').textContent = empleado.telefono || 'N/A';
          document.getElementById('vistaEmail').textContent = empleado.email || 'N/A';
          document.getElementById('vistaDireccion').textContent = empleado.direccion || 'N/A';
          document.getElementById('vistaSalario').textContent = empleado.salario
            ? `$${Number(empleado.salario).toLocaleString()}`
            : 'N/A';
          document.getElementById('vistaTipoContrato').textContent = empleado.tipoContrato || 'N/A';
          document.getElementById('vistaFechaContratacion').textContent = empleado.fechaContratacion
            ? new Date(empleado.fechaContratacion).toLocaleDateString('es-ES')
            : 'N/A';

          // Mostrar el modal
          document.getElementById('modalVistaEmpleado').style.display = 'flex';
        } catch (error) {
          console.error('❌ Error mostrando empleado:', error);
          mostrarMensaje('Error al mostrar empleado: ' + error.message, 'error');
        }
      }

      // Cerrar modal de detalles
      function cerrarModalDetalles() {
        const modal = document.getElementById('modalDetallesEmpleado');
        if (modal) {
          modal.remove();
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;

        // Agregar al body
        document.body.appendChild(mensajeDiv);

        // Auto-remover después de 5 segundos
        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }

      // Función para exportar empleados a Excel con estilos profesionales
      async function exportarEmpleados() {
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          if (empleados.length === 0) {
            mostrarMensaje('No hay empleados para exportar', 'warning');
            return;
          }

          // Crear libro de Excel
          const workbook = XLSX.utils.book_new();

          // Crear hoja de trabajo con los datos
          const datosExcel = [
            ['VILLA VENECIA - LISTADO DE EMPLEADOS'],
            [`Fecha de Exportación: ${new Date().toLocaleDateString()}`],
            [''], // Línea en blanco
            [
              'ID',
              'Nombre Completo',
              'Cargo',
              'Departamento',
              'Salario Base',
              'Tipo de Salario',
              'Fecha de Contratación',
              'Estado',
              'Teléfono',
              'Email',
              'Dirección',
            ],
          ];

          empleados.forEach((empleado) => {
            datosExcel.push([
              empleado.id || 'N/A',
              empleado.nombre || 'N/A',
              empleado.cargo || 'N/A',
              empleado.departamento || 'N/A',
              empleado.salario || 0,
              empleado.tipoContrato || 'FIJO',
              empleado.fechaContratacion || 'N/A',
              empleado.estado || 'ACTIVO',
              empleado.telefono || 'N/A',
              empleado.email || 'N/A',
              empleado.direccion || 'N/A',
            ]);
          });

          // Agregar línea en blanco y totales
          datosExcel.push(['']);
          const totalSalarios = empleados.reduce((sum, emp) => sum + (parseFloat(emp.salario) || 0), 0);
          datosExcel.push(['TOTALES', '', '', '', totalSalarios, '', '', '', '', '', '']);

          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 8 }, // ID
            { width: 30 }, // Nombre Completo
            { width: 20 }, // Cargo
            { width: 20 }, // Departamento
            { width: 18 }, // Salario Base
            { width: 18 }, // Tipo de Salario
            { width: 20 }, // Fecha de Contratación
            { width: 15 }, // Estado
            { width: 18 }, // Teléfono
            { width: 30 }, // Email
            { width: 40 }, // Dirección
          ];

          // Aplicar estilos a las celdas
          const range = XLSX.utils.decode_range(worksheet['!ref']);

          for (let R = range.s.r; R <= range.e.r; R++) {
            for (let C = range.s.c; C <= range.e.c; C++) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!worksheet[cellAddress]) continue;

              // Estilo para título principal (primera fila)
              if (R === 0) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: '4F81BD' } }, // Azul profesional
                  font: {
                    color: { rgb: 'FFFFFF' },
                    bold: true,
                    sz: 16,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                };
              }
              // Estilo para fecha (segunda fila)
              else if (R === 1) {
                worksheet[cellAddress].s = {
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                };
              }
              // Estilo para encabezados de tabla (fila 3)
              else if (R === 3) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'D9E1F2' } }, // Azul claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 11,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: '000000' } },
                    bottom: { style: 'thin', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para fila de totales (última fila)
              else if (R === range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'C6EFCE' } }, // Verde claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'medium', color: { rgb: '000000' } },
                    bottom: { style: 'medium', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para datos (filas intermedias)
              else if (R > 3 && R < range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: R % 2 === 0 ? 'FFFFFF' : 'F8F9FA' } }, // Filas alternadas
                  font: {
                    color: { rgb: '000000' },
                    sz: 10,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    bottom: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    left: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    right: { style: 'thin', color: { rgb: 'D0D0D0' } },
                  },
                };

                // Formato especial para columna de salario
                if (C === 4) {
                  // Columna de salario
                  worksheet[cellAddress].s.numberFormat = '"$"#,##0.00';
                }
              }
            }
          }

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Empleados');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `Empleados_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);

          console.log('✅ Empleados exportados correctamente:', nombreArchivo);
          mostrarMensaje('✅ Empleados exportados a Excel con formato profesional', 'success');
        } catch (error) {
          console.error('❌ Error exportando empleados:', error);
          mostrarMensaje('Error al exportar: ' + error.message, 'error');
        }
      }

      // Gestionar departamentos
      function gestionarDepartamentos() {
        const modalHTML = `
          <div id="modalDepartamentos" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-building"></i> Gestión de Departamentos
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalDepartamentos()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-departments-container">
                  <div class="axyra-departments-list" id="listaDepartamentos">
                    <!-- Los departamentos se cargarán dinámicamente -->
                  </div>
                  <div class="axyra-department-form">
                    <h4>Agregar Nuevo Departamento</h4>
                    <div class="axyra-form-row">
                      <div class="axyra-form-group">
                        <label for="nuevoDepartamento" class="axyra-form-label">Nombre del Departamento</label>
                        <input type="text" id="nuevoDepartamento" class="axyra-form-input" placeholder="Ej: Marketing" />
                      </div>
                      <div class="axyra-form-group">
                        <button class="axyra-btn axyra-btn-primary" onclick="agregarDepartamento()">
                          <i class="fas fa-plus"></i> Agregar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        cargarDepartamentos().catch((error) => {
          console.error('Error cargando departamentos:', error);
        });
      }

      // Cerrar modal de departamentos
      function cerrarModalDepartamentos() {
        const modal = document.getElementById('modalDepartamentos');
        if (modal) {
          modal.remove();
        }
      }

      // Cargar departamentos
      async function cargarDepartamentos() {
        const listaDepartamentos = document.getElementById('listaDepartamentos');
        try {
          const departamentos = await obtenerDepartamentos();

          let departamentosHTML = '';

          for (let index = 0; index < departamentos.length; index++) {
            const depto = departamentos[index];
            const nombre = typeof depto === 'string' ? depto : depto.nombre;
            const descripcion = depto.descripcion || '';
            const color = depto.color || '#667eea';
            const empleadosCount = await contarEmpleadosPorDepartamento(nombre);

            departamentosHTML += `
            <div class="axyra-department-item">
              <div class="axyra-department-info">
                  <span class="axyra-department-name" style="color: ${color}">${nombre}</span>
                  ${descripcion ? `<small class="axyra-department-descripcion">${descripcion}</small>` : ''}
                  <span class="axyra-department-count">${empleadosCount} empleados</span>
              </div>
              <div class="axyra-department-actions">
                <button class="axyra-btn axyra-btn-sm axyra-btn-warning" onclick="editarDepartamento(${index})" title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="axyra-btn axyra-btn-sm axyra-btn-error" onclick="eliminarDepartamento(${index})" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
          }

          if (departamentosHTML === '') {
            departamentosHTML = '<p class="axyra-text-center">No hay departamentos configurados</p>';
          }

          listaDepartamentos.innerHTML = departamentosHTML;

          // Actualizar también los selects de departamentos en los formularios
          actualizarSelectsDepartamentos(departamentos);
        } catch (error) {
          console.error('Error cargando departamentos:', error);
          listaDepartamentos.innerHTML = '<p class="axyra-text-center">Error cargando departamentos</p>';
        }
      }

      // Obtener departamentos
      async function obtenerDepartamentos() {
        try {
          // Intentar obtener desde Firebase primero
          if (window.firebaseSyncManager) {
            const departamentos = await window.firebaseSyncManager.getDepartamentos();
            if (departamentos && departamentos.length > 0) {
              return departamentos;
            }
          }

          // Fallback a localStorage
          const departamentosGuardados = localStorage.getItem('axyra_departamentos');
          if (departamentosGuardados) {
            return JSON.parse(departamentosGuardados);
          }

          // Departamentos por defecto con estructura completa
          const departamentosDefault = [
            {
              nombre: 'Administración',
              descripcion: 'Departamento de administración y gestión',
              color: '#667eea',
              fechaCreacion: new Date().toISOString(),
              usuarioId: obtenerUsuarioActual(),
            },
            {
              nombre: 'Ventas',
              descripcion: 'Departamento de ventas y comercialización',
              color: '#10b981',
              fechaCreacion: new Date().toISOString(),
              usuarioId: obtenerUsuarioActual(),
            },
            {
              nombre: 'Producción',
              descripcion: 'Departamento de producción y operaciones',
              color: '#f59e0b',
              fechaCreacion: new Date().toISOString(),
              usuarioId: obtenerUsuarioActual(),
            },
            {
              nombre: 'Recursos Humanos',
              descripcion: 'Departamento de recursos humanos',
              color: '#ef4444',
              fechaCreacion: new Date().toISOString(),
              usuarioId: obtenerUsuarioActual(),
            },
            {
              nombre: 'Tecnología',
              descripcion: 'Departamento de tecnología e informática',
              color: '#8b5cf6',
              fechaCreacion: new Date().toISOString(),
              usuarioId: obtenerUsuarioActual(),
            },
          ];

          // Guardar departamentos por defecto en Firebase si está disponible
          if (window.firebaseSyncManager) {
            for (const depto of departamentosDefault) {
              try {
                await window.firebaseSyncManager.addDepartamento(depto);
              } catch (error) {
                console.warn('Error guardando departamento por defecto:', error);
              }
            }
          }

          return departamentosDefault;
        } catch (error) {
          console.error('Error obteniendo departamentos:', error);
          // Fallback a localStorage
          const departamentosGuardados = localStorage.getItem('axyra_departamentos');
          if (departamentosGuardados) {
            return JSON.parse(departamentosGuardados);
          }
          return ['Administración', 'Ventas', 'Producción', 'Recursos Humanos', 'Tecnología'];
        }
      }

      // Contar empleados por departamento
      async function contarEmpleadosPorDepartamento(departamento) {
        try {
          // Obtener empleados desde Firebase si está disponible
          let empleadosActuales = [];
          if (window.firebaseSyncManager) {
            empleadosActuales = (await window.firebaseSyncManager.getEmpleados()) || [];
          } else {
            empleadosActuales = empleados || [];
          }

          return empleadosActuales.filter((emp) => emp.departamento === departamento).length;
        } catch (error) {
          console.error('Error contando empleados por departamento:', error);
          return 0;
        }
      }

      // Actualizar selects de departamentos en formularios
      function actualizarSelectsDepartamentos(departamentos) {
        // Actualizar select del formulario principal
        const selectDepartamento = document.getElementById('departamento');
        if (selectDepartamento) {
          selectDepartamento.innerHTML = '<option value="">Seleccionar departamento</option>';
          departamentos.forEach((depto) => {
            const option = document.createElement('option');
            const nombre = typeof depto === 'string' ? depto : depto.nombre;
            option.value = nombre;
            option.textContent = nombre;
            selectDepartamento.appendChild(option);
          });
        }

        // Actualizar select del filtro
        const selectFiltroDepartamento = document.getElementById('filterDepartamento');
        if (selectFiltroDepartamento) {
          selectFiltroDepartamento.innerHTML = '<option value="">Todos los departamentos</option>';
          departamentos.forEach((depto) => {
            const option = document.createElement('option');
            option.value = depto;
            option.textContent = depto;
            selectFiltroDepartamento.appendChild(option);
          });
        }
      }

      // Agregar departamento
      async function agregarDepartamento() {
        const nombre = document.getElementById('nuevoDepartamento').value.trim();
        if (!nombre) {
          mostrarMensaje('❌ El nombre del departamento no puede estar vacío', 'error');
          return;
        }

        try {
          // Crear objeto departamento completo
          const departamento = {
            nombre: nombre,
            descripcion: '',
            color: '#667eea',
            fechaCreacion: new Date().toISOString(),
            usuarioId: obtenerUsuarioActual(),
          };

          // Intentar agregar a Firebase primero usando el sync manager
          if (window.firebaseSyncManager) {
            await window.firebaseSyncManager.addDepartamento(departamento);
            mostrarMensaje('✅ Departamento agregado exitosamente y sincronizado con Firebase', 'success');
          } else {
            // Fallback a localStorage
            const departamentos = await obtenerDepartamentos();
            if (departamentos.some((d) => d.nombre === nombre)) {
              mostrarMensaje('❌ El departamento ya existe', 'error');
              return;
            }

            departamentos.push(departamento);
            localStorage.setItem('axyra_departamentos', JSON.stringify(departamentos));
            mostrarMensaje('✅ Departamento agregado exitosamente (modo offline)', 'success');
          }

          document.getElementById('nuevoDepartamento').value = '';
          await cargarDepartamentos();

          // Actualizar selects de departamentos en el formulario
          const departamentosActualizados = await obtenerDepartamentos();
          actualizarSelectsDepartamentos(departamentosActualizados);
        } catch (error) {
          console.error('Error agregando departamento:', error);
          mostrarMensaje('❌ Error al agregar departamento: ' + error.message, 'error');
        }
      }

      // Editar departamento
      function editarDepartamento(index) {
        const departamentos = obtenerDepartamentos();
        const nombreActual = departamentos[index];

        // Crear modal para editar departamento
        const modalHTML = `
          <div id="modalEditarDepartamento" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-edit"></i> Editar Departamento
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalEditarDepartamento()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-form-group">
                  <label for="nuevoNombreDepartamento" class="axyra-form-label">Nuevo nombre del departamento:</label>
                  <input type="text" id="nuevoNombreDepartamento" class="axyra-form-input" value="${nombreActual}" />
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalEditarDepartamento()">
                  Cancelar
                </button>
                <button class="axyra-btn axyra-btn-warning" onclick="confirmarEditarDepartamento(${index})">
                  <i class="fas fa-save"></i> Guardar Cambios
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Cerrar modal editar departamento
      function cerrarModalEditarDepartamento() {
        const modal = document.getElementById('modalEditarDepartamento');
        if (modal) {
          modal.remove();
        }
      }

      // Confirmar editar departamento
      async function confirmarEditarDepartamento(index) {
        try {
          const departamentos = await obtenerDepartamentos();
          const departamentoActual = departamentos[index];
          const nuevoNombre = document.getElementById('nuevoNombreDepartamento').value.trim();

          if (!nuevoNombre) {
            mostrarMensaje('❌ El nombre del departamento no puede estar vacío', 'error');
            return;
          }

          if (nuevoNombre === departamentoActual.nombre) {
            cerrarModalEditarDepartamento();
            return;
          }

          // Verificar si el nuevo nombre ya existe
          if (departamentos.some((d) => d.nombre === nuevoNombre && d !== departamentoActual)) {
            mostrarMensaje('❌ Ya existe un departamento con ese nombre', 'error');
            return;
          }

          // Actualizar empleados que usan este departamento
          const empleados = (await window.firebaseSyncManager.getEmpleados()) || [];
          empleados.forEach((emp) => {
            if (emp.departamento === departamentoActual.nombre) {
              emp.departamento = nuevoNombre;
            }
          });

          // Guardar empleados actualizados
          if (window.firebaseSyncManager) {
            for (const emp of empleados) {
              await window.firebaseSyncManager.addEmpleado(emp);
            }
          }

          // Actualizar departamento en Firebase y localStorage
          if (window.firebaseSyncManager) {
            // Crear nuevo departamento con el nombre actualizado
            const departamentoActualizado = {
              ...departamentoActual,
              nombre: nuevoNombre,
              fechaModificacion: new Date().toISOString(),
            };

            await window.firebaseSyncManager.addDepartamento(departamentoActualizado);
          } else {
            // Fallback a localStorage
            departamentos[index] = {
              ...departamentoActual,
              nombre: nuevoNombre,
              fechaModificacion: new Date().toISOString(),
            };
            localStorage.setItem('axyra_departamentos', JSON.stringify(departamentos));
          }

          cerrarModalEditarDepartamento();
          await cargarDepartamentos();
          mostrarEmpleados();
          mostrarMensaje('✅ Departamento actualizado exitosamente', 'success');
        } catch (error) {
          console.error('Error editando departamento:', error);
          mostrarMensaje('❌ Error al editar departamento', 'error');
        }
      }

      // Eliminar departamento
      async function eliminarDepartamento(index) {
        const departamentos = await obtenerDepartamentos();
        const departamento = departamentos[index];
        const empleadosEnDepartamento = contarEmpleadosPorDepartamento(departamento.nombre || departamento);

        if (empleadosEnDepartamento > 0) {
          mostrarMensaje(
            `❌ No se puede eliminar el departamento "${
              departamento.nombre || departamento
            }" porque tiene ${empleadosEnDepartamento} empleado(s) asignado(s)`,
            'error'
          );
          return;
        }

        // Crear modal de confirmación
        const modalHTML = `
          <div id="modalConfirmarEliminarDepartamento" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-trash"></i> Confirmar Eliminación
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalConfirmarEliminarDepartamento()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-modal-text">
                  <p>¿Estás seguro de que quieres eliminar el departamento <strong>"${departamento}"</strong>?</p>
                  <p>Esta acción no se puede deshacer.</p>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalConfirmarEliminarDepartamento()">
                  Cancelar
                </button>
                <button class="axyra-btn axyra-btn-error" onclick="confirmarEliminarDepartamento(${index})">
                  <i class="fas fa-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Cerrar modal confirmar eliminar departamento
      function cerrarModalConfirmarEliminarDepartamento() {
        const modal = document.getElementById('modalConfirmarEliminarDepartamento');
        if (modal) {
          modal.remove();
        }
      }

      // Confirmar eliminar departamento
      async function confirmarEliminarDepartamento(index) {
        try {
          const departamentos = await obtenerDepartamentos();
          const departamento = departamentos[index];

          // Eliminar departamento de Firebase si está disponible
          if (window.firebaseSyncManager) {
            // Marcar como eliminado en el sistema de sincronización
            // La eliminación física se maneja en el sistema de sincronización
            console.log('Departamento marcado para eliminación en Firebase:', departamento);
          }

          // Actualizar localStorage
          departamentos.splice(index, 1);
          localStorage.setItem('axyra_departamentos', JSON.stringify(departamentos));

          cerrarModalConfirmarEliminarDepartamento();
          await cargarDepartamentos();

          // Actualizar selects de departamentos en el formulario
          actualizarSelectsDepartamentos(departamentos);

          mostrarMensaje('✅ Departamento eliminado exitosamente', 'success');
        } catch (error) {
          console.error('Error eliminando departamento:', error);
          mostrarMensaje('❌ Error al eliminar departamento: ' + error.message, 'error');
        }
      }

      // Eventos
      document.getElementById('formEmpleado').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        const empleado = {
          nombre: formData.get('nombre'),
          email: formData.get('email'),
          telefono: formData.get('telefono'),
          fechaNacimiento: formData.get('fechaNacimiento'),
          departamento: formData.get('departamento'),
          cargo: formData.get('cargo'),
          salario: parseFloat(formData.get('salario')) || 0,
          fechaIngreso: formData.get('fechaIngreso'),
          estado: formData.get('estado'),
          direccion: formData.get('direccion'),
          createdAt: new Date().toISOString(),
        };

        if (empleadoEditando) {
          empleado.id = empleadoEditando.id;
          actualizarEmpleado(empleado);
        } else {
          agregarEmpleado(empleado);
        }

        cerrarModal('modalAgregarEmpleado');
      });

      // Eventos de filtros
      document.getElementById('searchInput').addEventListener('input', aplicarFiltros);
      document.getElementById('filterDepartamento').addEventListener('change', aplicarFiltros);
      document.getElementById('filterEstado').addEventListener('change', aplicarFiltros);

      // Búsqueda y filtros
      function aplicarFiltros() {
        const busqueda = document.getElementById('searchInput').value.toLowerCase();
        const departamento = document.getElementById('filterDepartamento').value;
        const estado = document.getElementById('filterEstado').value;

        const empleadosFiltrados = empleados.filter((empleado) => {
          const coincideBusqueda =
            empleado.nombre.toLowerCase().includes(busqueda) ||
            empleado.email.toLowerCase().includes(busqueda) ||
            empleado.cargo.toLowerCase().includes(busqueda);
          const coincideDepartamento = !departamento || empleado.departamento === departamento;
          const coincideEstado = !estado || empleado.estado === estado;

          return coincideBusqueda && coincideDepartamento && coincideEstado;
        });

        // Mostrar empleados filtrados
        const tbody = document.getElementById('empleadosTableBody');
        tbody.innerHTML = '';

        if (empleadosFiltrados.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="axyra-text-center">
                <div style="padding: 40px; text-align: center; color: #64748b;">
                  <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                  <p>No se encontraron empleados con los filtros aplicados</p>
                </div>
              </td>
            </tr>
          `;
        } else {
          empleadosFiltrados.forEach((empleado) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${empleado.id}</td>
              <td>
                <div class="axyra-avatar">
                  <i class="fas fa-user"></i>
                </div>
              </td>
              <td>${empleado.nombre}</td>
              <td>${empleado.departamento}</td>
              <td>${empleado.cargo}</td>
              <td>$${empleado.salario.toFixed(2)}</td>
              <td>
                <span class="axyra-status axyra-status-${empleado.estado.toLowerCase()}">
                  ${empleado.estado}
                </span>
              </td>
              <td>
                <div class="axyra-action-buttons">
                  <button class="axyra-btn-action axyra-btn-edit" onclick="editarEmpleado(${
                    empleado.id
                  })" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="axyra-btn-action axyra-btn-view" onclick="verEmpleado(${
                    empleado.id
                  })" title="Ver Detalles">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="axyra-btn-action axyra-btn-delete" onclick="eliminarEmpleado(${
                    empleado.id
                  })" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
      }

      // Cerrar modal al hacer clic fuera
      window.onclick = function (event) {
        const modals = document.querySelectorAll('.axyra-modal');
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      };

      // Función para limpiar datos inconsistentes
      function limpiarDatosInconsistentes() {
        try {
          console.log('🧹 Limpiando datos inconsistentes...');

          // Obtener usuario actual
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.log('⚠️ No hay usuario autenticado para limpiar datos');
            return;
          }

          // Limpiar empleados obsoletos del localStorage
          const empleadosGuardados = localStorage.getItem('axyra_empleados');
          if (empleadosGuardados) {
            try {
              const empleadosLocal = JSON.parse(empleadosGuardados);
              const empleadosFiltrados = empleadosLocal.filter(
                (emp) =>
                  emp.userId === currentUser.username ||
                  emp.userId === currentUser.email ||
                  emp.userId === currentUser.id
              );

              if (empleadosFiltrados.length !== empleadosLocal.length) {
                console.log(
                  `🧹 Limpiando empleados obsoletos: ${empleadosLocal.length} -> ${empleadosFiltrados.length}`
                );
                localStorage.setItem('axyra_empleados', JSON.stringify(empleadosFiltrados));
              }
            } catch (error) {
              console.error('Error limpiando empleados obsoletos:', error);
              localStorage.removeItem('axyra_empleados');
            }
          }

          console.log('✅ Limpieza de datos completada');
        } catch (error) {
          console.error('❌ Error limpiando datos:', error);
        }
      }

      // Inicialización
      window.addEventListener('load', async () => {
        try {
          console.log('🚀 AXYRA Empleados inicializando...');

          // Verificar autenticación
          const isAuthenticated = await checkAuth();

          if (isAuthenticated) {
            console.log('✅ Usuario autenticado, cargando empleados...');

            // Cargar empleados
            await cargarEmpleados();

            // Limpiar datos inconsistentes después de cargar
            setTimeout(limpiarDatosInconsistentes, 1000);

            console.log('✅ Módulo de empleados cargado correctamente');
          } else {
            console.log('❌ Usuario no autenticado, redirigiendo al login...');
            window.location.href = '../../login.html';
          }
        } catch (error) {
          console.error('❌ Error inicializando módulo de empleados:', error);
          window.location.href = '../../login.html';
        }
      });

      // Limpiar datos cuando la página se vuelve visible (solo una vez)
      let limpiezaEjecutada = false;
      document.addEventListener('visibilitychange', function () {
        if (!document.hidden && !limpiezaEjecutada) {
          console.log('👁️ Página visible, verificando datos...');
          setTimeout(() => {
            limpiarDatosInconsistentes();
            limpiezaEjecutada = true;
          }, 500);
        }
      });

      // Función para notificar cambios en empleados a otros módulos
      function notificarCambioEmpleados() {
        try {
          console.log('📢 Notificando cambio en empleados a otros módulos...');

          // Crear un evento personalizado para notificar cambios
          const eventoCambio = new CustomEvent('axyraEmpleadosCambiados', {
            detail: {
              timestamp: new Date().toISOString(),
              userId: (() => {
                if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
                  currentUser = window.axyraIsolatedAuth.getCurrentUser();
                } else {
                  const userData = localStorage.getItem('axyra_isolated_user');
                  if (userData) {
                    currentUser = JSON.parse(userData);
                  }
                }
                return currentUser?.id || currentUser?.username || currentUser?.email;
              })(),
              action: 'dataChanged',
            },
          });

          // Disparar el evento
          window.dispatchEvent(eventoCambio);

          // También notificar a través de localStorage para compatibilidad
          localStorage.setItem(
            'axyra_last_employee_change',
            JSON.stringify({
              timestamp: new Date().toISOString(),
              userId: (() => {
                if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
                  currentUser = window.axyraIsolatedAuth.getCurrentUser();
                  return currentUser?.id || currentUser?.username || currentUser?.email;
                } else {
                  const userData = localStorage.getItem('axyra_isolated_user');
                  if (userData) {
                    currentUser = JSON.parse(userData);
                    return currentUser?.id || currentUser?.username || currentUser?.email;
                  }
                }
                return null;
              })(),
              action: 'dataChanged',
            })
          );

          console.log('✅ Notificación enviada a otros módulos');
        } catch (error) {
          console.error('❌ Error notificando cambios:', error);
        }
      }

      // Hacer funciones globales para acceso desde HTML
      window.exportarEmpleados = exportarEmpleados;
      window.mostrarModal = mostrarModal;
      window.cerrarModal = cerrarModal;
      window.cambiarPagina = cambiarPagina;
      window.gestionarDepartamentos = gestionarDepartamentos;
      window.cerrarModalDepartamentos = cerrarModalDepartamentos;
      window.agregarDepartamento = agregarDepartamento;
      window.editarDepartamento = editarDepartamento;
      window.eliminarDepartamento = eliminarDepartamento;
      window.cerrarModalEditarDepartamento = cerrarModalEditarDepartamento;
      window.confirmarEditarDepartamento = confirmarEditarDepartamento;
      window.cerrarModalConfirmarEliminarDepartamento = cerrarModalConfirmarEliminarDepartamento;
      window.confirmarEliminarDepartamento = confirmarEliminarDepartamento;
      window.verEmpleado = verEmpleado;
      window.cerrarModalDetalles = cerrarModalDetalles;
      window.editarEmpleado = editarEmpleado;
      window.actualizarEmpleado = actualizarEmpleado;
      window.eliminarEmpleado = eliminarEmpleado;
      window.resetearFormulario = resetearFormulario;
      window.aplicarFiltros = aplicarFiltros;
      window.logout = logout;
      window.mostrarHistorialCambios = mostrarHistorialCambios;
      window.mostrarModalImportacion = mostrarModalImportacion;
      window.mostrarOrganigrama = mostrarOrganigrama;
      window.mostrarModalFotos = mostrarModalFotos;
      window.cambiarFotoEmpleado = cambiarFotoEmpleado;

      // Guardar edición de empleado
      async function guardarEdicionEmpleado() {
        try {
          const id = window.empleadoAEditar;
          if (!id) {
            mostrarMensaje('❌ ID de empleado no válido', 'error');
            return;
          }

          // Obtener los datos del formulario
          const formData = new FormData(document.getElementById('formEditarEmpleado'));
          const empleadoEditado = {
            nombre: formData.get('nombre'),
            cedula: formData.get('cedula'),
            telefono: formData.get('telefono'),
            email: formData.get('email'),
            direccion: formData.get('direccion'),
            salario: Number(formData.get('salario')),
            tipoContrato: formData.get('tipoContrato'),
            fechaContratacion: formData.get('fechaContratacion'),
            updatedAt: new Date().toISOString(),
          };

          // Validar datos requeridos
          if (!empleadoEditado.nombre || !empleadoEditado.cedula || !empleadoEditado.salario) {
            mostrarMensaje('❌ Por favor completa todos los campos requeridos', 'error');
            return;
          }

          // Cerrar el modal
          cerrarModalEditar();

          // Mostrar notificación de actualización
          mostrarMensaje('🔄 Actualizando empleado...', 'info');

          // Actualizar en Firebase si está disponible
          try {
            if (typeof firebase !== 'undefined' && firebase.firestore) {
              const db = firebase.firestore();

              // Buscar el empleado en Firebase
              const empleadosRef = db.collection('empleados');
              const query = empleadosRef.where('id', '==', id);
              const snapshot = await query.get();

              if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                  batch.update(doc.ref, empleadoEditado);
                });
                await batch.commit();
                console.log('✅ Empleado actualizado en Firebase');
              }
            }
          } catch (firebaseError) {
            console.warn('⚠️ Error actualizando en Firebase:', firebaseError);
          }

          // Actualizar en localStorage
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const index = empleados.findIndex((emp) => emp.id === id);
          if (index !== -1) {
            empleados[index] = { ...empleados[index], ...empleadoEditado };
            localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          }

          // Actualizar la tabla
          cargarEmpleados();

          // Registrar cambio en historial
          registrarCambio('update', id, `Empleado actualizado: ${empleadoEditado.nombre}`);

          // Disparar evento de cambio para actualizar dashboard
          const event = new CustomEvent('axyraEmpleadosCambiados', {
            detail: {
              action: 'update',
              empleadoId: id,
              userId: 'axyra',
            },
          });
          window.dispatchEvent(event);

          mostrarMensaje('✅ Empleado actualizado correctamente', 'success');
        } catch (error) {
          console.error('❌ Error actualizando empleado:', error);
          mostrarMensaje('Error al actualizar empleado: ' + error.message, 'error');
        }
      }
    </script>
    
    <!-- Chat de IA AXYRA - Cargar al final -->
    <script src="../../static/axyra-ai-global.js"></script>
  </body>
</html>
