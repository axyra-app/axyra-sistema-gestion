<!-- frontend/cuadre_caja.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Cuadre de Caja</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="stylesheet" href="../../static/modal-positioning-fix.css" />
    <link rel="stylesheet" href="../../static/modal-emergency-fix.css" />
    <link rel="stylesheet" href="../../static/header-fixes.css" />
    <link rel="stylesheet" href="cuadre-caja-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../static/work-areas-config.js"></script>
    <script src="../../static/cash-reconciliation-export.js"></script>
    <script src="../../static/colombian-labor-law.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>

    <!-- Sistema de Sincronizaci√≥n Firebase ‚Üî localStorage -->
    <script src="../../static/firebase-sync-manager.js"></script>

    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>

    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>

    <!-- Sistema Unificado de Autenticaci√≥n AXYRA -->
    <script src="../../static/unified-auth-system.js"></script>

    <!-- Sistema Unificado de Reportes Avanzados AXYRA -->
    <script src="../../static/advanced-reports-unified.js"></script>

    <!-- Sistema Unificado de Backup AXYRA -->
    <script src="../../static/backup-system-unified.js"></script>

    <!-- Sistema Unificado de Auditor√≠a AXYRA -->
    <script src="../../static/audit-system-unified.js"></script>

    <script src="../../static/debug-auth.js"></script>

    <!-- Header Compartido AXYRA -->
    <script src="../../static/include-header.js"></script>

    <!-- Verificaci√≥n del Header Compartido -->
    <script src="../../static/header-verification.js"></script>

    <!-- Sistema de Validaciones Avanzadas AXYRA -->
    <script src="../../static/advanced-validation-system.js"></script>

    <!-- Sistema de Cuadre de Caja AXYRA -->
    <script src="cuadre_caja.js"></script>
  </head>
  <body>
    <!-- Header Compartido AXYRA - Se insertar√° autom√°ticamente -->

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Cuadre de Caja</h1>
          <p class="axyra-page-subtitle">Registro de ingresos por factura individual y control de caja</p>
        </div>

        <!-- Dashboard de Analytics Financieros -->
        <div class="axyra-financial-dashboard">
          <div class="axyra-financial-header">
            <h3>üí∞ Analytics Financieros Avanzados</h3>
            <p>An√°lisis detallado de ingresos, tendencias y rentabilidad</p>
          </div>

          <div class="axyra-financial-grid">
            <!-- Gr√°fico de Ingresos por Mes -->
            <div class="axyra-financial-card">
              <div class="axyra-financial-card-header">
                <h4>üìà Ingresos Mensuales</h4>
                <div class="axyra-financial-controls">
                  <select id="financialYear" onchange="actualizarGraficosFinancieros()">
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                  </select>
                </div>
              </div>
              <div class="axyra-financial-chart">
                <canvas id="ingresosMensualesChart"></canvas>
              </div>
            </div>

            <!-- Gr√°fico de Distribuci√≥n por Encargado -->
            <div class="axyra-financial-card">
              <div class="axyra-financial-card-header">
                <h4>üë• Rendimiento por Encargado</h4>
                <p>An√°lisis de productividad del equipo</p>
              </div>
              <div class="axyra-financial-chart">
                <canvas id="rendimientoEncargadoChart"></canvas>
              </div>
            </div>

            <!-- Gr√°fico de Tendencias Diarias -->
            <div class="axyra-financial-card">
              <div class="axyra-financial-card-header">
                <h4>üìä Tendencias por D√≠a de la Semana</h4>
                <p>Patrones de ingresos semanales</p>
              </div>
              <div class="axyra-financial-chart">
                <canvas id="tendenciasDiariasChart"></canvas>
              </div>
            </div>

            <!-- KPIs Financieros Mejorados -->
            <div class="axyra-financial-card">
              <div class="axyra-financial-card-header">
                <h4>üìä Indicadores Financieros</h4>
                <p>M√©tricas clave de rendimiento empresarial</p>
              </div>
              <div class="axyra-financial-metrics-grid">
                <div class="axyra-kpi-card axyra-kpi-primary">
                  <div class="axyra-kpi-icon">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <div class="axyra-kpi-content">
                    <div class="axyra-kpi-value" id="ingresoPromedio">$0</div>
                    <div class="axyra-kpi-label">Ingreso Promedio</div>
                    <div class="axyra-kpi-subtitle">Por transacci√≥n</div>
                  </div>
                </div>
                <div class="axyra-kpi-card axyra-kpi-success">
                  <div class="axyra-kpi-icon">
                    <i class="fas fa-file-invoice"></i>
                  </div>
                  <div class="axyra-kpi-content">
                    <div class="axyra-kpi-value" id="facturasPorDia">0</div>
                    <div class="axyra-kpi-label">Facturas/D√≠a</div>
                    <div class="axyra-kpi-subtitle">Promedio diario</div>
                  </div>
                </div>
                <div class="axyra-kpi-card axyra-kpi-warning">
                  <div class="axyra-kpi-icon">
                    <i class="fas fa-trending-up"></i>
                  </div>
                  <div class="axyra-kpi-content">
                    <div class="axyra-kpi-value" id="crecimientoMensual">0%</div>
                    <div class="axyra-kpi-label">Crecimiento</div>
                    <div class="axyra-kpi-subtitle">Mensual</div>
                  </div>
                </div>
                <div class="axyra-kpi-card axyra-kpi-info">
                  <div class="axyra-kpi-icon">
                    <i class="fas fa-wallet"></i>
                  </div>
                  <div class="axyra-kpi-content">
                    <div class="axyra-kpi-value" id="totalVentas">$0</div>
                    <div class="axyra-kpi-label">Total Ventas</div>
                    <div class="axyra-kpi-subtitle">Este mes</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Registrar Nueva Factura -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Registrar Nueva Factura</h3>
              <p class="axyra-card-subtitle">Ingresa los datos de la factura</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <form id="formFactura" class="axyra-form">
              <div class="axyra-form-grid">
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Fecha</label>
                  <input type="date" id="fecha" class="axyra-form-input" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Encargado</label>
                  <div class="axyra-form-select-container">
                    <select id="encargado" class="axyra-form-select" required onchange="manejarCambioEncargado()">
                      <option value="">Seleccionar encargado</option>
                      <option value="JULIO CASTA√ëO">JULIO CASTA√ëO</option>
                      <option value="MARIA GONZALEZ">MARIA GONZALEZ</option>
                      <option value="CARLOS RODRIGUEZ">CARLOS RODRIGUEZ</option>
                      <option value="ANA MARTINEZ">ANA MARTINEZ</option>
                      <option value="LUIS PEREZ">LUIS PEREZ</option>
                      <option value="otro">Otro (escribir)</option>
                    </select>
                    <input
                      type="text"
                      id="encargadoOtro"
                      class="axyra-form-input"
                      placeholder="Escribir nombre del encargado"
                      style="display: none; margin-top: 8px"
                    />
                  </div>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">C√©dula del Encargado</label>
                  <input
                    type="text"
                    id="cedulaEncargado"
                    class="axyra-form-input"
                    placeholder="Ej: 12345678"
                    required
                  />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">N√∫mero de Factura</label>
                  <input type="text" id="numeroFactura" class="axyra-form-input" placeholder="Ej: 3945" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">√Årea</label>
                  <select id="area" class="axyra-form-select" required>
                    <option value="">Seleccionar √°rea</option>
                    <option value="BAR">BAR</option>
                    <option value="RESTAURANTE">RESTAURANTE</option>
                    <option value="RECEPCI√ìN">RECEPCI√ìN</option>
                    <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                    <option value="ADMINISTRACI√ìN">ADMINISTRACI√ìN</option>
                    <option value="OTRO">OTRO</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Monto</label>
                  <input type="number" id="monto" class="axyra-form-input" placeholder="0" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">M√©todo de Pago</label>
                  <select id="metodoPago" class="axyra-form-select" required>
                    <option value="">Seleccionar m√©todo</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Descripci√≥n</label>
                  <input
                    type="text"
                    id="descripcion"
                    class="axyra-form-input"
                    placeholder="Ej: Cocteles, Comida, etc."
                    required
                  />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Estado</label>
                  <select id="estado" class="axyra-form-select" required>
                    <option value="">Seleccionar estado</option>
                    <option value="Pagada">Pagada</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Cancelada">Cancelada</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Link de Factura (Opcional)</label>
                  <input
                    type="url"
                    id="linkFactura"
                    class="axyra-form-input"
                    placeholder="https://ejemplo.com/factura"
                  />
                </div>
              </div>
              <div class="axyra-form-actions">
                <button type="submit" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-save"></i> Registrar Factura
                </button>
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="limpiarFormulario()">
                  <i class="fas fa-eraser"></i> Limpiar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Resumen del D√≠a -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Resumen del D√≠a</h3>
              <p class="axyra-card-subtitle">Total de ingresos y facturas del d√≠a</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-caja-summary">
              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalFacturas">0</div>
                  <div class="axyra-summary-label">Total Facturas</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalIngresos">$0</div>
                  <div class="axyra-summary-label">Total Ingresos</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalEfectivo">$0</div>
                  <div class="axyra-summary-label">Efectivo</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-university"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalTransferencias">$0</div>
                  <div class="axyra-summary-label">Transferencias</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalDatafono">$0</div>
                  <div class="axyra-summary-label">Datafono</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-qrcode"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalQR">$0</div>
                  <div class="axyra-summary-label">QR</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-money-check"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalCheque">$0</div>
                  <div class="axyra-summary-label">Cheque</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-ellipsis-h"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalOtros">$0</div>
                  <div class="axyra-summary-label">Otros</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- √öltima Factura -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">√öltima Factura</h3>
              <p class="axyra-card-subtitle">Informaci√≥n de la √∫ltima factura registrada</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-ultima-factura-container">
              <div class="axyra-ultima-factura-info">
                <div class="axyra-ultima-factura-monto" id="ultimaFactura">$0</div>
                <div class="axyra-ultima-factura-details" id="ultimaFacturaInfo">No hay facturas registradas</div>
                <div class="axyra-ultima-factura-time" id="ultimaFacturaTime"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Historial de Facturas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Historial de Facturas</h3>
              <p class="axyra-card-subtitle">Todas las facturas registradas</p>
            </div>
          </div>

          <!-- Filtros Mejorados -->
          <div class="axyra-filters-enhanced">
            <div class="axyra-search-box">
              <input
                type="text"
                id="searchFacturas"
                class="axyra-form-input"
                placeholder="Buscar por n√∫mero o encargado..."
              />
              <i class="fas fa-search"></i>
            </div>
            <div class="axyra-filter-group">
              <div class="axyra-date-filters">
                <input type="date" id="filterFechaDesde" class="axyra-form-input" placeholder="Desde" />
                <input type="date" id="filterFechaHasta" class="axyra-form-input" placeholder="Hasta" />
              </div>
              <select id="filterFechaFacturas" class="axyra-form-select">
                <option value="">Filtros r√°pidos</option>
                <option value="hoy">Hoy</option>
                <option value="ayer">Ayer</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este mes</option>
                <option value="mesAnterior">Mes anterior</option>
                <option value="trimestre">Este trimestre</option>
                <option value="a√±o">Este a√±o</option>
              </select>
              <select id="filterAreaFacturas" class="axyra-form-select">
                <option value="">Todas las √°reas</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
                <option value="Ventas">Ventas</option>
                <option value="Producci√≥n">Producci√≥n</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
              </select>
              <select id="filterMetodoPago" class="axyra-form-select">
                <option value="">Todos los m√©todos</option>
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="datafono">Datafono</option>
                <option value="qr">QR</option>
                <option value="cheque">Cheque</option>
              </select>
            </div>
            <button class="axyra-btn axyra-btn-primary" onclick="aplicarFiltrosFacturas()">
              <i class="fas fa-filter"></i> Aplicar Filtros
            </button>
            <button class="axyra-btn axyra-btn-secondary" onclick="limpiarFiltrosFacturas()">
              <i class="fas fa-times"></i> Limpiar
            </button>
            <button class="axyra-btn axyra-btn-primary" onclick="exportarFacturas()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>

          <div class="axyra-card-content">
            <div class="axyra-actions-bar">
              <button class="axyra-btn axyra-btn-success" onclick="exportarCuadreCaja()">
                <i class="fas fa-file-excel"></i> Exportar Cuadre de Caja
              </button>
              <button class="axyra-btn axyra-btn-primary" onclick="cargarResumen()">
                <i class="fas fa-sync-alt"></i> Actualizar Resumen
              </button>
              <button class="axyra-btn axyra-btn-warning" onclick="limpiarHistorial()">
                <i class="fas fa-trash"></i> Limpiar Historial
              </button>
            </div>

            <div class="axyra-table-container">
              <table class="axyra-table" id="facturasTable">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N√∫mero</th>
                    <th>Encargado</th>
                    <th>√Årea</th>
                    <th>Monto</th>
                    <th>M√©todo de Pago</th>
                    <th>Descripci√≥n</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="facturasTableBody">
                  <!-- Las facturas se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>

            <!-- Paginaci√≥n -->
            <div class="axyra-pagination">
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaFacturas(-1)">
                <i class="fas fa-chevron-left"></i> Anterior
              </button>
              <span id="paginaFacturasInfo">P√°gina 1 de 1</span>
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaFacturas(1)">
                Siguiente <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="axyra-footer">
      <div class="axyra-container">
        <div class="axyra-footer-content">
          <p>&copy; 2025 AXYRA. Sistema de Gesti√≥n Empresarial.</p>
        </div>
      </div>
    </footer>

    <script>
      // Verificar autenticaci√≥n
      async function checkAuth() {
        try {
          console.log('üîê Verificando autenticaci√≥n en cuadre de caja...');

          // Verificar sesi√≥n usando Firebase
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            const currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('‚úÖ Usuario autenticado con Firebase en cuadre de caja:', currentUser.email);
            return true;
          }

          // Verificar sesi√≥n usando localStorage como fallback
          const user = localStorage.getItem('axyra_isolated_user');
          if (user) {
            try {
              const userData = JSON.parse(user);
              if (userData && (userData.username || userData.email)) {
                console.log(
                  '‚úÖ Usuario autenticado con localStorage en cuadre de caja:',
                  userData.username || userData.email
                );
                return true;
              }
            } catch (error) {
              console.error('Error parseando sesi√≥n de localStorage:', error);
            }
          }

          // No hay sesi√≥n activa
          console.log('‚ö†Ô∏è No hay sesi√≥n activa en cuadre de caja - redirigiendo al login');
          window.location.href = '../../login.html';
          return false;
        } catch (error) {
          console.error('‚ùå Error al verificar sesi√≥n en cuadre de caja:', error);
          window.location.href = '../../login.html';
          return false;
        }
      }

      // Cerrar sesi√≥n - SISTEMA AISLADO
      function logout() {
        console.log('üîÑ Cerrando sesi√≥n desde cuadre de caja...');

        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }

        console.log('‚úÖ Sesi√≥n cerrada desde cuadre de caja');
        window.location.href = '../../login.html';
      }

      // Variables globales
      let facturas = [];
      let empleados = [];
      let monedaActual = 'COP';

      // Inicializaci√≥n
      window.addEventListener('load', async () => {
        try {
          console.log('üöÄ AXYRA Cuadre de Caja inicializando...');

          // Verificar autenticaci√≥n
          const isAuthenticated = await checkAuth();

          if (isAuthenticated) {
            console.log('‚úÖ Usuario autenticado, cargando cuadre de caja...');

            // Cargar facturas
            await cargarFacturas();

            // Cargar resumen y configuraci√≥n
            cargarResumen();
            cargarConfiguracion();

            console.log('‚úÖ M√≥dulo de cuadre de caja cargado correctamente');
          } else {
            console.log('‚ùå Usuario no autenticado, mostrando mensaje...');
            // NO redirigir autom√°ticamente
          }
        } catch (error) {
          console.error('‚ùå Error inicializando m√≥dulo de cuadre de caja:', error);
          // NO redirigir autom√°ticamente
        }
      });

      // Cargar facturas desde Firebase o localStorage
      async function cargarFacturas() {
        try {
          console.log('üìä Cargando facturas...');

          // Obtener usuario actual - SISTEMA AISLADO
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
            console.log(
              '‚úÖ Usuario actual en cuadre de caja (sistema aislado):',
              currentUser.username || currentUser.email
            );
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
              console.log(
                '‚úÖ Usuario actual en cuadre de caja (localStorage):',
                currentUser.username || currentUser.email
              );
            }
          }

          if (!currentUser) {
            console.log('‚ö†Ô∏è No hay usuario autenticado en cuadre de caja');
            facturas = [];
            mostrarFacturas();
            return;
          }

          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('üî• Intentando cargar facturas desde Firebase...');
              const facturasSnapshot = await firebase.firestore
                .collection('facturas')
                .where('userId', '==', currentUser.id)
                .get();

              if (!facturasSnapshot.empty) {
                facturas = [];
                facturasSnapshot.forEach((doc) => {
                  facturas.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`‚úÖ Facturas cargadas desde Firebase: ${facturas.length}`);
              } else {
                console.log('‚ÑπÔ∏è No hay facturas en Firebase para este usuario');
                facturas = [];
              }
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Error cargando desde Firebase, usando localStorage:', firebaseError.message);
              // Cargar desde localStorage como fallback
              facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

              // Filtrar facturas por usuario actual
              if (currentUser.username || currentUser.email) {
                const userId = currentUser.username || currentUser.email;
                const facturasFiltradas = facturas.filter((factura) => factura.userId === userId);
                console.log(
                  `‚úÖ Facturas filtradas para usuario ${userId}: ${facturasFiltradas.length} de ${facturas.length} totales`
                );
                facturas = facturasFiltradas;
              }
            }
          } else {
            // Firebase no disponible, usar localStorage
            console.log('üíæ Cargando facturas desde localStorage...');
            facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

            // Filtrar facturas por usuario actual
            if (currentUser.username || currentUser.email) {
              const userId = currentUser.username || currentUser.email;
              const facturasFiltradas = facturas.filter((factura) => factura.userId === userId);
              console.log(
                `‚úÖ Facturas filtradas para usuario ${userId}: ${facturasFiltradas.length} de ${facturas.length} totales`
              );
              facturas = facturasFiltradas;
            }
          }

          mostrarFacturas();
        } catch (error) {
          console.error('‚ùå Error cargando facturas:', error);
          facturas = [];
          mostrarFacturas();
        }
      }

      // Mostrar facturas en la tabla
      function mostrarFacturas() {
        const tbody = document.getElementById('facturasTableBody');
        if (facturas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="axyra-text-center">No hay facturas registradas</td></tr>';
          return;
        }

        tbody.innerHTML = facturas
          .map(
            (factura) => `
          <tr>
            <td>${formatearFecha(factura.fecha)}</td>
            <td>${factura.numero}</td>
            <td>${factura.encargado}</td>
            <td>${factura.area}</td>
            <td>${formatearMoneda(factura.monto)}</td>
            <td>${factura.metodoPago || '-'}</td>
            <td>${factura.descripcion || '-'}</td>
            <td>
              <button class="axyra-btn axyra-btn-danger axyra-btn-small" onclick="eliminarFactura('${factura.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `
          )
          .join('');
      }

      // Formatear fecha
      function formatearFecha(fecha) {
        return new Date(fecha).toLocaleDateString('es-CO');
      }

      // Funci√≥n para formatear moneda sin decimales
      function formatearMoneda(valor) {
        if (valor === null || valor === undefined) return '$0';
        const numero = parseFloat(valor);
        if (isNaN(numero)) return '$0';

        // Usar separadores de miles con formato colombiano
        return (
          '$' +
          numero.toLocaleString('es-CO', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          })
        );
      }

      // Funci√≥n para formatear moneda con separadores de miles
      function formatearMonedaConSeparadores(valor) {
        if (typeof valor === 'number') {
          return valor.toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          });
        }
        return valor;
      }

      // Cargar resumen del d√≠a
      function cargarResumen() {
        try {
          const fechaHoy = new Date().toISOString().split('T')[0];
          const facturasHoy = facturas.filter((f) => f.fecha === fechaHoy);

          // Calcular totales
          const totalFacturas = facturasHoy.length;
          const totalIngresos = facturasHoy.reduce((total, f) => total + parseFloat(f.monto), 0);

          // Calcular por m√©todo de pago
          const efectivo = facturasHoy
            .filter((f) => f.metodoPago === 'efectivo')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const transferencia = facturasHoy
            .filter((f) => f.metodoPago === 'transferencia')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const datafono = facturasHoy
            .filter((f) => f.metodoPago === 'datafono')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const qr = facturasHoy
            .filter((f) => f.metodoPago === 'qr')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const cheque = facturasHoy
            .filter((f) => f.metodoPago === 'cheque')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const otros = facturasHoy
            .filter((f) => !['efectivo', 'transferencia', 'datafono', 'qr', 'cheque'].includes(f.metodoPago))
            .reduce((total, f) => total + parseFloat(f.monto), 0);

          // Actualizar resumen
          document.getElementById('totalFacturas').textContent = totalFacturas;
          document.getElementById('totalIngresos').textContent = formatearMoneda(totalIngresos);
          document.getElementById('totalEfectivo').textContent = formatearMoneda(efectivo);
          document.getElementById('totalTransferencias').textContent = formatearMoneda(transferencia);

          // Actualizar m√©todos de pago adicionales si existen los elementos
          const totalDatafonoElement = document.getElementById('totalDatafono');
          const totalQRElement = document.getElementById('totalQR');
          const totalChequeElement = document.getElementById('totalCheque');
          const totalOtrosElement = document.getElementById('totalOtros');

          if (totalDatafonoElement) totalDatafonoElement.textContent = formatearMoneda(datafono);
          if (totalQRElement) totalQRElement.textContent = formatearMoneda(qr);
          if (totalChequeElement) totalChequeElement.textContent = formatearMoneda(cheque);
          if (totalOtrosElement) totalOtrosElement.textContent = formatearMoneda(otros);

          // Mostrar √∫ltima factura con informaci√≥n completa
          if (facturasHoy.length > 0) {
            const ultimaFactura = facturasHoy[facturasHoy.length - 1];
            document.getElementById('ultimaFactura').textContent = formatearMoneda(ultimaFactura.monto);
            document.getElementById('ultimaFacturaInfo').textContent = `#${ultimaFactura.numero} - ${
              ultimaFactura.encargado
            } - ${ultimaFactura.metodoPago.toUpperCase()}`;

            const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');
            if (ultimaFacturaTimeElement) {
              const fechaFactura = new Date(ultimaFactura.fecha);
              // Formatear hora en zona horaria de Colombia
              const horaColombia = fechaFactura.toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'America/Bogota',
              });
              ultimaFacturaTimeElement.textContent = `Registrada a las ${horaColombia}`;
            }
          } else {
            document.getElementById('ultimaFactura').textContent = formatearMoneda(0);
            document.getElementById('ultimaFacturaInfo').textContent = 'No hay facturas hoy';
            const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');
            if (ultimaFacturaTimeElement) {
              ultimaFacturaTimeElement.textContent = '';
            }
          }

          console.log('‚úÖ Resumen del d√≠a actualizado');
        } catch (error) {
          console.error('‚ùå Error cargando resumen:', error);
        }
      }

      // Cambiar moneda
      function cambiarMoneda(moneda) {
        document.querySelectorAll('.axyra-currency-option').forEach((option) => {
          option.classList.remove('active');
        });

        // Encontrar la opci√≥n seleccionada y marcarla como activa
        const opcionSeleccionada = document.querySelector(`.axyra-currency-option[onclick*="${moneda}"]`);
        if (opcionSeleccionada) {
          opcionSeleccionada.classList.add('active');
        }

        monedaActual = moneda;
        localStorage.setItem('axyra_moneda', moneda);

        mostrarFacturas();
        cargarResumen();

        mostrarMensaje(`‚úÖ Moneda cambiada a ${moneda}`, 'success');
      }

      // Funci√≥n para actualizar inmediatamente la √∫ltima factura
      function actualizarUltimaFactura(factura) {
        try {
          const ultimaFacturaElement = document.getElementById('ultimaFactura');
          const ultimaFacturaInfoElement = document.getElementById('ultimaFacturaInfo');
          const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');

          if (ultimaFacturaElement && ultimaFacturaInfoElement && ultimaFacturaTimeElement) {
            // Actualizar monto
            ultimaFacturaElement.textContent = formatearMoneda(parseFloat(factura.monto));

            // Actualizar informaci√≥n
            ultimaFacturaInfoElement.textContent = `#${factura.numero} - ${
              factura.encargado
            } - ${factura.metodoPago.toUpperCase()}`;

            // Actualizar tiempo
            const fechaFactura = new Date(factura.fecha);
            const horaColombia = fechaFactura.toLocaleTimeString('es-CO', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: true,
              timeZone: 'America/Bogota',
            });
            ultimaFacturaTimeElement.textContent = `Registrada a las ${horaColombia}`;

            console.log('‚úÖ √öltima factura actualizada inmediatamente:', factura.numero);
          }
        } catch (error) {
          console.error('‚ùå Error actualizando √∫ltima factura:', error);
        }
      }

      // Cargar configuraci√≥n
      function cargarConfiguracion() {
        const moneda = localStorage.getItem('axyra_moneda') || 'COP';
        cambiarMoneda(moneda);
      }

      // Funci√≥n para manejar cambio en encargado
      function manejarCambioEncargado() {
        const encargadoSelect = document.getElementById('encargado');
        const encargadoOtro = document.getElementById('encargadoOtro');

        if (encargadoSelect.value === 'otro') {
          encargadoOtro.style.display = 'block';
          encargadoOtro.required = true;
        } else {
          encargadoOtro.style.display = 'none';
          encargadoOtro.required = false;
          encargadoOtro.value = '';
        }
      }

      // Funci√≥n para obtener el nombre del encargado
      function obtenerNombreEncargado() {
        const encargadoSelect = document.getElementById('encargado');
        const encargadoOtro = document.getElementById('encargadoOtro');

        if (encargadoSelect.value === 'otro') {
          return encargadoOtro.value;
        }
        return encargadoSelect.value;
      }

      // Funci√≥n para exportar a Excel usando plantilla existente
      async function exportarFacturasExcel() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

          if (facturas.length === 0) {
            mostrarMensaje('No hay facturas para exportar', 'warning');
            return;
          }

          // Crear libro de Excel usando la plantilla
          const workbook = XLSX.utils.book_new();

          // Crear hoja de trabajo con los datos
          const datosExcel = [
            ['CUADRE DE CAJA - Villa Venecia'],
            ['EMPRESA: Villa Venecia'],
            ['NIT: NIT Pendiente'],
            [`FECHA DE EXPORTACI√ìN: ${new Date().toLocaleDateString()}`],
            [''], // L√≠nea en blanco
            ['ID', 'Empleado', 'C√©dula', 'Fecha', 'Concepto', 'Valor', 'Estado', 'Observaciones'],
          ];

          let totalValor = 0;

          facturas.forEach((factura) => {
            const valor = parseFloat(factura.monto || 0);
            totalValor += valor;

            datosExcel.push([
              factura.numero || 'N/A',
              factura.encargado || 'N/A',
              factura.cedulaEncargado || 'N/A',
              factura.fecha || 'N/A',
              factura.descripcion || 'N/A',
              valor,
              factura.estado || 'N/A',
              factura.linkFactura || 'N/A',
            ]);
          });

          // Agregar l√≠nea en blanco y totales
          datosExcel.push(['']);
          datosExcel.push(['TOTALES', '', '', '', '', totalValor, '', '']);

          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 15 }, // ID
            { width: 25 }, // Empleado
            { width: 15 }, // C√©dula
            { width: 15 }, // Fecha
            { width: 30 }, // Concepto
            { width: 15 }, // Valor
            { width: 15 }, // Estado
            { width: 40 }, // Observaciones
          ];

          // Aplicar estilos a las celdas
          const range = XLSX.utils.decode_range(worksheet['!ref']);

          for (let R = range.s.r; R <= range.e.r; R++) {
            for (let C = range.s.c; C <= range.e.c; C++) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!worksheet[cellAddress]) continue;

              // Estilo para t√≠tulo principal (primera fila)
              if (R === 0) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: '4F81BD' } }, // Azul profesional
                  font: {
                    color: { rgb: 'FFFFFF' },
                    bold: true,
                    sz: 16,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                };
              }
              // Estilo para informaci√≥n de empresa (filas 1-3)
              else if (R >= 1 && R <= 3) {
                worksheet[cellAddress].s = {
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'left',
                    vertical: 'center',
                  },
                };
              }
              // Estilo para encabezados de tabla (fila 5)
              else if (R === 5) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'D9E1F2' } }, // Azul claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 11,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: '000000' } },
                    bottom: { style: 'thin', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para fila de totales (√∫ltima fila)
              else if (R === range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'C6EFCE' } }, // Verde claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'medium', color: { rgb: '000000' } },
                    bottom: { style: 'medium', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para datos (filas intermedias)
              else if (R > 5 && R < range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: R % 2 === 0 ? 'FFFFFF' : 'F8F9FA' } }, // Filas alternadas
                  font: {
                    color: { rgb: '000000' },
                    sz: 10,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    bottom: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    left: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    right: { style: 'thin', color: { rgb: 'D0D0D0' } },
                  },
                };

                // Formato especial para columna de valor
                if (C === 5) {
                  // Columna de valor
                  worksheet[cellAddress].s.numberFormat = '"$"#,##0.00';
                }
              }
            }
          }

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Cuadre de Caja');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `CUADRE_CAJA_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);

          console.log('‚úÖ Facturas exportadas correctamente:', nombreArchivo);
          mostrarMensaje('‚úÖ Facturas exportadas a Excel con formato profesional', 'success');
        } catch (error) {
          console.error('‚ùå Error exportando facturas:', error);
          mostrarMensaje('Error al exportar: ' + error.message, 'error');
        }
      }

      // Funci√≥n para registrar factura
      document.getElementById('formFactura').addEventListener('submit', function (e) {
        e.preventDefault();

        // Obtener usuario actual
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        const factura = {
          id: Date.now().toString(),
          fecha: document.getElementById('fecha').value,
          encargado: obtenerNombreEncargado(),
          cedulaEncargado: document.getElementById('cedulaEncargado').value,
          numero: document.getElementById('numeroFactura').value,
          area: document.getElementById('area').value,
          monto: document.getElementById('monto').value,
          metodoPago: document.getElementById('metodoPago').value,
          descripcion: document.getElementById('descripcion').value,
          estado: document.getElementById('estado').value,
          linkFactura: document.getElementById('linkFactura').value,
          userId: currentUser ? currentUser.username || currentUser.email : 'admin',
          createdAt: new Date().toISOString(),
        };

        facturas.unshift(factura);
        localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

        mostrarFacturas();
        limpiarFormulario();

        mostrarMensaje('‚úÖ Factura registrada correctamente', 'success');

        // Actualizar inmediatamente la √∫ltima factura
        actualizarUltimaFactura(factura);

        // Actualizar resumen del d√≠a en tiempo real
        setTimeout(() => {
          cargarResumen();
        }, 100);
      });

      // Limpiar formulario
      function limpiarFormulario() {
        document.getElementById('formFactura').reset();
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('encargadoOtro').style.display = 'none'; // Ocultar el input de texto
        document.getElementById('cedulaEncargado').value = ''; // Limpiar c√©dula
      }

      // Eliminar factura
      function eliminarFactura(id) {
        // Obtener informaci√≥n de la factura
        const factura = facturas.find((f) => f.id === id);
        if (!factura) {
          mostrarMensaje('‚ùå Factura no encontrada', 'error');
          return;
        }

        // Mostrar modal de confirmaci√≥n
        mostrarModalEliminarFactura(factura);
      }

      // Funci√≥n para aplicar filtros de facturas
      function aplicarFiltrosFacturas() {
        try {
          const fechaDesde = document.getElementById('filterFechaDesde').value;
          const fechaHasta = document.getElementById('filterFechaHasta').value;
          const filtroRapido = document.getElementById('filterFechaFacturas').value;
          const filtroArea = document.getElementById('filterAreaFacturas').value;
          const filtroMetodo = document.getElementById('filterMetodoPago').value;
          const busqueda = document.getElementById('searchFacturas').value.toLowerCase();

          // Obtener todas las facturas
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          let facturasFiltradas = [...facturas];

          // Aplicar filtro de fechas
          if (fechaDesde || fechaHasta || filtroRapido) {
            facturasFiltradas = facturasFiltradas.filter((factura) => {
              const fechaFactura = new Date(factura.fecha);

              // Filtros r√°pidos
              if (filtroRapido) {
                const hoy = new Date();
                const inicioDia = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

                switch (filtroRapido) {
                  case 'hoy':
                    return fechaFactura >= inicioDia;
                  case 'ayer':
                    const ayer = new Date(inicioDia);
                    ayer.setDate(ayer.getDate() - 1);
                    return fechaFactura >= ayer && fechaFactura < inicioDia;
                  case 'semana':
                    const inicioSemana = new Date(inicioDia);
                    inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
                    return fechaFactura >= inicioSemana;
                  case 'mes':
                    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    return fechaFactura >= inicioMes;
                  case 'mesAnterior':
                    const inicioMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    const finMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                    return fechaFactura >= inicioMesAnterior && fechaFactura <= finMesAnterior;
                  case 'trimestre':
                    const trimestre = Math.floor(hoy.getMonth() / 3);
                    const inicioTrimestre = new Date(hoy.getFullYear(), trimestre * 3, 1);
                    return fechaFactura >= inicioTrimestre;
                  case 'a√±o':
                    const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);
                    return fechaFactura >= inicioA√±o;
                }
              }

              // Filtros de fecha espec√≠fica
              if (fechaDesde && fechaFactura < new Date(fechaDesde)) {
                return false;
              }
              if (fechaHasta) {
                const fechaHastaObj = new Date(fechaHasta);
                fechaHastaObj.setHours(23, 59, 59, 999);
                if (fechaFactura > fechaHastaObj) {
                  return false;
                }
              }

              return true;
            });
          }

          // Aplicar filtro de √°rea
          if (filtroArea) {
            facturasFiltradas = facturasFiltradas.filter((factura) => factura.area === filtroArea);
          }

          // Aplicar filtro de m√©todo de pago
          if (filtroMetodo) {
            facturasFiltradas = facturasFiltradas.filter((factura) => factura.metodoPago === filtroMetodo);
          }

          // Aplicar b√∫squeda por texto
          if (busqueda) {
            facturasFiltradas = facturasFiltradas.filter(
              (factura) =>
                factura.numero.toLowerCase().includes(busqueda) ||
                factura.encargado.toLowerCase().includes(busqueda) ||
                factura.descripcion.toLowerCase().includes(busqueda)
            );
          }

          // Mostrar facturas filtradas
          mostrarFacturasFiltradas(facturasFiltradas);

          // Mostrar resumen de filtros aplicados
          const totalFiltradas = facturasFiltradas.length;
          const totalOriginal = facturas.length;
          mostrarMensaje(`‚úÖ Filtros aplicados: ${totalFiltradas} de ${totalOriginal} facturas`, 'success');
        } catch (error) {
          console.error('‚ùå Error aplicando filtros:', error);
          mostrarMensaje('‚ùå Error al aplicar filtros: ' + error.message, 'error');
        }
      }

      // Funci√≥n para mostrar facturas filtradas
      function mostrarFacturasFiltradas(facturasFiltradas) {
        const tbody = document.getElementById('facturasTableBody');
        if (!tbody) return;

        if (facturasFiltradas.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="axyra-text-center">
                <div class="axyra-empty-state">
                  <i class="fas fa-search" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                  <p>No se encontraron facturas con los filtros aplicados</p>
                  <button class="axyra-btn axyra-btn-primary" onclick="limpiarFiltrosFacturas()">
                    Limpiar Filtros
                  </button>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        // Mostrar facturas filtradas
        mostrarFacturas(facturasFiltradas);
      }

      // Funci√≥n para limpiar filtros
      function limpiarFiltrosFacturas() {
        document.getElementById('filterFechaDesde').value = '';
        document.getElementById('filterFechaHasta').value = '';
        document.getElementById('filterFechaFacturas').value = '';
        document.getElementById('filterAreaFacturas').value = '';
        document.getElementById('filterMetodoPago').value = '';
        document.getElementById('searchFacturas').value = '';

        // Recargar todas las facturas
        mostrarFacturas();
        mostrarMensaje('‚úÖ Filtros limpiados', 'success');
      }

      // Funci√≥n para mostrar modal de eliminaci√≥n
      function mostrarModalEliminarFactura(factura) {
        const modalHTML = `
          <div id="modalEliminarFactura" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Confirmar Eliminaci√≥n
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalEliminarFactura()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-confirmacion-container">
                  <div class="axyra-confirmacion-icon">
                    <i class="fas fa-trash-alt" style="color: #ef4444; font-size: 48px;"></i>
                  </div>
                  <div class="axyra-confirmacion-texto">
                    <h4>¬øEst√°s seguro de que deseas eliminar esta factura?</h4>
                    <p>Esta acci√≥n no se puede deshacer.</p>
                  </div>
                  <div class="axyra-factura-info">
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">N√∫mero:</span>
                      <span class="axyra-factura-value">${factura.numero}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Encargado:</span>
                      <span class="axyra-factura-value">${factura.encargado}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">√Årea:</span>
                      <span class="axyra-factura-value">${factura.area}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Monto:</span>
                      <span class="axyra-factura-value">$${factura.monto.toLocaleString('es-CO')}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Fecha:</span>
                      <span class="axyra-factura-value">${new Date(factura.fecha).toLocaleDateString('es-CO')}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModalEliminarFactura()">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="axyra-btn axyra-btn-danger" onclick="confirmarEliminarFactura('${
                  factura.id
                }')">
                  <i class="fas fa-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Funci√≥n para cerrar modal de eliminaci√≥n
      function cerrarModalEliminarFactura() {
        const modal = document.getElementById('modalEliminarFactura');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para confirmar eliminaci√≥n
      function confirmarEliminarFactura(id) {
        // Cerrar modal
        cerrarModalEliminarFactura();

        // Eliminar factura
        facturas = facturas.filter((f) => f.id !== id);
        localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

        mostrarFacturas();
        cargarResumen();

        mostrarMensaje('‚úÖ Factura eliminada correctamente', 'success');
      }

      // Exportar facturas a Excel profesional
      function exportarFacturas() {
        if (facturas.length === 0) {
          mostrarMensaje('‚ùå No hay facturas para exportar', 'warning');
          return;
        }

        try {
          // Verificar si XLSX est√° disponible
          if (typeof XLSX === 'undefined') {
            mostrarMensaje('Error: Librer√≠a XLSX no est√° disponible', 'error');
            return;
          }

          console.log('üìä Iniciando exportaci√≥n de facturas...');
          console.log('üìã Total de facturas a exportar:', facturas.length);

          // Crear datos para exportar
          const data = [
            ['REPORTE DE FACTURAS - Villa Venecia'],
            ['EMPRESA: Villa Venecia'],
            ['NIT: NIT Pendiente'],
            [`FECHA DE EXPORTACI√ìN: ${new Date().toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}`],
            [],
            ['ID', 'Empleado', 'C√©dula', 'Fecha', 'Concepto', 'Valor', 'Estado', 'Observaciones'],
          ];

          // Agregar datos de cada factura
          facturas.forEach((f, index) => {
            const empleado = empleados.find((e) => e.id === f.empleado_id);
            console.log(`üìù Procesando factura ${index + 1}:`, f.id, empleado?.nombre);

            data.push([
              f.id || 'N/A',
              empleado ? empleado.nombre : 'Empleado no encontrado',
              empleado ? empleado.cedula || 'N/A' : 'N/A',
              new Date(f.fecha).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' }),
              f.concepto || 'N/A',
              formatearMoneda(f.valor),
              f.estado || 'Activa',
              f.observaciones || 'N/A',
            ]);
          });

          // Agregar totales
          data.push([]);
          const totales = [
            'TOTALES',
            '',
            '',
            '',
            formatearMoneda(facturas.reduce((sum, f) => sum + (f.valor || 0), 0)),
            '',
            '',
          ];
          data.push(totales);

          console.log('üìä Datos preparados para exportaci√≥n');

          // Crear hoja de trabajo
          const ws = XLSX.utils.aoa_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Facturas');

          // Ajustar ancho de columnas
          ws['!cols'] = [
            { width: 8 },
            { width: 25 },
            { width: 15 },
            { width: 15 },
            { width: 30 },
            { width: 18 },
            { width: 12 },
            { width: 30 },
          ];

          // Generar nombre de archivo
          const now = new Date();
          const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
          const fileName = `REPORTE_FACTURAS_Villa_Venecia_${colombiaTime.toISOString().split('T')[0]}_${colombiaTime
            .getHours()
            .toString()
            .padStart(2, '0')}-${colombiaTime.getMinutes().toString().padStart(2, '0')}.xlsx`;

          console.log('üíæ Descargando archivo:', fileName);

          // Descargar archivo
          XLSX.writeFile(wb, fileName);

          console.log('‚úÖ Exportaci√≥n completada exitosamente');
          mostrarMensaje('Facturas exportadas correctamente con formato profesional', 'success');
        } catch (error) {
          console.error('‚ùå Error exportando facturas:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Funci√≥n para exportar cuadre de caja
      function exportarCuadreCaja() {
        try {
          if (facturas.length === 0) {
            mostrarMensaje('‚ùå No hay facturas para exportar', 'error');
            return;
          }

          // Verificar si XLSX est√° disponible
          if (typeof XLSX === 'undefined') {
            mostrarMensaje('Error: Librer√≠a XLSX no est√° disponible', 'error');
            return;
          }

          console.log('üìä Iniciando exportaci√≥n de cuadre de caja...');
          console.log('üìã Total de facturas a exportar:', facturas.length);

          // Crear datos para exportar
          const data = [
            ['CUADRE DE CAJA - Villa Venecia'],
            ['EMPRESA: Villa Venecia'],
            ['NIT: NIT Pendiente'],
            [`FECHA DE EXPORTACI√ìN: ${new Date().toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}`],
            [],
            ['ID', 'Empleado', 'C√©dula', 'Fecha', 'Concepto', 'Valor', 'Estado', 'Observaciones'],
          ];

          // Agregar datos de cada factura
          facturas.forEach((f, index) => {
            const empleado = empleados.find((e) => e.id === f.empleado_id);
            console.log(`üìù Procesando factura ${index + 1}:`, f.id, empleado?.nombre);

            data.push([
              f.id || 'N/A',
              empleado ? empleado.nombre : 'Empleado no encontrado',
              empleado ? empleado.cedula || 'N/A' : 'N/A',
              new Date(f.fecha).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' }),
              f.concepto || 'N/A',
              formatearMoneda(f.valor),
              f.estado || 'Activa',
              f.observaciones || 'N/A',
            ]);
          });

          // Agregar totales
          data.push([]);
          const totales = [
            'TOTALES',
            '',
            '',
            '',
            formatearMoneda(facturas.reduce((sum, f) => sum + (f.valor || 0), 0)),
            '',
            '',
          ];
          data.push(totales);

          console.log('üìä Datos preparados para exportaci√≥n');

          // Crear hoja de trabajo
          const ws = XLSX.utils.aoa_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Cuadre de Caja');

          // Ajustar ancho de columnas
          ws['!cols'] = [
            { width: 8 },
            { width: 25 },
            { width: 15 },
            { width: 15 },
            { width: 30 },
            { width: 18 },
            { width: 12 },
            { width: 30 },
          ];

          // Generar nombre de archivo
          const now = new Date();
          const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
          const fileName = `CUADRE_CAJA_Villa_Venecia_${colombiaTime.toISOString().split('T')[0]}_${colombiaTime
            .getHours()
            .toString()
            .padStart(2, '0')}-${colombiaTime.getMinutes().toString().padStart(2, '0')}.xlsx`;

          console.log('üíæ Descargando archivo:', fileName);

          // Descargar archivo
          XLSX.writeFile(wb, fileName);

          console.log('‚úÖ Exportaci√≥n completada exitosamente');
          mostrarMensaje('Cuadre de caja exportado correctamente con formato profesional', 'success');
        } catch (error) {
          console.error('‚ùå Error exportando cuadre de caja:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Limpiar historial
      function limpiarHistorial() {
        if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial? Esta acci√≥n no se puede deshacer.')) {
          facturas = [];
          localStorage.removeItem('axyra_facturas');

          mostrarFacturas();
          cargarResumen();

          mostrarMensaje('‚úÖ Historial limpiado correctamente', 'success');
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        document.body.appendChild(mensajeDiv);

        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }
    </script>

    <style>
      .axyra-currency-info {
        text-align: center;
        padding: var(--spacing-lg);
      }

      .axyra-currency-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        font-size: 1.1rem;
      }

      .axyra-currency-flag {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .axyra-currency-description {
        color: var(--axyra-gray-600);
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
      }

      /* Estilos para el modal de eliminaci√≥n */
      .axyra-confirmacion-container {
        text-align: center;
        padding: 20px;
      }

      .axyra-confirmacion-icon {
        margin-bottom: 20px;
      }

      .axyra-confirmacion-texto h4 {
        color: #1f2937;
        margin-bottom: 10px;
        font-size: 18px;
      }

      .axyra-confirmacion-texto p {
        color: #6b7280;
        margin-bottom: 25px;
      }

      .axyra-factura-info {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e2e8f0;
      }

      .axyra-factura-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .axyra-factura-item:last-child {
        border-bottom: none;
      }

      .axyra-factura-label {
        font-weight: 600;
        color: #374151;
      }

      .axyra-factura-value {
        font-weight: 500;
        color: #1f2937;
      }

      /* Bot√≥n de peligro */
      .axyra-btn-danger {
        background: #ef4444;
        color: white;
        border: none;
      }

      .axyra-btn-danger:hover {
        background: #dc2626;
      }

      /* Estilos para Dashboard Financiero */
      .axyra-financial-dashboard {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        border: 1px solid #bae6fd;
      }

      .axyra-financial-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .axyra-financial-header h3 {
        color: #0c4a6e;
        font-size: 1.8rem;
        margin: 0 0 10px 0;
        font-weight: 700;
      }

      .axyra-financial-header p {
        color: #0369a1;
        font-size: 1.1rem;
        margin: 0;
      }

      .axyra-financial-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
      }

      .axyra-financial-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0f2fe;
        transition: all 0.3s ease;
      }

      .axyra-financial-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      .axyra-financial-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f5f9;
      }

      .axyra-financial-card-header h4 {
        color: #0c4a6e;
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .axyra-financial-card-header p {
        color: #0369a1;
        margin: 5px 0 0 0;
        font-size: 0.9rem;
      }

      .axyra-financial-controls select {
        padding: 8px 12px;
        border: 2px solid #e0f2fe;
        border-radius: 8px;
        background: #f0f9ff;
        color: #0c4a6e;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .axyra-financial-controls select:focus {
        outline: none;
        border-color: #0284c7;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
      }

      .axyra-financial-chart {
        height: 250px;
        position: relative;
      }

      .axyra-financial-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .axyra-kpi-item {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #0284c7 0%, #0c4a6e 100%);
        border-radius: 12px;
        color: white;
      }

      .axyra-kpi-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .axyra-kpi-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Responsive para dashboard financiero */
      @media (max-width: 768px) {
        .axyra-financial-grid {
          grid-template-columns: 1fr;
        }

        .axyra-financial-metrics {
          grid-template-columns: 1fr;
        }
      }

      /* Estilos para √∫ltima factura */
      .axyra-ultima-factura-container {
        text-align: center;
        padding: 30px;
      }

      .axyra-ultima-factura-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .axyra-ultima-factura-monto {
        font-size: 2.5rem;
        font-weight: 700;
        color: #10b981;
        text-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }

      .axyra-ultima-factura-details {
        font-size: 1.1rem;
        color: #374151;
        font-weight: 500;
        max-width: 400px;
        line-height: 1.4;
      }

      .axyra-ultima-factura-time {
        font-size: 0.9rem;
        color: #6b7280;
        font-style: italic;
      }

      /* Estilos para filtros de fecha */
      .axyra-date-filters {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .axyra-date-filters input[type='date'] {
        min-width: 140px;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .axyra-date-filters input[type='date']:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Estado vac√≠o para tabla */
      .axyra-empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .axyra-empty-state i {
        display: block;
        margin-bottom: 1rem;
      }

      .axyra-empty-state p {
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
      }

      /* Responsive para resumen */
      @media (max-width: 1200px) {
        .axyra-summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .axyra-summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .axyra-ultima-factura-monto {
          font-size: 2rem;
        }
      }
    </style>

    <!-- Inicializaci√≥n autom√°tica del m√≥dulo de cuadre de caja -->
    <script>
      // Inicializar m√≥dulo de cuadre de caja cuando se carga la p√°gina
      document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ M√≥dulo de cuadre de caja cargado, verificando autenticaci√≥n...');

        // Esperar un poco para que se carguen todos los scripts
        setTimeout(async () => {
          await inicializarCuadreCaja();
        }, 500);
      });

      // Funci√≥n para cargar datos desde Firebase
      async function cargarDatosFirebase() {
        try {
          console.log('üîÑ Cargando datos desde Firebase...');

          // Verificar si Firebase est√° disponible
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.warn('‚ö†Ô∏è Firebase no disponible, usando localStorage como fallback');
            await cargarDatosLocalStorage();
            return;
          }

          const db = firebase.firestore();

          // Obtener userId del usuario autenticado en Firebase
          let userId = null;

          // Intentar obtener el usuario actual de Firebase Auth
          if (firebase.auth().currentUser) {
            userId = firebase.auth().currentUser.uid;
            console.log('‚úÖ Usuario autenticado en Firebase:', userId);
          } else {
            // Fallback: buscar en localStorage o usar el usuario aislado
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              const user = JSON.parse(userData);
              userId = user.username || user.email;
            }

            if (!userId) {
              console.warn('‚ö†Ô∏è No se puede identificar usuario, usando localStorage');
              await cargarDatosLocalStorage();
              return;
            }
          }

          console.log('üîç Buscando datos para userId:', userId);

          // Cargar empleados desde Firebase - buscar por userId
          try {
            const empleadosSnapshot = await db.collection('empleados').where('userId', '==', userId).get();

            empleados = empleadosSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`‚úÖ ${empleados.length} empleados cargados desde Firebase para userId: ${userId}`);

            // Si no hay empleados con ese userId, intentar buscar sin filtro
            if (empleados.length === 0) {
              console.log('üîç No se encontraron empleados con userId espec√≠fico, buscando todos...');
              const allEmpleadosSnapshot = await db.collection('empleados').get();
              empleados = allEmpleadosSnapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              console.log(`‚úÖ ${empleados.length} empleados totales encontrados en Firebase`);
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando empleados desde Firebase:', error);
            empleados = [];
          }

          // Cargar facturas desde Firebase
          try {
            const facturasSnapshot = await db.collection('facturas').where('userId', '==', userId).get();

            facturas = facturasSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`‚úÖ ${facturas.length} facturas cargadas desde Firebase`);
          } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando facturas desde Firebase:', error);
            facturas = [];
          }

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_facturas', JSON.stringify(facturas));
        } catch (error) {
          console.error('‚ùå Error cargando datos desde Firebase:', error);
          // Fallback a localStorage
          await cargarDatosLocalStorage();
        }
      }

      // Funci√≥n para cargar datos desde localStorage (fallback)
      async function cargarDatosLocalStorage() {
        try {
          console.log('üîÑ Cargando datos desde localStorage...');

          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username;
            });
          }

          // Cargar facturas
          const facturasData = localStorage.getItem('axyra_facturas');
          if (facturasData) {
            facturas = JSON.parse(facturasData);
            // Filtrar por usuario actual
            facturas = facturas.filter((f) => {
              if (!f.userId) return true; // Datos globales
              return f.userId === currentUser?.username;
            });
          }

          console.log(
            `‚úÖ Datos cargados desde localStorage: ${empleados.length} empleados, ${facturas.length} facturas`
          );
        } catch (error) {
          console.error('‚ùå Error cargando datos desde localStorage:', error);
        }
      }

      // Funci√≥n de inicializaci√≥n mejorada
      async function inicializarCuadreCaja() {
        try {
          console.log('üöÄ Inicializando m√≥dulo de cuadre de caja...');

          // Verificar autenticaci√≥n
          await verificarAutenticacion();

          // Intentar cargar desde Firebase primero
          await cargarDatosFirebase();

          // Los selects no son necesarios en este m√≥dulo

          // Renderizar tabla
          renderizarTablaFacturas();

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();

          console.log('‚úÖ M√≥dulo de cuadre de caja inicializado correctamente');
        } catch (error) {
          console.error('‚ùå Error inicializando cuadre de caja:', error);
          mostrarNotificacion('Error inicializando m√≥dulo de cuadre de caja', 'error');
        }
      }

      // FUNCIONES AVANZADAS DE CUADRE DE CAJA - IMPLEMENTACI√ìN COMPLETA

      // Funci√≥n para generar reporte financiero completo
      function generarReporteFinanciero() {
        try {
          console.log('üîÑ Generando reporte financiero completo...');

          if (facturas.length === 0) {
            mostrarNotificacion('No hay facturas para generar reporte', 'warning');
            return;
          }

          // Calcular totales por per√≠odo
          const reporte = {
            totalIngresos: facturas.reduce((total, f) => total + parseFloat(f.valor || 0), 0),
            totalFacturas: facturas.length,
            facturasAprobadas: facturas.filter((f) => f.estado === 'APROBADA').length,
            facturasPendientes: facturas.filter((f) => f.estado === 'PENDIENTE').length,
            promedioPorFactura: 0,
            ingresosPorMes: {},
            ingresosPorEncargado: {},
          };

          // Calcular promedio
          reporte.promedioPorFactura = reporte.totalIngresos / reporte.totalFacturas;

          // Agrupar por mes
          facturas.forEach((factura) => {
            const fecha = new Date(factura.fecha);
            const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;

            if (!reporte.ingresosPorMes[mes]) {
              reporte.ingresosPorMes[mes] = 0;
            }
            reporte.ingresosPorMes[mes] += parseFloat(factura.valor || 0);
          });

          // Agrupar por encargado
          facturas.forEach((factura) => {
            const encargado = factura.encargado || 'Sin asignar';
            if (!reporte.ingresosPorEncargado[encargado]) {
              reporte.ingresosPorEncargado[encargado] = 0;
            }
            reporte.ingresosPorEncargado[encargado] += parseFloat(factura.valor || 0);
          });

          // Crear reporte en Excel
          const datosExcel = [
            ['REPORTE FINANCIERO - VILLA VENECIA'],
            ['Fecha de generaci√≥n: ' + new Date().toLocaleDateString()],
            [''],
            ['RESUMEN GENERAL'],
            ['Total Ingresos', `$${reporte.totalIngresos.toLocaleString()}`],
            ['Total Facturas', reporte.totalFacturas],
            ['Facturas Aprobadas', reporte.facturasAprobadas],
            ['Facturas Pendientes', reporte.facturasPendientes],
            ['Promedio por Factura', `$${reporte.promedioPorFactura.toLocaleString()}`],
            [''],
            ['INGRESOS POR MES'],
            ['Mes', 'Total Ingresos'],
          ];

          // Agregar datos por mes
          Object.entries(reporte.ingresosPorMes)
            .sort(([a], [b]) => a.localeCompare(b))
            .forEach(([mes, total]) => {
              datosExcel.push([mes, `$${total.toLocaleString()}`]);
            });

          datosExcel.push(['', '']);
          datosExcel.push(['INGRESOS POR ENCARGADO']);
          datosExcel.push(['Encargado', 'Total Ingresos']);

          // Agregar datos por encargado
          Object.entries(reporte.ingresosPorEncargado)
            .sort(([, a], [, b]) => b - a)
            .forEach(([encargado, total]) => {
              datosExcel.push([encargado, `$${total.toLocaleString()}`]);
            });

          // Crear libro de Excel
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [{ width: 30 }, { width: 20 }];

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Reporte Financiero');

          // Generar nombre de archivo
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `Reporte_Financiero_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);

          console.log('‚úÖ Reporte financiero generado:', nombreArchivo);
          mostrarNotificacion('‚úÖ Reporte financiero generado correctamente', 'success');
        } catch (error) {
          console.error('‚ùå Error generando reporte financiero:', error);
          mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
        }
      }

      // Funci√≥n para conciliaci√≥n bancaria
      function generarConciliacionBancaria() {
        try {
          console.log('üîÑ Generando conciliaci√≥n bancaria...');

          // Simular datos bancarios (en producci√≥n vendr√≠an de API bancaria)
          const datosBancarios = {
            saldoCuenta: 15000000,
            movimientos: [
              { fecha: '2024-01-15', descripcion: 'Dep√≥sito factura #001', monto: 250000, tipo: 'CREDITO' },
              { fecha: '2024-01-16', descripcion: 'Dep√≥sito factura #002', monto: 180000, tipo: 'CREDITO' },
              { fecha: '2024-01-17', descripcion: 'Retiro caja menor', monto: -50000, tipo: 'DEBITO' },
            ],
          };

          // Comparar con facturas registradas
          const facturasDelDia = facturas.filter((f) => {
            const fechaFactura = new Date(f.fecha);
            const hoy = new Date();
            return fechaFactura.toDateString() === hoy.toDateString();
          });

          const totalFacturasDia = facturasDelDia.reduce((total, f) => total + parseFloat(f.valor || 0), 0);

          // Crear reporte de conciliaci√≥n
          const conciliacion = {
            saldoSistema: totalFacturasDia,
            saldoBanco: datosBancarios.saldoCuenta,
            diferencia: totalFacturasDia - datosBancarios.saldoCuenta,
            estado: Math.abs(totalFacturasDia - datosBancarios.saldoCuenta) < 1000 ? 'CONCILIADO' : 'SIN CONCILIAR',
          };

          // Mostrar modal de conciliaci√≥n
          mostrarModalConciliacion(conciliacion, facturasDelDia, datosBancarios.movimientos);
        } catch (error) {
          console.error('‚ùå Error generando conciliaci√≥n bancaria:', error);
          mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
        }
      }

      // Funci√≥n para mostrar modal de conciliaci√≥n
      function mostrarModalConciliacion(conciliacion, facturas, movimientos) {
        const modalHTML = `
          <div class="axyra-modal-overlay" id="modalConciliacion">
            <div class="axyra-modal">
              <div class="axyra-modal-header">
                <h3>Conciliaci√≥n Bancaria</h3>
                <button onclick="cerrarModalConciliacion()" class="axyra-modal-close">&times;</button>
              </div>
              <div class="axyra-modal-content">
                <div class="detalle-section">
                  <h4>Estado de Conciliaci√≥n</h4>
                  <div class="detalle-row">
                    <span class="detalle-label">Saldo Sistema:</span>
                    <span class="detalle-value">$${conciliacion.saldoSistema.toLocaleString()}</span>
                  </div>
                  <div class="detalle-row">
                    <span class="detalle-label">Saldo Banco:</span>
                    <span class="detalle-value">$${conciliacion.saldoBanco.toLocaleString()}</span>
                  </div>
                  <div class="detalle-row total">
                    <span class="detalle-label">Diferencia:</span>
                    <span class="detalle-value ${conciliacion.diferencia === 0 ? 'text-success' : 'text-danger'}">
                      $${conciliacion.diferencia.toLocaleString()}
                    </span>
                  </div>
                  <div class="detalle-row">
                    <span class="detalle-label">Estado:</span>
                    <span class="badge badge-${conciliacion.estado === 'CONCILIADO' ? 'success' : 'warning'}">
                      ${conciliacion.estado}
                    </span>
                  </div>
                </div>
                
                <div class="detalle-section">
                  <h4>Facturas del D√≠a</h4>
                  ${facturas
                    .map(
                      (f) => `
                    <div class="detalle-row">
                      <span>${f.numeroFactura} - ${f.cliente}</span>
                      <span>$${parseFloat(f.valor).toLocaleString()}</span>
                    </div>
                  `
                    )
                    .join('')}
                </div>
                
                <div class="detalle-section">
                  <h4>Movimientos Bancarios</h4>
                  ${movimientos
                    .map(
                      (m) => `
                    <div class="detalle-row">
                      <span>${m.fecha} - ${m.descripcion}</span>
                      <span class="${m.tipo === 'CREDITO' ? 'text-success' : 'text-danger'}">
                        $${m.monto.toLocaleString()}
                      </span>
                    </div>
                  `
                    )
                    .join('')}
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button onclick="exportarConciliacion()" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-download"></i> Exportar
                </button>
                <button onclick="cerrarModalConciliacion()" class="axyra-btn axyra-btn-secondary">
                  Cerrar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Funci√≥n para cerrar modal de conciliaci√≥n
      function cerrarModalConciliacion() {
        const modal = document.getElementById('modalConciliacion');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para exportar conciliaci√≥n
      function exportarConciliacion() {
        try {
          // Implementar exportaci√≥n de conciliaci√≥n
          mostrarNotificacion('‚úÖ Conciliaci√≥n exportada correctamente', 'success');
        } catch (error) {
          console.error('‚ùå Error exportando conciliaci√≥n:', error);
        }
      }

      // Funci√≥n para integraci√≥n con facturaci√≥n
      function integrarConFacturacion() {
        try {
          console.log('üîÑ Integrando con sistema de facturaci√≥n...');

          // Simular integraci√≥n con sistema externo
          const facturasExternas = [
            { numero: 'EXT-001', cliente: 'Cliente Externo 1', valor: 350000, fecha: '2024-01-15' },
            { numero: 'EXT-002', cliente: 'Cliente Externo 2', valor: 420000, fecha: '2024-01-16' },
          ];

          // Sincronizar facturas externas
          facturasExternas.forEach((facturaExt) => {
            const existe = facturas.find((f) => f.numeroFactura === facturaExt.numero);
            if (!existe) {
              const nuevaFactura = {
                id: Date.now() + Math.random(),
                numeroFactura: facturaExt.numero,
                cliente: facturaExt.cliente,
                valor: facturaExt.valor,
                fecha: facturaExt.fecha,
                encargado: 'Sistema Externo',
                cedulaEncargado: '00000000',
                estado: 'APROBADA',
                origen: 'SISTEMA_EXTERNO',
                userId: currentUser?.username || 'sistema',
              };

              facturas.push(nuevaFactura);
            }
          });

          // Guardar cambios
          localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

          // Actualizar tabla
          renderizarTablaFacturas();

          console.log('‚úÖ Integraci√≥n con facturaci√≥n completada');
          mostrarNotificacion('‚úÖ Facturas externas sincronizadas correctamente', 'success');
        } catch (error) {
          console.error('‚ùå Error en integraci√≥n con facturaci√≥n:', error);
          mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
        }
      }

      // Funci√≥n para an√°lisis de tendencias
      function analizarTendencias() {
        try {
          console.log('üîÑ Analizando tendencias de ingresos...');

          if (facturas.length < 7) {
            mostrarNotificacion('Se necesitan al menos 7 d√≠as de datos para analizar tendencias', 'warning');
            return;
          }

          // Agrupar por d√≠a de la semana
          const tendenciasPorDia = {};
          const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

          facturas.forEach((factura) => {
            const fecha = new Date(factura.fecha);
            const diaSemana = diasSemana[fecha.getDay()];

            if (!tendenciasPorDia[diaSemana]) {
              tendenciasPorDia[diaSemana] = { total: 0, cantidad: 0 };
            }

            tendenciasPorDia[diaSemana].total += parseFloat(factura.valor || 0);
            tendenciasPorDia[diaSemana].cantidad += 1;
          });

          // Calcular promedios
          Object.keys(tendenciasPorDia).forEach((dia) => {
            tendenciasPorDia[dia].promedio = tendenciasPorDia[dia].total / tendenciasPorDia[dia].cantidad;
          });

          // Mostrar resultados
          mostrarModalTendencias(tendenciasPorDia);
        } catch (error) {
          console.error('‚ùå Error analizando tendencias:', error);
          mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
        }
      }

      // Funci√≥n para mostrar modal de tendencias
      function mostrarModalTendencias(tendencias) {
        const modalHTML = `
          <div class="axyra-modal-overlay" id="modalTendencias">
            <div class="axyra-modal">
              <div class="axyra-modal-header">
                <h3>An√°lisis de Tendencias</h3>
                <button onclick="cerrarModalTendencias()" class="axyra-modal-close">&times;</button>
              </div>
              <div class="axyra-modal-content">
                <div class="detalle-section">
                  <h4>Ingresos por D√≠a de la Semana</h4>
                  ${Object.entries(tendencias)
                    .map(
                      ([dia, datos]) => `
                    <div class="detalle-row">
                      <span class="detalle-label">${dia}:</span>
                      <span class="detalle-value">
                        $${datos.total.toLocaleString()} (${datos.cantidad} facturas)
                      </span>
                    </div>
                    <div class="detalle-row">
                      <span class="detalle-label">Promedio:</span>
                      <span class="detalle-value">$${datos.promedio.toLocaleString()}</span>
                    </div>
                  `
                    )
                    .join('')}
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button onclick="exportarTendencias()" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-download"></i> Exportar
                </button>
                <button onclick="cerrarModalTendencias()" class="axyra-btn axyra-btn-secondary">
                  Cerrar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Funci√≥n para cerrar modal de tendencias
      function cerrarModalTendencias() {
        const modal = document.getElementById('modalTendencias');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para exportar tendencias
      function exportarTendencias() {
        try {
          // Implementar exportaci√≥n de tendencias
          mostrarNotificacion('‚úÖ An√°lisis de tendencias exportado correctamente', 'success');
        } catch (error) {
          console.error('‚ùå Error exportando tendencias:', error);
        }
      }

      // Variables globales para gr√°ficos financieros
      let ingresosMensualesChart, rendimientoEncargadoChart, tendenciasDiariasChart;

      // Funci√≥n para inicializar gr√°ficos financieros
      function inicializarGraficosFinancieros() {
        try {
          // Gr√°fico de Ingresos Mensuales
          const ctxIngresos = document.getElementById('ingresosMensualesChart');
          if (ctxIngresos) {
            ingresosMensualesChart = new Chart(ctxIngresos, {
              type: 'line',
              data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [
                  {
                    label: 'Ingresos Mensuales',
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    borderColor: '#0284c7',
                    backgroundColor: 'rgba(2, 132, 199, 0.1)',
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                  },
                  title: {
                    display: true,
                    text: 'Evoluci√≥n de Ingresos Mensuales',
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return '$' + value.toLocaleString();
                      },
                    },
                  },
                },
              },
            });
          }

          // Gr√°fico de Rendimiento por Encargado
          const ctxRendimiento = document.getElementById('rendimientoEncargadoChart');
          if (ctxRendimiento) {
            rendimientoEncargadoChart = new Chart(ctxRendimiento, {
              type: 'bar',
              data: {
                labels: [],
                datasets: [
                  {
                    label: 'Ingresos por Encargado',
                    data: [],
                    backgroundColor: 'rgba(2, 132, 199, 0.8)',
                    borderColor: '#0284c7',
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                  },
                  title: {
                    display: true,
                    text: 'Rendimiento del Equipo',
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return '$' + value.toLocaleString();
                      },
                    },
                  },
                },
              },
            });
          }

          // Gr√°fico de Tendencias Diarias
          const ctxTendencias = document.getElementById('tendenciasDiariasChart');
          if (ctxTendencias) {
            tendenciasDiariasChart = new Chart(ctxTendencias, {
              type: 'radar',
              data: {
                labels: ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'],
                datasets: [
                  {
                    label: 'Ingresos por D√≠a',
                    data: [0, 0, 0, 0, 0, 0, 0],
                    borderColor: '#0c4a6e',
                    backgroundColor: 'rgba(12, 74, 110, 0.2)',
                    pointBackgroundColor: '#0284c7',
                    pointBorderColor: '#0c4a6e',
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                  },
                  title: {
                    display: true,
                    text: 'Patrones Semanales de Ingresos',
                  },
                },
                scales: {
                  r: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return '$' + value.toLocaleString();
                      },
                    },
                  },
                },
              },
            });
          }

          // Actualizar datos iniciales
          actualizarGraficosFinancieros();
          actualizarKPIsFinancieros();
        } catch (error) {
          console.error('‚ùå Error inicializando gr√°ficos financieros:', error);
        }
      }

      // Funci√≥n para actualizar todos los gr√°ficos financieros
      function actualizarGraficosFinancieros() {
        try {
          const a√±o = document.getElementById('financialYear').value;
          actualizarGraficoIngresosMensuales(a√±o);
          actualizarGraficoRendimientoEncargado();
          actualizarGraficoTendenciasDiarias();
          actualizarKPIsFinancieros();
        } catch (error) {
          console.error('‚ùå Error actualizando gr√°ficos financieros:', error);
        }
      }

      // Actualizar gr√°fico de ingresos mensuales
      function actualizarGraficoIngresosMensuales(a√±o) {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          const ingresosMensuales = new Array(12).fill(0);

          facturas.forEach((factura) => {
            const fecha = new Date(factura.fecha);
            if (fecha.getFullYear() == a√±o) {
              const mes = fecha.getMonth();
              ingresosMensuales[mes] += parseFloat(factura.valor || 0);
            }
          });

          if (ingresosMensualesChart) {
            ingresosMensualesChart.data.datasets[0].data = ingresosMensuales;
            ingresosMensualesChart.update();
          }
        } catch (error) {
          console.error('‚ùå Error actualizando ingresos mensuales:', error);
        }
      }

      // Actualizar gr√°fico de rendimiento por encargado
      function actualizarGraficoRendimientoEncargado() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          const rendimientoPorEncargado = {};

          facturas.forEach((factura) => {
            const encargado = factura.encargado || 'Sin asignar';
            rendimientoPorEncargado[encargado] =
              (rendimientoPorEncargado[encargado] || 0) + parseFloat(factura.valor || 0);
          });

          const encargados = Object.keys(rendimientoPorEncargado).slice(0, 8); // Top 8
          const valores = encargados.map((encargado) => rendimientoPorEncargado[encargado]);

          if (rendimientoEncargadoChart) {
            rendimientoEncargadoChart.data.labels = encargados;
            rendimientoEncargadoChart.data.datasets[0].data = valores;
            rendimientoEncargadoChart.update();
          }
        } catch (error) {
          console.error('‚ùå Error actualizando rendimiento por encargado:', error);
        }
      }

      // Actualizar gr√°fico de tendencias diarias
      function actualizarGraficoTendenciasDiarias() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          const ingresosPorDia = new Array(7).fill(0);

          facturas.forEach((factura) => {
            const fecha = new Date(factura.fecha);
            const diaSemana = fecha.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            ingresosPorDia[diaSemana] += parseFloat(factura.valor || 0);
          });

          // Reorganizar para que Lunes sea el primer d√≠a
          const ingresosReorganizados = [
            ingresosPorDia[1], // Lunes
            ingresosPorDia[2], // Martes
            ingresosPorDia[3], // Mi√©rcoles
            ingresosPorDia[4], // Jueves
            ingresosPorDia[5], // Viernes
            ingresosPorDia[6], // S√°bado
            ingresosPorDia[0], // Domingo
          ];

          if (tendenciasDiariasChart) {
            tendenciasDiariasChart.data.datasets[0].data = ingresosReorganizados;
            tendenciasDiariasChart.update();
          }
        } catch (error) {
          console.error('‚ùå Error actualizando tendencias diarias:', error);
        }
      }

      // Actualizar KPIs financieros
      function actualizarKPIsFinancieros() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

          // Calcular ingreso promedio
          const totalIngresos = facturas.reduce((sum, f) => sum + parseFloat(f.valor || 0), 0);
          const ingresoPromedio = facturas.length > 0 ? totalIngresos / facturas.length : 0;

          // Calcular facturas por d√≠a (√∫ltimos 30 d√≠as)
          const fechaLimite = new Date();
          fechaLimite.setDate(fechaLimite.getDate() - 30);
          const facturasRecientes = facturas.filter((f) => new Date(f.fecha) >= fechaLimite);
          const facturasPorDia = facturasRecientes.length / 30;

          // Calcular crecimiento mensual
          const mesActual = new Date().getMonth();
          const a√±oActual = new Date().getFullYear();
          const facturasMesActual = facturas.filter((f) => {
            const fecha = new Date(f.fecha);
            return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
          });
          const facturasMesAnterior = facturas.filter((f) => {
            const fecha = new Date(f.fecha);
            const mesAnterior = mesActual === 0 ? 11 : mesActual - 1;
            const a√±oAnterior = mesActual === 0 ? a√±oActual - 1 : a√±oActual;
            return fecha.getMonth() === mesAnterior && fecha.getFullYear() === a√±oAnterior;
          });

          const ingresosMesActual = facturasMesActual.reduce((sum, f) => sum + parseFloat(f.valor || 0), 0);
          const ingresosMesAnterior = facturasMesAnterior.reduce((sum, f) => sum + parseFloat(f.valor || 0), 0);
          const crecimientoMensual =
            ingresosMesAnterior > 0 ? ((ingresosMesActual - ingresosMesAnterior) / ingresosMesAnterior) * 100 : 0;

          // Actualizar UI
          document.getElementById('ingresoPromedio').textContent =
            '$' + ingresoPromedio.toLocaleString(undefined, { maximumFractionDigits: 0 });
          document.getElementById('facturasPorDia').textContent = facturasPorDia.toFixed(1);
          document.getElementById('crecimientoMensual').textContent = crecimientoMensual.toFixed(1) + '%';
          
          // Actualizar total de ventas del mes actual
          const totalVentasElement = document.getElementById('totalVentas');
          if (totalVentasElement) {
            totalVentasElement.textContent = '$' + ingresosMesActual.toLocaleString(undefined, { maximumFractionDigits: 0 });
          }
        } catch (error) {
          console.error('‚ùå Error actualizando KPIs financieros:', error);
        }
      }

      // Agregar funciones al scope global
      window.generarReporteFinanciero = generarReporteFinanciero;
      window.generarConciliacionBancaria = generarConciliacionBancaria;
      window.integrarConFacturacion = integrarConFacturacion;
      window.analizarTendencias = analizarTendencias;
      window.cerrarModalConciliacion = cerrarModalConciliacion;
      window.cerrarModalTendencias = cerrarModalTendencias;
      window.exportarConciliacion = exportarConciliacion;
      window.exportarTendencias = exportarTendencias;
      window.actualizarGraficosFinancieros = actualizarGraficosFinancieros;
    </script>
    
    <!-- Chat de IA AXYRA - Cargar al final -->
    <script src="../../static/axyra-ai-global.js"></script>
  </body>
</html>
