<!-- frontend/cuadre_caja.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Cuadre de Caja</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../../static/work-areas-config.js"></script>
    <script src="../../static/cash-reconciliation-export.js"></script>
    <script src="../../static/excel-export.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>
    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-calculator"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Cuadre de Caja</div>
          </div>
        </div>
        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link"> <i class="fas fa-home"></i> Inicio </a>
          <a href="../dashboard/dashboard.html" class="axyra-nav-link">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="../nomina/gestionar_nomina.html" class="axyra-nav-link">
            <i class="fas fa-file-invoice-dollar"></i> N√≥mina
          </a>
          <a href="cuadre_caja.html" class="axyra-nav-link active">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuraci√≥n
          </a>
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Cuadre de Caja</h1>
          <p class="axyra-page-subtitle">Registro de ingresos por factura individual y control de caja</p>
        </div>

        <!-- Registrar Nueva Factura -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Registrar Nueva Factura</h3>
              <p class="axyra-card-subtitle">Ingresa los datos de la factura</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <form id="formFactura" class="axyra-form">
              <div class="axyra-form-grid">
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Fecha</label>
                  <input type="date" id="fecha" class="axyra-form-input" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Encargado</label>
                  <input
                    type="text"
                    id="encargado"
                    class="axyra-form-input"
                    placeholder="Nombre del encargado"
                    required
                  />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">N√∫mero de Factura</label>
                  <input type="text" id="numeroFactura" class="axyra-form-input" placeholder="Ej: 3945" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">√Årea</label>
                  <select id="area" class="axyra-form-select" required data-axyra-area-config="select">
                    <option value="">Seleccionar √°rea</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Monto</label>
                  <input
                    type="number"
                    id="monto"
                    class="axyra-form-input"
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                    required
                  />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">M√©todo de Pago</label>
                  <select id="metodoPago" class="axyra-form-select" required>
                    <option value="">Seleccionar m√©todo</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="datafono">Datafono</option>
                    <option value="qr">QR</option>
                    <option value="cheque">Cheque</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Descripci√≥n</label>
                  <textarea
                    id="descripcion"
                    class="axyra-form-textarea"
                    placeholder="Descripci√≥n de la factura"
                    rows="3"
                  ></textarea>
                </div>
              </div>
              <div class="axyra-form-actions">
                <button type="submit" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-save"></i> Registrar Factura
                </button>
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="limpiarFormulario()">
                  <i class="fas fa-eraser"></i> Limpiar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Resumen del D√≠a -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Resumen del D√≠a</h3>
              <p class="axyra-card-subtitle">Total de ingresos y facturas del d√≠a</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-caja-summary">
              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalFacturas">0</div>
                  <div class="axyra-summary-label">Total Facturas</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalIngresos">$0</div>
                  <div class="axyra-summary-label">Total Ingresos</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalEfectivo">$0</div>
                  <div class="axyra-summary-label">Efectivo</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-university"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalTransferencias">$0</div>
                  <div class="axyra-summary-label">Transferencias</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalDatafono">$0</div>
                  <div class="axyra-summary-label">Datafono</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-qrcode"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalQR">$0</div>
                  <div class="axyra-summary-label">QR</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-money-check"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalCheque">$0</div>
                  <div class="axyra-summary-label">Cheque</div>
                </div>
              </div>

              <div class="axyra-summary-card">
                <div class="axyra-summary-icon">
                  <i class="fas fa-ellipsis-h"></i>
                </div>
                <div class="axyra-summary-content">
                  <div class="axyra-summary-number" id="totalOtros">$0</div>
                  <div class="axyra-summary-label">Otros</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- √öltima Factura -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">√öltima Factura</h3>
              <p class="axyra-card-subtitle">Informaci√≥n de la √∫ltima factura registrada</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-ultima-factura-container">
              <div class="axyra-ultima-factura-info">
                <div class="axyra-ultima-factura-monto" id="ultimaFactura">$0</div>
                <div class="axyra-ultima-factura-details" id="ultimaFacturaInfo">No hay facturas registradas</div>
                <div class="axyra-ultima-factura-time" id="ultimaFacturaTime"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Historial de Facturas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Historial de Facturas</h3>
              <p class="axyra-card-subtitle">Todas las facturas registradas</p>
            </div>
          </div>

          <!-- Filtros Mejorados -->
          <div class="axyra-filters-enhanced">
            <div class="axyra-search-box">
              <input
                type="text"
                id="searchFacturas"
                class="axyra-form-input"
                placeholder="Buscar por n√∫mero o encargado..."
              />
              <i class="fas fa-search"></i>
            </div>
            <div class="axyra-filter-group">
              <select id="filterFechaFacturas" class="axyra-form-select">
                <option value="">Todas las fechas</option>
                <option value="hoy">Hoy</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este mes</option>
                <option value="trimestre">Este trimestre</option>
              </select>
              <select id="filterAreaFacturas" class="axyra-form-select">
                <option value="">Todas las √°reas</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
                <option value="Ventas">Ventas</option>
                <option value="Producci√≥n">Producci√≥n</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
              </select>
              <select id="filterMetodoPago" class="axyra-form-select">
                <option value="">Todos los m√©todos</option>
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="tarjeta">Tarjeta</option>
              </select>
            </div>
            <button class="axyra-btn axyra-btn-primary" onclick="exportarFacturas()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>

          <div class="axyra-card-content">
            <div class="axyra-actions-bar">
              <button class="axyra-btn axyra-btn-success" onclick="exportarCuadreCaja()">
                <i class="fas fa-file-excel"></i> Exportar Cuadre de Caja
              </button>
              <button class="axyra-btn axyra-btn-primary" onclick="cargarResumen()">
                <i class="fas fa-sync-alt"></i> Actualizar Resumen
              </button>
              <button class="axyra-btn axyra-btn-warning" onclick="limpiarHistorial()">
                <i class="fas fa-trash"></i> Limpiar Historial
              </button>
            </div>

            <div class="axyra-table-container">
              <table class="axyra-table" id="facturasTable">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N√∫mero</th>
                    <th>Encargado</th>
                    <th>√Årea</th>
                    <th>Monto</th>
                    <th>M√©todo de Pago</th>
                    <th>Descripci√≥n</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="facturasTableBody">
                  <!-- Las facturas se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>

            <!-- Paginaci√≥n -->
            <div class="axyra-pagination">
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaFacturas(-1)">
                <i class="fas fa-chevron-left"></i> Anterior
              </button>
              <span id="paginaFacturasInfo">P√°gina 1 de 1</span>
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaFacturas(1)">
                Siguiente <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="axyra-footer">
      <div class="axyra-container">
        <div class="axyra-footer-content">
          <p>&copy; 2025 AXYRA. Sistema de Gesti√≥n Empresarial.</p>
        </div>
      </div>
    </footer>

    <script>
      // Verificar autenticaci√≥n
      async function checkAuth() {
        try {
          console.log('üîê Verificando autenticaci√≥n en cuadre de caja...');

          // Verificar sesi√≥n usando Firebase
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            const currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('‚úÖ Usuario autenticado con Firebase en cuadre de caja:', currentUser.email);
            return true;
          }

          // Verificar sesi√≥n usando localStorage como fallback
          const user = localStorage.getItem('axyra_isolated_user');
          if (user) {
            try {
              const userData = JSON.parse(user);
              if (userData && (userData.username || userData.email)) {
                console.log(
                  '‚úÖ Usuario autenticado con localStorage en cuadre de caja:',
                  userData.username || userData.email
                );
                return true;
              }
            } catch (error) {
              console.error('Error parseando sesi√≥n de localStorage:', error);
            }
          }

          // No hay sesi√≥n activa
          console.log('‚ö†Ô∏è No hay sesi√≥n activa en cuadre de caja - redirigiendo al login');
          window.location.href = '../../login.html';
          return false;
        } catch (error) {
          console.error('‚ùå Error al verificar sesi√≥n en cuadre de caja:', error);
          window.location.href = '../../login.html';
          return false;
        }
      }

      // Cerrar sesi√≥n - SISTEMA AISLADO
      function logout() {
        console.log('üîÑ Cerrando sesi√≥n desde cuadre de caja...');

        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }

        console.log('‚úÖ Sesi√≥n cerrada desde cuadre de caja');
        window.location.href = '../../login.html';
      }

      // Variables globales
      let facturas = [];
      let monedaActual = 'COP';

      // Inicializaci√≥n
      window.addEventListener('load', async () => {
        try {
          console.log('üöÄ AXYRA Cuadre de Caja inicializando...');

          // Verificar autenticaci√≥n
          const isAuthenticated = await checkAuth();

          if (isAuthenticated) {
            console.log('‚úÖ Usuario autenticado, cargando cuadre de caja...');

            // Cargar facturas
            await cargarFacturas();

            // Cargar resumen y configuraci√≥n
            cargarResumen();
            cargarConfiguracion();

            console.log('‚úÖ M√≥dulo de cuadre de caja cargado correctamente');
          } else {
            console.log('‚ùå Usuario no autenticado, mostrando mensaje...');
            // NO redirigir autom√°ticamente
          }
        } catch (error) {
          console.error('‚ùå Error inicializando m√≥dulo de cuadre de caja:', error);
          // NO redirigir autom√°ticamente
        }
      });

      // Cargar facturas desde Firebase o localStorage
      async function cargarFacturas() {
        try {
          console.log('üìä Cargando facturas...');

          // Obtener usuario actual - SISTEMA AISLADO
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
            console.log(
              '‚úÖ Usuario actual en cuadre de caja (sistema aislado):',
              currentUser.username || currentUser.email
            );
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
              console.log(
                '‚úÖ Usuario actual en cuadre de caja (localStorage):',
                currentUser.username || currentUser.email
              );
            }
          }

          if (!currentUser) {
            console.log('‚ö†Ô∏è No hay usuario autenticado en cuadre de caja');
            facturas = [];
            mostrarFacturas();
            return;
          }

          // Intentar cargar desde Firebase primero
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('üî• Intentando cargar facturas desde Firebase...');
              const facturasSnapshot = await firebase.firestore
                .collection('facturas')
                .where('userId', '==', currentUser.id)
                .get();

              if (!facturasSnapshot.empty) {
                facturas = [];
                facturasSnapshot.forEach((doc) => {
                  facturas.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });
                console.log(`‚úÖ Facturas cargadas desde Firebase: ${facturas.length}`);
              } else {
                console.log('‚ÑπÔ∏è No hay facturas en Firebase para este usuario');
                facturas = [];
              }
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Error cargando desde Firebase, usando localStorage:', firebaseError.message);
              // Cargar desde localStorage como fallback
              facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
              
              // Filtrar facturas por usuario actual
              if (currentUser.username || currentUser.email) {
                const userId = currentUser.username || currentUser.email;
                const facturasFiltradas = facturas.filter((factura) => factura.userId === userId);
                console.log(
                  `‚úÖ Facturas filtradas para usuario ${userId}: ${facturasFiltradas.length} de ${facturas.length} totales`
                );
                facturas = facturasFiltradas;
              }
            }
          } else {
            // Firebase no disponible, usar localStorage
            console.log('üíæ Cargando facturas desde localStorage...');
            facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');

            // Filtrar facturas por usuario actual
            if (currentUser.username || currentUser.email) {
              const userId = currentUser.username || currentUser.email;
              const facturasFiltradas = facturas.filter((factura) => factura.userId === userId);
              console.log(
                `‚úÖ Facturas filtradas para usuario ${userId}: ${facturasFiltradas.length} de ${facturas.length} totales`
              );
              facturas = facturasFiltradas;
            }
          }

          mostrarFacturas();
        } catch (error) {
          console.error('‚ùå Error cargando facturas:', error);
          facturas = [];
          mostrarFacturas();
        }
      }

      // Mostrar facturas en la tabla
      function mostrarFacturas() {
        const tbody = document.getElementById('facturasTableBody');
        if (facturas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="axyra-text-center">No hay facturas registradas</td></tr>';
          return;
        }

        tbody.innerHTML = facturas
          .map(
            (factura) => `
          <tr>
            <td>${formatearFecha(factura.fecha)}</td>
            <td>${factura.numero}</td>
            <td>${factura.encargado}</td>
            <td>${factura.area}</td>
            <td>${formatearMoneda(factura.monto)}</td>
            <td>${factura.metodoPago || '-'}</td>
            <td>${factura.descripcion || '-'}</td>
            <td>
              <button class="axyra-btn axyra-btn-danger axyra-btn-small" onclick="eliminarFactura('${factura.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `
          )
          .join('');
      }

      // Formatear fecha
      function formatearFecha(fecha) {
        return new Date(fecha).toLocaleDateString('es-CO');
      }

      // Funci√≥n para formatear moneda sin decimales
      function formatearMoneda(valor) {
        if (typeof valor === 'number') {
          return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(valor);
        }
        return valor;
      }

      // Funci√≥n para formatear moneda con separadores de miles
      function formatearMonedaConSeparadores(valor) {
        if (typeof valor === 'number') {
          return valor.toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          });
        }
        return valor;
      }

      // Cargar resumen del d√≠a
      function cargarResumen() {
        try {
          const fechaHoy = new Date().toISOString().split('T')[0];
          const facturasHoy = facturas.filter((f) => f.fecha === fechaHoy);

          // Calcular totales
          const totalFacturas = facturasHoy.length;
          const totalIngresos = facturasHoy.reduce((total, f) => total + parseFloat(f.monto), 0);

          // Calcular por m√©todo de pago
          const efectivo = facturasHoy
            .filter((f) => f.metodoPago === 'efectivo')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const transferencia = facturasHoy
            .filter((f) => f.metodoPago === 'transferencia')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const datafono = facturasHoy
            .filter((f) => f.metodoPago === 'datafono')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const qr = facturasHoy
            .filter((f) => f.metodoPago === 'qr')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const cheque = facturasHoy
            .filter((f) => f.metodoPago === 'cheque')
            .reduce((total, f) => total + parseFloat(f.monto), 0);
          const otros = facturasHoy
            .filter((f) => !['efectivo', 'transferencia', 'datafono', 'qr', 'cheque'].includes(f.metodoPago))
            .reduce((total, f) => total + parseFloat(f.monto), 0);

          // Actualizar resumen
          document.getElementById('totalFacturas').textContent = totalFacturas;
          document.getElementById('totalIngresos').textContent = formatearMoneda(totalIngresos);
          document.getElementById('totalEfectivo').textContent = formatearMoneda(efectivo);
          document.getElementById('totalTransferencias').textContent = formatearMoneda(transferencia);

          // Actualizar m√©todos de pago adicionales si existen los elementos
          const totalDatafonoElement = document.getElementById('totalDatafono');
          const totalQRElement = document.getElementById('totalQR');
          const totalChequeElement = document.getElementById('totalCheque');
          const totalOtrosElement = document.getElementById('totalOtros');

          if (totalDatafonoElement) totalDatafonoElement.textContent = formatearMoneda(datafono);
          if (totalQRElement) totalQRElement.textContent = formatearMoneda(qr);
          if (totalChequeElement) totalChequeElement.textContent = formatearMoneda(cheque);
          if (totalOtrosElement) totalOtrosElement.textContent = formatearMoneda(otros);

          // Mostrar √∫ltima factura con informaci√≥n completa
          if (facturasHoy.length > 0) {
            const ultimaFactura = facturasHoy[facturasHoy.length - 1];
            document.getElementById('ultimaFactura').textContent = formatearMoneda(ultimaFactura.monto);
            document.getElementById('ultimaFacturaInfo').textContent = `#${ultimaFactura.numero} - ${
              ultimaFactura.encargado
            } - ${ultimaFactura.metodoPago.toUpperCase()}`;

            const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');
            if (ultimaFacturaTimeElement) {
              const fechaFactura = new Date(ultimaFactura.fecha);
              // Formatear hora en zona horaria de Colombia
              const horaColombia = fechaFactura.toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'America/Bogota',
              });
              ultimaFacturaTimeElement.textContent = `Registrada a las ${horaColombia}`;
            }
          } else {
            document.getElementById('ultimaFactura').textContent = formatearMoneda(0);
            document.getElementById('ultimaFacturaInfo').textContent = 'No hay facturas hoy';
            const ultimaFacturaTimeElement = document.getElementById('ultimaFacturaTime');
            if (ultimaFacturaTimeElement) {
              ultimaFacturaTimeElement.textContent = '';
            }
          }

          console.log('‚úÖ Resumen del d√≠a actualizado');
        } catch (error) {
          console.error('‚ùå Error cargando resumen:', error);
        }
      }

      // Cambiar moneda
      function cambiarMoneda(moneda) {
        document.querySelectorAll('.axyra-currency-option').forEach((option) => {
          option.classList.remove('active');
        });

        // Encontrar la opci√≥n seleccionada y marcarla como activa
        const opcionSeleccionada = document.querySelector(`.axyra-currency-option[onclick*="${moneda}"]`);
        if (opcionSeleccionada) {
          opcionSeleccionada.classList.add('active');
        }

        monedaActual = moneda;
        localStorage.setItem('axyra_moneda', moneda);

        mostrarFacturas();
        cargarResumen();

        mostrarMensaje(`‚úÖ Moneda cambiada a ${moneda}`, 'success');
      }

      // Cargar configuraci√≥n
      function cargarConfiguracion() {
        const moneda = localStorage.getItem('axyra_moneda') || 'COP';
        cambiarMoneda(moneda);
      }

      // Registrar factura
      document.getElementById('formFactura').addEventListener('submit', function (e) {
        e.preventDefault();

        // Obtener usuario actual
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        const factura = {
          id: Date.now().toString(),
          fecha: document.getElementById('fecha').value,
          encargado: document.getElementById('encargado').value,
          numero: document.getElementById('numeroFactura').value,
          area: document.getElementById('area').value,
          monto: document.getElementById('monto').value,
          metodoPago: document.getElementById('metodoPago').value,
          descripcion: document.getElementById('descripcion').value,
          userId: currentUser ? currentUser.username || currentUser.email : 'admin',
          createdAt: new Date().toISOString(),
        };

        facturas.unshift(factura);
        localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

        mostrarFacturas();
        cargarResumen();
        limpiarFormulario();

        mostrarMensaje('‚úÖ Factura registrada correctamente', 'success');

        // Actualizar resumen del d√≠a en tiempo real
        setTimeout(() => {
          cargarResumen();
        }, 100);
      });

      // Limpiar formulario
      function limpiarFormulario() {
        document.getElementById('formFactura').reset();
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
      }

      // Eliminar factura
      function eliminarFactura(id) {
        // Obtener informaci√≥n de la factura
        const factura = facturas.find((f) => f.id === id);
        if (!factura) {
          mostrarMensaje('‚ùå Factura no encontrada', 'error');
          return;
        }

        // Mostrar modal de confirmaci√≥n
        mostrarModalEliminarFactura(factura);
      }

      // Funci√≥n para mostrar modal de eliminaci√≥n
      function mostrarModalEliminarFactura(factura) {
        const modalHTML = `
          <div id="modalEliminarFactura" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Confirmar Eliminaci√≥n
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalEliminarFactura()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-confirmacion-container">
                  <div class="axyra-confirmacion-icon">
                    <i class="fas fa-trash-alt" style="color: #ef4444; font-size: 48px;"></i>
                  </div>
                  <div class="axyra-confirmacion-texto">
                    <h4>¬øEst√°s seguro de que deseas eliminar esta factura?</h4>
                    <p>Esta acci√≥n no se puede deshacer.</p>
                  </div>
                  <div class="axyra-factura-info">
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">N√∫mero:</span>
                      <span class="axyra-factura-value">${factura.numero}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Encargado:</span>
                      <span class="axyra-factura-value">${factura.encargado}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">√Årea:</span>
                      <span class="axyra-factura-value">${factura.area}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Monto:</span>
                      <span class="axyra-factura-value">$${factura.monto.toLocaleString('es-CO')}</span>
                    </div>
                    <div class="axyra-factura-item">
                      <span class="axyra-factura-label">Fecha:</span>
                      <span class="axyra-factura-value">${new Date(factura.fecha).toLocaleDateString('es-CO')}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModalEliminarFactura()">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="axyra-btn axyra-btn-danger" onclick="confirmarEliminarFactura('${
                  factura.id
                }')">
                  <i class="fas fa-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Funci√≥n para cerrar modal de eliminaci√≥n
      function cerrarModalEliminarFactura() {
        const modal = document.getElementById('modalEliminarFactura');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para confirmar eliminaci√≥n
      function confirmarEliminarFactura(id) {
        // Cerrar modal
        cerrarModalEliminarFactura();

        // Eliminar factura
        facturas = facturas.filter((f) => f.id !== id);
        localStorage.setItem('axyra_facturas', JSON.stringify(facturas));

        mostrarFacturas();
        cargarResumen();

        mostrarMensaje('‚úÖ Factura eliminada correctamente', 'success');
      }

      // Exportar facturas a Excel profesional
      function exportarFacturas() {
        if (facturas.length === 0) {
          mostrarMensaje('‚ùå No hay facturas para exportar', 'warning');
          return;
        }

        try {
          // Usar el nuevo sistema de Excel profesional
          const nombreArchivo = window.axyraExcelExporter.exportarFacturas(facturas);
          mostrarMensaje(`‚úÖ Facturas exportadas a Excel correctamente: ${nombreArchivo}`, 'success');
        } catch (error) {
          console.error('‚ùå Error exportando facturas:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Funci√≥n para exportar cuadre de caja
      function exportarCuadreCaja() {
        try {
          if (facturas.length === 0) {
            mostrarMensaje('‚ùå No hay facturas para exportar', 'error');
            return;
          }

          // Verificar si el exportador est√° disponible
          if (typeof window.axyraExcelExporter === 'undefined') {
            window.axyraExcelExporter = new AXYRAExcelExporter();
          }

          const nombreArchivo = window.axyraExcelExporter.exportarFacturas(facturas);
          mostrarMensaje(`‚úÖ Cuadre de caja exportado correctamente: ${nombreArchivo}`, 'success');
        } catch (error) {
          console.error('‚ùå Error exportando cuadre de caja:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Limpiar historial
      function limpiarHistorial() {
        if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial? Esta acci√≥n no se puede deshacer.')) {
          facturas = [];
          localStorage.removeItem('axyra_facturas');

          mostrarFacturas();
          cargarResumen();

          mostrarMensaje('‚úÖ Historial limpiado correctamente', 'success');
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        document.body.appendChild(mensajeDiv);

        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }
    </script>

    <style>
      .axyra-currency-info {
        text-align: center;
        padding: var(--spacing-lg);
      }

      .axyra-currency-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        font-size: 1.1rem;
      }

      .axyra-currency-flag {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .axyra-currency-description {
        color: var(--axyra-gray-600);
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
      }

      /* Estilos para el modal de eliminaci√≥n */
      .axyra-confirmacion-container {
        text-align: center;
        padding: 20px;
      }

      .axyra-confirmacion-icon {
        margin-bottom: 20px;
      }

      .axyra-confirmacion-texto h4 {
        color: #1f2937;
        margin-bottom: 10px;
        font-size: 18px;
      }

      .axyra-confirmacion-texto p {
        color: #6b7280;
        margin-bottom: 25px;
      }

      .axyra-factura-info {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e2e8f0;
      }

      .axyra-factura-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .axyra-factura-item:last-child {
        border-bottom: none;
      }

      .axyra-factura-label {
        font-weight: 600;
        color: #374151;
      }

      .axyra-factura-value {
        font-weight: 500;
        color: #1f2937;
      }

      /* Bot√≥n de peligro */
      .axyra-btn-danger {
        background: #ef4444;
        color: white;
        border: none;
      }

      .axyra-btn-danger:hover {
        background: #dc2626;
      }

      /* Estilos para √∫ltima factura */
      .axyra-ultima-factura-container {
        text-align: center;
        padding: 30px;
      }

      .axyra-ultima-factura-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .axyra-ultima-factura-monto {
        font-size: 2.5rem;
        font-weight: 700;
        color: #10b981;
        text-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }

      .axyra-ultima-factura-details {
        font-size: 1.1rem;
        color: #374151;
        font-weight: 500;
        max-width: 400px;
        line-height: 1.4;
      }

      .axyra-ultima-factura-time {
        font-size: 0.9rem;
        color: #6b7280;
        font-style: italic;
      }

      /* Responsive para resumen */
      @media (max-width: 1200px) {
        .axyra-summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .axyra-summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .axyra-ultima-factura-monto {
          font-size: 2rem;
        }
      }
    </style>
  </body>
</html>
