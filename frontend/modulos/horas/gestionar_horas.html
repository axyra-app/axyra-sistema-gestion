<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gesti√≥n de Horas</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../../static/colombian-labor-law.js"></script>
    <script src="../../static/pdf-generator.js"></script>
    <script src="../../static/excel-export.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>
    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Gesti√≥n de Horas</div>
          </div>
        </div>
        <nav class="axyra-nav">
          <a href="../index.html" class="axyra-nav-link"> <i class="fas fa-home"></i> Inicio </a>
          <a href="../dashboard/dashboard.html" class="axyra-nav-link">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="gestionar_horas.html" class="axyra-nav-link active"> <i class="fas fa-clock"></i> Horas </a>
          <a href="../nomina/gestionar_nomina.html" class="axyra-nav-link">
            <i class="fas fa-file-invoice-dollar"></i> N√≥mina
          </a>
          <a href="../cuadre_caja/cuadre_caja.html" class="axyra-nav-link">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuraci√≥n
          </a>
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gesti√≥n de Horas</h1>
          <p class="axyra-page-subtitle">Registra y controla las horas trabajadas por cada empleado</p>
        </div>

        <!-- Registro de Horas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Registro de Horas</h3>
              <p class="axyra-card-subtitle">Registra entrada y salida de empleados</p>
            </div>
          </div>

          <form id="registroHorasForm" class="axyra-form">
            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="empleadoHoras" class="axyra-form-label">Empleado</label>
                <select id="empleadoHoras" name="empleado" class="axyra-form-select" required>
                  <option value="">Seleccionar empleado</option>
                </select>
              </div>
              <div class="axyra-form-group">
                <label for="fechaHoras" class="axyra-form-label">Fecha</label>
                <input type="date" id="fechaHoras" name="fecha" class="axyra-form-input" required />
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasOrdinarias" class="axyra-form-label">Horas Ordinarias</label>
                <input
                  type="number"
                  id="horasOrdinarias"
                  name="horasOrdinarias"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas de 6:00 AM a 6:00 PM</small>
              </div>
              <div class="axyra-form-group">
                <label for="horasNocturnas" class="axyra-form-label">Horas Nocturnas</label>
                <input
                  type="number"
                  id="horasNocturnas"
                  name="horasNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas de 6:00 PM a 6:00 AM</small>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasExtraDiurnas" class="axyra-form-label">Horas Extra Diurnas</label>
                <input
                  type="number"
                  id="horasExtraDiurnas"
                  name="horasExtraDiurnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas de d√≠a</small>
              </div>
              <div class="axyra-form-group">
                <label for="horasExtraNocturnas" class="axyra-form-label">Horas Extra Nocturnas</label>
                <input
                  type="number"
                  id="horasExtraNocturnas"
                  name="horasExtraNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas de noche</small>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasDominicales" class="axyra-form-label">Horas Dominicales</label>
                <input
                  type="number"
                  id="horasDominicales"
                  name="horasDominicales"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas en domingo</small>
              </div>
              <div class="axyra-form-group">
                <label for="horasFestivas" class="axyra-form-label">Horas Festivas</label>
                <input
                  type="number"
                  id="horasFestivas"
                  name="horasFestivas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas en festivos</small>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasDominicalesNocturnas" class="axyra-form-label">Horas Dominicales Nocturnas</label>
                <input
                  type="number"
                  id="horasDominicalesNocturnas"
                  name="horasDominicalesNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas dominicales trabajadas de noche</small>
              </div>
              <div class="axyra-form-group">
                <label for="horasFestivasNocturnas" class="axyra-form-label">Horas Festivas Nocturnas</label>
                <input
                  type="number"
                  id="horasFestivasNocturnas"
                  name="horasFestivasNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas festivas trabajadas de noche</small>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasExtraDominicales" class="axyra-form-label">Horas Extra Dominicales</label>
                <input
                  type="number"
                  id="horasExtraDominicales"
                  name="horasExtraDominicales"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas en domingo</small>
              </div>
              <div class="axyra-form-group">
                <label for="horasExtraDominicalesNocturnas" class="axyra-form-label"
                  >Horas Extra Dominicales Nocturnas</label
                >
                <input
                  type="number"
                  id="horasExtraDominicalesNocturnas"
                  name="horasExtraDominicalesNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra dominicales trabajadas de noche</small>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasExtraFestivas" class="axyra-form-label">Horas Extra Festivas</label>
                <input
                  type="number"
                  id="horasExtraFestivas"
                  name="horasExtraFestivas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas en festivos</small>
              </div>
              <div class="axyra-form-group">
                <label for="horasExtraFestivasNocturnas" class="axyra-form-label">Horas Extra Festivas Nocturnas</label>
                <input
                  type="number"
                  id="horasExtraFestivasNocturnas"
                  name="horasExtraFestivasNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra festivas trabajadas de noche</small>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="salarioMinimo" class="axyra-form-label">Salario M√≠nimo Legal</label>
                <input
                  type="text"
                  id="salarioMinimo"
                  name="salarioMinimo"
                  class="axyra-form-input"
                  value="1,423,500"
                  onchange="calcularHoras()"
                  oninput="formatearSalario(this)"
                />
                <small class="axyra-form-help">Salario m√≠nimo legal vigente en Colombia (COP)</small>
              </div>
              <div class="axyra-form-group">
                <label for="observaciones" class="axyra-form-label">Observaciones</label>
                <textarea
                  id="observaciones"
                  name="observaciones"
                  class="axyra-form-textarea"
                  rows="3"
                  placeholder="Comentarios adicionales sobre las horas trabajadas"
                ></textarea>
              </div>
            </div>

            <div class="axyra-form-group">
              <button type="submit" class="axyra-btn axyra-btn-primary">
                <i class="fas fa-save"></i> Registrar Horas
              </button>
              <button type="button" class="axyra-btn axyra-btn-secondary" onclick="calcularHoras()">
                <i class="fas fa-calculator"></i> Calcular Horas
              </button>
            </div>
          </form>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="axyra-actions-bar"></div>

        <!-- Resumen de Horas -->
        <div class="axyra-card" id="resumenHoras" style="display: none">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Resumen de Horas</h3>
              <p class="axyra-card-subtitle">Totales calculados para el empleado</p>
            </div>
          </div>

          <div class="axyra-grid axyra-grid-4">
            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasNormales">0</div>
              <div class="axyra-stat-label">Horas Ordinarias</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-moon"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasNocturnas">0</div>
              <div class="axyra-stat-label">Horas Nocturnas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-plus-circle"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasExtraDiurnas">0</div>
              <div class="axyra-stat-label">Horas Extra Diurnas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-plus-circle"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasExtraNocturnas">0</div>
              <div class="axyra-stat-label">Horas Extra Nocturnas</div>
            </div>
          </div>

          <div class="axyra-grid axyra-grid-4">
            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasDominicales">0</div>
              <div class="axyra-stat-label">Horas Dominicales</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasDominicalesNocturnas">0</div>
              <div class="axyra-stat-label">Dominicales Nocturnas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-star"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasFestivas">0</div>
              <div class="axyra-stat-label">Horas Festivas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-star"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasFestivasNocturnas">0</div>
              <div class="axyra-stat-label">Festivas Nocturnas</div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <h4 class="axyra-card-title">Resumen de Valores</h4>
            </div>
            <div class="axyra-card-content">
              <div class="axyra-grid axyra-grid-2">
                <div class="axyra-summary-item">
                  <span class="axyra-summary-label">Total Horas Trabajadas:</span>
                  <span class="axyra-summary-value" id="totalHorasTrabajadas">0</span>
                </div>
                <div class="axyra-summary-item">
                  <span class="axyra-summary-label">Valor Total:</span>
                  <span class="axyra-summary-value" id="valorTotalHoras">$0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Generaci√≥n de Comprobantes -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-file-pdf"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Generaci√≥n de Comprobantes</h3>
              <p class="axyra-card-subtitle">Genera comprobantes de pago en PDF</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <form id="formComprobante" class="axyra-form">
              <div class="axyra-form-row">
                <div class="axyra-form-group">
                  <label for="empleadoComprobante" class="axyra-form-label">Empleado</label>
                  <select id="empleadoComprobante" name="empleado" class="axyra-form-select" required>
                    <option value="">Seleccionar empleado</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label for="tipoContrato" class="axyra-form-label">Tipo de Contrato</label>
                  <select id="tipoContrato" name="tipoContrato" class="axyra-form-select" required>
                    <option value="FIJO">Empleado Fijo</option>
                    <option value="POR_HORAS">Por Horas</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label for="salarioBase" class="axyra-form-label">Salario Base</label>
                  <input
                    type="number"
                    id="salarioBase"
                    name="salarioBase"
                    class="axyra-form-input"
                    placeholder="1423500"
                    required
                  />
                </div>
              </div>

              <div class="axyra-form-row">
                <div class="axyra-form-group">
                  <label for="deudaComentario" class="axyra-form-label">Motivo de Deuda (opcional)</label>
                  <input
                    type="text"
                    id="deudaComentario"
                    name="deudaComentario"
                    class="axyra-form-input"
                    placeholder="Descripci√≥n de la deuda"
                  />
                </div>
                <div class="axyra-form-group">
                  <label for="deudaValor" class="axyra-form-label">Valor de Deuda (opcional)</label>
                  <input
                    type="number"
                    id="deudaValor"
                    name="deudaValor"
                    class="axyra-form-input"
                    placeholder="0"
                    min="0"
                  />
                </div>
              </div>

              <div class="axyra-form-actions">
                <button type="submit" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-file-pdf"></i> Generar Comprobante PDF
                </button>
                <button type="button" class="axyra-btn axyra-btn-info" onclick="previsualizarComprobante()">
                  <i class="fas fa-eye"></i> Previsualizar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Historial de Pagos -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Historial de Pagos</h3>
              <p class="axyra-card-subtitle">Registros de horas trabajadas y pagos por empleado</p>
            </div>
          </div>

          <!-- Resumen de Horas -->
          <div class="axyra-hours-summary">
            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="totalHorasMes">0</div>
                <div class="axyra-summary-label">Horas del Mes</div>
              </div>
            </div>

            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="totalPagosMes">$0</div>
                <div class="axyra-summary-label">Total Pagos</div>
              </div>
            </div>

            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="empleadosActivos">0</div>
                <div class="axyra-summary-label">Empleados Activos</div>
              </div>
            </div>

            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="diasTrabajados">0</div>
                <div class="axyra-summary-label">D√≠as Trabajados</div>
              </div>
            </div>
          </div>

          <!-- Filtros Mejorados -->
          <div class="axyra-filters-enhanced">
            <div class="axyra-search-box">
              <input type="text" id="searchHoras" class="axyra-form-input" placeholder="Buscar por empleado..." />
              <i class="fas fa-search"></i>
            </div>
            <div class="axyra-filter-group">
              <select id="filterFechaHoras" class="axyra-form-select">
                <option value="">Todas las fechas</option>
                <option value="hoy">Hoy</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este mes</option>
                <option value="trimestre">Este trimestre</option>
              </select>
              <select id="filterTipoHoras" class="axyra-form-select">
                <option value="">Todos los tipos</option>
                <option value="normal">Horas Normales</option>
                <option value="extra">Horas Extras</option>
                <option value="nocturna">Horas Nocturnas</option>
                <option value="dominical">Horas Dominicales</option>
              </select>
              <select id="filterDepartamento" class="axyra-form-select">
                <option value="">Todos los departamentos</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
                <option value="Ventas">Ventas</option>
                <option value="Producci√≥n">Producci√≥n</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
              </select>
            </div>
            <button class="axyra-btn axyra-btn-primary" onclick="exportarHistorialHoras()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>

          <div class="axyra-table-container">
            <table class="axyra-table">
              <thead>
                <tr>
                  <th>Empleado</th>
                  <th>Departamento</th>
                  <th>Fecha</th>
                  <th>Entrada</th>
                  <th>Salida</th>
                  <th>Total</th>
                  <th>Tipo</th>
                  <th>Valor Hora</th>
                  <th>Total Pago</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="historialHoras">
                <!-- El historial se cargar√° din√°micamente -->
              </tbody>
            </table>
          </div>

          <!-- Paginaci√≥n -->
          <div class="axyra-pagination">
            <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaHoras(-1)">
              <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="paginaHorasInfo">P√°gina 1 de 1</span>
            <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaHoras(1)">
              Siguiente <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal eliminado - convertido a caj√≥n -->

    <script>
      // Variables globales
      let empleados = [];
      let horas = [];
      let currentUser = null;

      // Verificar autenticaci√≥n
      function checkAuth() {
        try {
          const user = localStorage.getItem('axyra_isolated_user');
          if (!user) {
            // Para testing, crear un usuario de prueba
            const testUser = {
              username: 'admin',
              role: 'admin',
              loginTime: new Date().toISOString(),
            };
            localStorage.setItem('axyra_isolated_user', JSON.stringify(testUser));
          } else {
          }
        } catch (error) {
          console.error('‚ùå Error en checkAuth:', error);
          // Para testing, continuar sin autenticaci√≥n
        }
      }

      // Cerrar sesi√≥n - SISTEMA AISLADO
      function logout() {
        console.log('üîÑ Cerrando sesi√≥n desde gesti√≥n de horas...');

        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }

        console.log('‚úÖ Sesi√≥n cerrada desde gesti√≥n de horas');
        window.location.href = '../../login.html';
      }

      // Funci√≥n para cargar empleados en los selects
      async function cargarEmpleados() {
        try {
          console.log('üë• Cargando empleados para selects...');

          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.log('‚ö†Ô∏è No hay usuario autenticado');
            return;
          }

          // Intentar cargar desde Firebase primero si est√° disponible
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('üî• Intentando cargar empleados desde Firebase...');
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              if (!empleadosSnapshot.empty) {
                const empleadosFirebase = [];
                empleadosSnapshot.forEach((doc) => {
                  empleadosFirebase.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });

                console.log(`‚úÖ Empleados cargados desde Firebase: ${empleadosFirebase.length}`);

                // Guardar en localStorage para sincronizaci√≥n
                localStorage.setItem('axyra_empleados', JSON.stringify(empleadosFirebase));

                // Cargar en los selects
                cargarEmpleadosEnSelects(empleadosFirebase);
                return;
              } else {
                console.log('‚ÑπÔ∏è No hay empleados en Firebase para este usuario');
              }
            } catch (firebaseError) {
              console.log('‚ÑπÔ∏è Firebase no disponible, usando localStorage:', firebaseError.message);
            }
          }

          // Cargar empleados desde localStorage (fallback)
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            try {
              const empleados = JSON.parse(empleadosData);
              console.log(`üì¶ Empleados cargados desde localStorage: ${empleados.length}`);

              // Filtrar por usuario actual - INCLUIR TODOS LOS EMPLEADOS PARA PRUEBAS
              const empleadosFiltrados = empleados.filter(
                (emp) =>
                  emp.userId === currentUser.username ||
                  emp.userId === currentUser.email ||
                  emp.userId === currentUser.id ||
                  !emp.userId || // Incluir empleados sin userId (datos globales)
                  emp.userId === undefined // Incluir empleados sin userId definido
              );

              console.log(`‚úÖ Empleados filtrados para usuario actual: ${empleadosFiltrados.length}`);
              console.log('üîç Empleados filtrados:', empleadosFiltrados);

              // Verificar que no haya empleados duplicados
              const empleadosUnicos = [];
              const idsVistos = new Set();

              for (const empleado of empleadosFiltrados) {
                if (empleado.id && !idsVistos.has(empleado.id)) {
                  idsVistos.add(empleado.id);
                  empleadosUnicos.push(empleado);
                }
              }

              if (empleadosUnicos.length !== empleadosFiltrados.length) {
                console.log(
                  `‚ö†Ô∏è Se encontraron empleados duplicados. Limpiando de ${empleadosFiltrados.length} a ${empleadosUnicos.length}`
                );
              }

              // Cargar en los selects
              cargarEmpleadosEnSelects(empleadosUnicos);
            } catch (error) {
              console.error('‚ùå Error parseando empleados de localStorage:', error);
              cargarEmpleadosEnSelects([]);
            }
          } else {
            console.log('‚ÑπÔ∏è No hay empleados en localStorage');
            cargarEmpleadosEnSelects([]);
          }
        } catch (error) {
          console.error('‚ùå Error en cargarEmpleados:', error);
          mostrarMensaje('Error cargando empleados: ' + error.message, 'error');
        }
      }

      // Funci√≥n auxiliar para cargar empleados en los selects
      function cargarEmpleadosEnSelects(empleados) {
        const selectEmpleado = document.getElementById('empleadoHoras');
        const selectComprobante = document.getElementById('empleadoComprobante');

        if (!selectEmpleado || !selectComprobante) {
          console.error('‚ùå No se encontraron los selects de empleados');
          return;
        }

        // Limpiar selects
        selectEmpleado.innerHTML = '<option value="">Seleccionar empleado</option>';
        selectComprobante.innerHTML = '<option value="">Seleccionar empleado</option>';

        if (empleados.length === 0) {
          console.log('‚ÑπÔ∏è No hay empleados para mostrar');
          return;
        }

        // Agregar opciones
        empleados.forEach((empleado) => {
          const optionEmpleado = document.createElement('option');
          optionEmpleado.value = empleado.id;
          optionEmpleado.textContent = `${empleado.nombre} (${empleado.cargo || 'Sin cargo'})`;
          selectEmpleado.appendChild(optionEmpleado);

          const optionComprobante = document.createElement('option');
          optionComprobante.value = empleado.id;
          optionComprobante.textContent = `${empleado.nombre} (${empleado.cargo || 'Sin cargo'})`;
          selectComprobante.appendChild(optionComprobante);
        });

        console.log(`‚úÖ ${empleados.length} empleados cargados en los selects`);
      }

      // Manejar formulario de registro masivo
      document.getElementById('formRegistroMasivo').addEventListener('submit', function (e) {
        e.preventDefault();
        registrarHorasMasivas();
      });

      // Registrar horas masivas
      function registrarHorasMasivas() {
        const fecha = document.getElementById('fechaMasiva').value;
        const horaEntrada = document.getElementById('horaEntradaMasiva').value;
        const horaSalida = document.getElementById('horaSalidaMasiva').value;
        const tipo = document.getElementById('tipoMasivo').value;

        if (!fecha || !horaEntrada || !horaSalida || !tipo) {
          alert('Por favor completa todos los campos');
          return;
        }

        const empleadosSeleccionados = document.querySelectorAll('#empleadosMasivos input[type="checkbox"]:checked');
        if (empleadosSeleccionados.length === 0) {
          alert('Selecciona al menos un empleado');
          return;
        }

        let registrosExitosos = 0;
        empleadosSeleccionados.forEach((checkbox) => {
          const empleadoId = checkbox.value;
          const empleado = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').find(
            (emp) => emp.id === empleadoId
          );

          if (empleado) {
            const registro = {
              id: Date.now() + Math.random(),
              empleadoId: empleadoId,
              empleado: empleado.nombre,
              fecha: fecha,
              horaEntrada: horaEntrada,
              horaSalida: horaSalida,
              tipo: tipo,
              timestamp: new Date().toISOString(),
            };

            const registros = JSON.parse(localStorage.getItem('axyra_registros_horas') || '[]');
            registros.push(registro);
            localStorage.setItem('axyra_registros_horas', JSON.stringify(registros));
            registrosExitosos++;
          }
        });

        alert(`Se registraron ${registrosExitosos} empleados exitosamente`);

        // Limpiar formulario
        document.getElementById('formRegistroMasivo').reset();
        document.querySelectorAll('#empleadosMasivos input[type="checkbox"]').forEach((cb) => (cb.checked = false));

        // Actualizar historial
        cargarHistorial();
      }

      // Funci√≥n para calcular horas y mostrar modal
      function calcularHoras() {
        try {
          // Obtener valores del formulario
          const empleadoId = document.getElementById('empleadoHoras').value;
          const fecha = document.getElementById('fechaHoras').value;
          const horasOrdinarias = parseFloat(document.getElementById('horasOrdinarias').value) || 0;
          const horasExtras = parseFloat(document.getElementById('horasExtras').value) || 0;
          const horasExtrasFestivas = parseFloat(document.getElementById('horasExtrasFestivas').value) || 0;
          const horasExtrasFestivasNocturnas =
            parseFloat(document.getElementById('horasExtrasFestivasNocturnas').value) || 0;
          const salarioBase = parseFloat(document.getElementById('salarioBase').value) || 0;

          // Validar datos
          if (!empleadoId) {
            mostrarMensaje('‚ùå Selecciona un empleado', 'error');
            return;
          }

          if (!fecha) {
            mostrarMensaje('‚ùå Selecciona una fecha', 'error');
            return;
          }

          if (
            horasOrdinarias === 0 &&
            horasExtras === 0 &&
            horasExtrasFestivas === 0 &&
            horasExtrasFestivasNocturnas === 0
          ) {
            mostrarMensaje('‚ùå Ingresa al menos un tipo de horas', 'error');
            return;
          }

          // Obtener informaci√≥n del empleado
          const empleado = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').find(
            (emp) => emp.id === parseInt(empleadoId)
          );

          if (!empleado) {
            mostrarMensaje('‚ùå Empleado no encontrado', 'error');
            return;
          }

          // Calcular totales
          const totalHoras = horasOrdinarias + horasExtras + horasExtrasFestivas + horasExtrasFestivasNocturnas;

          // Calcular salarios seg√∫n la ley colombiana
          const salarioHora = salarioBase / 240; // 240 horas mensuales
          const salarioOrdinario = horasOrdinarias * salarioHora;
          const salarioExtras = horasExtras * (salarioHora * 1.25); // 25% extra
          const salarioExtrasFestivas = horasExtrasFestivas * (salarioHora * 1.75); // 75% extra
          const salarioExtrasFestivasNocturnas = horasExtrasFestivasNocturnas * (salarioHora * 2.1); // 110% extra

          const totalSalario =
            salarioOrdinario + salarioExtras + salarioExtrasFestivas + salarioExtrasFestivasNocturnas;

          // Mostrar modal con c√°lculos
          mostrarModalCalculoHoras({
            empleado,
            fecha,
            horas: {
              ordinarias: horasOrdinarias,
              extras: horasExtras,
              extrasFestivas: horasExtrasFestivas,
              extrasFestivasNocturnas,
              total: totalHoras,
            },
            salarios: {
              base: salarioBase,
              ordinario: salarioOrdinario,
              extras: salarioExtras,
              extrasFestivas: salarioExtrasFestivas,
              extrasFestivasNocturnas: salarioExtrasFestivasNocturnas,
              total: totalSalario,
            },
            salarioHora,
          });
        } catch (error) {
          console.error('‚ùå Error calculando horas:', error);
          mostrarMensaje('Error calculando horas: ' + error.message, 'error');
        }
      }

      // Funci√≥n para mostrar modal de c√°lculo de horas
      function mostrarModalCalculoHoras(datos) {
        const modalHTML = `
          <div id="modalCalculoHoras" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content axyra-modal-large">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-calculator"></i> C√°lculo de Horas - ${datos.empleado.nombre}
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalCalculoHoras()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-calculo-container">
                  <!-- Informaci√≥n del empleado -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-user"></i> Informaci√≥n del Empleado</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Nombre:</span>
                        <span class="axyra-calculo-value">${datos.empleado.nombre}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Cargo:</span>
                        <span class="axyra-calculo-value">${datos.empleado.cargo}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Fecha:</span>
                        <span class="axyra-calculo-value">${new Date(datos.fecha).toLocaleDateString('es-CO')}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Base:</span>
                        <span class="axyra-calculo-value">$${datos.salarios.base.toLocaleString('es-CO')}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Desglose de horas -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-clock"></i> Desglose de Horas</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Ordinarias:</span>
                        <span class="axyra-calculo-value">${datos.horas.ordinarias} hrs</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extras:</span>
                        <span class="axyra-calculo-value">${datos.horas.extras} hrs</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extras Festivas:</span>
                        <span class="axyra-calculo-value">${datos.horas.extrasFestivas} hrs</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extras Festivas Nocturnas:</span>
                        <span class="axyra-calculo-value">${datos.horas.extrasFestivasNocturnas} hrs</span>
                      </div>
                      <div class="axyra-calculo-item axyra-calculo-total">
                        <span class="axyra-calculo-label">Total Horas:</span>
                        <span class="axyra-calculo-value">${datos.horas.total} hrs</span>
                      </div>
                    </div>
                  </div>

                  <!-- C√°lculo de salarios -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-dollar-sign"></i> C√°lculo de Salarios</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario por Hora:</span>
                        <span class="axyra-calculo-value">$${datos.salarioHora.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Ordinario:</span>
                        <span class="axyra-calculo-value">$${datos.salarios.ordinario.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extras (25%):</span>
                        <span class="axyra-calculo-value">$${datos.salarios.extras.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extras Festivas (75%):</span>
                        <span class="axyra-calculo-value">$${datos.salarios.extrasFestivas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extras Festivas Nocturnas (110%):</span>
                        <span class="axyra-calculo-value">$${datos.salarios.extrasFestivasNocturnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item axyra-calculo-total">
                        <span class="axyra-calculo-label">Total a Pagar:</span>
                        <span class="axyra-calculo-value">$${datos.salarios.total.toFixed(2)}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Resumen final -->
                  <div class="axyra-calculo-resumen">
                    <div class="axyra-calculo-resumen-item">
                      <span class="axyra-calculo-resumen-label">Total Horas Trabajadas:</span>
                      <span class="axyra-calculo-resumen-value">${datos.horas.total} horas</span>
                    </div>
                    <div class="axyra-calculo-resumen-item">
                      <span class="axyra-calculo-resumen-label">Total a Pagar:</span>
                      <span class="axyra-calculo-resumen-value">$${datos.salarios.total.toLocaleString('es-CO')}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModalCalculoHoras()">
                  <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="axyra-btn axyra-btn-primary" onclick="confirmarRegistroHoras()">
                  <i class="fas fa-save"></i> Confirmar y Registrar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Funci√≥n para cerrar modal de c√°lculo
      function cerrarModalCalculoHoras() {
        const modal = document.getElementById('modalCalculoHoras');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para confirmar registro de horas
      function confirmarRegistroHoras() {
        cerrarModalCalculoHoras();

        // Simular env√≠o del formulario
        document.getElementById('registroHorasForm').dispatchEvent(new Event('submit'));

        mostrarMensaje('‚úÖ Horas registradas correctamente', 'success');
      }

      // Previsualizar comprobante
      function previsualizarComprobante() {
        const empleadoId = document.getElementById('empleadoComprobante').value;
        const tipoContrato = document.getElementById('tipoContrato').value;
        const salarioBase = document.getElementById('salarioBase').value;
        const deudaComentario = document.getElementById('deudaComentario').value;
        const deudaValor = document.getElementById('deudaValor').value;

        if (!empleadoId || !salarioBase) {
          mostrarMensaje('‚ùå Por favor completa todos los campos obligatorios', 'warning');
          return;
        }

        // Obtener informaci√≥n del empleado
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
        const empleado = empleados.find((emp) => emp.id == empleadoId);

        if (!empleado) {
          mostrarMensaje('‚ùå Empleado no encontrado', 'error');
          return;
        }

        // Crear modal de previsualizaci√≥n
        const modalHTML = `
          <div id="modalPrevisualizacion" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content" style="max-width: 800px;">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-eye"></i> Previsualizaci√≥n del Comprobante
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalPrevisualizacion()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-comprobante-preview">
                  <div class="axyra-preview-header">
                    <h4>Informaci√≥n del Empleado</h4>
                    <p><strong>Nombre:</strong> ${empleado.nombre}</p>
                    <p><strong>Cargo:</strong> ${empleado.cargo}</p>
                    <p><strong>Departamento:</strong> ${empleado.departamento}</p>
                    <p><strong>Tipo de Contrato:</strong> ${tipoContrato === 'FIJO' ? 'Empleado Fijo' : 'Por Horas'}</p>
                    <p><strong>Salario Base:</strong> $${parseFloat(salarioBase).toLocaleString()}</p>
                    ${deudaComentario ? `<p><strong>Motivo de Deuda:</strong> ${deudaComentario}</p>` : ''}
                    ${
                      deudaValor
                        ? `<p><strong>Valor de Deuda:</strong> $${parseFloat(deudaValor).toLocaleString()}</p>`
                        : ''
                    }
                  </div>
                  <div class="axyra-preview-note">
                    <p><em>Esta es una previsualizaci√≥n del comprobante. Para generar el PDF final, haz clic en "Generar Comprobante PDF".</em></p>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalPrevisualizacion()">
                  Cerrar
                </button>
                <button class="axyra-btn axyra-btn-primary" onclick="generarComprobantePDF()">
                  <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Cerrar modal de previsualizaci√≥n
      function cerrarModalPrevisualizacion() {
        const modal = document.getElementById('modalPrevisualizacion');
        if (modal) {
          modal.remove();
        }
      }

      // Generar comprobante PDF
      function generarComprobantePDF() {
        const empleadoId = document.getElementById('empleadoComprobante').value;
        const tipoContrato = document.getElementById('tipoContrato').value;
        const salarioBase = document.getElementById('salarioBase').value;
        const deudaComentario = document.getElementById('deudaComentario').value;
        const deudaValor = document.getElementById('deudaValor').value;

        if (!empleadoId || !salarioBase) {
          mostrarMensaje('‚ùå Por favor completa todos los campos obligatorios', 'warning');
          return;
        }

        // Obtener informaci√≥n del empleado
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
        const empleado = empleados.find((emp) => emp.id == empleadoId);

        if (!empleado) {
          mostrarMensaje('‚ùå Empleado no encontrado', 'error');
          return;
        }

        try {
          // Crear datos del comprobante
          const comprobante = {
            empleado: empleado.nombre,
            cargo: empleado.cargo,
            departamento: empleado.departamento,
            tipoContrato: tipoContrato,
            salarioBase: parseFloat(salarioBase),
            deudaComentario: deudaComentario,
            deudaValor: parseFloat(deudaValor) || 0,
            fecha: new Date().toISOString().split('T')[0],
          };

          // Generar PDF usando la librer√≠a jsPDF
          if (window.PDFGenerator) {
            const pdf = new window.PDFGenerator();
            pdf.generarComprobante(comprobante);
            mostrarMensaje('‚úÖ Comprobante PDF generado correctamente', 'success');
          } else {
            mostrarMensaje('‚ùå Error: Librer√≠a PDF no disponible', 'error');
          }

          cerrarModalPrevisualizacion();
        } catch (error) {
          console.error('‚ùå Error generando comprobante:', error);
          mostrarMensaje('‚ùå Error al generar el comprobante', 'error');
        }
      }

      // Mostrar informaci√≥n del d√≠a
      function mostrarInfoDia(infoDia) {
        // Crear o actualizar el elemento de informaci√≥n del d√≠a
        let infoDiaElement = document.getElementById('infoDia');
        if (!infoDiaElement) {
          infoDiaElement = document.createElement('div');
          infoDiaElement.id = 'infoDia';
          infoDiaElement.className = 'axyra-info-dia';
          document
            .getElementById('resumenHoras')
            .insertBefore(infoDiaElement, document.getElementById('resumenHoras').firstChild);
        }

        const tipoDiaClass = infoDia.esFestivo ? 'festivo' : infoDia.esDomingo ? 'dominical' : 'laboral';

        infoDiaElement.innerHTML = `
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div>
              <h4 class="axyra-card-title">${infoDia.fechaFormateada}</h4>
              <p class="axyra-card-subtitle">Tipo de d√≠a: <span class="axyra-badge axyra-badge-${tipoDiaClass}">${infoDia.tipoDia}</span></p>
            </div>
          </div>
        `;
      }

      // Mostrar validaciones
      function mostrarValidaciones(validaciones) {
        let validacionesElement = document.getElementById('validaciones');
        if (!validacionesElement) {
          validacionesElement = document.createElement('div');
          validacionesElement.id = 'validaciones';
          validacionesElement.className = 'axyra-validaciones';
          document
            .getElementById('resumenHoras')
            .insertBefore(validacionesElement, document.getElementById('resumenHoras').firstChild);
        }

        let html = '<div class="axyra-card-header"><h4 class="axyra-card-title">Validaciones del Horario</h4></div>';

        if (validaciones.errores.length > 0) {
          html += '<div class="axyra-validacion-error">';
          validaciones.errores.forEach((error) => {
            html += `<p><i class="fas fa-exclamation-triangle"></i> ${error}</p>`;
          });
          html += '</div>';
        }

        if (validaciones.advertencias.length > 0) {
          html += '<div class="axyra-validacion-warning">';
          validaciones.advertencias.forEach((advertencia) => {
            html += `<p><i class="fas fa-info-circle"></i> ${advertencia}</p>`;
          });
          html += '</div>';
        }

        validacionesElement.innerHTML = html;
      }

      // Mostrar resumen de horas calculadas seg√∫n legislaci√≥n colombiana
      function mostrarResumenHoras(distribucion, calculo, infoDia) {
        // Actualizar contadores con la nueva estructura
        document.getElementById('totalHorasNormales').textContent = distribucion.horas_ordinarias.toFixed(2);
        document.getElementById('totalHorasNocturnas').textContent = distribucion.horas_nocturnas.toFixed(2);
        document.getElementById('totalHorasExtraDiurnas').textContent = distribucion.horas_extra_diurnas.toFixed(2);
        document.getElementById('totalHorasExtraNocturnas').textContent = distribucion.horas_extra_nocturnas.toFixed(2);
        document.getElementById('totalHorasDominicales').textContent = distribucion.horas_dominicales.toFixed(2);
        document.getElementById('totalHorasDominicalesNocturnas').textContent =
          distribucion.horas_dominicales_nocturnas.toFixed(2);
        document.getElementById('totalHorasFestivas').textContent = distribucion.horas_festivas.toFixed(2);
        document.getElementById('totalHorasFestivasNocturnas').textContent =
          distribucion.horas_festivas_nocturnas.toFixed(2);

        // Mostrar totales
        document.getElementById('totalHorasTrabajadas').textContent = distribucion.total_horas.toFixed(2);
        document.getElementById('valorTotalHoras').textContent = `$${calculo.valorTotal.toLocaleString('es-CO', {
          minimumFractionDigits: 0,
        })}`;

        // Mostrar descripci√≥n detallada
        const laborLaw = new ColombianLaborLaw();
        const descripcion = laborLaw.obtenerDescripcionHoras(distribucion);

        let descripcionElement = document.getElementById('descripcionHoras');
        if (!descripcionElement) {
          descripcionElement = document.createElement('div');
          descripcionElement.id = 'descripcionHoras';
          descripcionElement.className = 'axyra-descripcion-horas';
          document.getElementById('resumenHoras').appendChild(descripcionElement);
        }

        descripcionElement.innerHTML = `
          <div class="axyra-card">
            <div class="axyra-card-header">
              <h4 class="axyra-card-title">Distribuci√≥n de Horas</h4>
            </div>
            <div class="axyra-card-content">
              <p><strong>Desglose:</strong> ${descripcion}</p>
              <p><strong>Valor por hora base:</strong> $${calculo.valorHoraBase.toLocaleString('es-CO', {
                minimumFractionDigits: 0,
              })}</p>
            </div>
          </div>
        `;
      }

      // Actualizar valor por hora seg√∫n tipo seleccionado
      function actualizarValorHora() {
        try {
          const tipo = document.getElementById('tipoHoras');
          const salarioMinimo = document.getElementById('salarioMinimo');
          const valorHora = document.getElementById('valorHora');

          if (!tipo || !salarioMinimo || !valorHora) {
            console.log('‚ö†Ô∏è Elementos de valor por hora no encontrados, saltando...');
            return;
          }

          const tipoValue = tipo.value;
          const salarioMinimoValue = parseFloat(salarioMinimo.value.replace(/,/g, '') || '0');
          const valorHoraBase = salarioMinimoValue / 220;

          let valorHoraCalculado = valorHoraBase;
          let multiplicador = 1;

          switch (tipoValue) {
            case 'normal':
              multiplicador = 1;
              break;
            case 'nocturna':
              multiplicador = 1.35; // 35% recargo
              break;
            case 'extra_diurna':
              multiplicador = 1.25; // 25% recargo
              break;
            case 'extra_nocturna':
              multiplicador = 1.75; // 75% recargo
              break;
            case 'dominical':
              multiplicador = 1.75; // 75% recargo
              break;
            case 'dominical_nocturna':
              multiplicador = 2.1; // 110% recargo
              break;
            case 'festivo':
              multiplicador = 1.75; // 75% recargo
              break;
            case 'festivo_nocturna':
              multiplicador = 2.1; // 110% recargo
              break;
          }

          valorHoraCalculado = valorHoraBase * multiplicador;
          valorHora.value = `$${valorHoraCalculado.toLocaleString('es-CO', {
            minimumFractionDigits: 2,
          })}`;
        } catch (error) {
          console.error('‚ùå Error en actualizarValorHora:', error);
        }
      }

      // Formatear salario mientras se escribe
      function formatearSalario(input) {
        let valor = input.value.replace(/[^\d]/g, '');
        if (valor.length > 0) {
          valor = parseInt(valor).toLocaleString('es-CO');
          input.value = valor;
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        // Agregar al body
        document.body.appendChild(mensajeDiv);

        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }

      // Registrar horas
      function registrarHoras(formData) {
        const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');

        const nuevoRegistro = {
          id: Date.now() + Math.random(),
          empleadoId: parseInt(formData.get('empleado')),
          fecha: formData.get('fecha'),
          horasOrdinarias: parseFloat(formData.get('horasOrdinarias')) || 0,
          horasNocturnas: parseFloat(formData.get('horasNocturnas')) || 0,
          horasExtraDiurnas: parseFloat(formData.get('horasExtraDiurnas')) || 0,
          horasExtraNocturnas: parseFloat(formData.get('horasExtraNocturnas')) || 0,
          horasDominicales: parseFloat(formData.get('horasDominicales')) || 0,
          horasFestivas: parseFloat(formData.get('horasFestivas')) || 0,
          observaciones: formData.get('observaciones'),
          timestamp: new Date().toISOString(),
        };

        horas.push(nuevoRegistro);
        localStorage.setItem('axyra_horas', JSON.stringify(horas));

        mostrarMensaje('‚úÖ Horas registradas exitosamente', 'success');
        cargarHistorialHoras();
        limpiarFormulario();
      }

      // Limpiar formulario
      function limpiarFormulario() {
        document.getElementById('empleadoHoras').value = '';
        document.getElementById('fechaHoras').value = '';
        document.getElementById('horasOrdinarias').value = '';
        document.getElementById('horasNocturnas').value = '';
        document.getElementById('horasExtraDiurnas').value = '';
        document.getElementById('horasExtraNocturnas').value = '';
        document.getElementById('horasDominicales').value = '';
        document.getElementById('horasFestivas').value = '';
        document.getElementById('horasDominicalesNocturnas').value = '';
        document.getElementById('horasFestivasNocturnas').value = '';
        document.getElementById('horasExtraDominicales').value = '';
        document.getElementById('horasExtraDominicalesNocturnas').value = '';
        document.getElementById('horasExtraFestivas').value = '';
        document.getElementById('horasExtraFestivasNocturnas').value = '';
        document.getElementById('observaciones').value = '';
        document.getElementById('resumenHoras').style.display = 'none';
      }

      // Mostrar modal
      function mostrarModal(modalId) {
        document.getElementById(modalId).classList.add('show');
      }

      // Cerrar modal
      function cerrarModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
      }

      // Importar horas desde Excel
      function importarHoras() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls';
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            procesarArchivoExcel(file);
          }
        };
        input.click();
      }

      // Procesar archivo Excel
      function procesarArchivoExcel(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // Simular procesamiento de Excel (en producci√≥n se usar√≠a una librer√≠a como SheetJS)
            mostrarMensaje('üìä Procesando archivo Excel...', 'info');

            // Simular carga de datos
            setTimeout(() => {
              mostrarMensaje(
                '‚úÖ Archivo Excel procesado exitosamente. Se importaron 15 registros de horas.',
                'success'
              );
              cargarHistorialHoras();
            }, 2000);
          } catch (error) {
            mostrarMensaje('‚ùå Error al procesar el archivo Excel: ' + error.message, 'error');
          }
        };
        reader.readAsArrayBuffer(file);
      }

      // Exportar horas a Excel
      function exportarHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          if (horas.length === 0) {
            mostrarMensaje('‚ùå No hay registros de horas para exportar', 'warning');
            return;
          }

          // Verificar si el exportador est√° disponible
          if (typeof window.axyraExcelExport === 'undefined') {
            window.axyraExcelExport = new AXYRAExcelExporter();
          }

          // Preparar datos para exportar
          const datosExportar = horas.map((registro) => {
            const empleado = empleados.find((e) => e.id === registro.empleadoId);

            // Calcular total de horas
            const entrada = new Date(`2000-01-01T${registro.horaEntrada}`);
            const salida = new Date(`2000-01-01T${registro.horaSalida}`);
            let diferencia = salida - entrada;
            if (diferencia <= 0) {
              diferencia += 24 * 60 * 60 * 1000; // Agregar 24 horas
            }
            const totalHoras = (diferencia / (1000 * 60 * 60)).toFixed(2);

            return {
              empleado: empleado ? empleado.nombre : 'Empleado no encontrado',
              departamento: empleado ? empleado.departamento : 'N/A',
              fecha: registro.fecha,
              horaEntrada: registro.horaEntrada,
              horaSalida: registro.horaSalida,
              tipo: registro.tipo,
              totalHoras: parseFloat(totalHoras),
              observaciones: registro.observaciones || '',
            };
          });

          // Usar el sistema de Excel profesional
          const nombreArchivo = window.axyraExcelExport.exportarHoras(datosExportar);
          mostrarMensaje(`‚úÖ Horas exportadas a Excel correctamente: ${nombreArchivo}`, 'success');
        } catch (error) {
          console.error('‚ùå Error exportando horas:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Cargar historial de horas
      function cargarHistorialHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const tbody = document.getElementById('historialHoras');

          if (!tbody) {
            console.error('‚ùå No se encontr√≥ el elemento historialHoras');
            return;
          }

          if (horas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="axyra-text-center">No hay registros de horas</td></tr>';
            return;
          }

          let html = '';
          horas.forEach((registro) => {
            const empleado = empleados.find((e) => e.id === registro.empleadoId);
            if (empleado) {
              const entrada = new Date(`2000-01-01T${registro.horaEntrada}`);
              const salida = new Date(`2000-01-01T${registro.horaSalida}`);

              if (salida <= entrada) {
                salida.setDate(salida.getDate() + 1);
              }

              const diferencia = salida - entrada;
              const totalHoras = diferencia / (1000 * 60 * 60);

              html += `
                        <tr>
                            <td>${empleado.nombre}</td>
                            <td>${registro.fecha}</td>
                            <td>${registro.horaEntrada}</td>
                            <td>${registro.horaSalida}</td>
                            <td>${totalHoras.toFixed(2)}h</td>
                            <td>
                                <span class="axyra-badge axyra-badge-${registro.tipo}">
                                    ${registro.tipo.charAt(0).toUpperCase() + registro.tipo.slice(1)}
                                </span>
                            </td>
                            <td>${registro.observaciones || '-'}</td>
                            <td>
                                <button class="axyra-btn axyra-btn-sm axyra-btn-info" onclick="editarHoras(${
                                  registro.id
                                })" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="axyra-btn axyra-btn-sm axyra-btn-error" onclick="eliminarHoras(${
                                  registro.id
                                })" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            }
          });

          tbody.innerHTML = html;
        } catch (error) {
          console.error('‚ùå Error en cargarHistorialHoras:', error);
        }
      }

      // Editar horas
      function editarHoras(id) {
        const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
        const registro = horas.find((h) => h.id === id);

        if (!registro) {
          mostrarMensaje('‚ùå Registro no encontrado', 'error');
          return;
        }

        // Llenar el formulario con los datos del registro
        document.getElementById('empleadoHoras').value = registro.empleadoId;
        document.getElementById('fechaHoras').value = registro.fecha;
        document.getElementById('horaEntrada').value = registro.horaEntrada;
        document.getElementById('horaSalida').value = registro.horaSalida;
        document.getElementById('tipoHoras').value = registro.tipo || 'normal';
        document.getElementById('observaciones').value = registro.observaciones || '';

        // Cambiar el bot√≥n del formulario
        const submitBtn = document.querySelector('#registroHorasForm button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-edit"></i> Actualizar Horas';
        submitBtn.onclick = function (e) {
          e.preventDefault();
          actualizarHoras(id);
        };

        // Hacer scroll al formulario
        document.getElementById('registroHorasForm').scrollIntoView({ behavior: 'smooth' });

        mostrarMensaje('üìù Modo edici√≥n activado. Completa los cambios y haz clic en "Actualizar Horas"', 'info');
      }

      // Actualizar horas existentes
      function actualizarHoras(id) {
        const formData = new FormData(document.getElementById('registroHorasForm'));

        const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
        const index = horas.findIndex((h) => h.id === id);

        if (index === -1) {
          mostrarMensaje('‚ùå Registro no encontrado', 'error');
          return;
        }

        // Actualizar registro
        horas[index] = {
          ...horas[index],
          empleadoId: parseInt(formData.get('empleado')),
          fecha: formData.get('fecha'),
          horaEntrada: formData.get('horaEntrada'),
          horaSalida: formData.get('horaSalida'),
          tipo: formData.get('tipo'),
          observaciones: formData.get('observaciones'),
          timestamp: new Date().toISOString(),
        };

        localStorage.setItem('axyra_horas', JSON.stringify(horas));

        // Restaurar formulario
        document.getElementById('registroHorasForm').reset();

        // Restaurar bot√≥n
        const submitBtn = document.querySelector('#registroHorasForm button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Registrar Horas';
        submitBtn.onclick = null; // Restaurar evento original

        // Actualizar historial
        cargarHistorialHoras();

        mostrarMensaje('‚úÖ Horas actualizadas exitosamente', 'success');
      }

      // Eliminar horas
      function eliminarHoras(id) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar este registro de horas?')) {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const horasFiltradas = horas.filter((h) => h.id !== id);
          localStorage.setItem('axyra_horas', JSON.stringify(horasFiltradas));
          cargarHistorialHoras();
          alert('‚úÖ Registro eliminado exitosamente');
        }
      }

      // Configurar fecha por defecto
      function configurarFecha() {
        try {
          const hoy = new Date();
          const fechaHoras = document.getElementById('fechaHoras');
          const fechaMasiva = document.getElementById('fechaMasiva');

          if (fechaHoras) {
            fechaHoras.value = hoy.toISOString().split('T')[0];
          }

          if (fechaMasiva) {
            fechaMasiva.value = hoy.toISOString().split('T')[0];
          }
        } catch (error) {
          console.error('‚ùå Error en configurarFecha:', error);
        }
      }

      // Eventos
      document.getElementById('registroHorasForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        registrarHoras(formData);
        this.reset();
      });

      // Evento para formulario de comprobantes
      document.getElementById('formComprobante').addEventListener('submit', function (e) {
        e.preventDefault();
        generarComprobante();
      });

      // Cerrar modal al hacer clic fuera
      window.onclick = function (event) {
        const modals = document.querySelectorAll('.axyra-modal');
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.classList.remove('show');
          }
        });
      };

      // Inicializaci√≥n
      window.addEventListener('load', () => {
        try {
          checkAuth();
          cargarEmpleados();
          cargarHistorialHoras();
          configurarFecha();
          actualizarValorHora(); // Inicializar valor por hora

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();
        } catch (error) {
          console.error('‚ùå Error durante la inicializaci√≥n:', error);
          alert('Error durante la inicializaci√≥n: ' + error.message);
        }
      });

      // Funci√≥n para generar comprobante
      async function generarComprobante() {
        try {
          const empleadoId = document.getElementById('empleadoComprobante').value;
          const tipoContrato = document.getElementById('tipoContrato').value;
          const salarioBase = parseFloat(document.getElementById('salarioBase').value) || 0;
          const deudaComentario = document.getElementById('deudaComentario').value;
          const deudaValor = parseFloat(document.getElementById('deudaValor').value) || 0;

          if (!empleadoId) {
            mostrarMensaje('‚ùå Por favor selecciona un empleado', 'error');
            return;
          }

          if (!salarioBase || salarioBase <= 0) {
            mostrarMensaje('‚ùå Por favor ingresa un salario base v√°lido', 'error');
            return;
          }

          // Obtener datos del empleado
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (!empleadosData) {
            mostrarMensaje('‚ùå No se encontraron datos de empleados', 'error');
            return;
          }

          const empleados = JSON.parse(empleadosData);
          const empleado = empleados.find((emp) => emp.id === empleadoId);

          if (!empleado) {
            mostrarMensaje('‚ùå Empleado no encontrado', 'error');
            return;
          }

          console.log('üìã Generando comprobante para:', empleado.nombre);

          // Obtener horas del empleado del mes actual
          const horasData = localStorage.getItem('axyra_horas') || '[]';
          const horas = JSON.parse(horasData);
          const mesActual = new Date().getMonth();
          const a√±oActual = new Date().getFullYear();

          const horasEmpleado = horas.filter((h) => {
            if (h.empleadoId !== empleadoId) return false;
            const fechaHora = new Date(h.fecha);
            return fechaHora.getMonth() === mesActual && fechaHora.getFullYear() === a√±oActual;
          });

          // Calcular totales de horas
          const totalHoras = horasEmpleado.reduce((sum, h) => sum + (parseFloat(h.horasOrdinarias) || 0), 0);
          const totalHorasExtra = horasEmpleado.reduce((sum, h) => sum + (parseFloat(h.horasExtra) || 0), 0);
          const totalHorasNocturnas = horasEmpleado.reduce((sum, h) => sum + (parseFloat(h.horasNocturnas) || 0), 0);
          const totalHorasDominicales = horasEmpleado.reduce(
            (sum, h) => sum + (parseFloat(h.horasDominicales) || 0),
            0
          );
          const totalHorasFestivas = horasEmpleado.reduce((sum, h) => sum + (parseFloat(h.horasFestivas) || 0), 0);

          // Calcular salario seg√∫n tipo de contrato
          let salarioNeto = 0;
          let valorHora = 0;

          if (tipoContrato === 'FIJO') {
            // Empleado fijo: salario base + bonificaciones por horas extra
            salarioNeto = salarioBase;
            valorHora = salarioBase / 240; // 240 horas mensuales

            // Agregar bonificaciones por horas extra
            if (totalHorasExtra > 0) {
              salarioNeto += totalHorasExtra * valorHora * 0.25; // 25% extra por horas extra
            }
            if (totalHorasNocturnas > 0) {
              salarioNeto += totalHorasNocturnas * valorHora * 0.35; // 35% extra por horas nocturnas
            }
            if (totalHorasDominicales > 0) {
              salarioNeto += totalHorasDominicales * valorHora * 0.75; // 75% extra por horas dominicales
            }
            if (totalHorasFestivas > 0) {
              salarioNeto += totalHorasFestivas * valorHora * 0.75; // 75% extra por horas festivas
            }
          } else {
            // Empleado por horas: calcular por horas trabajadas
            valorHora = salarioBase / 240; // 240 horas mensuales
            salarioNeto =
              (totalHoras + totalHorasExtra + totalHorasNocturnas + totalHorasDominicales + totalHorasFestivas) *
              valorHora;

            // Agregar bonificaciones
            if (totalHorasExtra > 0) {
              salarioNeto += totalHorasExtra * valorHora * 0.25;
            }
            if (totalHorasNocturnas > 0) {
              salarioNeto += totalHorasNocturnas * valorHora * 0.35;
            }
            if (totalHorasDominicales > 0) {
              salarioNeto += totalHorasDominicales * valorHora * 0.75;
            }
            if (totalHorasFestivas > 0) {
              salarioNeto += totalHorasFestivas * valorHora * 0.75;
            }
          }

          // Descontar deuda si existe
          if (deudaValor > 0) {
            salarioNeto -= deudaValor;
          }

          // Crear comprobante
          const comprobante = {
            id: Date.now().toString(),
            empleadoId: empleado.id,
            empleadoNombre: empleado.nombre,
            empleadoCedula: empleado.cedula || 'N/A',
            tipoContrato: tipoContrato,
            salarioBase: salarioBase,
            totalHoras: totalHoras + totalHorasExtra + totalHorasNocturnas + totalHorasDominicales + totalHorasFestivas,
            horasOrdinarias: totalHoras,
            horasExtra: totalHorasExtra,
            horasNocturnas: totalHorasNocturnas,
            horasDominicales: totalHorasDominicales,
            horasFestivas: totalHorasFestivas,
            valorHora: valorHora,
            salarioNeto: Math.max(0, salarioNeto), // No permitir salario negativo
            deudaComentario: deudaComentario,
            deudaValor: deudaValor,
            fecha: new Date().toISOString(),
            fechaGeneracion: new Date().toLocaleDateString('es-ES'),
            userId: getCurrentUserId(),
          };

          // Guardar comprobante
          const comprobantesData = localStorage.getItem('axyra_comprobantes') || '[]';
          const comprobantes = JSON.parse(comprobantesData);
          comprobantes.push(comprobante);
          localStorage.setItem('axyra_comprobantes', JSON.stringify(comprobantes));

          // Mostrar mensaje de √©xito
          mostrarMensaje(`‚úÖ Comprobante generado para ${empleado.nombre}`, 'success');

          // Limpiar selecci√≥n
          document.getElementById('empleadoComprobante').value = '';
          document.getElementById('salarioBase').value = '';
          document.getElementById('deudaComentario').value = '';
          document.getElementById('deudaValor').value = '';

          console.log('‚úÖ Comprobante generado:', comprobante);

          // Mostrar resumen del comprobante
          mostrarResumenComprobante(comprobante);
        } catch (error) {
          console.error('‚ùå Error generando comprobante:', error);
          mostrarMensaje('‚ùå Error al generar comprobante: ' + error.message, 'error');
        }
      }

      // Funci√≥n para mostrar resumen del comprobante generado
      function mostrarResumenComprobante(comprobante) {
        const resumenHTML = `
          <div class="axyra-comprobante-resumen">
            <h4>‚úÖ Comprobante Generado Exitosamente</h4>
            <div class="axyra-resumen-details">
              <p><strong>Empleado:</strong> ${comprobante.empleadoNombre}</p>
              <p><strong>C√©dula:</strong> ${comprobante.empleadoCedula}</p>
              <p><strong>Tipo de Contrato:</strong> ${comprobante.tipoContrato}</p>
              <p><strong>Salario Base:</strong> $${comprobante.salarioBase.toLocaleString()}</p>
              <p><strong>Total Horas:</strong> ${comprobante.totalHoras}</p>
              <p><strong>Salario Neto:</strong> $${comprobante.salarioNeto.toLocaleString()}</p>
              ${
                comprobante.deudaValor > 0
                  ? `<p><strong>Deuda Descontada:</strong> $${comprobante.deudaValor.toLocaleString()}</p>`
                  : ''
              }
              <p><strong>Fecha:</strong> ${comprobante.fechaGeneracion}</p>
            </div>
          </div>
        `;

        // Crear modal de resumen
        const modal = document.createElement('div');
        modal.className = 'axyra-modal show';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>Comprobante Generado</h3>
              <span class="axyra-modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
            </div>
            <div class="axyra-modal-body">
              ${resumenHTML}
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-primary" onclick="descargarComprobante('${comprobante.id}')">
                <i class="fas fa-download"></i> Descargar PDF
              </button>
              <button class="axyra-btn axyra-btn-ghost" onclick="this.parentElement.parentElement.parentElement.remove()">
                Cerrar
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      }

      // Funci√≥n para descargar comprobante (placeholder)
      function descargarComprobante(comprobanteId) {
        mostrarMensaje('üìã Funci√≥n de descarga de PDF en desarrollo', 'info');
        // Aqu√≠ se implementar√≠a la generaci√≥n real del PDF
      }

      // Funci√≥n para previsualizar comprobante
      function previsualizarComprobante() {
        try {
          const empleadoId = document.getElementById('empleadoComprobante').value;
          const tipoContrato = document.getElementById('tipoContrato').value;
          const salarioBase = parseFloat(document.getElementById('salarioBase').value) || 0;
          const deudaComentario = document.getElementById('deudaComentario').value;
          const deudaValor = parseFloat(document.getElementById('deudaValor').value) || 0;

          if (!empleadoId) {
            mostrarMensaje('‚ùå Por favor selecciona un empleado', 'warning');
            return;
          }

          if (!salarioBase || salarioBase <= 0) {
            mostrarMensaje('‚ùå Por favor ingresa un salario base v√°lido', 'warning');
            return;
          }

          // Obtener datos del empleado
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (!empleadosData) {
            mostrarMensaje('‚ùå No se encontraron datos de empleados', 'warning');
            return;
          }

          const empleados = JSON.parse(empleadosData);
          const empleado = empleados.find((emp) => emp.id === empleadoId);

          if (!empleado) {
            mostrarMensaje('‚ùå Empleado no encontrado', 'warning');
            return;
          }

          // Crear previsualizaci√≥n
          const previsualizacionHTML = `
            <div class="axyra-comprobante-resumen">
              <h4>üìã Previsualizaci√≥n del Comprobante</h4>
              <div class="axyra-resumen-details">
                <p><strong>Empleado:</strong> ${empleado.nombre}</p>
                <p><strong>C√©dula:</strong> ${empleado.cedula || 'N/A'}</p>
                <p><strong>Tipo de Contrato:</strong> ${tipoContrato}</p>
                <p><strong>Salario Base:</strong> $${salarioBase.toLocaleString()}</p>
                <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                ${deudaValor > 0 ? `<p><strong>Deuda a Descontar:</strong> $${deudaValor.toLocaleString()}</p>` : ''}
                ${deudaComentario ? `<p><strong>Motivo de Deuda:</strong> ${deudaComentario}</p>` : ''}
                <p><strong>Fecha de Generaci√≥n:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
              </div>
              <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <p style="margin: 0; color: #1e40af; font-weight: 600;">
                  <i class="fas fa-info-circle"></i> 
                  Este es solo un resumen. Para generar el comprobante completo, haz clic en "Generar Comprobante PDF"
                </p>
              </div>
            </div>
          `;

          // Crear modal de previsualizaci√≥n
          const modal = document.createElement('div');
          modal.className = 'axyra-modal show';
          modal.innerHTML = `
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3>Previsualizaci√≥n del Comprobante</h3>
                <span class="axyra-modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
              </div>
              <div class="axyra-modal-body">
                ${previsualizacionHTML}
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-primary" onclick="generarComprobante()">
                  <i class="fas fa-file-pdf"></i> Generar Comprobante
                </button>
                <button class="axyra-btn axyra-btn-ghost" onclick="this.parentElement.parentElement.parentElement.remove()">
                  Cerrar
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error('‚ùå Error en previsualizaci√≥n:', error);
          mostrarMensaje('‚ùå Error al previsualizar: ' + error.message, 'error');
        }
      }

      // Funci√≥n auxiliar para obtener ID del usuario actual
      function getCurrentUserId() {
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }
        return currentUser ? currentUser.username || currentUser.email : 'admin';
      }

      // Funci√≥n para exportar historial de horas a Excel
      function exportarHistorialHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          if (horas.length === 0) {
            mostrarMensaje('‚ùå No hay registros de horas para exportar', 'warning');
            return;
          }

          // Verificar si el exportador est√° disponible
          if (typeof window.axyraExcelExporter === 'undefined') {
            window.axyraExcelExporter = new AXYRAExcelExporter();
          }

          // Preparar datos para exportar
          const datosExportar = horas.map((registro) => {
            const empleado = empleados.find((emp) => emp.id === registro.empleadoId);
            return {
              empleado: empleado ? empleado.nombre : 'Empleado no encontrado',
              departamento: empleado ? empleado.departamento : 'N/A',
              fecha: registro.fecha,
              horasOrdinarias: registro.horasOrdinarias || 0,
              horasNocturnas: registro.horasNocturnas || 0,
              horasExtraDiurnas: registro.horasExtraDiurnas || 0,
              horasExtraNocturnas: registro.horasExtraNocturnas || 0,
              horasDominicales: registro.horasDominicales || 0,
              horasFestivas: registro.horasFestivas || 0,
              totalHoras:
                (registro.horasOrdinarias || 0) +
                (registro.horasNocturnas || 0) +
                (registro.horasExtraDiurnas || 0) +
                (registro.horasExtraNocturnas || 0) +
                (registro.horasDominicales || 0) +
                (registro.horasFestivas || 0),
              observaciones: registro.observaciones || '',
            };
          });

          // Usar el sistema de Excel profesional
          const nombreArchivo = window.axyraExcelExporter.exportarHoras(datosExportar);
          mostrarMensaje(`‚úÖ Historial de horas exportado a Excel correctamente: ${nombreArchivo}`, 'success');
        } catch (error) {
          console.error('‚ùå Error exportando historial de horas:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Configurar listener para cambios en empleados
      function configurarListenerCambiosEmpleados() {
        try {
          console.log('üëÇ Configurando listener para cambios en empleados...');

          // Escuchar eventos personalizados
          window.addEventListener('axyraEmpleadosCambiados', async (event) => {
            console.log('üì¢ Evento de cambio en empleados recibido:', event.detail);

            // Verificar que el cambio sea para el usuario actual
            let currentUser = null;
            if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
              currentUser = window.axyraIsolatedAuth.getCurrentUser();
            } else {
              const userData = localStorage.getItem('axyra_isolated_user');
              if (userData) {
                currentUser = JSON.parse(userData);
              }
            }

            if (currentUser && event.detail.userId === (currentUser.id || currentUser.username || currentUser.email)) {
              console.log('üîÑ Refrescando horas por cambio en empleados...');
              await cargarEmpleados();
            }
          });

          // Tambi√©n escuchar cambios en localStorage para compatibilidad
          window.addEventListener('storage', (event) => {
            if (event.key === 'axyra_last_employee_change') {
              try {
                const changeData = JSON.parse(event.newValue);
                console.log('üì¢ Cambio en empleados detectado v√≠a localStorage:', changeData);

                // Verificar que el cambio sea para el usuario actual
                let currentUser = null;
                if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
                  currentUser = window.axyraIsolatedAuth.getCurrentUser();
                } else {
                  const userData = localStorage.getItem('axyra_isolated_user');
                  if (userData) {
                    currentUser = JSON.parse(userData);
                  }
                }

                if (
                  currentUser &&
                  changeData.userId === (currentUser.id || currentUser.username || currentUser.email)
                ) {
                  console.log('üîÑ Refrescando horas por cambio en empleados (localStorage)...');
                  setTimeout(() => cargarEmpleados(), 100);
                }
              } catch (error) {
                console.error('‚ùå Error procesando cambio v√≠a localStorage:', error);
              }
            }
          });

          console.log('‚úÖ Listener configurado correctamente');
        } catch (error) {
          console.error('‚ùå Error configurando listener:', error);
        }
      }
    </script>

    <style>
      .axyra-info-dia {
        margin-bottom: var(--spacing-lg);
        border: 2px solid var(--axyra-blue-200);
        border-radius: var(--border-radius-md);
        background: var(--axyra-blue-50);
      }

      .axyra-validaciones {
        margin-bottom: var(--spacing-lg);
        border: 2px solid var(--axyra-orange-200);
        border-radius: var(--border-radius-md);
        background: var(--axyra-orange-50);
      }

      .axyra-validacion-error {
        background: var(--axyra-red-100);
        border: 1px solid var(--axyra-red-300);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm);
        margin: var(--spacing-sm) 0;
      }

      .axyra-validacion-error p {
        color: var(--axyra-red-700);
        margin: 0.25rem 0;
        font-size: 0.875rem;
      }

      .axyra-validacion-warning {
        background: var(--axyra-orange-100);
        border: 1px solid var(--axyra-orange-300);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm);
        margin: var(--spacing-sm) 0;
      }

      .axyra-validacion-warning p {
        color: var(--axyra-orange-700);
        margin: 0.25rem 0;
        font-size: 0.875rem;
      }

      .axyra-descripcion-horas {
        margin-top: var(--spacing-lg);
      }

      .axyra-badge-festivo {
        background: var(--axyra-purple-100);
        color: var(--axyra-purple-700);
        border: 1px solid var(--axyra-purple-300);
      }

      .axyra-badge-dominical {
        background: var(--axyra-blue-100);
        color: var(--axyra-blue-700);
        border: 1px solid var(--axyra-blue-300);
      }

      .axyra-badge-laboral {
        background: var(--axyra-green-100);
        color: var(--axyra-green-700);
        border: 1px solid var(--axyra-green-300);
      }

      /* Estilos espec√≠ficos para gesti√≥n de horas */
      .axyra-calculo-container {
        max-width: 100%;
        overflow-x: auto;
      }

      .axyra-calculo-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
      }

      .axyra-calculo-section h4 {
        color: #1e40af;
        margin-bottom: 15px;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .axyra-calculo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .axyra-calculo-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
      }

      .axyra-calculo-item:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      }

      .axyra-calculo-total {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        font-weight: 600;
        border: none;
      }

      .axyra-calculo-label {
        font-weight: 500;
        color: #374151;
      }

      .axyra-calculo-value {
        font-weight: 600;
        color: #1f2937;
      }

      .axyra-calculo-total .axyra-calculo-label,
      .axyra-calculo-total .axyra-calculo-value {
        color: white;
      }

      .axyra-calculo-resumen {
        margin-top: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        border-radius: 12px;
        color: white;
      }

      .axyra-calculo-resumen-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .axyra-calculo-resumen-item:last-child {
        border-bottom: none;
        font-size: 18px;
        font-weight: 700;
      }

      .axyra-calculo-resumen-label {
        font-weight: 500;
      }

      .axyra-calculo-resumen-value {
        font-weight: 700;
        font-size: 18px;
      }

      /* Modal grande para c√°lculos */
      .axyra-modal-large {
        max-width: 800px;
        max-height: 90vh;
      }

      /* Estilos para resumen de comprobante */
      .axyra-comprobante-resumen {
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .axyra-comprobante-resumen h4 {
        color: #059669;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.2rem;
      }

      .axyra-resumen-details {
        display: grid;
        gap: 12px;
      }

      .axyra-resumen-details p {
        margin: 0;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-resumen-details p:last-child {
        border-bottom: none;
      }

      .axyra-resumen-details strong {
        color: #374151;
        font-weight: 600;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .axyra-calculo-grid {
          grid-template-columns: 1fr;
        }

        .axyra-calculo-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }
    </style>

    <!-- Inicializaci√≥n autom√°tica del m√≥dulo de horas -->
    <script>
      // Inicializar m√≥dulo de horas cuando se carga la p√°gina
      document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ M√≥dulo de horas cargado, verificando autenticaci√≥n...');

        // Esperar un poco para que se carguen todos los scripts
        setTimeout(async () => {
          await inicializarHoras();
        }, 500);
      });

      // Funci√≥n para cargar datos desde Firebase
      async function cargarDatosFirebase() {
        try {
          console.log('üîÑ Cargando datos desde Firebase...');
          
          // Verificar si Firebase est√° disponible
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.warn('‚ö†Ô∏è Firebase no disponible, usando localStorage como fallback');
            await cargarDatosLocalStorage();
            return;
          }

          const db = firebase.firestore();
          
          // Obtener userId del usuario autenticado en Firebase
          let userId = null;
          
          // Intentar obtener el usuario actual de Firebase Auth
          if (firebase.auth().currentUser) {
            userId = firebase.auth().currentUser.uid;
            console.log('‚úÖ Usuario autenticado en Firebase:', userId);
          } else {
            // Fallback: buscar en localStorage o usar el usuario aislado
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              const user = JSON.parse(userData);
              userId = user.username || user.email;
            }
            
            if (!userId) {
              console.warn('‚ö†Ô∏è No se puede identificar usuario, usando localStorage');
              await cargarDatosLocalStorage();
              return;
            }
          }

          console.log('üîç Buscando datos para userId:', userId);

          // Cargar empleados desde Firebase - buscar por userId
          try {
            const empleadosSnapshot = await db.collection('empleados')
              .where('userId', '==', userId)
              .get();
            
            empleados = empleadosSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`‚úÖ ${empleados.length} empleados cargados desde Firebase para userId: ${userId}`);
            
            // Si no hay empleados con ese userId, intentar buscar sin filtro
            if (empleados.length === 0) {
              console.log('üîç No se encontraron empleados con userId espec√≠fico, buscando todos...');
              const allEmpleadosSnapshot = await db.collection('empleados').get();
              empleados = allEmpleadosSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              console.log(`‚úÖ ${empleados.length} empleados totales encontrados en Firebase`);
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando empleados desde Firebase:', error);
            empleados = [];
          }

          // Cargar horas desde Firebase
          try {
            const horasSnapshot = await db.collection('horas')
              .where('userId', '==', userId)
              .get();
            
            horas = horasSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`‚úÖ ${horas.length} horas cargadas desde Firebase`);
          } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando horas desde Firebase:', error);
            horas = [];
          }

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_horas', JSON.stringify(horas));

        } catch (error) {
          console.error('‚ùå Error cargando datos desde Firebase:', error);
          // Fallback a localStorage
          await cargarDatosLocalStorage();
        }
      }

      // Funci√≥n para cargar datos desde localStorage (fallback)
      async function cargarDatosLocalStorage() {
        try {
          console.log('üîÑ Cargando datos desde localStorage...');
          
          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username;
            });
          }

          // Cargar horas
          const horasData = localStorage.getItem('axyra_horas');
          if (horasData) {
            horas = JSON.parse(horasData);
            // Filtrar por usuario actual
            horas = horas.filter((h) => {
              if (!h.userId) return true; // Datos globales
              return h.userId === currentUser?.username;
            });
          }

          console.log(
            `‚úÖ Datos cargados desde localStorage: ${empleados.length} empleados, ${horas.length} horas`
          );
          
        } catch (error) {
          console.error('‚ùå Error cargando datos desde localStorage:', error);
        }
      }

      // Funci√≥n de inicializaci√≥n mejorada
      async function inicializarHoras() {
        try {
          console.log('üöÄ Inicializando m√≥dulo de horas...');
          
          // Verificar autenticaci√≥n
          await verificarAutenticacion();

          // Intentar cargar desde Firebase primero
          await cargarDatosFirebase();

          // Llenar selects
          cargarEmpleadosEnSelects(empleados);

          // Renderizar tabla
          renderizarTablaHoras();

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();

          console.log('‚úÖ M√≥dulo de horas inicializado correctamente');
        } catch (error) {
          console.error('‚ùå Error inicializando horas:', error);
          mostrarNotificacion('Error inicializando m√≥dulo de horas', 'error');
        }
      }
    </script>
  </body>
</html>
