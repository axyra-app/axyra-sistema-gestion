<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Dashboard</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Scripts removidos por limpieza del sistema -->

    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Dashboard</div>
          </div>
        </div>

        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link" onclick="irAInicio(event)">
            <i class="fas fa-home"></i> Inicio
          </a>
          <a href="dashboard.html" class="axyra-nav-link active"> <i class="fas fa-tachometer-alt"></i> Dashboard </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="../nomina/gestionar_nomina.html" class="axyra-nav-link">
            <i class="fas fa-file-invoice-dollar"></i> N√≥mina
          </a>
          <a href="../cuadre_caja/cuadre_caja.html" class="axyra-nav-link">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuraci√≥n
          </a>
          <button class="axyra-btn axyra-btn-ghost" onclick="irAInicio(event)">
            <i class="fas fa-home"></i> Inicio
          </button>
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Dashboard</h1>
          <p class="axyra-page-subtitle">Resumen general de tu empresa y estad√≠sticas importantes</p>
        </div>

        <!-- Mensaje de Bienvenida -->
        <div class="axyra-welcome-card" id="welcomeCard">
          <div class="axyra-welcome-icon">
            <i class="fas fa-sun"></i>
          </div>
          <div class="axyra-welcome-content">
            <h2 class="axyra-welcome-title" id="welcomeTitle">¬°Bienvenido a AXYRA!</h2>
            <p class="axyra-welcome-message" id="welcomeMessage">
              Esperamos que tengas un excelente d√≠a gestionando tu empresa
            </p>
            <div class="axyra-welcome-time" id="welcomeTime"></div>
          </div>
        </div>

        <!-- Estad√≠sticas Principales -->
        <div class="axyra-stats-grid">
          <div class="axyra-stat-card clickable" onclick="mostrarDetalleEmpleados()">
            <div class="axyra-stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="axyra-stat-number" id="totalEmpleados">0</div>
            <div class="axyra-stat-label">Total Empleados</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleHoras()">
            <div class="axyra-stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="axyra-stat-number" id="horasTrabajadas">0</div>
            <div class="axyra-stat-label">Horas Trabajadas</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleComprobantes()">
            <div class="axyra-stat-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="axyra-stat-number" id="comprobantesGenerados">0</div>
            <div class="axyra-stat-label">Comprobantes</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleSalarios()">
            <div class="axyra-stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="axyra-stat-number" id="totalSalarios">$0</div>
            <div class="axyra-stat-label">Total Salarios</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>
        </div>

        <!-- Indicadores de Productividad -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Indicadores de Productividad</h3>
              <p class="axyra-card-subtitle">M√©tricas de eficiencia y rendimiento</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div id="productivityIndicators">
              <!-- Los indicadores se cargan din√°micamente -->
            </div>
          </div>
        </div>

        <!-- Gr√°ficos y An√°lisis -->
        <div class="axyra-grid axyra-grid-2">
          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Distribuci√≥n de Empleados</h3>
                <p class="axyra-card-subtitle">Por departamento</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="employeeDistributionChart" style="height: 300px"></div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Tendencia de Horas</h3>
                <p class="axyra-card-subtitle">Por mes</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="hoursTrendChart" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <div class="axyra-grid axyra-grid-2">
          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-bar"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Distribuci√≥n de Salarios</h3>
                <p class="axyra-card-subtitle">Por departamento</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="salaryDistributionChart" style="height: 300px"></div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-area"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">M√©tricas de Productividad</h3>
                <p class="axyra-card-subtitle">Eficiencia y ocupaci√≥n</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="productivityChart" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <!-- Configuraci√≥n Regional -->
        <div class="axyra-grid axyra-grid-2"></div>

        <!-- Panel de Configuraci√≥n -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-cog"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Configuraci√≥n de Cuenta</h3>
              <p class="axyra-card-subtitle">Gestiona tu perfil y configuraciones de seguridad</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-config-grid">
              <!-- Perfil de Usuario -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-user"></i> Perfil de Usuario</h4>
                <div class="axyra-config-item">
                  <label>Nombre de Usuario:</label>
                  <input type="text" id="configUsername" class="axyra-config-input" />
                  <button class="axyra-config-btn" onclick="actualizarUsername()">
                    <i class="fas fa-save"></i> Actualizar
                  </button>
                </div>
                <div class="axyra-config-item">
                  <label>Email:</label>
                  <input type="email" id="configEmail" class="axyra-config-input" readonly />
                  <span class="axyra-config-status" id="emailStatus">No verificado</span>
                </div>
              </div>

              <!-- Seguridad -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-shield-alt"></i> Seguridad</h4>
                <div class="axyra-config-item">
                  <label>Cambiar Contrase√±a:</label>
                  <button class="axyra-config-btn" onclick="mostrarModalCambiarPassword()">
                    <i class="fas fa-key"></i> Cambiar
                  </button>
                </div>
                <div class="axyra-config-item">
                  <label>Autenticaci√≥n 2FA:</label>
                  <div class="axyra-2fa-controls">
                    <button class="axyra-config-btn" id="btn2FA" onclick="toggle2FA()">
                      <i class="fas fa-toggle-off"></i> Deshabilitado
                    </button>
                    <button
                      class="axyra-config-btn"
                      onclick="configurarGoogleAuthenticator()"
                      style="display: none"
                      id="btnGoogleAuth"
                    >
                      <i class="fab fa-google"></i> Google Auth
                    </button>
                  </div>
                  <small class="axyra-help-text">El 2FA solo se pedir√° si lo tienes habilitado</small>
                </div>
                <div class="axyra-config-item">
                  <label>Verificaci√≥n de Email:</label>
                  <button class="axyra-config-btn" onclick="enviarVerificacionEmail()" id="btnVerificarEmail">
                    <i class="fas fa-envelope"></i> Verificar
                  </button>
                </div>
              </div>

              <!-- Preferencias -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-sliders-h"></i> Preferencias</h4>
                <div class="axyra-config-item">
                  <label>Recordar Sesi√≥n:</label>
                  <select id="configRememberSession" class="axyra-config-select" onchange="actualizarPreferencias()">
                    <option value="0">Siempre pedir login</option>
                    <option value="1">1 d√≠a</option>
                    <option value="7">1 semana</option>
                    <option value="30">1 mes</option>
                  </select>
                </div>
                <div class="axyra-config-item">
                  <label>Notificaciones:</label>
                  <label class="axyra-checkbox">
                    <input type="checkbox" id="configNotificaciones" onchange="actualizarPreferencias()" />
                    <span class="checkmark"></span>
                    Recibir notificaciones por email
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Actividad Reciente</h3>
              <p class="axyra-card-subtitle">√öltimas acciones en el sistema</p>
            </div>
          </div>
          <div id="actividadReciente">
            <!-- La actividad se cargar√° din√°micamente -->
          </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Acciones R√°pidas</h3>
              <p class="axyra-card-subtitle">Accede r√°pidamente a las funciones principales</p>
            </div>
          </div>
          <div class="axyra-actions-bar">
            <button
              onclick="mostrarModalAccion('Agregar Empleado', '¬øDeseas ir a la p√°gina de empleados para agregar un nuevo empleado?', 'empleados')"
              class="axyra-btn axyra-btn-primary"
            >
              <i class="fas fa-user-plus"></i> Agregar Empleado
            </button>
            <button
              onclick="mostrarModalAccion('Registrar Horas', '¬øDeseas ir a la p√°gina de horas para registrar el tiempo trabajado?', 'horas')"
              class="axyra-btn axyra-btn-secondary"
            >
              <i class="fas fa-clock"></i> Registrar Horas
            </button>
            <button
              onclick="mostrarModalAccion('Generar N√≥mina', '¬øDeseas ir a la p√°gina de n√≥mina para generar el reporte de salarios?', 'nomina')"
              class="axyra-btn axyra-btn-success"
            >
              <i class="fas fa-file-invoice-dollar"></i> Generar N√≥mina
            </button>
            <button
              onclick="mostrarModalAccion('Cuadre de Caja', '¬øDeseas ir a la p√°gina de cuadre de caja para revisar los ingresos?', 'cuadre')"
              class="axyra-btn axyra-btn-info"
            >
              <i class="fas fa-calculator"></i> Cuadre de Caja
            </button>
            <button
              onclick="mostrarModalConfirmacion('Limpiar Datos', '¬øEst√°s seguro de que deseas limpiar todos los datos corruptos del sistema? Esta acci√≥n no se puede deshacer.', 'limpiarDatosCorruptos')"
              class="axyra-btn axyra-btn-warning"
            >
              <i class="fas fa-broom"></i> Limpiar Datos
            </button>
            <button
              onclick="mostrarModalConfirmacion('Resetear Todo', '‚ö†Ô∏è ADVERTENCIA: ¬øEst√°s completamente seguro de que deseas eliminar TODOS los datos del sistema? Esta acci√≥n es IRREVERSIBLE y eliminar√° toda la informaci√≥n.', 'resetearLocalStorage')"
              class="axyra-btn axyra-btn-danger"
            >
              <i class="fas fa-trash"></i> Resetear Todo
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal Cambiar Contrase√±a -->
    <div id="modalCambiarPassword" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3><i class="fas fa-key"></i> Cambiar Contrase√±a</h3>
          <button class="axyra-modal-close" onclick="cerrarModalCambiarPassword()">&times;</button>
        </div>
        <div class="axyra-modal-body">
          <form id="formCambiarPassword">
            <div class="axyra-form-group">
              <label for="currentPassword">Contrase√±a Actual:</label>
              <div class="password-container">
                <input type="password" id="currentPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleCurrentPassword()">
                  <i class="fas fa-eye" id="currentPasswordIcon"></i>
                </button>
              </div>
            </div>
            <div class="axyra-form-group">
              <label for="newPassword">Nueva Contrase√±a:</label>
              <div class="password-container">
                <input type="password" id="newPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleNewPassword()">
                  <i class="fas fa-eye" id="newPasswordIcon"></i>
                </button>
              </div>
              <small class="axyra-form-help">M√≠nimo 8 caracteres, incluir may√∫sculas y n√∫meros</small>
            </div>
            <div class="axyra-form-group">
              <label for="confirmNewPassword">Confirmar Nueva Contrase√±a:</label>
              <div class="password-container">
                <input type="password" id="confirmNewPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleConfirmNewPassword()">
                  <i class="fas fa-eye" id="confirmNewPasswordIcon"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalCambiarPassword()">Cancelar</button>
          <button class="axyra-btn axyra-btn-primary" onclick="cambiarPassword()">Cambiar Contrase√±a</button>
        </div>
      </div>
    </div>

    <!-- Modal Configurar Google Authenticator -->
    <div id="modalGoogleAuth" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3><i class="fab fa-google"></i> Configurar Google Authenticator</h3>
          <button class="axyra-modal-close" onclick="cerrarModalGoogleAuth()">&times;</button>
        </div>
        <div class="axyra-modal-body">
          <div class="axyra-google-auth-setup">
            <div class="axyra-qr-section">
              <h4>1. Escanea el c√≥digo QR</h4>
              <div id="qrCode" class="axyra-qr-container">
                <!-- El c√≥digo QR se generar√° aqu√≠ -->
              </div>
              <p>Usa la aplicaci√≥n Google Authenticator para escanear este c√≥digo</p>
            </div>
            <div class="axyra-manual-section">
              <h4>2. O ingresa manualmente</h4>
              <div class="axyra-form-group">
                <label>Clave Secreta:</label>
                <input type="text" id="secretKey" class="axyra-form-input" readonly />
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="copiarClaveSecreta()">
                  <i class="fas fa-copy"></i> Copiar
                </button>
              </div>
              <p>Ingresa esta clave en tu aplicaci√≥n de autenticaci√≥n</p>
            </div>
            <div class="axyra-verification-section">
              <h4>3. Verifica la configuraci√≥n</h4>
              <div class="axyra-form-group">
                <label>C√≥digo de Verificaci√≥n:</label>
                <input
                  type="text"
                  id="verificationCode"
                  class="axyra-form-input"
                  placeholder="Ingresa el c√≥digo de 6 d√≠gitos"
                  maxlength="6"
                />
              </div>
              <button class="axyra-btn axyra-btn-primary" onclick="verificarGoogleAuth()">
                <i class="fas fa-check"></i> Verificar y Activar
              </button>
            </div>
          </div>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalGoogleAuth()">Cancelar</button>
        </div>
      </div>
    </div>

    <script>
      // Verificar autenticaci√≥n
      async function checkAuth() {
        try {
          console.log('üîê Verificando autenticaci√≥n...');

          // Verificar sesi√≥n en localStorage primero
          const savedUser = localStorage.getItem('axyra_user');
          if (savedUser) {
            try {
              const userData = JSON.parse(savedUser);
              const lastLogin = new Date(userData.lastLogin);
              const now = new Date();
              const hoursDiff = (now - lastLogin) / (1000 * 60 * 60);

              // Sesi√≥n v√°lida por 24 horas
              if (hoursDiff < 24) {
                console.log('‚úÖ Sesi√≥n v√°lida encontrada:', userData.email);
                currentUser = userData;
                return true;
              } else {
                localStorage.removeItem('axyra_user');
                localStorage.removeItem('axyra_firebase_user');
              }
            } catch (error) {
              localStorage.removeItem('axyra_user');
              localStorage.removeItem('axyra_firebase_user');
            }
          }

          // Verificar Firebase si est√° disponible
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession) {
            try {
              currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
              console.log('‚úÖ Usuario autenticado con Firebase:', currentUser.email);

              return true;
            } catch (error) {
              console.log('‚ö†Ô∏è Error con Firebase, usando sesi√≥n local');
            }
          }

          // No hay sesi√≥n activa
          console.log('‚ö†Ô∏è No hay sesi√≥n activa - redirigiendo al login');
          window.location.href = '../../login.html';
          return false;
        } catch (error) {
          console.error('‚ùå Error al verificar sesi√≥n:', error);
          window.location.href = '../../login.html';
          return false;
        }
      }

      // Ir a inicio
      function irAInicio(event) {
        event.preventDefault();
        // Simplemente ir a la p√°gina principal sin verificar sesi√≥n
        window.location.href = '../../index.html';
      }

      // Cerrar sesi√≥n
      // Cerrar sesi√≥n - SISTEMA AISLADO
      function logout() {
        console.log('üîÑ Cerrando sesi√≥n desde dashboard...');
        
        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }
        
        console.log('‚úÖ Sesi√≥n cerrada desde dashboard');
        
        // Redirigir al login
        window.location.href = '../../login.html';
      }

      // Funci√≥n para limpiar datos corruptos del localStorage
      function limpiarDatosCorruptos() {
        console.log('=== LIMPIANDO DATOS CORRUPTOS ===');

        // Mostrar todos los datos del localStorage para depuraci√≥n
        console.log('=== DATOS COMPLETOS DEL LOCALSTORAGE ===');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('axyra_')) {
            console.log(`${key}:`, localStorage.getItem(key));
          }
        }

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
          currentUser = axyraUserSystem.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para limpieza de datos');
          return;
        }

        // Limpiar empleados con salarios inv√°lidos FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        console.log('Empleados del usuario antes de limpieza:', empleados);

        const empleadosLimpios = empleados.filter((empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            console.log('Empleado sin salario v√°lido:', empleado);
            return false;
          }
          const salario = parseFloat(empleado.salario);
          if (isNaN(salario) || salario <= 0) {
            console.log('Empleado con salario inv√°lido:', empleado);
            return false;
          }
          return true;
        });

        // Guardar empleados limpios
        localStorage.setItem('axyra_empleados', JSON.stringify(empleadosLimpios));
        console.log('Empleados despu√©s de limpieza:', empleadosLimpios);

        // Recargar estad√≠sticas
        cargarEstadisticas();

        // Mostrar mensaje de confirmaci√≥n usando modal
        mostrarMensaje(
          '‚úÖ Datos corruptos limpiados correctamente. Se han eliminado empleados con salarios inv√°lidos.',
          'success'
        );
      }

      // Funci√≥n para resetear completamente el localStorage (√∫ltimo recurso)
      function resetearLocalStorage() {
        console.log('=== RESETEANDO LOCALSTORAGE ===');

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
          currentUser = axyraUserSystem.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para reset de datos');
          return;
        }

        // Eliminar solo los datos de AXYRA DEL USUARIO ACTUAL
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('axyra_') && key !== 'axyra_user') {
            keysToRemove.push(key);
          }
        }

        keysToRemove.forEach((key) => {
          localStorage.removeItem(key);
          console.log(`Eliminado: ${key}`);
        });

        console.log('LocalStorage reseteado completamente');
        console.log('‚úÖ Usuario mantiene su sesi√≥n:', currentUser.username);

        // Mostrar mensaje de √©xito
        mostrarMensaje(
          '‚úÖ Todos los datos han sido reseteados correctamente. Tu sesi√≥n se mantiene activa.',
          'success'
        );

        // Recargar las estad√≠sticas sin recargar la p√°gina
        setTimeout(() => {
          cargarEstadisticas();
          cargarActividadReciente();
        }, 1000);
      }

      // Funci√≥n para verificar autom√°ticamente datos corruptos
      function verificarDatosCorruptos() {
        console.log('=== VERIFICANDO DATOS CORRUPTOS AUTOM√ÅTICAMENTE ===');

        let datosCorruptos = false;

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
          currentUser = axyraUserSystem.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para verificaci√≥n de datos');
          return;
        }

        // Verificar empleados FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        const empleadosLimpios = empleados.filter((empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            console.log('Empleado sin salario v√°lido detectado:', empleado);
            datosCorruptos = true;
            return false;
          }
          const salario = parseFloat(empleado.salario);
          if (isNaN(salario) || salario <= 0 || salario > 1000000000) {
            // L√≠mite razonable de 1 bill√≥n
            console.log('Empleado con salario inv√°lido detectado:', empleado);
            datosCorruptos = true;
            return false;
          }
          return true;
        });

        // Si se encontraron datos corruptos, limpiarlos autom√°ticamente
        if (datosCorruptos) {
          console.log('Datos corruptos detectados. Limpiando autom√°ticamente...');
          localStorage.setItem('axyra_empleados', JSON.stringify(empleadosLimpios));
          console.log('Empleados despu√©s de limpieza autom√°tica:', empleadosLimpios);
        }

        // Verificar otros datos FILTRADOS POR USUARIO
        const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
          (hr) => hr.userId === currentUser.username
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username
        );

        // Verificar que no haya valores extremadamente altos
        const totalSalarios = empleadosLimpios.reduce((total, empleado) => {
          const salario = parseFloat(empleado.salario) || 0;
          return total + salario;
        }, 0);

        if (totalSalarios > 1000000000) {
          // M√°s de 1 bill√≥n
          console.log('Total de salarios extremadamente alto detectado:', totalSalarios);
          console.log('Limpiando todos los datos de empleados...');
          localStorage.removeItem('axyra_empleados');
          localStorage.removeItem('axyra_horas');
          localStorage.removeItem('axyra_comprobantes');
          datosCorruptos = true;
        }

        if (datosCorruptos) {
          console.log('‚úÖ Datos corruptos corregidos autom√°ticamente');
        } else {
          console.log('‚úÖ No se encontraron datos corruptos');
        }
      }

      // Funci√≥n para actualizar indicador de seguridad
      function updateSecurityStatus() {
        const securityStatus = document.getElementById('securityStatus');
        if (!securityStatus) return;

        try {
          if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
            const user = axyraUserSystem.getCurrentUser();
            if (user) {
              securityStatus.className = 'axyra-security-indicator';
              securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>Sesi√≥n Activa</span>';
            } else {
              securityStatus.className = 'axyra-security-indicator warning';
              securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Sesi√≥n Expirada</span>';
            }
          } else {
            // Verificar localStorage como fallback
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              try {
                const user = JSON.parse(userData);
                if (user && user.username) {
                  securityStatus.className = 'axyra-security-indicator';
                  securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>Sesi√≥n Activa</span>';
                  return;
                }
              } catch (error) {
                console.error('Error parseando sesi√≥n:', error);
              }
            }

            securityStatus.className = 'axyra-security-indicator danger';
            securityStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Sin Seguridad</span>';
          }
        } catch (error) {
          console.error('Error actualizando estado de seguridad:', error);
          securityStatus.className = 'axyra-security-indicator danger';
          securityStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Error</span>';
        }
      }

      // Cargar estad√≠sticas
      async function cargarEstadisticas() {
        try {
          console.log('üìä Cargando estad√≠sticas...');

          // Obtener usuario actual para aislamiento de datos
          let currentUser = null;
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('‚úÖ Usuario Firebase:', currentUser.email);
          } else if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
            currentUser = axyraUserSystem.getCurrentUser();
            console.log('‚úÖ Usuario sistema profesional:', currentUser.username);
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.error('‚ùå No hay usuario autenticado');
            return;
          }

          // Intentar cargar datos desde Firebase primero
          if (window.axyraFirebaseDataSystem && currentUser.uid) {
            console.log('üî• Cargando datos desde Firebase...');

            try {
              // Cargar empleados desde Firebase
              const empleados = await window.axyraFirebaseDataSystem.getEmployees();
              document.getElementById('totalEmpleados').textContent = empleados.length;

              // Cargar horas desde Firebase
              const horas = await window.axyraFirebaseDataSystem.getHours();
              const totalHorasTrabajadas = horas.reduce((total, registro) => {
                const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
                const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
                const horasExtras = parseFloat(registro.horasExtras) || 0;
                const horasDominicales = parseFloat(registro.horasDominicales) || 0;
                return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
              }, 0);

              // Cargar comprobantes desde Firebase
              const comprobantes = await window.axyraFirebaseDataSystem.getReceipts();
              document.getElementById('comprobantesGenerados').textContent = comprobantes.length;

              // Calcular total de salarios base
              const totalSalarios = empleados.reduce((total, empleado) => {
                if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
                  return total;
                }
                const salario = parseFloat(empleado.salario);
                if (!isNaN(salario) && salario > 0) {
                  return total + salario;
                }
                return total;
              }, 0);

              // Formatear y mostrar datos
              formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas);

              console.log('‚úÖ Datos cargados desde Firebase');
              return;
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Error cargando desde Firebase, usando localStorage:', firebaseError);
            }
          }

          // Fallback a localStorage
          console.log('üíæ Cargando datos desde localStorage...');
          cargarEstadisticasLocalStorage(currentUser);
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas:', error);
        }
      }

      // Funci√≥n auxiliar para cargar desde localStorage
      function cargarEstadisticasLocalStorage(currentUser) {
        // Empleados FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username || emp.userId === currentUser.email
        );
        document.getElementById('totalEmpleados').textContent = empleados.length;

        // Comprobantes FILTRADOS POR USUARIO
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username || comp.userId === currentUser.email
        );
        document.getElementById('comprobantesGenerados').textContent = comprobantes.length;

        // Calcular total de salarios base
        const totalSalarios = empleados.reduce((total, empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            return total;
          }
          const salario = parseFloat(empleado.salario);
          if (!isNaN(salario) && salario > 0) {
            return total + salario;
          }
          return total;
        }, 0);

        // Calcular horas trabajadas
        const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
          (hr) => hr.userId === currentUser.username || hr.userId === currentUser.email
        );
        const totalHorasTrabajadas = registrosHoras.reduce((total, registro) => {
          const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
          const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
          const horasExtras = parseFloat(registro.horasExtras) || 0;
          const horasDominicales = parseFloat(registro.horasDominicales) || 0;
          return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
        }, 0);

        // Formatear y mostrar datos
        formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas);

        // Cargar actividad reciente
        cargarActividadReciente();
      }

      // Funci√≥n para formatear y mostrar datos
      function formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas) {
        // Formatear salario con solo 1 decimal y ajustar tama√±o
        const formatearMoneda = (monto) => {
          if (monto === 0) return '$0';
          if (monto < 1000) return `$${monto.toFixed(1)}`;
          if (monto < 1000000) return `$${(monto / 1000).toFixed(1)}K`;
          if (monto < 1000000000) return `$${(monto / 1000000).toFixed(1)}M`;
          return `$${(monto / 1000000000).toFixed(1)}B`;
        };

        document.getElementById('totalSalarios').textContent = formatearMoneda(totalSalarios);

        // Formatear horas con solo 1 decimal y ajustar tama√±o
        const formatearHoras = (horas) => {
          if (horas === 0) return '0';
          if (horas < 100) return horas.toFixed(1);
          if (horas < 1000) return (horas / 100).toFixed(1) + 'C';
          if (horas < 1000000) return (horas / 1000).toFixed(1) + 'K';
          return (horas / 1000000).toFixed(1) + 'M';
        };

        document.getElementById('horasTrabajadas').textContent = formatearHoras(totalHorasTrabajadas);
      }

      // Cargar actividad reciente
      function cargarActividadReciente() {
        const actividadReciente = document.getElementById('actividadReciente');

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
          currentUser = axyraUserSystem.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser || !currentUser.username) {
          console.error('No hay usuario autenticado para actividad reciente');
          return;
        }

        // Filtrar datos por usuario
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username
        );

        let actividadHTML = '';

        // Actividad de empleados
        if (empleados.length > 0) {
          const ultimoEmpleado = empleados[empleados.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Empleado agregado</div>
                            <div class="axyra-activity-time">${
                              ultimoEmpleado.nombre
                            } - ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad de comprobantes
        if (comprobantes.length > 0) {
          const ultimoComprobante = comprobantes[comprobantes.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Comprobante generado</div>
                            <div class="axyra-activity-time">${ultimoComprobante.empleado} - ${ultimoComprobante.fecha}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad del sistema
        actividadHTML += `
                <div class="axyra-activity-item">
                    <div class="axyra-activity-icon">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <div class="axyra-activity-content">
                        <div class="axyra-activity-title">Sesi√≥n iniciada</div>
                        <div class="axyra-activity-time">Administrador - ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            `;

        if (actividadHTML === '') {
          actividadHTML = '<p class="axyra-text-center">No hay actividad reciente</p>';
        }

        actividadReciente.innerHTML = actividadHTML;
      }

      // Funciones para mostrar detalles de las estad√≠sticas
      function mostrarDetalleEmpleados() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
            currentUser = axyraUserSystem.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
            (emp) => emp.userId === currentUser.username
          );

          let detalleHTML = '<h4>üìã Lista de Empleados</h4>';
          if (empleados.length > 0) {
            detalleHTML += '<div class="axyra-empleados-lista">';
            empleados.forEach((emp) => {
              detalleHTML += `
                <div class="axyra-empleado-item">
                  <div class="axyra-empleado-info">
                    <strong>${emp.nombre}</strong>
                    <span>${emp.cargo} - ${emp.departamento}</span>
                    <span>Salario: $${emp.salario?.toLocaleString('es-CO') || '0'}</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay empleados registrados</p>';
          }

          mostrarModal('Detalle de Empleados', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de empleados:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleHoras() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
            currentUser = axyraUserSystem.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
            (hr) => hr.userId === currentUser.username
          );

          let detalleHTML = '<h4>‚è∞ Detalle de Horas Trabajadas</h4>';
          if (registrosHoras.length > 0) {
            detalleHTML += '<div class="axyra-horas-lista">';
            registrosHoras.forEach((hr) => {
              const totalHoras =
                (parseFloat(hr.horasOrdinarias) || 0) +
                (parseFloat(hr.horasNocturnas) || 0) +
                (parseFloat(hr.horasExtras) || 0) +
                (parseFloat(hr.horasDominicales) || 0);
              detalleHTML += `
                <div class="axyra-hora-item">
                  <div class="axyra-hora-info">
                    <strong>${hr.empleado}</strong>
                    <span>Fecha: ${hr.fecha}</span>
                    <span>Total: ${totalHoras} horas</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay registros de horas</p>';
          }

          mostrarModal('Detalle de Horas', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de horas:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleComprobantes() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
            currentUser = axyraUserSystem.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
            (comp) => comp.userId === currentUser.username
          );

          let detalleHTML = '<h4>üßæ Detalle de Comprobantes</h4>';
          if (comprobantes.length > 0) {
            detalleHTML += '<div class="axyra-comprobantes-lista">';
            comprobantes.forEach((comp) => {
              detalleHTML += `
                <div class="axyra-comprobante-item">
                  <div class="axyra-comprobante-info">
                    <strong>${comp.numeroFactura}</strong>
                    <span>${comp.encargado} - ${comp.area}</span>
                    <span>$${comp.monto?.toLocaleString('es-CO') || '0'}</span>
                </div>
                <button class="axyra-btn axyra-btn-sm axyra-btn-secondary" onclick="descargarComprobante('${comp.id}')">
                  <i class="fas fa-download"></i> Descargar
                </button>
              </div>
            `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay comprobantes generados</p>';
          }

          mostrarModal('Detalle de Comprobantes', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de comprobantes:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleSalarios() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (axyraUserSystem && axyraUserSystem.hasActiveSession()) {
            currentUser = axyraUserSystem.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
            (emp) => emp.userId === currentUser.username
          );

          let detalleHTML = '<h4>üí∞ Detalle de Salarios</h4>';
          if (empleados.length > 0) {
            detalleHTML += '<div class="axyra-salarios-lista">';
            let totalGeneral = 0;
            empleados.forEach((emp) => {
              const salario = parseFloat(emp.salario) || 0;
              totalGeneral += salario;
              detalleHTML += `
                <div class="axyra-salario-item">
                  <div class="axyra-empleado-info">
                    <strong>${emp.nombre}</strong>
                    <span>${emp.cargo}</span>
                    <span class="axyra-salario-monto">$${salario.toLocaleString('es-CO')}</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += `
              <div class="axyra-salario-total">
                <strong>Total General: $${totalGeneral.toLocaleString('es-CO')}</strong>
              </div>
            `;
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay empleados registrados</p>';
          }

          mostrarModal('Detalle de Salarios', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de salarios:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      // Funci√≥n para mostrar mensajes
      function mostrarMensaje(mensaje, tipo = 'info') {
        // Remover mensajes existentes
        const existingMessages = document.querySelectorAll('.axyra-message');
        existingMessages.forEach((msg) => msg.remove());

        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        document.body.appendChild(mensajeDiv);

        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }

      // Funci√≥n para mostrar modal
      function mostrarModal(titulo, contenido) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">√ó</button>
            </div>
            <div class="axyra-modal-body">
              ${contenido}
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-primary" onclick="cerrarModal(this)">
                <i class="fas fa-check"></i> Entendido
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Funci√≥n para descargar comprobante
      function descargarComprobante(comprobanteId) {
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
        const comprobante = comprobantes.find((c) => c.id === comprobanteId);

        if (comprobante) {
          // Crear contenido del comprobante
          const contenido = `
            COMPROBANTE: ${comprobante.numeroFactura}
            FECHA: ${comprobante.fecha}
            ENCARGADO: ${comprobante.encargado}
            √ÅREA: ${comprobante.area}
            MONTO: $${comprobante.monto?.toLocaleString('es-CO') || '0'}
            M√âTODO DE PAGO: ${comprobante.metodoPago}
            DESCRIPCI√ìN: ${comprobante.descripcion}
          `;

          // Crear y descargar archivo
          const blob = new Blob([contenido], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `comprobante_${comprobante.numeroFactura}.txt`;
          a.click();
          window.URL.revokeObjectURL(url);
        }
      }

      // Funci√≥n para mostrar modal de acci√≥n (navegaci√≥n)
      function mostrarModalAccion(titulo, mensaje, accion) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">√ó</button>
            </div>
            <div class="axyra-modal-body">
              <p>${mensaje}</p>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal(this)">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-primary" onclick="ejecutarAccion('${accion}')">
                <i class="fas fa-check"></i> Continuar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Funci√≥n para mostrar modal de confirmaci√≥n (acciones destructivas)
      function mostrarModalConfirmacion(titulo, mensaje, accion) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">√ó</button>
            </div>
            <div class="axyra-modal-body">
              <p>${mensaje}</p>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal(this)">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-danger" onclick="ejecutarAccionConfirmada('${accion}')">
                <i class="fas fa-exclamation-triangle"></i> Confirmar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Funci√≥n para ejecutar acciones de navegaci√≥n
      function ejecutarAccion(accion) {
        // Cerrar modal
        document.querySelector('.axyra-modal').remove();

        // Ejecutar acci√≥n seg√∫n el tipo
        switch (accion) {
          case 'empleados':
            window.location.href = '../empleados/empleados.html';
            break;
          case 'horas':
            window.location.href = '../horas/gestionar_horas.html';
            break;
          case 'nomina':
            window.location.href = '../nomina/gestionar_nomina.html';
            break;
          case 'cuadre':
            window.location.href = '../cuadre_caja/cuadre_caja.html';
            break;
          default:
            console.log('Acci√≥n no reconocida:', accion);
        }
      }

      // Funci√≥n para ejecutar acciones confirmadas
      function ejecutarAccionConfirmada(accion) {
        // Cerrar modal
        cerrarModalesExistentes();

        // Ejecutar acci√≥n seg√∫n el tipo
        switch (accion) {
          case 'limpiarDatosCorruptos':
            limpiarDatosCorruptos();
            break;
          case 'resetearLocalStorage':
            resetearLocalStorage();
            break;
          case 'crearDatosPrueba':
            crearDatosPrueba();
            break;
          default:
            console.log('Acci√≥n confirmada no reconocida:', accion);
        }
      }

      // Funci√≥n para cerrar un modal espec√≠fico
      function cerrarModal(elemento) {
        const modal = elemento.closest('.axyra-modal');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para cerrar todos los modales existentes
      function cerrarModalesExistentes() {
        const modales = document.querySelectorAll('.axyra-modal');
        modales.forEach((modal) => modal.remove());
      }

      // Ver todas las tareas
      function verTodasLasTareas() {
        // Crear modal para mostrar todas las tareas
        const modalHTML = `
          <div id="modalTareas" class="axyra-modal show">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-tasks"></i> Todas las Tareas
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalTareas()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-tasks-container">
                  <div class="axyra-task-filters">
                    <select id="filterPrioridad" class="axyra-form-select" onchange="filtrarTareas()">
                      <option value="">Todas las prioridades</option>
                      <option value="Alta">Alta</option>
                      <option value="Media">Media</option>
                      <option value="Baja">Baja</option>
                    </select>
                    <select id="filterEstado" class="axyra-form-select" onchange="filtrarTareas()">
                      <option value="">Todos los estados</option>
                      <option value="Pendiente">Pendiente</option>
                      <option value="En Progreso">En Progreso</option>
                      <option value="Completada">Completada</option>
                    </select>
                  </div>
                  <div id="listaTareasCompleta" class="axyra-tasks-list">
                    <!-- Las tareas se cargar√°n din√°micamente -->
                  </div>
                  <div class="axyra-task-actions">
                    <button class="axyra-btn axyra-btn-primary" onclick="agregarNuevaTarea()">
                      <i class="fas fa-plus"></i> Nueva Tarea
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        cargarTodasLasTareas();
      }

      // Cerrar modal de tareas
      function cerrarModalTareas() {
        const modal = document.getElementById('modalTareas');
        if (modal) {
          modal.remove();
        }
      }

      // Cargar todas las tareas
      function cargarTodasLasTareas() {
        const listaTareas = document.getElementById('listaTareasCompleta');
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');

        let tareasHTML = '';

        // Tareas del sistema
        const tareasSistema = [
          {
            id: 'sistema-1',
            titulo: 'Configurar zona horaria',
            descripcion: 'Establecer zona horaria para Colombia',
            prioridad: 'Baja',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Sistema',
          },
          {
            id: 'sistema-2',
            titulo: 'Configurar moneda por defecto',
            descripcion: 'Establecer COP como moneda principal',
            prioridad: 'Media',
            estado: 'Completada',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Sistema',
          },
        ];

        // Tareas basadas en empleados
        if (empleados.length === 0) {
          tareasSistema.push({
            id: 'empleado-1',
            titulo: 'Agregar primer empleado',
            descripcion: 'Registrar el primer empleado en el sistema',
            prioridad: 'Alta',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Empleado',
          });
        }

        // Tareas basadas en comprobantes
        if (comprobantes.length === 0 && empleados.length > 0) {
          tareasSistema.push({
            id: 'comprobante-1',
            titulo: 'Generar primer comprobante',
            descripcion: 'Crear el primer comprobante de pago',
            prioridad: 'Media',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Comprobante',
          });
        }

        // Mostrar todas las tareas
        tareasSistema.forEach((tarea) => {
          const prioridadClass = tarea.prioridad.toLowerCase().replace(' ', '-');
          const estadoClass = tarea.estado.toLowerCase().replace(' ', '-');

          tareasHTML += `
            <div class="axyra-task-item" data-prioridad="${tarea.prioridad}" data-estado="${tarea.estado}">
              <div class="axyra-task-header">
                <div class="axyra-task-title">${tarea.titulo}</div>
                <div class="axyra-task-meta">
                  <span class="axyra-badge axyra-badge-${prioridadClass}">${tarea.prioridad}</span>
                  <span class="axyra-badge axyra-badge-${estadoClass}">${tarea.estado}</span>
                </div>
              </div>
              <div class="axyra-task-description">${tarea.descripcion}</div>
              <div class="axyra-task-footer">
                <span class="axyra-task-type">${tarea.tipo}</span>
                <span class="axyra-task-date">${tarea.fecha}</span>
              </div>
            </div>
          `;
        });

        if (tareasHTML === '') {
          tareasHTML = '<p class="axyra-text-center">No hay tareas pendientes</p>';
        }

        listaTareas.innerHTML = tareasHTML;
      }

      // Filtrar tareas
      function filtrarTareas() {
        const prioridad = document.getElementById('filterPrioridad').value;
        const estado = document.getElementById('filterEstado').value;

        document.querySelectorAll('.axyra-task-item').forEach((item) => {
          let mostrar = true;

          if (prioridad && item.dataset.prioridad !== prioridad) {
            mostrar = false;
          }

          if (estado && item.dataset.estado !== estado) {
            mostrar = false;
          }

          item.style.display = mostrar ? 'block' : 'none';
        });
      }

      // Agregar nueva tarea
      function agregarNuevaTarea() {
        alert('üìù Funcionalidad de agregar tareas en desarrollo');
      }

      // Cargar configuraci√≥n guardada
      function cargarConfiguracion() {
        const moneda = localStorage.getItem('axyra_moneda') || 'COP';
        const zonaHoraria = localStorage.getItem('axyra_zona_horaria') || 'America/Bogota';
        const formatoFecha = localStorage.getItem('axyra_formato_fecha') || 'DD/MM/YYYY';

        // Aplicar moneda
        cambiarMoneda(moneda);

        // Aplicar zona horaria
        document.getElementById('zonaHoraria').value = zonaHoraria;

        // Aplicar formato de fecha
        document.getElementById('formatoFecha').value = formatoFecha;
      }

      // Guardar configuraci√≥n
      function guardarConfiguracion() {
        const zonaHoraria = document.getElementById('zonaHoraria').value;
        const formatoFecha = document.getElementById('formatoFecha').value;

        localStorage.setItem('axyra_zona_horaria', zonaHoraria);
        localStorage.setItem('axyra_formato_fecha', formatoFecha);

        mostrarMensaje('‚úÖ Configuraci√≥n guardada', 'success');
      }

      // Inicializaci√≥n
      window.addEventListener('load', async () => {
        // Inicializar dashboard
        console.log('üöÄ AXYRA Dashboard cargando...');

        // Verificar autenticaci√≥n
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) {
          return; // checkAuth ya redirige al login
        }

        // Configurar listener de cambios de autenticaci√≥n
        if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.auth) {
          window.axyraFirebaseUserSystem.auth.onAuthStateChanged((user) => {
            if (!user) {
              console.log('‚ö†Ô∏è Usuario desconectado de Firebase, redirigiendo al login');
              localStorage.removeItem('axyra_firebase_user');
              localStorage.removeItem('axyra_user');
              window.location.href = '../../login.html';
            }
          });
        }

        // Verificar y corregir datos corruptos antes de cargar estad√≠sticas
        verificarDatosCorruptos();

        // Cargar estad√≠sticas
        cargarEstadisticas();
        cargarConfiguracion();

        // Event listeners para configuraci√≥n
        document.getElementById('zonaHoraria').addEventListener('change', guardarConfiguracion);
        document.getElementById('formatoFecha').addEventListener('change', guardarConfiguracion);

        // Inicializar analytics si est√° disponible
        if (window.axyraDashboardAnalytics) {
          setTimeout(() => {
            window.axyraDashboardAnalytics.loadMetrics();
          }, 1000);
        }

        // Actualizar estado de seguridad
        updateSecurityStatus();

        // Actualizar estado de seguridad cada 30 segundos
        setInterval(updateSecurityStatus, 30000);

        console.log('‚úÖ Dashboard completamente inicializado');
      });
    </script>

    <style>
      .axyra-productivity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .axyra-productivity-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
      }

      .axyra-productivity-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
      }

      .axyra-productivity-content {
        flex: 1;
      }

      .axyra-productivity-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--axyra-gray-900);
        line-height: 1;
      }

      .axyra-productivity-label {
        font-size: 0.875rem;
        color: var(--axyra-gray-600);
        margin-top: 0.25rem;
      }

      #employeeDistributionChart,
      #hoursTrendChart,
      #salaryDistributionChart,
      #productivityChart {
        position: relative;
        min-height: 300px;
      }

      /* Estilos para tarjetas clickeables */
      .axyra-stat-card.clickable {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .axyra-stat-card.clickable:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .axyra-stat-hint {
        font-size: 0.75rem;
        color: var(--axyra-gray-500);
        text-align: center;
        margin-top: 0.5rem;
        opacity: 0.8;
      }

      /* Estilos para el modal */
      .axyra-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .axyra-modal-content {
        background: white;
        border-radius: 0.5rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      /* Estilos para tarjeta de bienvenida */
      .axyra-welcome-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .axyra-welcome-icon {
        font-size: 48px;
        opacity: 0.9;
      }

      .axyra-welcome-content {
        flex: 1;
      }

      .axyra-welcome-title {
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: white;
      }

      .axyra-welcome-message {
        font-size: 16px;
        margin: 0 0 15px 0;
        opacity: 0.9;
        line-height: 1.5;
      }

      .axyra-welcome-time {
        font-size: 14px;
        opacity: 0.8;
        font-weight: 500;
      }

      /* Estilos para panel de configuraci√≥n */
      .axyra-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }

      .axyra-config-section {
        background: #f8fafc;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .axyra-config-title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .axyra-config-item {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .axyra-config-item label {
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
      }

      .axyra-config-input {
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .axyra-config-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .axyra-config-select {
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .axyra-config-btn {
        padding: 10px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-config-btn:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .axyra-config-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        background: #fed7d7;
        color: #c53030;
        display: inline-block;
      }

      .axyra-config-status.verified {
        background: #c6f6d5;
        color: #2f855a;
      }

      .axyra-2fa-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .axyra-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 14px;
        color: #4a5568;
      }

      .axyra-checkbox input[type='checkbox'] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      /* Estilos para modales */
      .axyra-modal-body {
        padding: 20px;
      }

      .axyra-modal-footer {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .axyra-form-group {
        margin-bottom: 20px;
      }

      .axyra-form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .axyra-form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .axyra-form-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .axyra-form-help {
        font-size: 12px;
        color: #718096;
        margin-top: 5px;
        display: block;
      }

      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
        font-size: 16px;
        padding: 5px;
        transition: color 0.3s ease;
      }

      .password-toggle:hover {
        color: #667eea;
      }

      /* Estilos para Google Authenticator */
      .axyra-google-auth-setup {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .axyra-qr-section,
      .axyra-manual-section,
      .axyra-verification-section {
        text-align: center;
      }

      .axyra-qr-section h4,
      .axyra-manual-section h4,
      .axyra-verification-section h4 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
      }

      .axyra-qr-container {
        background: #f8fafc;
        border: 2px dashed #e2e8f0;
        border-radius: 12px;
        padding: 30px;
        margin: 20px 0;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .axyra-qr-container img {
        max-width: 200px;
        height: auto;
      }

      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-btn-primary {
        background: #667eea;
        color: white;
        border: none;
      }

      .axyra-btn-primary:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .axyra-btn-secondary {
        background: #718096;
        color: white;
        border: none;
      }

      .axyra-btn-secondary:hover {
        background: #4a5568;
        transform: translateY(-2px);
      }

      .axyra-modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--axyra-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-modal-header h3 {
        margin: 0;
        color: var(--axyra-gray-900);
      }

      .axyra-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--axyra-gray-500);
        padding: 0.25rem;
        border-radius: 0.25rem;
      }

      .axyra-modal-close:hover {
        background: var(--axyra-gray-100);
        color: var(--axyra-gray-700);
      }

      .axyra-modal-body {
        padding: 1.5rem;
      }

      .axyra-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--axyra-gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        background: var(--axyra-gray-50);
        border-radius: 0 0 0.5rem 0.5rem;
      }

      /* Estilos para listas de detalles */
      .axyra-empleados-lista,
      .axyra-horas-lista,
      .axyra-comprobantes-lista,
      .axyra-salarios-lista {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .axyra-empleado-item,
      .axyra-hora-item,
      .axyra-comprobante-item,
      .axyra-salario-item {
        padding: 1rem;
        border: 1px solid var(--axyra-gray-200);
        border-radius: 0.5rem;
        background: var(--axyra-gray-50);
      }

      .axyra-empleado-info,
      .axyra-hora-info,
      .axyra-comprobante-info,
      .axyra-salario-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .axyra-comprobante-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-salario-total {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--axyra-blue-50);
        border: 1px solid var(--axyra-blue-200);
        border-radius: 0.5rem;
        text-align: center;
        color: var(--axyra-blue-800);
      }

      .axyra-chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      @media (max-width: 768px) {
        .axyra-productivity-grid {
          grid-template-columns: 1fr;
        }

        .axyra-productivity-item {
          flex-direction: column;
          text-align: center;
        }
      }
    </style>

    <!-- Inicializaci√≥n autom√°tica del dashboard -->
    <script>
      // Inicializar dashboard cuando se carga la p√°gina
      document.addEventListener('DOMContentLoaded', async function () {
        console.log('üöÄ AXYRA Dashboard inicializando...');

        try {
          // Verificar autenticaci√≥n
          const isAuthenticated = await checkAuth();

          if (isAuthenticated) {
            console.log('‚úÖ Usuario autenticado, cargando dashboard...');

            // Personalizar mensaje de bienvenida
            personalizarBienvenida();

            // Cargar configuraci√≥n del usuario
            cargarConfiguracionUsuario();

            // Cargar estad√≠sticas
            await cargarEstadisticas();

            // Verificar datos corruptos autom√°ticamente
            verificarDatosCorruptos();

            console.log('‚úÖ Dashboard cargado correctamente');
          } else {
            console.log('‚ùå Usuario no autenticado, redirigiendo al login...');
            window.location.href = '../../login.html';
          }
        } catch (error) {
          console.error('‚ùå Error inicializando dashboard:', error);
          window.location.href = '../../login.html';
        }
      });

      // Personalizar mensaje de bienvenida
      function personalizarBienvenida() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (currentUser) {
            const username =
              currentUser.username || currentUser.displayName || currentUser.email?.split('@')[0] || 'Usuario';
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const welcomeTime = document.getElementById('welcomeTime');

            if (welcomeTitle) {
              welcomeTitle.textContent = `¬°Bienvenido, ${username}!`;
            }

            if (welcomeMessage) {
              const hora = new Date().getHours();
              let mensaje = '';

              if (hora < 12) {
                mensaje = '¬°Que tengas un excelente d√≠a gestionando tu empresa!';
              } else if (hora < 18) {
                mensaje = '¬°Que tengas una excelente tarde gestionando tu empresa!';
              } else {
                mensaje = '¬°Que tengas una excelente noche gestionando tu empresa!';
              }

              welcomeMessage.textContent = mensaje;
            }

            if (welcomeTime) {
              const ahora = new Date();
              const opciones = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              };
              welcomeTime.textContent = ahora.toLocaleDateString('es-CO', opciones);
            }
          }
        } catch (error) {
          console.error('‚ùå Error personalizando bienvenida:', error);
        }
      }

      // ===== FUNCIONES DEL PANEL DE CONFIGURACI√ìN =====

      // Cargar configuraci√≥n del usuario
      function cargarConfiguracionUsuario() {
        try {
          let currentUser = null;
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (currentUser) {
            // Cargar datos en el formulario
            const configUsername = document.getElementById('configUsername');
            const configEmail = document.getElementById('configEmail');
            const emailStatus = document.getElementById('emailStatus');
            const btn2FA = document.getElementById('btn2FA');
            const btnGoogleAuth = document.getElementById('btnGoogleAuth');
            const configRememberSession = document.getElementById('configRememberSession');
            const configNotificaciones = document.getElementById('configNotificaciones');

            if (configUsername) {
              configUsername.value =
                currentUser.username || currentUser.displayName || currentUser.email?.split('@')[0] || '';
            }

            if (configEmail) {
              configEmail.value = currentUser.email || '';
            }

            if (emailStatus) {
              if (currentUser.emailVerified) {
                emailStatus.textContent = 'Verificado';
                emailStatus.className = 'axyra-config-status verified';
              } else {
                emailStatus.textContent = 'No verificado';
                emailStatus.className = 'axyra-config-status';
              }
            }

            // Cargar estado del 2FA
            const twoFAEnabled = localStorage.getItem('axyra_2fa_enabled') === 'true';
            if (btn2FA) {
              if (twoFAEnabled) {
                btn2FA.innerHTML = '<i class="fas fa-toggle-on"></i> Habilitado';
                btn2FA.style.background = '#48bb78';
                if (btnGoogleAuth) btnGoogleAuth.style.display = 'inline-flex';
              } else {
                btn2FA.innerHTML = '<i class="fas fa-toggle-off"></i> Deshabilitado';
                btn2FA.style.background = '#718096';
                if (btnGoogleAuth) btnGoogleAuth.style.display = 'none';
              }
            }

            // Cargar preferencias
            const rememberSession = localStorage.getItem('axyra_remember_session') || '0';
            if (configRememberSession) {
              configRememberSession.value = rememberSession;
            }

            const notificaciones = localStorage.getItem('axyra_notificaciones') === 'true';
            if (configNotificaciones) {
              configNotificaciones.checked = notificaciones;
            }
          }
        } catch (error) {
          console.error('‚ùå Error cargando configuraci√≥n:', error);
        }
      }

      // Actualizar nombre de usuario
      async function actualizarUsername() {
        try {
          const newUsername = document.getElementById('configUsername').value.trim();

          if (!newUsername || newUsername.length < 3) {
            alert('El nombre de usuario debe tener al menos 3 caracteres');
            return;
          }

          // Validar que solo contenga letras y n√∫meros
          if (!/^[a-zA-Z0-9]+$/.test(newUsername)) {
            alert('El nombre de usuario solo puede contener letras y n√∫meros');
            return;
          }

          // Actualizar en Firebase si est√° disponible
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            await window.axyraFirebaseUserSystem.updateProfile({ displayName: newUsername });
            console.log('‚úÖ Username actualizado en Firebase');
          }

          // Actualizar en localStorage
          const userData = JSON.parse(localStorage.getItem('axyra_user') || '{}');
          userData.username = newUsername;
          localStorage.setItem('axyra_user', JSON.stringify(userData));

          // Actualizar mensaje de bienvenida
          personalizarBienvenida();

          alert('‚úÖ Nombre de usuario actualizado correctamente');
        } catch (error) {
          console.error('‚ùå Error actualizando username:', error);
          alert('‚ùå Error al actualizar el nombre de usuario');
        }
      }

      // Mostrar modal para cambiar contrase√±a
      function mostrarModalCambiarPassword() {
        document.getElementById('modalCambiarPassword').style.display = 'flex';
        document.getElementById('formCambiarPassword').reset();
      }

      // Cerrar modal de cambiar contrase√±a
      function cerrarModalCambiarPassword() {
        document.getElementById('modalCambiarPassword').style.display = 'none';
      }

      // Cambiar contrase√±a
      async function cambiarPassword() {
        try {
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmNewPassword = document.getElementById('confirmNewPassword').value;

          // Validaciones
          if (!currentPassword || !newPassword || !confirmNewPassword) {
            alert('Por favor completa todos los campos');
            return;
          }

          if (newPassword !== confirmNewPassword) {
            alert('Las contrase√±as no coinciden');
            return;
          }

          if (newPassword.length < 8) {
            alert('La nueva contrase√±a debe tener al menos 8 caracteres');
            return;
          }

          if (!/(?=.*[A-Z])(?=.*\d)/.test(newPassword)) {
            alert('La nueva contrase√±a debe incluir al menos una may√∫scula y un n√∫mero');
            return;
          }

          // Cambiar contrase√±a en Firebase si est√° disponible
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            await window.axyraFirebaseUserSystem.updatePassword(newPassword);
            console.log('‚úÖ Contrase√±a actualizada en Firebase');
          }

          // Actualizar en localStorage
          const userData = JSON.parse(localStorage.getItem('axyra_user') || '{}');
          userData.password = newPassword; // En producci√≥n, esto deber√≠a estar hasheado
          localStorage.setItem('axyra_user', JSON.stringify(userData));

          alert('‚úÖ Contrase√±a actualizada correctamente');
          cerrarModalCambiarPassword();
        } catch (error) {
          console.error('‚ùå Error cambiando contrase√±a:', error);
          alert('‚ùå Error al cambiar la contrase√±a');
        }
      }

      // Toggle 2FA
      function toggle2FA() {
        const twoFAEnabled = localStorage.getItem('axyra_2fa_enabled') === 'true';

        if (twoFAEnabled) {
          // Deshabilitar 2FA
          if (
            confirm(
              '¬øEst√°s seguro de que quieres deshabilitar la autenticaci√≥n de dos factores? Esto reducir√° la seguridad de tu cuenta.'
            )
          ) {
            localStorage.setItem('axyra_2fa_enabled', 'false');
            localStorage.removeItem('axyra_2fa_secret');
            localStorage.removeItem('axyra_2fa_backup_codes');

            const btn2FA = document.getElementById('btn2FA');
            const btnGoogleAuth = document.getElementById('btnGoogleAuth');

            if (btn2FA) {
              btn2FA.innerHTML = '<i class="fas fa-toggle-off"></i> Deshabilitado';
              btn2FA.style.background = '#718096';
            }

            if (btnGoogleAuth) {
              btnGoogleAuth.style.display = 'none';
            }

            alert('‚úÖ Autenticaci√≥n de dos factores deshabilitada');
          }
        } else {
          // Habilitar 2FA - solo mostrar modal si el usuario lo activa
          if (
            confirm('¬øQuieres habilitar la autenticaci√≥n de dos factores? Esto agregar√° una capa extra de seguridad.')
          ) {
            configurarGoogleAuthenticator();
          }
        }
      }

      // Configurar Google Authenticator
      function configurarGoogleAuthenticator() {
        try {
          // Generar clave secreta
          const secretKey = generarClaveSecreta();
          localStorage.setItem('axyra_2fa_secret', secretKey);

          // Mostrar clave en el modal
          document.getElementById('secretKey').value = secretKey;

          // Generar c√≥digo QR (simulado por ahora)
          const qrContainer = document.getElementById('qrCode');
          qrContainer.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <i class="fas fa-qrcode" style="font-size: 100px; color: #667eea;"></i>
              <p style="margin-top: 15px; color: #718096;">C√≥digo QR simulado</p>
              <p style="font-size: 12px; color: #a0aec0;">En producci√≥n, aqu√≠ se generar√≠a un c√≥digo QR real</p>
            </div>
          `;

          // Mostrar modal
          document.getElementById('modalGoogleAuth').style.display = 'flex';
        } catch (error) {
          console.error('‚ùå Error configurando Google Auth:', error);
          alert('‚ùå Error al configurar Google Authenticator');
        }
      }

      // Cerrar modal de Google Auth
      function cerrarModalGoogleAuth() {
        document.getElementById('modalGoogleAuth').style.display = 'none';
      }

      // Generar clave secreta para 2FA
      function generarClaveSecreta() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let result = '';
        for (let i = 0; i < 32; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      // Copiar clave secreta
      function copiarClaveSecreta() {
        const secretKey = document.getElementById('secretKey');
        secretKey.select();
        document.execCommand('copy');
        alert('‚úÖ Clave secreta copiada al portapapeles');
      }

      // Verificar Google Auth
      function verificarGoogleAuth() {
        try {
          const verificationCode = document.getElementById('verificationCode').value.trim();

          if (!verificationCode || verificationCode.length !== 6) {
            alert('Por favor ingresa un c√≥digo de 6 d√≠gitos v√°lido');
            return;
          }

          // Verificaci√≥n simple del c√≥digo
          if (verificationCode.length === 6) {
            // C√≥digo de prueba
            // Activar 2FA
            localStorage.setItem('axyra_2fa_enabled', 'true');

            // Generar c√≥digos de respaldo
            const backupCodes = generarCodigosRespaldo();
            localStorage.setItem('axyra_2fa_backup_codes', JSON.stringify(backupCodes));

            // Actualizar UI
            const btn2FA = document.getElementById('btn2FA');
            const btnGoogleAuth = document.getElementById('btnGoogleAuth');

            if (btn2FA) {
              btn2FA.innerHTML = '<i class="fas fa-toggle-on"></i> Habilitado';
              btn2FA.style.background = '#48bb78';
            }

            if (btnGoogleAuth) {
              btnGoogleAuth.style.display = 'inline-flex';
            }

            alert(
              `‚úÖ Autenticaci√≥n de dos factores activada correctamente!\n\nC√≥digos de respaldo: ${backupCodes.join(
                ', '
              )}\n\nGuarda estos c√≥digos en un lugar seguro.`
            );

            cerrarModalGoogleAuth();
          } else {
            alert('‚ùå C√≥digo de verificaci√≥n incorrecto. Por favor intenta nuevamente.');
          }
        } catch (error) {
          console.error('‚ùå Error verificando Google Auth:', error);
          alert('‚ùå Error al verificar el c√≥digo');
        }
      }

      // Generar c√≥digos de respaldo
      function generarCodigosRespaldo() {
        const codes = [];
        for (let i = 0; i < 5; i++) {
          codes.push(Math.floor(100000 + Math.random() * 900000));
        }
        return codes;
      }

      // Enviar verificaci√≥n de email
      async function enviarVerificacionEmail() {
        try {
          let currentUser = null;
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.email) {
            alert('‚ùå No se encontr√≥ un email v√°lido para verificar');
            return;
          }

          // Simular env√≠o de email
          alert('‚úÖ Email de verificaci√≥n enviado (simulado). En producci√≥n, se enviar√≠a un email real.');

          // Actualizar estado
          const emailStatus = document.getElementById('emailStatus');
          if (emailStatus) {
            emailStatus.textContent = 'Verificaci√≥n enviada';
            emailStatus.className = 'axyra-config-status';
          }
        } catch (error) {
          console.error('‚ùå Error enviando verificaci√≥n de email:', error);
          alert('‚ùå Error al enviar el email de verificaci√≥n');
        }
      }

      // Actualizar preferencias
      function actualizarPreferencias() {
        try {
          const rememberSession = document.getElementById('configRememberSession').value;
          const notificaciones = document.getElementById('configNotificaciones').checked;

          localStorage.setItem('axyra_remember_session', rememberSession);
          localStorage.setItem('axyra_notificaciones', notificaciones.toString());

          alert('‚úÖ Preferencias actualizadas correctamente');
        } catch (error) {
          console.error('‚ùå Error actualizando preferencias:', error);
          alert('‚ùå Error al actualizar las preferencias');
        }
      }

      // Funciones para mostrar/ocultar contrase√±as en modales
      function toggleCurrentPassword() {
        const input = document.getElementById('currentPassword');
        const icon = document.getElementById('currentPasswordIcon');
        togglePasswordVisibility(input, icon);
      }

      function toggleNewPassword() {
        const input = document.getElementById('newPassword');
        const icon = document.getElementById('newPasswordIcon');
        togglePasswordVisibility(input, icon);
      }

      function toggleConfirmNewPassword() {
        const input = document.getElementById('confirmNewPassword');
        const icon = document.getElementById('confirmNewPasswordIcon');
        togglePasswordVisibility(input, icon);
      }

      function togglePasswordVisibility(input, icon) {
        if (input.type === 'password') {
          input.type = 'text';
          icon.className = 'fas fa-eye-slash';
        } else {
          input.type = 'password';
          icon.className = 'fas fa-eye';
        }
      }
    </script>
  </body>
</html>
