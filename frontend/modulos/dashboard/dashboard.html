<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Dashboard</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Scripts removidos por limpieza del sistema -->

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Configuraci√≥n de Firebase AXYRA -->
    <script src="../../static/firebase-config.js"></script>

    <!-- SISTEMA AISLADO -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Dashboard</div>
          </div>
        </div>

        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link" onclick="irAInicio(event)">
            <i class="fas fa-home"></i> Inicio
          </a>
          <a href="dashboard.html" class="axyra-nav-link active"> <i class="fas fa-tachometer-alt"></i> Dashboard </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="../nomina/gestionar_nomina.html" class="axyra-nav-link">
            <i class="fas fa-file-invoice-dollar"></i> N√≥mina
          </a>
          <a href="../cuadre_caja/cuadre_caja.html" class="axyra-nav-link">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuraci√≥n
          </a>
          <!-- Bot√≥n de inicio removido para evitar duplicaci√≥n -->
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Dashboard</h1>
          <p class="axyra-page-subtitle">Resumen general de tu empresa y estad√≠sticas importantes</p>
        </div>

        <!-- Mensaje de Bienvenida -->
        <div class="axyra-welcome-card" id="welcomeCard">
          <div class="axyra-welcome-icon">
            <i class="fas fa-sun"></i>
          </div>
          <div class="axyra-welcome-content">
            <h2 class="axyra-welcome-title" id="welcomeTitle">¬°Bienvenido a AXYRA!</h2>
            <p class="axyra-welcome-message" id="welcomeMessage">
              Esperamos que tengas un excelente d√≠a gestionando tu empresa
            </p>
            <div class="axyra-welcome-time" id="welcomeTime"></div>
          </div>
        </div>

        <!-- Estad√≠sticas Principales -->
        <div class="axyra-stats-grid">
          <div class="axyra-stat-card clickable" onclick="mostrarDetalleEmpleados()">
            <div class="axyra-stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="axyra-stat-number" id="totalEmpleados">0</div>
            <div class="axyra-stat-label">Total Empleados</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleHoras()">
            <div class="axyra-stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="axyra-stat-number" id="horasTrabajadas">0</div>
            <div class="axyra-stat-label">Horas Trabajadas</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleComprobantes()">
            <div class="axyra-stat-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="axyra-stat-number" id="comprobantesGenerados">0</div>
            <div class="axyra-stat-label">Comprobantes</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>

          <div class="axyra-stat-card clickable" onclick="mostrarDetalleSalarios()">
            <div class="axyra-stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="axyra-stat-number" id="totalSalarios">$0</div>
            <div class="axyra-stat-label">Total Salarios</div>
            <div class="axyra-stat-hint">Click para ver detalles</div>
          </div>
        </div>

        <!-- Estad√≠sticas Secundarias -->
        <div class="axyra-stats-grid-secondary">
          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="empleadosActivos">0</div>
              <div class="axyra-stat-label-secondary">Empleados Activos</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="horasMes">0</div>
              <div class="axyra-stat-label-secondary">Horas del Mes</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="nominasGeneradas">0</div>
              <div class="axyra-stat-label-secondary">N√≥minas Generadas</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-calculator"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="cuadresCaja">0</div>
              <div class="axyra-stat-label-secondary">Cuadres de Caja</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="departamentos">0</div>
              <div class="axyra-stat-label-secondary">Departamentos</div>
            </div>
          </div>

          <div class="axyra-stat-card-secondary">
            <div class="axyra-stat-icon-secondary">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="axyra-stat-content">
              <div class="axyra-stat-number-secondary" id="tareasPendientes">0</div>
              <div class="axyra-stat-label-secondary">Tareas Pendientes</div>
            </div>
          </div>
        </div>

        <!-- Indicadores de Productividad -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Indicadores de Productividad</h3>
              <p class="axyra-card-subtitle">M√©tricas de eficiencia y rendimiento</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div id="productivityIndicators">
              <!-- Los indicadores se cargan din√°micamente -->
            </div>
          </div>
        </div>

        <!-- Gr√°ficos y An√°lisis -->
        <div class="axyra-grid axyra-grid-2">
          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Distribuci√≥n de Empleados</h3>
                <p class="axyra-card-subtitle">Por departamento</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="employeeDistributionChart" style="height: 300px"></div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Tendencia de Horas</h3>
                <p class="axyra-card-subtitle">Por mes</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="hoursTrendChart" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <div class="axyra-grid axyra-grid-2">
          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-bar"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">Distribuci√≥n de Salarios</h3>
                <p class="axyra-card-subtitle">Por departamento</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="salaryDistributionChart" style="height: 300px"></div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <div class="axyra-card-icon">
                <i class="fas fa-chart-area"></i>
              </div>
              <div>
                <h3 class="axyra-card-title">M√©tricas de Productividad</h3>
                <p class="axyra-card-subtitle">Eficiencia y ocupaci√≥n</p>
              </div>
            </div>
            <div class="axyra-card-content">
              <div id="productivityChart" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <!-- Configuraci√≥n Regional -->
        <div class="axyra-grid axyra-grid-2"></div>

        <!-- Panel de Configuraci√≥n -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-cog"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Configuraci√≥n de Cuenta</h3>
              <p class="axyra-card-subtitle">Gestiona tu perfil y configuraciones de seguridad</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-config-grid">
              <!-- Perfil de Usuario -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-user"></i> Perfil de Usuario</h4>
                <div class="axyra-config-item">
                  <label>Nombre de Usuario:</label>
                  <input type="text" id="configUsername" class="axyra-config-input" />
                  <button class="axyra-config-btn" onclick="actualizarUsername()">
                    <i class="fas fa-save"></i> Actualizar
                  </button>
                </div>
                <div class="axyra-config-item">
                  <label>Email:</label>
                  <input type="email" id="configEmail" class="axyra-config-input" readonly />
                  <span class="axyra-config-status" id="emailStatus">No verificado</span>
                </div>
              </div>

              <!-- Seguridad -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-shield-alt"></i> Seguridad</h4>
                <div class="axyra-config-item">
                  <label>Cambiar Contrase√±a:</label>
                  <button class="axyra-config-btn" onclick="mostrarModalCambiarPassword()">
                    <i class="fas fa-key"></i> Cambiar
                  </button>
                </div>
                <div class="axyra-config-item">
                  <label>Autenticaci√≥n 2FA:</label>
                  <div class="axyra-2fa-controls">
                    <button class="axyra-config-btn" id="btn2FA" onclick="toggle2FA()">
                      <i class="fas fa-toggle-off"></i> Deshabilitado
                    </button>
                    <button
                      class="axyra-config-btn"
                      onclick="configurarGoogleAuthenticator()"
                      style="display: none"
                      id="btnGoogleAuth"
                    >
                      <i class="fab fa-google"></i> Google Auth
                    </button>
                  </div>
                  <small class="axyra-help-text">El 2FA solo se pedir√° si lo tienes habilitado</small>
                </div>
                <div class="axyra-config-item">
                  <label>Verificaci√≥n de Email:</label>
                  <button class="axyra-config-btn" onclick="enviarVerificacionEmail()" id="btnVerificarEmail">
                    <i class="fas fa-envelope"></i> Verificar
                  </button>
                </div>
              </div>

              <!-- Preferencias -->
              <div class="axyra-config-section">
                <h4 class="axyra-config-title"><i class="fas fa-sliders-h"></i> Preferencias</h4>
                <div class="axyra-config-item">
                  <label>Recordar Sesi√≥n:</label>
                  <select id="configRememberSession" class="axyra-config-select" onchange="actualizarPreferencias()">
                    <option value="0">Siempre pedir login</option>
                    <option value="1">1 d√≠a</option>
                    <option value="7">1 semana</option>
                    <option value="30">1 mes</option>
                  </select>
                </div>
                <div class="axyra-config-item">
                  <label>Notificaciones:</label>
                  <label class="axyra-checkbox">
                    <input type="checkbox" id="configNotificaciones" onchange="actualizarPreferencias()" />
                    <span class="checkmark"></span>
                    Recibir notificaciones por email
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Actividad Reciente</h3>
              <p class="axyra-card-subtitle">√öltimas acciones en el sistema</p>
            </div>
          </div>
          <div id="actividadReciente">
            <!-- La actividad se cargar√° din√°micamente -->
          </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Acciones R√°pidas</h3>
              <p class="axyra-card-subtitle">Accede r√°pidamente a las funciones principales</p>
            </div>
          </div>
          <div class="axyra-actions-bar">
            <button
              onclick="mostrarModalAccion('Agregar Empleado', '¬øDeseas ir a la p√°gina de empleados para agregar un nuevo empleado?', 'empleados')"
              class="axyra-btn axyra-btn-primary"
            >
              <i class="fas fa-user-plus"></i> Agregar Empleado
            </button>
            <button
              onclick="mostrarModalAccion('Registrar Horas', '¬øDeseas ir a la p√°gina de horas para registrar el tiempo trabajado?', 'horas')"
              class="axyra-btn axyra-btn-secondary"
            >
              <i class="fas fa-clock"></i> Registrar Horas
            </button>
            <button
              onclick="mostrarModalAccion('Generar N√≥mina', '¬øDeseas ir a la p√°gina de n√≥mina para generar el reporte de salarios?', 'nomina')"
              class="axyra-btn axyra-btn-success"
            >
              <i class="fas fa-file-invoice-dollar"></i> Generar N√≥mina
            </button>
            <button
              onclick="mostrarModalAccion('Cuadre de Caja', '¬øDeseas ir a la p√°gina de cuadre de caja para revisar los ingresos?', 'cuadre')"
              class="axyra-btn axyra-btn-info"
            >
              <i class="fas fa-calculator"></i> Cuadre de Caja
            </button>
            <button
              onclick="mostrarModalConfirmacion('Limpiar Datos', '¬øEst√°s seguro de que deseas limpiar todos los datos corruptos del sistema? Esta acci√≥n no se puede deshacer.', 'limpiarDatosCorruptos')"
              class="axyra-btn axyra-btn-warning"
            >
              <i class="fas fa-broom"></i> Limpiar Datos
            </button>
            <button
              onclick="mostrarModalConfirmacion('Resetear Todo', '‚ö†Ô∏è ADVERTENCIA: ¬øEst√°s completamente seguro de que deseas eliminar TODOS los datos del sistema? Esta acci√≥n es IRREVERSIBLE y eliminar√° toda la informaci√≥n.', 'resetearLocalStorage')"
              class="axyra-btn axyra-btn-error"
            >
              <i class="fas fa-trash"></i> Resetear Todo
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal Cambiar Contrase√±a -->
    <div id="modalCambiarPassword" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3><i class="fas fa-key"></i> Cambiar Contrase√±a</h3>
          <button class="axyra-modal-close" onclick="cerrarModalCambiarPassword()">&times;</button>
        </div>
        <div class="axyra-modal-body">
          <form id="formCambiarPassword">
            <div class="axyra-form-group">
              <label for="currentPassword">Contrase√±a Actual:</label>
              <div class="password-container">
                <input type="password" id="currentPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleCurrentPassword()">
                  <i class="fas fa-eye" id="currentPasswordIcon"></i>
                </button>
              </div>
            </div>
            <div class="axyra-form-group">
              <label for="newPassword">Nueva Contrase√±a:</label>
              <div class="password-container">
                <input type="password" id="newPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleNewPassword()">
                  <i class="fas fa-eye" id="newPasswordIcon"></i>
                </button>
              </div>
              <small class="axyra-form-help">M√≠nimo 8 caracteres, incluir may√∫sculas y n√∫meros</small>
            </div>
            <div class="axyra-form-group">
              <label for="confirmNewPassword">Confirmar Nueva Contrase√±a:</label>
              <div class="password-container">
                <input type="password" id="confirmNewPassword" class="axyra-form-input" required />
                <button type="button" class="password-toggle" onclick="toggleConfirmNewPassword()">
                  <i class="fas fa-eye" id="confirmNewPasswordIcon"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalCambiarPassword()">Cancelar</button>
          <button class="axyra-btn axyra-btn-primary" onclick="cambiarPassword()">Cambiar Contrase√±a</button>
        </div>
      </div>
    </div>

    <!-- Modal Configurar Google Authenticator -->
    <div id="modalGoogleAuth" class="axyra-modal" style="display: none">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3><i class="fab fa-google"></i> Configurar Google Authenticator</h3>
          <button class="axyra-modal-close" onclick="cerrarModalGoogleAuth()">&times;</button>
        </div>
        <div class="axyra-modal-body">
          <div class="axyra-google-auth-setup">
            <div class="axyra-qr-section">
              <h4>1. Escanea el c√≥digo QR</h4>
              <div id="qrCode" class="axyra-qr-container">
                <!-- El c√≥digo QR se generar√° aqu√≠ -->
              </div>
              <p>Usa la aplicaci√≥n Google Authenticator para escanear este c√≥digo</p>
            </div>
            <div class="axyra-manual-section">
              <h4>2. O ingresa manualmente</h4>
              <div class="axyra-form-group">
                <label>Clave Secreta:</label>
                <input type="text" id="secretKey" class="axyra-form-input" readonly />
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="copiarClaveSecreta()">
                  <i class="fas fa-copy"></i> Copiar
                </button>
              </div>
              <p>Ingresa esta clave en tu aplicaci√≥n de autenticaci√≥n</p>
            </div>
            <div class="axyra-verification-section">
              <h4>3. Verifica la configuraci√≥n</h4>
              <div class="axyra-form-group">
                <label>C√≥digo de Verificaci√≥n:</label>
                <input
                  type="text"
                  id="verificationCode"
                  class="axyra-form-input"
                  placeholder="Ingresa el c√≥digo de 6 d√≠gitos"
                  maxlength="6"
                />
              </div>
              <button class="axyra-btn axyra-btn-primary" onclick="verificarGoogleAuth()">
                <i class="fas fa-check"></i> Verificar y Activar
              </button>
            </div>
          </div>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalGoogleAuth()">Cancelar</button>
        </div>
      </div>
    </div>

    <script>
      // Verificar autenticaci√≥n - FIREBASE + SISTEMA AISLADO MEJORADO
      async function checkAuth() {
        try {
          console.log('üîê Verificando autenticaci√≥n...');

          // PRIMERO: Verificar Firebase
          if (typeof firebase !== 'undefined' && firebase.auth) {
            const firebaseUser = firebase.auth().currentUser;
            if (firebaseUser) {
              console.log('üî• Usuario autenticado con Firebase:', firebaseUser.email);
              currentUser = {
                id: firebaseUser.uid,
                username: firebaseUser.email.split('@')[0],
                email: firebaseUser.email,
                nombre: firebaseUser.displayName || firebaseUser.email.split('@')[0],
                rol: 'usuario',
                createdAt: new Date().toISOString()
              };
              
              // Guardar en localStorage para compatibilidad
              localStorage.setItem('axyra_firebase_user', JSON.stringify(firebaseUser));
              localStorage.setItem('axyra_isolated_user', JSON.stringify(currentUser));
              
              console.log('‚úÖ Usuario autenticado, cargando dashboard...');
              return true;
            }
          }

          // SEGUNDO: Verificar localStorage (Firebase user)
          const firebaseUser = localStorage.getItem('axyra_firebase_user');
          if (firebaseUser) {
            try {
              const userData = JSON.parse(firebaseUser);
              console.log('‚úÖ Usuario Firebase encontrado en localStorage:', userData.email);
              currentUser = {
                id: userData.uid,
                username: userData.email.split('@')[0],
                email: userData.email,
                nombre: userData.displayName || userData.email.split('@')[0],
                rol: 'usuario',
                createdAt: new Date().toISOString()
              };
              
              console.log('‚úÖ Usuario autenticado, cargando dashboard...');
              return true;
            } catch (error) {
              console.error('‚ùå Error parseando usuario Firebase:', error);
              localStorage.removeItem('axyra_firebase_user');
            }
          }

          // TERCERO: Verificar localStorage (sistema aislado)
          const isolatedUser = localStorage.getItem('axyra_isolated_user');
          if (isolatedUser) {
            try {
              const userData = JSON.parse(isolatedUser);
              console.log('‚úÖ Sesi√≥n encontrada en localStorage:', userData.username);
              currentUser = userData;

              // Restaurar el estado del sistema aislado si est√° disponible
              if (window.axyraIsolatedAuth) {
                window.axyraIsolatedAuth.currentUser = userData;
                window.axyraIsolatedAuth.isAuthenticated = true;
                console.log('‚úÖ Estado del sistema aislado restaurado');
              }

              console.log('‚úÖ Usuario autenticado, cargando dashboard...');
              return true;
            } catch (error) {
              console.error('‚ùå Error parseando sesi√≥n aislada:', error);
              localStorage.removeItem('axyra_isolated_user');
            }
          }

          // CUARTO: Verificar sistema aislado
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            const user = window.axyraIsolatedAuth.getCurrentUser();
            console.log('‚úÖ Usuario autenticado con sistema aislado:', user.username);
            currentUser = user;
            console.log('‚úÖ Usuario autenticado, cargando dashboard...');
            return true;
          }

          // No hay sesi√≥n activa
          console.log('‚ö†Ô∏è No hay sesi√≥n activa - mostrando mensaje de login');
          mostrarMensajeNoAutenticado();
          return false;
        } catch (error) {
          console.error('‚ùå Error al verificar sesi√≥n:', error);
          mostrarMensajeNoAutenticado();
          return false;
        }
      }

      // Funci√≥n para mostrar mensaje cuando no hay autenticaci√≥n
      function mostrarMensajeNoAutenticado() {
        const mainContent = document.querySelector('.axyra-section');
        if (mainContent) {
          mainContent.innerHTML = `
            <div class="axyra-container">
              <div class="axyra-page-header">
                <h1 class="axyra-page-title">üîê Acceso Requerido</h1>
                <p class="axyra-page-subtitle">Necesitas iniciar sesi√≥n para acceder al dashboard</p>
              </div>
              
              <div class="axyra-auth-required-card">
                <div class="axyra-auth-required-icon">
                  <i class="fas fa-lock"></i>
                </div>
                <h2>Inicia Sesi√≥n para Continuar</h2>
                <p>Para acceder al dashboard y todas las funcionalidades de AXYRA, necesitas iniciar sesi√≥n con tu cuenta.</p>
                
                <div class="axyra-auth-actions">
                  <button class="axyra-btn axyra-btn-primary" onclick="irALogin()">
                    üîê Iniciar Sesi√≥n
                  </button>
                  <button class="axyra-btn axyra-btn-secondary" onclick="irARegistro()">
                    üìù Crear Cuenta
                  </button>
                  <button class="axyra-btn axyra-btn-ghost" onclick="irAInicio()">
                    üè† Volver al Inicio
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      // Funci√≥n para ir al login
      function irALogin() {
        window.location.href = '../../login.html';
      }

      // Funci√≥n para ir al registro
      function irARegistro() {
        window.location.href = '../../register.html';
      }

      // Funci√≥n para ir al inicio
      function irAInicio() {
        window.location.href = '../../index.html';
      }

      // Cerrar sesi√≥n
      // Cerrar sesi√≥n - SISTEMA COMPLETO
      async function logout() {
        console.log('üîÑ Cerrando sesi√≥n desde dashboard...');

        try {
          // PRIMERO: Cerrar sesi√≥n de Firebase
          if (typeof firebase !== 'undefined' && firebase.auth) {
            try {
              await firebase.auth().signOut();
              console.log('‚úÖ Sesi√≥n de Firebase cerrada');
            } catch (firebaseError) {
              console.log('‚ö†Ô∏è Error cerrando Firebase:', firebaseError.message);
            }
          }

          // SEGUNDO: Cerrar sesi√≥n del sistema aislado
          if (window.axyraIsolatedAuth) {
            window.axyraIsolatedAuth.logout();
            console.log('‚úÖ Sesi√≥n del sistema aislado cerrada');
          }

          // TERCERO: Limpiar localStorage completamente
          localStorage.removeItem('axyra_firebase_user');
          localStorage.removeItem('axyra_isolated_user');
          localStorage.removeItem('axyra_isolated_remember');
          console.log('‚úÖ localStorage limpiado');

          // CUARTO: Limpiar variables globales
          currentUser = null;
          console.log('‚úÖ Variables globales limpiadas');

          console.log('‚úÖ Sesi√≥n completamente cerrada');

          // Redirigir al login
          window.location.href = '../../login.html';

        } catch (error) {
          console.error('‚ùå Error en logout:', error);
          // A√∫n as√≠, limpiar y redirigir
          localStorage.removeItem('axyra_firebase_user');
          localStorage.removeItem('axyra_isolated_user');
          localStorage.removeItem('axyra_isolated_remember');
          currentUser = null;
          window.location.href = '../../login.html';
        }
      }

      // Funci√≥n para limpiar datos corruptos del localStorage
      function limpiarDatosCorruptos() {
        console.log('=== LIMPIANDO DATOS CORRUPTOS ===');

        // Mostrar todos los datos del localStorage para depuraci√≥n
        console.log('=== DATOS COMPLETOS DEL LOCALSTORAGE ===');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('axyra_')) {
            console.log(`${key}:`, localStorage.getItem(key));
          }
        }

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para limpieza de datos');
          return;
        }

        // Limpiar empleados con salarios inv√°lidos FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        console.log('Empleados del usuario antes de limpieza:', empleados);

        const empleadosLimpios = empleados.filter((empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            console.log('Empleado sin salario v√°lido:', empleado);
            return false;
          }
          const salario = parseFloat(empleado.salario);
          if (isNaN(salario) || salario <= 0) {
            console.log('Empleado con salario inv√°lido:', empleado);
            return false;
          }
          return true;
        });

        // Guardar empleados limpios
        localStorage.setItem('axyra_empleados', JSON.stringify(empleadosLimpios));
        console.log('Empleados despu√©s de limpieza:', empleadosLimpios);

        // Recargar estad√≠sticas
        cargarEstadisticas();

        // Mostrar mensaje de confirmaci√≥n usando modal
        mostrarMensaje(
          '‚úÖ Datos corruptos limpiados correctamente. Se han eliminado empleados con salarios inv√°lidos.',
          'success'
        );
      }

      // Funci√≥n para resetear completamente el localStorage (√∫ltimo recurso)
      function resetearLocalStorage() {
        console.log('=== RESETEANDO LOCALSTORAGE ===');

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para reset de datos');
          return;
        }

        // Eliminar solo los datos de AXYRA DEL USUARIO ACTUAL
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('axyra_') && key !== 'axyra_isolated_user') {
            keysToRemove.push(key);
          }
        }

        keysToRemove.forEach((key) => {
          localStorage.removeItem(key);
          console.log(`Eliminado: ${key}`);
        });

        console.log('LocalStorage reseteado completamente');
        console.log('‚úÖ Usuario mantiene su sesi√≥n:', currentUser.username);

        // Mostrar mensaje de √©xito
        mostrarMensaje(
          '‚úÖ Todos los datos han sido reseteados correctamente. Tu sesi√≥n se mantiene activa.',
          'success'
        );

        // Recargar las estad√≠sticas sin recargar la p√°gina
        setTimeout(() => {
          cargarEstadisticas();
          cargarActividadReciente();
        }, 1000);
      }

      // Funci√≥n para verificar autom√°ticamente datos corruptos
      function verificarDatosCorruptos() {
        console.log('=== VERIFICANDO DATOS CORRUPTOS AUTOM√ÅTICAMENTE ===');

        let datosCorruptos = false;

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser) {
          console.log('No hay usuario autenticado para verificaci√≥n de datos');
          return;
        }

        // Verificar empleados FILTRADOS POR USUARIO
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        const empleadosLimpios = empleados.filter((empleado) => {
          if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
            console.log('Empleado sin salario v√°lido detectado:', empleado);
            datosCorruptos = true;
            return false;
          }
          const salario = parseFloat(empleado.salario);
          if (isNaN(salario) || salario <= 0 || salario > 1000000000) {
            // L√≠mite razonable de 1 bill√≥n
            console.log('Empleado con salario inv√°lido detectado:', empleado);
            datosCorruptos = true;
            return false;
          }
          return true;
        });

        // Si se encontraron datos corruptos, limpiarlos autom√°ticamente
        if (datosCorruptos) {
          console.log('Datos corruptos detectados. Limpiando autom√°ticamente...');
          localStorage.setItem('axyra_empleados', JSON.stringify(empleadosLimpios));
          console.log('Empleados despu√©s de limpieza autom√°tica:', empleadosLimpios);
        }

        // Verificar otros datos FILTRADOS POR USUARIO
        const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
          (hr) => hr.userId === currentUser.username
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username
        );

        // Verificar que no haya valores extremadamente altos
        const totalSalarios = empleadosLimpios.reduce((total, empleado) => {
          const salario = parseFloat(empleado.salario) || 0;
          return total + salario;
        }, 0);

        if (totalSalarios > 1000000000) {
          // M√°s de 1 bill√≥n
          console.log('Total de salarios extremadamente alto detectado:', totalSalarios);
          console.log('Limpiando todos los datos de empleados...');
          localStorage.removeItem('axyra_empleados');
          localStorage.removeItem('axyra_horas');
          localStorage.removeItem('axyra_comprobantes');
          datosCorruptos = true;
        }

        if (datosCorruptos) {
          console.log('‚úÖ Datos corruptos corregidos autom√°ticamente');
        } else {
          console.log('‚úÖ No se encontraron datos corruptos');
        }
      }

      // Funci√≥n para actualizar indicador de seguridad
      function updateSecurityStatus() {
        const securityStatus = document.getElementById('securityStatus');
        if (!securityStatus) return;

        try {
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            const user = window.axyraIsolatedAuth.getCurrentUser();
            if (user) {
              securityStatus.className = 'axyra-security-indicator';
              securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>Sesi√≥n Activa</span>';
            } else {
              securityStatus.className = 'axyra-security-indicator warning';
              securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Sesi√≥n Expirada</span>';
            }
          } else {
            // Verificar localStorage como fallback
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              try {
                const user = JSON.parse(userData);
                if (user && user.username) {
                  securityStatus.className = 'axyra-security-indicator';
                  securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>Sesi√≥n Activa</span>';
                  return;
                }
              } catch (error) {
                console.error('Error parseando sesi√≥n:', error);
              }
            }

            securityStatus.className = 'axyra-security-indicator danger';
            securityStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Sin Seguridad</span>';
          }
        } catch (error) {
          console.error('Error actualizando estado de seguridad:', error);
          securityStatus.className = 'axyra-security-indicator danger';
          securityStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Error</span>';
        }
      }

      // Cargar estad√≠sticas
      async function cargarEstadisticas() {
        try {
          console.log('üìä Cargando estad√≠sticas...');

          // Obtener usuario actual para aislamiento de datos
          let currentUser = null;
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('‚úÖ Usuario Firebase:', currentUser.email);
          } else if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
            console.log('‚úÖ Usuario sistema profesional:', currentUser.username);
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.error('‚ùå No hay usuario autenticado');
            return;
          }

          // Intentar cargar datos desde Firebase primero
          if (window.axyraFirebaseDataSystem && currentUser.uid) {
            console.log('üî• Cargando datos desde Firebase...');

            try {
              // Cargar empleados desde Firebase
              const empleados = await window.axyraFirebaseDataSystem.getEmployees();
              document.getElementById('totalEmpleados').textContent = empleados.length;

              // Cargar horas desde Firebase
              const horas = await window.axyraFirebaseDataSystem.getHours();
              const totalHorasTrabajadas = horas.reduce((total, registro) => {
                const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
                const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
                const horasExtras = parseFloat(registro.horasExtras) || 0;
                const horasDominicales = parseFloat(registro.horasDominicales) || 0;
                return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
              }, 0);

              // Cargar comprobantes desde Firebase
              const comprobantes = await window.axyraFirebaseDataSystem.getReceipts();
              document.getElementById('comprobantesGenerados').textContent = comprobantes.length;

              // Calcular total de salarios base
              const totalSalarios = empleados.reduce((total, empleado) => {
                if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
                  return total;
                }
                const salario = parseFloat(empleado.salario);
                if (!isNaN(salario) && salario > 0) {
                  return total + salario;
                }
                return total;
              }, 0);

              // Formatear y mostrar datos
              formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas);

              console.log('‚úÖ Datos cargados desde Firebase');
              return;
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Error cargando desde Firebase, usando localStorage:', firebaseError);
            }
          }

          // Fallback a localStorage
          console.log('üíæ Cargando datos desde localStorage...');
          cargarEstadisticasLocalStorage(currentUser);
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas:', error);
          // NO redirigir al login por errores de estad√≠sticas
          // Solo mostrar mensaje de error
          console.log('‚ö†Ô∏è Continuando sin estad√≠sticas...');
        }
      }

      // Funci√≥n auxiliar para cargar desde localStorage - SISTEMA AISLADO
      function cargarEstadisticasLocalStorage(currentUser) {
        try {
          console.log('üíæ Cargando estad√≠sticas desde localStorage para usuario:', currentUser.username);

          // Empleados FILTRADOS POR USUARIO
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
            (emp) => emp.userId === currentUser.username || emp.userId === currentUser.email
          );

          // Buscar elemento totalEmpleados de forma segura
          const totalEmpleadosElement = document.getElementById('totalEmpleados');
          if (totalEmpleadosElement) {
            totalEmpleadosElement.textContent = empleados.length;
            console.log('‚úÖ Total empleados actualizado:', empleados.length);
          } else {
            console.log('‚ö†Ô∏è Elemento totalEmpleados no encontrado');
          }

          // Comprobantes FILTRADOS POR USUARIO
          const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
            (comp) => comp.userId === currentUser.username || comp.userId === currentUser.email
          );

          // Buscar elemento comprobantesGenerados de forma segura
          const comprobantesElement = document.getElementById('comprobantesGenerados');
          if (comprobantesElement) {
            comprobantesElement.textContent = comprobantes.length;
            console.log('‚úÖ Comprobantes generados actualizados:', comprobantes.length);
          } else {
            console.log('‚ö†Ô∏è Elemento comprobantesGenerados no encontrado');
          }

          // Calcular total de salarios base
          const totalSalarios = empleados.reduce((total, empleado) => {
            if (!empleado.salario || empleado.salario === '' || empleado.salario === 'undefined') {
              return total;
            }
            const salario = parseFloat(empleado.salario);
            if (!isNaN(salario) && salario > 0) {
              return total + salario;
            }
            return total;
          }, 0);

          // Calcular horas trabajadas
          const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
            (hr) => hr.userId === currentUser.username || hr.userId === currentUser.email
          );
          const totalHorasTrabajadas = registrosHoras.reduce((total, registro) => {
            const horasOrdinarias = parseFloat(registro.horasOrdinarias) || 0;
            const horasNocturnas = parseFloat(registro.horasNocturnas) || 0;
            const horasExtras = parseFloat(registro.horasExtras) || 0;
            const horasDominicales = parseFloat(registro.horasDominicales) || 0;
            return total + horasOrdinarias + horasNocturnas + horasExtras + horasDominicales;
          }, 0);

          // Si no hay horas trabajadas, el total de salarios debe ser 0
          const totalSalariosFinal = totalHorasTrabajadas > 0 ? totalSalarios : 0;

          // Formatear y mostrar datos de forma segura
          formatearYMostrarDatos(totalSalariosFinal, totalHorasTrabajadas);

          // Cargar actividad reciente de forma segura
          if (typeof cargarActividadReciente === 'function') {
            cargarActividadReciente();
          } else {
            console.log('‚ö†Ô∏è Funci√≥n cargarActividadReciente no disponible');
          }

          console.log('‚úÖ Estad√≠sticas cargadas exitosamente');
        } catch (error) {
          console.error('‚ùå Error en cargarEstadisticasLocalStorage:', error);
          // NO redirigir al login por errores de estad√≠sticas
        }
      }

      // Funci√≥n para formatear y mostrar datos - SISTEMA AISLADO
      function formatearYMostrarDatos(totalSalarios, totalHorasTrabajadas) {
        try {
          console.log('üíπ Formateando datos:', { totalSalarios, totalHorasTrabajadas });

          // Formatear salario con solo 1 decimal y ajustar tama√±o
          const formatearMoneda = (monto) => {
            if (monto === 0) return '$0';
            if (monto < 1000) return `$${monto.toFixed(1)}`;
            if (monto < 1000000) return `$${(monto / 1000).toFixed(1)}K`;
            if (monto < 1000000000) return `$${(monto / 1000000).toFixed(1)}M`;
            return `$${(monto / 1000000000).toFixed(1)}B`;
          };

          // Buscar elemento totalSalarios de forma segura
          const totalSalariosElement = document.getElementById('totalSalarios');
          if (totalSalariosElement) {
            totalSalariosElement.textContent = formatearMoneda(totalSalarios);
            console.log('‚úÖ Total salarios actualizado:', formatearMoneda(totalSalarios));
          } else {
            console.log('‚ö†Ô∏è Elemento totalSalarios no encontrado');
          }

          // Formatear horas con solo 1 decimal y ajustar tama√±o
          const formatearHoras = (horas) => {
            if (horas === 0) return '0';
            if (horas < 100) return horas.toFixed(1);
            if (horas < 1000) return (horas / 100).toFixed(1) + 'C';
            if (horas < 1000000) return (horas / 1000).toFixed(1) + 'K';
            return (horas / 1000000).toFixed(1) + 'M';
          };

          // Buscar elemento horasTrabajadas de forma segura
          const horasTrabajadasElement = document.getElementById('horasTrabajadas');
          if (horasTrabajadasElement) {
            horasTrabajadasElement.textContent = formatearHoras(totalHorasTrabajadas);
            console.log('‚úÖ Horas trabajadas actualizadas:', formatearHoras(totalHorasTrabajadas));
          } else {
            console.log('‚ö†Ô∏è Elemento horasTrabajadas no encontrado');
          }

          console.log('‚úÖ Datos formateados y mostrados exitosamente');
        } catch (error) {
          console.error('‚ùå Error en formatearYMostrarDatos:', error);
          // NO redirigir al login por errores de formato
        }
      }

      // Cargar actividad reciente
      function cargarActividadReciente() {
        const actividadReciente = document.getElementById('actividadReciente');

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser || !currentUser.username) {
          console.error('No hay usuario autenticado para actividad reciente');
          return;
        }

        // Filtrar datos por usuario
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username
        );

        let actividadHTML = '';

        // Actividad de empleados
        if (empleados.length > 0) {
          const ultimoEmpleado = empleados[empleados.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Empleado agregado</div>
                            <div class="axyra-activity-time">${
                              ultimoEmpleado.nombre
                            } - ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad de comprobantes
        if (comprobantes.length > 0) {
          const ultimoComprobante = comprobantes[comprobantes.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Comprobante generado</div>
                            <div class="axyra-activity-time">${ultimoComprobante.empleado} - ${ultimoComprobante.fecha}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad del sistema
        actividadHTML += `
                <div class="axyra-activity-item">
                    <div class="axyra-activity-icon">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <div class="axyra-activity-content">
                        <div class="axyra-activity-title">Sesi√≥n iniciada</div>
                        <div class="axyra-activity-time">Administrador - ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            `;

        if (actividadHTML === '') {
          actividadHTML = '<p class="axyra-text-center">No hay actividad reciente</p>';
        }

        actividadReciente.innerHTML = actividadHTML;
      }

      // Funciones para mostrar detalles de las estad√≠sticas
      function mostrarDetalleEmpleados() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
            (emp) => emp.userId === currentUser.username
          );

          let detalleHTML = '<h4>üìã Lista de Empleados</h4>';
          if (empleados.length > 0) {
            detalleHTML += '<div class="axyra-empleados-lista">';
            empleados.forEach((emp) => {
              detalleHTML += `
                <div class="axyra-empleado-item">
                  <div class="axyra-empleado-info">
                    <strong>${emp.nombre}</strong>
                    <span>${emp.cargo} - ${emp.departamento}</span>
                    <span>Salario: $${emp.salario?.toLocaleString('es-CO') || '0'}</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay empleados registrados</p>';
          }

          mostrarModal('Detalle de Empleados', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de empleados:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleHoras() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const registrosHoras = JSON.parse(localStorage.getItem('axyra_horas') || '[]').filter(
            (hr) => hr.userId === currentUser.username
          );

          let detalleHTML = '<h4>‚è∞ Detalle de Horas Trabajadas</h4>';
          if (registrosHoras.length > 0) {
            detalleHTML += '<div class="axyra-horas-lista">';
            registrosHoras.forEach((hr) => {
              const totalHoras =
                (parseFloat(hr.horasOrdinarias) || 0) +
                (parseFloat(hr.horasNocturnas) || 0) +
                (parseFloat(hr.horasExtras) || 0) +
                (parseFloat(hr.horasDominicales) || 0);
              detalleHTML += `
                <div class="axyra-hora-item">
                  <div class="axyra-hora-info">
                    <strong>${hr.empleado}</strong>
                    <span>Fecha: ${hr.fecha}</span>
                    <span>Total: ${totalHoras} horas</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay registros de horas</p>';
          }

          mostrarModal('Detalle de Horas', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de horas:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleComprobantes() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
            (comp) => comp.userId === currentUser.username
          );

          let detalleHTML = '<h4>üßæ Detalle de Comprobantes</h4>';
          if (comprobantes.length > 0) {
            detalleHTML += '<div class="axyra-comprobantes-lista">';
            comprobantes.forEach((comp) => {
              detalleHTML += `
                <div class="axyra-comprobante-item">
                  <div class="axyra-comprobante-info">
                    <strong>${comp.numeroFactura}</strong>
                    <span>${comp.encargado} - ${comp.area}</span>
                    <span>$${comp.monto?.toLocaleString('es-CO') || '0'}</span>
                </div>
                <button class="axyra-btn axyra-btn-sm axyra-btn-secondary" onclick="descargarComprobante('${comp.id}')">
                  <i class="fas fa-download"></i> Descargar
                </button>
              </div>
            `;
            });
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay comprobantes generados</p>';
          }

          mostrarModal('Detalle de Comprobantes', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de comprobantes:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      function mostrarDetalleSalarios() {
        try {
          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            // Fallback a localStorage
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser || !currentUser.username) {
            mostrarMensaje('‚ùå No hay usuario autenticado', 'error');
            return;
          }

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
            (emp) => emp.userId === currentUser.username
          );

          let detalleHTML = '<h4>üí∞ Detalle de Salarios</h4>';
          if (empleados.length > 0) {
            detalleHTML += '<div class="axyra-salarios-lista">';
            empleados.forEach((emp) => {
              detalleHTML += `
                <div class="axyra-salario-item">
                  <div class="axyra-empleado-info">
                    <strong>${emp.nombre}</strong>
                    <span>${emp.cargo}</span>
                    <span class="axyra-salario-monto">Salario base configurado</span>
                  </div>
                </div>
              `;
            });
            detalleHTML += `
              <div class="axyra-salario-total">
                <strong>Total Empleados: ${empleados.length}</strong>
              </div>
            `;
            detalleHTML += '</div>';
          } else {
            detalleHTML += '<p>No hay empleados registrados</p>';
          }

          mostrarModal('Detalle de Salarios', detalleHTML);
        } catch (error) {
          console.error('Error mostrando detalle de salarios:', error);
          mostrarMensaje('‚ùå Error al mostrar detalles', 'error');
        }
      }

      // Funci√≥n para mostrar mensajes
      function mostrarMensaje(mensaje, tipo = 'info') {
        // Remover mensajes existentes
        const existingMessages = document.querySelectorAll('.axyra-message');
        existingMessages.forEach((msg) => msg.remove());

        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        document.body.appendChild(mensajeDiv);

        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }

      // Funci√≥n para mostrar modal
      function mostrarModal(titulo, contenido) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">√ó</button>
            </div>
            <div class="axyra-modal-body">
              ${contenido}
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-primary" onclick="cerrarModal(this)">
                <i class="fas fa-check"></i> Entendido
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Funci√≥n para descargar comprobante
      function descargarComprobante(comprobanteId) {
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
        const comprobante = comprobantes.find((c) => c.id === comprobanteId);

        if (comprobante) {
          // Crear contenido del comprobante
          const contenido = `
            COMPROBANTE: ${comprobante.numeroFactura}
            FECHA: ${comprobante.fecha}
            ENCARGADO: ${comprobante.encargado}
            √ÅREA: ${comprobante.area}
            MONTO: $${comprobante.monto?.toLocaleString('es-CO') || '0'}
            M√âTODO DE PAGO: ${comprobante.metodoPago}
            DESCRIPCI√ìN: ${comprobante.descripcion}
          `;

          // Crear y descargar archivo
          const blob = new Blob([contenido], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `comprobante_${comprobante.numeroFactura}.txt`;
          a.click();
          window.URL.revokeObjectURL(url);
        }
      }

      // Funci√≥n para mostrar modal de acci√≥n (navegaci√≥n)
      function mostrarModalAccion(titulo, mensaje, accion) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">√ó</button>
            </div>
            <div class="axyra-modal-body">
              <p>${mensaje}</p>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal(this)">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-primary" onclick="ejecutarAccion('${accion}')">
                <i class="fas fa-check"></i> Continuar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Funci√≥n para mostrar modal de confirmaci√≥n (acciones destructivas)
      function mostrarModalConfirmacion(titulo, mensaje, accion) {
        // Cerrar modales existentes antes de crear uno nuevo
        cerrarModalesExistentes();

        const modal = document.createElement('div');
        modal.className = 'axyra-modal';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>${titulo}</h3>
              <button class="axyra-modal-close" onclick="cerrarModal(this)">√ó</button>
            </div>
            <div class="axyra-modal-body">
              <p>${mensaje}</p>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModal(this)">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-danger" onclick="ejecutarAccionConfirmada('${accion}')">
                <i class="fas fa-exclamation-triangle"></i> Confirmar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Agregar funcionalidad para cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Cerrar al hacer click fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModal(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        });
      }

      // Funci√≥n para ejecutar acciones de navegaci√≥n
      function ejecutarAccion(accion) {
        // Cerrar modal
        document.querySelector('.axyra-modal').remove();

        // Ejecutar acci√≥n seg√∫n el tipo
        switch (accion) {
          case 'empleados':
            window.location.href = '../empleados/empleados.html';
            break;
          case 'horas':
            window.location.href = '../horas/gestionar_horas.html';
            break;
          case 'nomina':
            window.location.href = '../nomina/gestionar_nomina.html';
            break;
          case 'cuadre':
            window.location.href = '../cuadre_caja/cuadre_caja.html';
            break;
          default:
            console.log('Acci√≥n no reconocida:', accion);
        }
      }

      // Funci√≥n para ejecutar acciones confirmadas
      function ejecutarAccionConfirmada(accion) {
        // Cerrar modal
        cerrarModalesExistentes();

        // Ejecutar acci√≥n seg√∫n el tipo
        switch (accion) {
          case 'limpiarDatosCorruptos':
            limpiarDatosCorruptos();
            break;
          case 'resetearLocalStorage':
            resetearLocalStorage();
            break;
          case 'crearDatosPrueba':
            crearDatosPrueba();
            break;
          default:
            console.log('Acci√≥n confirmada no reconocida:', accion);
        }
      }

      // Funci√≥n para cerrar un modal espec√≠fico
      function cerrarModal(elemento) {
        const modal = elemento.closest('.axyra-modal');
        if (modal) {
          modal.remove();
        }
      }

      // Funci√≥n para cerrar todos los modales existentes
      function cerrarModalesExistentes() {
        const modales = document.querySelectorAll('.axyra-modal');
        modales.forEach((modal) => modal.remove());
      }

      // Ver todas las tareas
      function verTodasLasTareas() {
        // Crear modal para mostrar todas las tareas
        const modalHTML = `
          <div id="modalTareas" class="axyra-modal show">
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-tasks"></i> Todas las Tareas
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalTareas()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-tasks-container">
                  <div class="axyra-task-filters">
                    <select id="filterPrioridad" class="axyra-form-select" onchange="filtrarTareas()">
                      <option value="">Todas las prioridades</option>
                      <option value="Alta">Alta</option>
                      <option value="Media">Media</option>
                      <option value="Baja">Baja</option>
                    </select>
                    <select id="filterEstado" class="axyra-form-select" onchange="filtrarTareas()">
                      <option value="">Todos los estados</option>
                      <option value="Pendiente">Pendiente</option>
                      <option value="En Progreso">En Progreso</option>
                      <option value="Completada">Completada</option>
                    </select>
                  </div>
                  <div id="listaTareasCompleta" class="axyra-tasks-list">
                    <!-- Las tareas se cargar√°n din√°micamente -->
                  </div>
                  <div class="axyra-task-actions">
                    <button class="axyra-btn axyra-btn-primary" onclick="agregarNuevaTarea()">
                      <i class="fas fa-plus"></i> Nueva Tarea
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        cargarTodasLasTareas();
      }

      // Cerrar modal de tareas
      function cerrarModalTareas() {
        const modal = document.getElementById('modalTareas');
        if (modal) {
          modal.remove();
        }
      }

      // Cargar todas las tareas
      function cargarTodasLasTareas() {
        const listaTareas = document.getElementById('listaTareasCompleta');
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');

        let tareasHTML = '';

        // Tareas del sistema
        const tareasSistema = [
          {
            id: 'sistema-1',
            titulo: 'Configurar zona horaria',
            descripcion: 'Establecer zona horaria para Colombia',
            prioridad: 'Baja',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Sistema',
          },
          {
            id: 'sistema-2',
            titulo: 'Configurar moneda por defecto',
            descripcion: 'Establecer COP como moneda principal',
            prioridad: 'Media',
            estado: 'Completada',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Sistema',
          },
        ];

        // Tareas basadas en empleados
        if (empleados.length === 0) {
          tareasSistema.push({
            id: 'empleado-1',
            titulo: 'Agregar primer empleado',
            descripcion: 'Registrar el primer empleado en el sistema',
            prioridad: 'Alta',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Empleado',
          });
        }

        // Tareas basadas en comprobantes
        if (comprobantes.length === 0 && empleados.length > 0) {
          tareasSistema.push({
            id: 'comprobante-1',
            titulo: 'Generar primer comprobante',
            descripcion: 'Crear el primer comprobante de pago',
            prioridad: 'Media',
            estado: 'Pendiente',
            fecha: new Date().toLocaleDateString(),
            tipo: 'Comprobante',
          });
        }

        // Mostrar todas las tareas
        tareasSistema.forEach((tarea) => {
          const prioridadClass = tarea.prioridad.toLowerCase().replace(' ', '-');
          const estadoClass = tarea.estado.toLowerCase().replace(' ', '-');

          tareasHTML += `
            <div class="axyra-task-item" data-prioridad="${tarea.prioridad}" data-estado="${tarea.estado}">
              <div class="axyra-task-header">
                <div class="axyra-task-title">${tarea.titulo}</div>
                <div class="axyra-task-meta">
                  <span class="axyra-badge axyra-badge-${prioridadClass}">${tarea.prioridad}</span>
                  <span class="axyra-badge axyra-badge-${estadoClass}">${tarea.estado}</span>
                </div>
              </div>
              <div class="axyra-task-description">${tarea.descripcion}</div>
              <div class="axyra-task-footer">
                <span class="axyra-task-type">${tarea.tipo}</span>
                <span class="axyra-task-date">${tarea.fecha}</span>
              </div>
            </div>
          `;
        });

        if (tareasHTML === '') {
          tareasHTML = '<p class="axyra-text-center">No hay tareas pendientes</p>';
        }

        listaTareas.innerHTML = tareasHTML;
      }

      // Filtrar tareas
      function filtrarTareas() {
        const prioridad = document.getElementById('filterPrioridad').value;
        const estado = document.getElementById('filterEstado').value;

        document.querySelectorAll('.axyra-task-item').forEach((item) => {
          let mostrar = true;

          if (prioridad && item.dataset.prioridad !== prioridad) {
            mostrar = false;
          }

          if (estado && item.dataset.estado !== estado) {
            mostrar = false;
          }

          item.style.display = mostrar ? 'block' : 'none';
        });
      }

      // Agregar nueva tarea
      function agregarNuevaTarea() {
        alert('üìù Funcionalidad de agregar tareas en desarrollo');
      }

      // Cargar configuraci√≥n guardada
      function cargarConfiguracion() {
        const moneda = localStorage.getItem('axyra_moneda') || 'COP';
        const zonaHoraria = localStorage.getItem('axyra_zona_horaria') || 'America/Bogota';
        const formatoFecha = localStorage.getItem('axyra_formato_fecha') || 'DD/MM/YYYY';

        // Aplicar moneda
        cambiarMoneda(moneda);

        // Aplicar zona horaria
        document.getElementById('zonaHoraria').value = zonaHoraria;

        // Aplicar formato de fecha
        document.getElementById('formatoFecha').value = formatoFecha;
      }

      // Guardar configuraci√≥n
      function guardarConfiguracion() {
        const zonaHoraria = document.getElementById('zonaHoraria').value;
        const formatoFecha = document.getElementById('formatoFecha').value;

        localStorage.setItem('axyra_zona_horaria', zonaHoraria);
        localStorage.setItem('axyra_formato_fecha', formatoFecha);

        mostrarMensaje('‚úÖ Configuraci√≥n guardada', 'success');
      }

      // Inicializaci√≥n completa del dashboard
      window.addEventListener('load', () => {
        try {
          console.log('üöÄ Inicializando dashboard...');
          
          // Verificar autenticaci√≥n
          const isAuthenticated = checkAuth();
          
          if (isAuthenticated) {
            console.log('‚úÖ Usuario autenticado, cargando dashboard...');
            
            // Cargar estad√≠sticas
            cargarEstadisticas();
            
            // Actualizar indicador de seguridad
            updateSecurityStatus();
            
            // Mostrar configuraci√≥n de empresa
            mostrarConfiguracionEmpresa();
            
            // Configurar intervalo de actualizaci√≥n de seguridad
            setInterval(updateSecurityStatus, 30000); // Cada 30 segundos
            
            console.log('‚úÖ Dashboard completamente inicializado');
          } else {
            console.log('‚ùå Usuario no autenticado, mostrando mensaje...');
            // NO redirigir autom√°ticamente
          }
        } catch (error) {
          console.error('‚ùå Error inicializando dashboard:', error);
          // NO redirigir autom√°ticamente
        }
      });

      // Mostrar configuraci√≥n actual de la empresa
      function mostrarConfiguracionEmpresa() {
        try {
          const config = JSON.parse(localStorage.getItem('axyra_configuracion') || '{}');
          
          if (config.nombreEmpresa) {
            console.log('üè¢ Configuraci√≥n de empresa cargada:', {
              nombre: config.nombreEmpresa,
              nit: config.nitEmpresa,
              direccion: config.direccionEmpresa
            });
            
            // Actualizar el t√≠tulo del dashboard si hay configuraci√≥n
            const logoTitle = document.querySelector('.axyra-logo-title');
            if (logoTitle && config.nombreEmpresa) {
              logoTitle.textContent = config.nombreEmpresa.toUpperCase();
            }
          } else {
            console.log('‚ÑπÔ∏è No hay configuraci√≥n de empresa, usando valores por defecto');
          }
        } catch (error) {
          console.error('‚ùå Error mostrando configuraci√≥n de empresa:', error);
        }
      }

      // Cargar actividad reciente
      function cargarActividadReciente() {
        const actividadReciente = document.getElementById('actividadReciente');

        // Obtener usuario actual para aislamiento de datos
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          // Fallback a localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }

        if (!currentUser || !currentUser.username) {
          console.error('No hay usuario autenticado para actividad reciente');
          return;
        }

        // Filtrar datos por usuario
        const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').filter(
          (emp) => emp.userId === currentUser.username
        );
        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]').filter(
          (comp) => comp.userId === currentUser.username
        );

        let actividadHTML = '';

        // Actividad de empleados
        if (empleados.length > 0) {
          const ultimoEmpleado = empleados[empleados.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Empleado agregado</div>
                            <div class="axyra-activity-time">${
                              ultimoEmpleado.nombre
                            } - ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad de comprobantes
        if (comprobantes.length > 0) {
          const ultimoComprobante = comprobantes[comprobantes.length - 1];
          actividadHTML += `
                    <div class="axyra-activity-item">
                        <div class="axyra-activity-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="axyra-activity-content">
                            <div class="axyra-activity-title">Comprobante generado</div>
                            <div class="axyra-activity-time">${ultimoComprobante.empleado} - ${ultimoComprobante.fecha}</div>
                        </div>
                    </div>
                `;
        }

        // Actividad del sistema
        actividadHTML += `
                <div class="axyra-activity-item">
                    <div class="axyra-activity-icon">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <div class="axyra-activity-content">
                        <div class="axyra-activity-title">Sesi√≥n iniciada</div>
                        <div class="axyra-activity-time">Administrador - ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            `;

        if (actividadHTML === '') {
          actividadHTML = '<p class="axyra-text-center">No hay actividad reciente</p>';
        }

        actividadReciente.innerHTML = actividadHTML;
      }

      // Inicializar dashboard
      async function initializeDashboard() {
        console.log('üöÄ Inicializando dashboard...');
        
        // Verificar autenticaci√≥n
        const isAuthenticated = await checkAuth();
        
        if (isAuthenticated) {
          console.log('‚úÖ Usuario autenticado, cargando dashboard...');
          loadDashboardData();
          updateWelcomeMessage();
          
          // Configurar listener de Firebase para mantener sesi√≥n
          setupFirebaseAuthListener();
        } else {
          console.log('‚ö†Ô∏è Usuario no autenticado, mostrando mensaje de login');
        }
      }
      
      // Configurar listener de Firebase para mantener sesi√≥n sincronizada
      function setupFirebaseAuthListener() {
        if (typeof firebase !== 'undefined' && firebase.auth) {
          firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
              console.log('üî• Usuario Firebase autenticado en dashboard:', user.email);
              
              // Actualizar usuario actual
              currentUser = {
                id: user.uid,
                username: user.email.split('@')[0],
                email: user.email,
                nombre: user.displayName || user.email.split('@')[0],
                rol: 'usuario',
                createdAt: new Date().toISOString()
              };
              
              // Sincronizar localStorage
              localStorage.setItem('axyra_firebase_user', JSON.stringify(user));
              localStorage.setItem('axyra_isolated_user', JSON.stringify(currentUser));
              
            } else {
              console.log('üî• Usuario Firebase no autenticado, limpiando sesi√≥n...');
              
              // Limpiar sesi√≥n
              currentUser = null;
              localStorage.removeItem('axyra_firebase_user');
              localStorage.removeItem('axyra_isolated_user');
              
              // NO mostrar mensaje autom√°ticamente - solo si el usuario est√° en la p√°gina
              if (document.visibilityState === 'visible') {
                mostrarMensajeNoAutenticado();
              }
            }
          });
          
          console.log('‚úÖ Listener de Firebase configurado en dashboard');
        } else {
          console.log('‚ö†Ô∏è Firebase no disponible en dashboard');
        }
      }

      // Cargar datos del dashboard
      function loadDashboardData() {
        console.log('üìä Cargando datos del dashboard...');
        
        // Cargar estad√≠sticas
        loadEmpleadosStats();
        loadHorasStats();
        loadNominaStats();
        loadCuadreStats();
        loadDepartamentosStats();
        loadTareasStats();
        
        // Cargar gr√°ficos
        loadCharts();
      }

      // Actualizar mensaje de bienvenida
      function updateWelcomeMessage() {
        try {
          const currentUser = window.axyraIsolatedAuth.getCurrentUser();
          if (currentUser) {
            const welcomeTitle = document.getElementById('welcomeTitle');
            if (welcomeTitle) {
              welcomeTitle.textContent = `¬°Bienvenido, ${currentUser.username}!`;
            }
          }
        } catch (error) {
          console.error('‚ùå Error actualizando bienvenida:', error);
        }
      }

      // Funciones para cargar estad√≠sticas b√°sicas
      function loadEmpleadosStats() {
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const totalEmpleados = empleados.length;
          document.getElementById('totalEmpleados').textContent = totalEmpleados;
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas de empleados:', error);
        }
      }

      function loadHorasStats() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const totalHoras = horas.reduce((sum, h) => sum + (h.horas || 0), 0);
          document.getElementById('horasTrabajadas').textContent = totalHoras;
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas de horas:', error);
        }
      }

      function loadNominaStats() {
        try {
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const totalNominas = nominas.length;
          document.getElementById('totalNominas').textContent = totalNominas;
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas de n√≥minas:', error);
        }
      }

      function loadCuadreStats() {
        try {
          const facturas = JSON.parse(localStorage.getItem('axyra_facturas') || '[]');
          const totalFacturas = facturas.length;
          document.getElementById('totalFacturas').textContent = totalFacturas;
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas de facturas:', error);
        }
      }

      function loadDepartamentosStats() {
        try {
          const departamentos = JSON.parse(localStorage.getItem('axyra_departamentos') || '[]');
          const totalDepartamentos = departamentos.length;
          document.getElementById('totalDepartamentos').textContent = totalDepartamentos;
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas de departamentos:', error);
        }
      }

      function loadTareasStats() {
        try {
          const tareas = JSON.parse(localStorage.getItem('axyra_tareas') || '[]');
          const tareasPendientes = tareas.filter(t => !t.completada).length;
          document.getElementById('tareasPendientes').textContent = tareasPendientes;
        } catch (error) {
          console.error('‚ùå Error cargando estad√≠sticas de tareas:', error);
        }
      }

      function loadCharts() {
        // Por ahora solo cargar datos b√°sicos
        console.log('üìä Gr√°ficos cargados (b√°sico)');
      }
    </script>

    <style>
      .axyra-productivity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .axyra-productivity-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
      }

      .axyra-productivity-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
      }

      .axyra-productivity-content {
        flex: 1;
      }

      .axyra-productivity-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--axyra-gray-900);
        line-height: 1;
      }

      .axyra-productivity-label {
        font-size: 0.875rem;
        color: var(--axyra-gray-600);
        margin-top: 0.25rem;
      }

      #employeeDistributionChart,
      #hoursTrendChart,
      #salaryDistributionChart,
      #productivityChart {
        position: relative;
        min-height: 300px;
      }

      /* Estilos para tarjetas clickeables */
      .axyra-stat-card.clickable {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .axyra-stat-card.clickable:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .axyra-stat-hint {
        font-size: 0.75rem;
        color: var(--axyra-gray-500);
        text-align: center;
        margin-top: 0.5rem;
        opacity: 0.8;
      }

      /* Estilos para el modal */
      .axyra-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .axyra-modal-content {
        background: white;
        border-radius: 0.5rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      /* Estilos para tarjeta de bienvenida */
      .axyra-welcome-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .axyra-welcome-icon {
        font-size: 48px;
        opacity: 0.9;
      }

      .axyra-welcome-content {
        flex: 1;
      }

      .axyra-welcome-title {
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: white;
      }

      .axyra-welcome-message {
        font-size: 16px;
        margin: 0 0 15px 0;
        opacity: 0.9;
        line-height: 1.5;
      }

      .axyra-welcome-time {
        font-size: 14px;
        opacity: 0.8;
        font-weight: 500;
      }

      /* Estilos para panel de configuraci√≥n */
      .axyra-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }

      .axyra-config-section {
        background: #f8fafc;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .axyra-config-title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .axyra-config-item {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .axyra-config-item label {
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
      }

      .axyra-config-input {
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .axyra-config-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .axyra-config-select {
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .axyra-config-btn {
        padding: 10px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-config-btn:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .axyra-config-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        background: #fed7d7;
        color: #c53030;
        display: inline-block;
      }

      .axyra-config-status.verified {
        background: #c6f6d5;
        color: #2f855a;
      }

      .axyra-2fa-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .axyra-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 14px;
        color: #4a5568;
      }

      .axyra-checkbox input[type='checkbox'] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      /* Estilos para modales */
      .axyra-modal-body {
        padding: 20px;
      }

      .axyra-modal-footer {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .axyra-form-group {
        margin-bottom: 20px;
      }

      .axyra-form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .axyra-form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .axyra-form-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .axyra-form-help {
        font-size: 12px;
        color: #718096;
        margin-top: 5px;
        display: block;
      }

      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
        font-size: 16px;
        padding: 5px;
        transition: color 0.3s ease;
      }

      .password-toggle:hover {
        color: #667eea;
      }

      /* Estilos para Google Authenticator */
      .axyra-google-auth-setup {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .axyra-qr-section,
      .axyra-manual-section,
      .axyra-verification-section {
        text-align: center;
      }

      .axyra-qr-section h4,
      .axyra-manual-section h4,
      .axyra-verification-section h4 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
      }

      .axyra-qr-container {
        background: #f8fafc;
        border: 2px dashed #e2e8f0;
        border-radius: 12px;
        padding: 30px;
        margin: 20px 0;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .axyra-qr-container img {
        max-width: 200px;
        height: auto;
      }

      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-btn-primary {
        background: #667eea;
        color: white;
        border: none;
      }

      .axyra-btn-primary:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .axyra-btn-secondary {
        background: #718096;
        color: white;
        border: none;
      }

      .axyra-btn-secondary:hover {
        background: #4a5568;
        transform: translateY(-2px);
      }

      .axyra-modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--axyra-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-modal-header h3 {
        margin: 0;
        color: var(--axyra-gray-900);
      }

      .axyra-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--axyra-gray-500);
        padding: 0.25rem;
        border-radius: 0.25rem;
      }

      .axyra-modal-close:hover {
        background: var(--axyra-gray-100);
        color: var(--axyra-gray-700);
      }

      .axyra-modal-body {
        padding: 1.5rem;
      }

      .axyra-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--axyra-gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        background: var(--axyra-gray-50);
        border-radius: 0 0 0.5rem 0.5rem;
      }

      /* Estilos para listas de detalles */
      .axyra-empleados-lista,
      .axyra-horas-lista,
      .axyra-comprobantes-lista,
      .axyra-salarios-lista {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .axyra-empleado-item,
      .axyra-hora-item,
      .axyra-comprobante-item,
      .axyra-salario-item {
        padding: 1rem;
        border: 1px solid var(--axyra-gray-200);
        border-radius: 0.5rem;
        background: var(--axyra-gray-50);
      }

      .axyra-empleado-info,
      .axyra-hora-info,
      .axyra-comprobante-info,
      .axyra-salario-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .axyra-comprobante-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-salario-total {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--axyra-blue-50);
        border: 1px solid var(--axyra-blue-200);
        border-radius: 0.5rem;
        text-align: center;
        color: var(--axyra-blue-800);
      }

      .axyra-chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      @media (max-width: 768px) {
        .axyra-productivity-grid {
          grid-template-columns: 1fr;
        }

        .axyra-productivity-item {
          flex-direction: column;
          text-align: center;
        }
      }
    </style>

    <!-- Inicializaci√≥n autom√°tica del dashboard -->
    <script>
      // Inicializar dashboard cuando se carga la p√°gina
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Dashboard cargado, verificando autenticaci√≥n...');
        
        // Esperar un poco para que se carguen todos los scripts
        setTimeout(async () => {
          await initializeDashboard();
        }, 500);
      });
    </script>
  </body>
</html>
