<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gestión de Nómina</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="stylesheet" href="../../static/modal-positioning-fix.css" />
    <link rel="stylesheet" href="../../static/modal-emergency-fix.css" />
    <link rel="stylesheet" href="../../static/header-fixes.css" />
    <link rel="stylesheet" href="nomina-styles.css" />
    <link rel="stylesheet" href="nomina-avanzada-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>

    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>

    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>

    <!-- Sistema Unificado de Autenticación AXYRA -->
    <script src="../../static/unified-auth-system.js"></script>

    <!-- Sistema Unificado de Reportes Avanzados AXYRA -->
    <script src="../../static/advanced-reports-unified.js"></script>

    <!-- Sistema Unificado de Backup AXYRA -->
    <script src="../../static/backup-system-unified.js"></script>

    <!-- Sistema Unificado de Auditoría AXYRA -->
    <script src="../../static/audit-system-unified.js"></script>

    <script src="../../static/debug-auth.js"></script>
    <script src="../../static/gmail-notifications.js"></script>

    <!-- Header Compartido AXYRA -->
    <script src="../../static/include-header.js"></script>

    <!-- Verificación del Header Compartido -->
    <script src="../../static/header-verification.js"></script>

    <!-- Sistema Avanzado de Nómina AXYRA -->
    <script src="nomina-avanzada.js"></script>

    <style>
      /* Estilos específicos para el módulo de nómina */
      .axyra-metrics-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      }

      .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.9;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
      }

      .axyra-actions-bar {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin: 30px 0;
        padding: 25px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        border: 1px solid #e2e8f0;
      }

      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: white;
        min-width: 140px;
        justify-content: center;
      }

      .axyra-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .axyra-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .axyra-btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      .axyra-btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .axyra-btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      }

      .axyra-btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
      }

      .axyra-btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .axyra-analytics-dashboard {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        border: 1px solid #e2e8f0;
      }

      .axyra-analytics-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .axyra-analytics-header h3 {
        color: #1e3a8a;
        font-size: 1.8rem;
        margin: 0 0 10px 0;
        font-weight: 700;
      }

      .axyra-analytics-header p {
        color: #64748b;
        font-size: 1.1rem;
        margin: 0;
      }

      /* Filtros y Controles */
      .axyra-filtros-container {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        padding: 25px;
        margin: 30px 0;
        border: 1px solid #e2e8f0;
      }

      .axyra-filtros-header h3 {
        color: #1e3a8a;
        margin: 0 0 20px 0;
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-filtros-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
      }

      .axyra-filtro-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .axyra-filtro-group label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .axyra-actions-bar {
          flex-direction: column;
        }

        .axyra-btn {
          width: 100%;
        }

        .axyra-metrics-dashboard {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .axyra-filtros-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <!-- Header Compartido AXYRA - Se insertará automáticamente -->

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gestión de Nómina</h1>
          <p class="axyra-page-subtitle">Genera y gestiona las nóminas de tus empleados</p>
        </div>

        <!-- Botones de Acción -->
        <div class="axyra-actions-bar">
          <button id="btnGenerarNomina" class="axyra-btn axyra-btn-primary">
            <i class="fas fa-plus"></i> Generar Nómina
          </button>
          <button id="btnExportarExcel" class="axyra-btn axyra-btn-secondary">
            <i class="fas fa-download"></i> Exportar a Excel
          </button>
          <button id="btnGenerarPDF" class="axyra-btn axyra-btn-success">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
          <button id="btnReportes" class="axyra-btn axyra-btn-warning">
            <i class="fas fa-chart-bar"></i> Reportes Avanzados
          </button>
          <button id="btnConfiguracion" class="axyra-btn axyra-btn-info">
            <i class="fas fa-cog"></i> Configuración
          </button>
          <button id="btnHistorial" class="axyra-btn axyra-btn-secondary">
            <i class="fas fa-history"></i> Historial
          </button>
          <button id="btnAuditoria" class="axyra-btn axyra-btn-secondary">
            <i class="fas fa-shield-alt"></i> Auditoría
          </button>
        </div>

        <!-- Dashboard de Métricas -->
        <div class="axyra-metrics-dashboard">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalEmpleados">0</div>
              <div class="metric-label">Total Empleados</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalNominas">0</div>
              <div class="metric-label">Nóminas Generadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="costoTotalEmpresa">$0</div>
              <div class="metric-label">Costo Total Empresa</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalHorasTrabajadas">0 hrs</div>
              <div class="metric-label">Total Horas Trabajadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="promedioSalario">$0</div>
              <div class="metric-label">Promedio Salario</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="nominasEsteMes">0</div>
              <div class="metric-label">Nóminas Este Mes</div>
            </div>
          </div>
        </div>

        <!-- Filtros y Controles -->
        <div class="axyra-filtros-container">
          <div class="axyra-filtros-header">
            <h3><i class="fas fa-filter"></i> Filtros y Búsqueda</h3>
          </div>
          <div class="axyra-filtros-content">
            <div class="axyra-filtro-group">
              <label for="filtroEmpleado">Empleado:</label>
              <select id="filtroEmpleado" class="axyra-form-control">
                <option value="">Todos los empleados</option>
              </select>
            </div>
            <div class="axyra-filtro-group">
              <label for="filtroMes">Mes:</label>
              <input type="month" id="filtroMes" class="axyra-form-control" value="" />
            </div>
            <div class="axyra-filtro-group">
              <label for="filtroEstado">Estado:</label>
              <select id="filtroEstado" class="axyra-form-control">
                <option value="">Todos los estados</option>
                <option value="GENERADA">Generada</option>
                <option value="PAGADA">Pagada</option>
                <option value="ANULADA">Anulada</option>
              </select>
            </div>
            <div class="axyra-filtro-group">
              <button class="axyra-btn axyra-btn-primary" onclick="axyraNomina.aplicarFiltros()">
                <i class="fas fa-search"></i> Aplicar Filtros
              </button>
            </div>
          </div>
        </div>

        <!-- Dashboard de Analytics Avanzado -->
        <div class="axyra-analytics-dashboard">
          <div class="axyra-analytics-header">
            <h3>📊 Analytics Avanzado de Nómina</h3>
            <p>Análisis detallado de costos laborales y tendencias</p>
          </div>
        </div>
      </div>
    </main>

    <script>
      // ========================================
      // SISTEMA ROBUSTO DE FUNCIONES PARA BOTONES
      // ========================================

      // Clase principal para gestión de nómina
      class NominaManager {
        constructor() {
          this.empleados = [];
          this.nominas = [];
          this.configuracion = {};
          this.init();
        }

        async init() {
          try {
            await this.cargarDatos();
            this.configurarEventos();
            console.log('✅ NominaManager inicializado correctamente');
          } catch (error) {
            console.error('❌ Error inicializando NominaManager:', error);
          }
        }

        async cargarDatos() {
          try {
            this.empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            this.nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
            this.configuracion = JSON.parse(localStorage.getItem('axyra_config_simple') || '{}');
            console.log(`📊 Datos cargados: ${this.empleados.length} empleados, ${this.nominas.length} nóminas`);
          } catch (error) {
            console.error('❌ Error cargando datos:', error);
            this.empleados = [];
            this.nominas = [];
            this.configuracion = {};
          }
        }

        configurarEventos() {
          // Configurar eventos de los botones
          this.configurarBotones();
        }

        configurarBotones() {
          // Botón Generar Nómina
          const btnGenerar = document.querySelector('button[onclick="mostrarModalGenerarNomina()"]');
          if (btnGenerar) {
            btnGenerar.onclick = () => this.mostrarModalGenerarNomina();
          }

          // Botón Exportar Excel
          const btnExportar = document.querySelector('button[onclick="exportarNominaSimple()"]');
          if (btnExportar) {
            btnExportar.onclick = () => this.exportarNominaSimple();
          }

          // Botón Generar PDF
          const btnPDF = document.querySelector('button[onclick="generarPDFSimple()"]');
          if (btnPDF) {
            btnPDF.onclick = () => this.generarPDFSimple();
          }

          // Botón Reportes
          const btnReportes = document.querySelector('button[onclick="generarReporteSimple()"]');
          if (btnReportes) {
            btnReportes.onclick = () => this.generarReporteSimple();
          }

          // Botón Configuración
          const btnConfig = document.querySelector('button[onclick="mostrarConfiguracionSimple()"]');
          if (btnConfig) {
            btnConfig.onclick = () => this.mostrarConfiguracionSimple();
          }
        }

        // ========================================
        // FUNCIÓN: MOSTRAR MODAL GENERAR NÓMINA
        // ========================================
        mostrarModalGenerarNomina() {
          try {
            // Crear modal con diseño moderno
            const modal = document.createElement('div');
            modal.className = 'axyra-modal-overlay';
            modal.id = 'modalGenerarNomina';

            modal.innerHTML = `
              <div class="axyra-modal-content">
                <div class="axyra-modal-header">
                  <h3>📋 Generar Nueva Nómina</h3>
                  <button class="axyra-modal-close" onclick="nominaManager.cerrarModalGenerarNomina()">×</button>
                </div>
                <div class="axyra-modal-body">
                  <div class="axyra-form-group">
                    <label for="empleadoSelect">👤 Seleccionar Empleado:</label>
                    <select id="empleadoSelect" class="axyra-form-control">
                      <option value="">Seleccione un empleado...</option>
                    </select>
                  </div>
                  <div class="axyra-form-group">
                    <label for="mesNomina">📅 Mes de Nómina:</label>
                    <input type="month" id="mesNomina" class="axyra-form-control" value="${new Date()
                      .toISOString()
                      .slice(0, 7)}">
                  </div>
                  <div class="axyra-form-group">
                    <label for="horasTrabajadas">⏰ Horas Trabajadas:</label>
                    <input type="number" id="horasTrabajadas" class="axyra-form-control" placeholder="Horas trabajadas este mes" min="0" step="0.5">
                  </div>
                  <div class="axyra-form-group">
                    <label for="horasExtras">⏰ Horas Extras:</label>
                    <input type="number" id="horasExtras" class="axyra-form-control" placeholder="Horas extras (opcional)" value="0" min="0" step="0.5">
                  </div>
                </div>
                <div class="axyra-modal-footer">
                  <button class="axyra-btn axyra-btn-secondary" onclick="nominaManager.cerrarModalGenerarNomina()">❌ Cancelar</button>
                  <button class="axyra-btn axyra-btn-primary" onclick="nominaManager.generarNominaEmpleado()">✅ Generar Nómina</button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);
            this.cargarEmpleadosEnSelect();

            // Agregar estilos para el modal
            if (!document.getElementById('modalStyles')) {
              const styles = document.createElement('style');
              styles.id = 'modalStyles';
              styles.textContent = `
                .axyra-modal-overlay {
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: rgba(0, 0, 0, 0.7);
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  z-index: 9999;
                }
                
                .axyra-modal-content {
                  background: white;
                  border-radius: 16px;
                  max-width: 500px;
                  width: 90%;
                  max-height: 90%;
                  overflow-y: auto;
                  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                }
                
                .axyra-modal-header {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 20px;
                  border-radius: 16px 16px 0 0;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                }
                
                .axyra-modal-header h3 {
                  margin: 0;
                  font-size: 1.25rem;
                }
                
                .axyra-modal-close {
                  background: none;
                  border: none;
                  color: white;
                  font-size: 24px;
                  cursor: pointer;
                  padding: 0;
                  width: 32px;
                  height: 32px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 50%;
                  transition: background-color 0.2s ease;
                }
                
                .axyra-modal-close:hover {
                  background: rgba(255, 255, 255, 0.2);
                }
                
                .axyra-modal-body {
                  padding: 20px;
                }
                
                .axyra-modal-footer {
                  padding: 20px;
                  border-top: 1px solid #e2e8f0;
                  display: flex;
                  justify-content: flex-end;
                  gap: 10px;
                }
                
                .axyra-form-group {
                  margin-bottom: 20px;
                }
                
                .axyra-form-group label {
                  display: block;
                  margin-bottom: 8px;
                  font-weight: 600;
                  color: #374151;
                }
                
                .axyra-form-control {
                  width: 100%;
                  padding: 12px 15px;
                  border: 2px solid #e9ecef;
                  border-radius: 8px;
                  font-size: 14px;
                  transition: border-color 0.2s ease;
                  box-sizing: border-box;
                }
                
                .axyra-form-control:focus {
                  outline: none;
                  border-color: #007bff;
                  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
                }
                
                .axyra-btn {
                  padding: 10px 20px;
                  border: none;
                  border-radius: 6px;
                  font-size: 14px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  text-decoration: none;
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                }
                
                .axyra-btn-primary {
                  background: linear-gradient(135deg, #007bff, #0056b3);
                  color: white;
                }
                
                .axyra-btn-primary:hover {
                  background: linear-gradient(135deg, #0056b3, #004085);
                  transform: translateY(-1px);
                  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
                }
                
                .axyra-btn-secondary {
                  background: #6c757d;
                  color: white;
                }
                
                .axyra-btn-secondary:hover {
                  background: #5a6268;
                  transform: translateY(-1px);
                }
              `;
              document.head.appendChild(styles);
            }
          } catch (error) {
            console.error('❌ Error mostrando modal:', error);
            alert('Error mostrando modal: ' + error.message);
          }
        }

        cerrarModalGenerarNomina() {
          const modal = document.getElementById('modalGenerarNomina');
          if (modal) {
            modal.remove();
          }
        }

        cargarEmpleadosEnSelect() {
          try {
            const select = document.getElementById('empleadoSelect');
            if (select) {
              select.innerHTML = '<option value="">Seleccione un empleado...</option>';
              this.empleados.forEach((emp) => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.nombre} - ${emp.cargo}`;
                select.appendChild(option);
              });
            }
          } catch (error) {
            console.error('❌ Error cargando empleados:', error);
          }
        }

        generarNominaEmpleado() {
          try {
            const empleadoId = document.getElementById('empleadoSelect').value;
            const mes = document.getElementById('mesNomina').value;
            const horasTrabajadas = parseFloat(document.getElementById('horasTrabajadas').value) || 0;
            const horasExtras = parseFloat(document.getElementById('horasExtras').value) || 0;

            if (!empleadoId) {
              alert('Por favor seleccione un empleado');
              return;
            }

            if (!mes) {
              alert('Por favor seleccione un mes');
              return;
            }

            if (horasTrabajadas <= 0) {
              alert('Por favor ingrese las horas trabajadas');
              return;
            }

            // Obtener empleado
            const empleado = this.empleados.find((emp) => emp.id === empleadoId);

            if (!empleado) {
              alert('Empleado no encontrado');
              return;
            }

            // Calcular nómina
            const salarioBase = parseFloat(empleado.salario) || 0;
            const valorHora = salarioBase / 240; // 240 horas mensuales
            const subtotal = horasTrabajadas * valorHora;
            const horasExtrasValor = horasExtras * (valorHora * 1.5); // 1.5x por horas extras
            const totalBruto = subtotal + horasExtrasValor;

            // Descuentos (solo para empleados fijos)
            const tipoContrato = empleado.tipoContrato || 'FIJO';
            const salud = tipoContrato === 'FIJO' ? totalBruto * 0.04 : 0;
            const pension = tipoContrato === 'FIJO' ? totalBruto * 0.04 : 0;
            const totalDescuentos = salud + pension;
            const netoAPagar = totalBruto - totalDescuentos;

            // Crear nómina
            const nomina = {
              id: Date.now().toString(),
              empleado_id: empleadoId,
              empleado_nombre: empleado.nombre,
              mes: mes,
              horas_trabajadas: horasTrabajadas,
              horas_extras: horasExtras,
              salario_base: salarioBase,
              valor_hora: valorHora,
              subtotal: subtotal,
              horas_extras_valor: horasExtrasValor,
              total_bruto: totalBruto,
              salud: salud,
              pension: pension,
              total_descuentos: totalDescuentos,
              salario_final: netoAPagar,
              estado: 'GENERADA',
              fecha_generacion: new Date().toISOString(),
            };

            // Guardar nómina
            this.nominas.push(nomina);
            localStorage.setItem('axyra_nominas', JSON.stringify(this.nominas));

            alert(
              `✅ Nómina generada correctamente\n\nEmpleado: ${
                empleado.nombre
              }\nTotal a Pagar: $${netoAPagar.toLocaleString()}`
            );
            this.cerrarModalGenerarNomina();

            // Recargar la página para mostrar la nueva nómina
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            console.error('❌ Error generando nómina:', error);
            alert('Error generando nómina: ' + error.message);
          }
        }

        generarPDFSimple() {
          try {
            if (this.nominas.length === 0) {
              this.mostrarModalError(
                'No hay nóminas para generar PDF',
                'No se pueden generar PDFs sin datos de nómina disponibles.'
              );
              return;
            }

            // Crear modal de confirmación para PDF
            const modal = document.createElement('div');
            modal.className = 'axyra-modal-overlay';
            modal.id = 'modalPDF';

            modal.innerHTML = `
              <div class="axyra-modal-content axyra-modal-large">
                <div class="axyra-modal-header">
                  <h3><i class="fas fa-file-pdf"></i> Generar PDF de Nómina</h3>
                  <button class="axyra-modal-close" onclick="nominaManager.cerrarModal('modalPDF')">×</button>
                </div>
                <div class="axyra-modal-body">
                  <div class="axyra-pdf-preview">
                    <div class="axyra-pdf-header">
                      <h4>📋 VILLA VENECIA - Reporte de Nómina</h4>
                      <p>📅 Fecha: ${new Date().toLocaleDateString()}</p>
                      <p>👥 Total Empleados: ${this.empleados.length}</p>
                      <p>📊 Total Nóminas: ${this.nominas.length}</p>
                    </div>
                    
                    <div class="axyra-pdf-table">
                      <table>
                        <thead>
                          <tr>
                            <th>Empleado</th>
                            <th>Cargo</th>
                            <th>Horas</th>
                            <th>Salario Base</th>
                            <th>Total a Pagar</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${this.nominas
                            .slice(0, 5)
                            .map((n) => {
                              const emp = this.empleados.find((e) => e.id === n.empleado_id);
                              return `
                              <tr>
                                <td>${emp ? emp.nombre : 'N/A'}</td>
                                <td>${emp ? emp.cargo : 'N/A'}</td>
                                <td>${n.horas_trabajadas}</td>
                                <td>$${n.salario_base?.toLocaleString() || '0'}</td>
                                <td>$${n.salario_final?.toLocaleString() || '0'}</td>
                              </tr>
                            `;
                            })
                            .join('')}
                          ${
                            this.nominas.length > 5
                              ? `<tr><td colspan="5" class="axyra-pdf-more">... y ${
                                  this.nominas.length - 5
                                } nóminas más</td></tr>`
                              : ''
                          }
                        </tbody>
                      </table>
                    </div>
                    
                    <div class="axyra-pdf-summary">
                      <div class="axyra-pdf-total">
                        <strong>💰 Total a Pagar: $${this.nominas
                          .reduce((sum, n) => sum + (n.salario_final || 0), 0)
                          .toLocaleString()}</strong>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="axyra-modal-footer">
                  <button class="axyra-btn axyra-btn-secondary" onclick="nominaManager.cerrarModal('modalPDF')">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                  <button class="axyra-btn axyra-btn-success" onclick="nominaManager.confirmarGenerarPDF()">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                  </button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);
            this.agregarEstilosModales();
          } catch (error) {
            console.error('Error generando PDF:', error);
            this.mostrarModalError('Error generando PDF', error.message);
          }
        }

        confirmarGenerarPDF() {
          try {
            // Crear contenido del PDF
            const contenido = `
              <html>
                <head>
                  <title>Nómina Villa Venecia</title>
                  <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
                    .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    .table th { background-color: #f2f2f2; }
                    .total { font-weight: bold; margin-top: 20px; }
                  </style>
                </head>
                <body>
                  <div class="header">
                    <h1>VILLA VENECIA</h1>
                    <h2>Reporte de Nómina</h2>
                    <p>Fecha: ${new Date().toLocaleDateString()}</p>
                  </div>

                  <table class="table">
                    <thead>
                      <tr>
                        <th>Empleado</th>
                        <th>Cargo</th>
                        <th>Horas</th>
                        <th>Salario Base</th>
                        <th>Total a Pagar</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${this.nominas
                        .map((n) => {
                          const emp = this.empleados.find((e) => e.id === n.empleado_id);
                          return `
                          <tr>
                            <td>${emp ? emp.nombre : 'N/A'}</td>
                            <td>${emp ? emp.cargo : 'N/A'}</td>
                            <td>${n.horas_trabajadas}</td>
                            <td>$${n.salario_base?.toLocaleString() || '0'}</td>
                            <td>$${n.salario_final?.toLocaleString() || '0'}</td>
                          </tr>
                        `;
                        })
                        .join('')}
                    </tbody>
                  </table>

                  <div class="total">
                    <p>Total Nóminas: ${this.nominas.length}</p>
                    <p>Total a Pagar: $${this.nominas
                      .reduce((sum, n) => sum + (n.salario_final || 0), 0)
                      .toLocaleString()}</p>
                  </div>
                </body>
              </html>
            `;

            // Abrir en nueva ventana para imprimir
            const ventana = window.open('', '_blank');
            ventana.document.write(contenido);
            ventana.document.close();

            // Auto-imprimir después de cargar
            setTimeout(() => {
              ventana.print();
            }, 500);

            // Cerrar modal y mostrar confirmación
            this.cerrarModal('modalPDF');
            this.mostrarModalExito(
              'PDF Generado',
              'El PDF se ha generado correctamente y se abrirá en una nueva ventana para imprimir.'
            );
          } catch (error) {
            console.error('Error generando PDF:', error);
            this.mostrarModalError('Error generando PDF', error.message);
          }
        }

        exportarNominaSimple() {
          try {
            if (this.nominas.length === 0) {
              this.mostrarModalError(
                'No hay nóminas para exportar',
                'No se pueden exportar datos sin nóminas disponibles en el sistema.'
              );
              return;
            }

            // Mostrar modal de confirmación de exportación
            this.mostrarModalExportacion();
          } catch (error) {
            console.error('Error exportando:', error);
            this.mostrarModalError(
              'Error al exportar',
              'Se produjo un error inesperado durante la exportación: ' + error.message
            );
          }
        }

        mostrarModalExportacion() {
          const modal = document.createElement('div');
          modal.className = 'axyra-modal-overlay';
          modal.id = 'modalExportacion';

          modal.innerHTML = `
            <div class="axyra-modal-content axyra-modal-medium">
              <div class="axyra-modal-header">
                <h3><i class="fas fa-download"></i> Exportar Nómina a Excel</h3>
                <button class="axyra-modal-close" onclick="nominaManager.cerrarModal('modalExportacion')">×</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-exportacion-info">
                  <div class="axyra-info-card">
                    <i class="fas fa-info-circle"></i>
                    <h4>Información de Exportación</h4>
                    <p>Se exportarán <strong>${this.nominas.length} nómina(s)</strong> con todos los detalles de empleados, salarios y estados.</p>
                  </div>
                  
                  <div class="axyra-exportacion-options">
                    <h4>Opciones de Exportación</h4>
                    <div class="axyra-form-group">
                      <label>
                        <input type="checkbox" id="incluirDetalles" checked>
                        Incluir detalles completos de empleados
                      </label>
                    </div>
                    <div class="axyra-form-group">
                      <label>
                        <input type="checkbox" id="incluirCalculos" checked>
                        Incluir cálculos de salarios y deducciones
                      </label>
                    </div>
                    <div class="axyra-form-group">
                      <label>
                        <input type="checkbox" id="incluirResumen" checked>
                        Incluir resumen ejecutivo
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-secondary" onclick="nominaManager.cerrarModal('modalExportacion')">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="axyra-btn axyra-btn-primary" onclick="nominaManager.ejecutarExportacion()">
                  <i class="fas fa-download"></i> Exportar Ahora
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        }

        ejecutarExportacion() {
          try {
            // Obtener opciones seleccionadas
            const incluirDetalles = document.getElementById('incluirDetalles').checked;
            const incluirCalculos = document.getElementById('incluirCalculos').checked;
            const incluirResumen = document.getElementById('incluirResumen').checked;

            // Crear datos para Excel según las opciones seleccionadas
            const datosExcel = this.prepararDatosExcel(incluirDetalles, incluirCalculos, incluirResumen);

            // Crear y descargar Excel
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Nómina');

            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Nómina_Villa_Venecia_${fecha}.xlsx`;
            XLSX.writeFile(workbook, nombreArchivo);

            // Cerrar modal y mostrar confirmación
            this.cerrarModal('modalExportacion');
            this.mostrarModalExito(
              'Exportación Completada',
              `✅ La nómina se exportó correctamente como "${nombreArchivo}"<br><br>El archivo se descargó automáticamente a tu carpeta de descargas.`
            );
          } catch (error) {
            console.error('Error ejecutando exportación:', error);
            this.mostrarModalError(
              'Error en Exportación',
              'Se produjo un error durante la exportación: ' + error.message
            );
          }
        }

        prepararDatosExcel(incluirDetalles, incluirCalculos, incluirResumen) {
          const datosExcel = [];

          // Encabezado principal
          datosExcel.push(['VILLA VENECIA - SISTEMA DE NÓMINA']);
          datosExcel.push([
            `Fecha de Exportación: ${new Date().toLocaleDateString('es-ES', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}`,
          ]);
          datosExcel.push(['Hora de Exportación: ' + new Date().toLocaleTimeString('es-ES')]);
          datosExcel.push(['']);

          if (incluirResumen) {
            datosExcel.push(['📊 RESUMEN EJECUTIVO']);
            datosExcel.push(['Total Empleados', this.empleados.length]);
            datosExcel.push(['Total Nóminas', this.nominas.length]);
            datosExcel.push(['Total Salarios', `$${this.calcularTotalSalarios().toLocaleString()}`]);
            datosExcel.push(['']);
          }

          // Datos principales de nóminas
          datosExcel.push(['📋 DETALLE DE NÓMINAS']);
          datosExcel.push([
            'ID',
            'Empleado',
            'Cargo',
            'Departamento',
            'Salario Base',
            'Salario Final',
            'Estado',
            'Fecha',
          ]);

          this.nominas.forEach((nomina) => {
            const empleado = this.empleados.find((emp) => emp.id === nomina.empleado_id);
            if (empleado) {
              const fila = [
                nomina.id || 'N/A',
                empleado.nombre || 'N/A',
                empleado.cargo || 'N/A',
                empleado.departamento || 'N/A',
                `$${(empleado.salario || 0).toLocaleString()}`,
                `$${(nomina.salario_final || 0).toLocaleString()}`,
                nomina.estado || 'N/A',
                nomina.fecha || 'N/A',
              ];

              if (incluirCalculos) {
                fila.push(`$${(nomina.deducciones || 0).toLocaleString()}`);
                fila.push(`$${(nomina.bonificaciones || 0).toLocaleString()}`);
              }

              datosExcel.push(fila);
            }
          });

          if (incluirDetalles) {
            datosExcel.push(['']);
            datosExcel.push(['👥 DETALLE DE EMPLEADOS']);
            datosExcel.push(['ID', 'Nombre', 'Cargo', 'Departamento', 'Salario Base', 'Estado', 'Fecha Ingreso']);

            this.empleados.forEach((empleado) => {
              datosExcel.push([
                empleado.id || 'N/A',
                empleado.nombre || 'N/A',
                empleado.cargo || 'N/A',
                empleado.departamento || 'N/A',
                `$${(empleado.salario || 0).toLocaleString()}`,
                empleado.estado || 'N/A',
                empleado.fechaIngreso || 'N/A',
              ]);
            });
          }

          return datosExcel;
        }

        calcularTotalSalarios() {
          return this.nominas.reduce((total, nomina) => total + (nomina.salario_final || 0), 0);
        }

        generarReporteSimple() {
          try {
            if (this.nominas.length === 0) {
              this.mostrarModalError(
                'No hay datos para generar reporte',
                'No se pueden generar reportes sin datos de nómina disponibles.'
              );
              return;
            }

            // Crear modal de reporte profesional
            const modal = document.createElement('div');
            modal.className = 'axyra-modal-overlay';
            modal.id = 'modalReporte';

            modal.innerHTML = `
              <div class="axyra-modal-content axyra-modal-large">
                <div class="axyra-modal-header">
                  <h3><i class="fas fa-chart-bar"></i> Reporte de Nómina - Villa Venecia</h3>
                  <button class="axyra-modal-close" onclick="nominaManager.cerrarModal('modalReporte')">×</button>
                </div>
                <div class="axyra-modal-body">
                  <div class="axyra-reporte-container">
                    <div class="axyra-reporte-header">
                      <div class="axyra-reporte-logo">
                        <i class="fas fa-building"></i>
                        <h4>VILLA VENECIA</h4>
                      </div>
                      <div class="axyra-reporte-fecha">
                        <p><strong>📅 Fecha del Reporte:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>⏰ Hora:</strong> ${new Date().toLocaleTimeString()}</p>
                      </div>
                    </div>
                    
                    <div class="axyra-reporte-stats">
                      <div class="axyra-stat-card">
                        <div class="axyra-stat-icon">
                          <i class="fas fa-users"></i>
                        </div>
                        <div class="axyra-stat-content">
                          <div class="axyra-stat-value">${this.empleados.length}</div>
                          <div class="axyra-stat-label">Total Empleados</div>
                        </div>
                      </div>
                      
                      <div class="axyra-stat-card">
                        <div class="axyra-stat-icon">
                          <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="axyra-stat-content">
                          <div class="axyra-stat-value">${this.nominas.length}</div>
                          <div class="axyra-stat-label">Total Nóminas</div>
                        </div>
                      </div>
                      
                      <div class="axyra-stat-card">
                        <div class="axyra-stat-icon">
                          <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="axyra-stat-content">
                          <div class="axyra-stat-value">$${this.nominas
                            .reduce((sum, n) => sum + (n.salario_final || 0), 0)
                            .toLocaleString()}</div>
                          <div class="axyra-stat-label">Total Salarios</div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="axyra-reporte-detalle">
                      <h5><i class="fas fa-list"></i> Detalle de Nóminas</h5>
                      <div class="axyra-reporte-table">
                        <table>
                          <thead>
                            <tr>
                              <th>Empleado</th>
                              <th>Cargo</th>
                              <th>Horas</th>
                              <th>Salario Final</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${this.nominas
                              .slice(0, 10)
                              .map((n) => {
                                const emp = this.empleados.find((e) => e.id === n.empleado_id);
                                return `
                                <tr>
                                  <td>${emp ? emp.nombre : 'N/A'}</td>
                                  <td>${emp ? emp.cargo : 'N/A'}</td>
                                  <td>${n.horas_trabajadas}</td>
                                  <td>$${(n.salario_final || 0).toLocaleString()}</td>
                                </tr>
                              `;
                              })
                              .join('')}
                            ${
                              this.nominas.length > 10
                                ? `<tr><td colspan="4" class="axyra-reporte-more">... y ${
                                    this.nominas.length - 10
                                  } nóminas más</td></tr>`
                                : ''
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="axyra-modal-footer">
                  <button class="axyra-btn axyra-btn-secondary" onclick="nominaManager.cerrarModal('modalReporte')">
                    <i class="fas fa-times"></i> Cerrar
                  </button>
                  <button class="axyra-btn axyra-btn-warning" onclick="nominaManager.imprimirReporte()">
                    <i class="fas fa-print"></i> Imprimir
                  </button>
                  <button class="axyra-btn axyra-btn-success" onclick="nominaManager.exportarReporte()">
                    <i class="fas fa-download"></i> Exportar
                  </button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);
            this.agregarEstilosModales();
          } catch (error) {
            console.error('Error generando reporte:', error);
            this.mostrarModalError('Error generando reporte', error.message);
          }
        }

        imprimirReporte() {
          try {
            const reporte = `
              📊 REPORTE DE NÓMINA - VILLA VENECIA

              📅 Fecha: ${new Date().toLocaleDateString()}
              👥 Total Empleados: ${this.empleados.length}
              📋 Total Nóminas: ${this.nominas.length}
              💰 Total Salarios: $${this.nominas.reduce((sum, n) => sum + (n.salario_final || 0), 0).toLocaleString()}

              📋 DETALLE:
              ${this.nominas
                .map((n) => {
                  const emp = this.empleados.find((e) => e.id === n.empleado_id);
                  return `• ${emp ? emp.nombre : 'N/A'}: $${(n.salario_final || 0).toLocaleString()}`;
                })
                .join('\n')}
            `;

            const ventana = window.open('', '_blank');
            ventana.document.write(`
              <html>
                <head><title>Reporte Nómina</title></head>
                <body style="font-family: Arial; padding: 20px;">
                  <pre style="white-space: pre-wrap;">${reporte}</pre>
                  <br><button onclick="window.print()">🖨️ Imprimir</button>
                  <button onclick="window.close()">❌ Cerrar</button>
                </body>
              </html>
            `);
            ventana.document.close();

            setTimeout(() => ventana.print(), 500);
          } catch (error) {
            console.error('Error imprimiendo reporte:', error);
            this.mostrarModalError('Error imprimiendo reporte', error.message);
          }
        }

        exportarReporte() {
          try {
            const datosExcel = [
              ['VILLA VENECIA - REPORTE DE NÓMINA'],
              [`Fecha: ${new Date().toLocaleDateString()}`],
              [''],
              ['Empleado', 'Cargo', 'Horas Trabajadas', 'Salario Final', 'Estado'],
            ];

            this.nominas.forEach((nomina) => {
              const empleado = this.empleados.find((emp) => emp.id === nomina.empleado_id);
              if (empleado) {
                datosExcel.push([
                  empleado.nombre || 'N/A',
                  empleado.cargo || 'N/A',
                  nomina.horas_trabajadas || 0,
                  `$${(nomina.salario_final || 0).toLocaleString()}`,
                  nomina.estado || 'N/A',
                ]);
              }
            });

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Reporte Nómina');

            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Reporte_Nomina_${fecha}.xlsx`);

            this.mostrarModalExito('Reporte Exportado', 'El reporte se ha exportado a Excel correctamente.');
          } catch (error) {
            console.error('Error exportando reporte:', error);
            this.mostrarModalError('Error exportando reporte', error.message);
          }
        }

        mostrarConfiguracionSimple() {
          try {
            const modal = document.createElement('div');
            modal.className = 'axyra-modal-overlay';
            modal.id = 'modalConfiguracion';

            modal.innerHTML = `
              <div class="axyra-modal-content axyra-modal-medium">
                <div class="axyra-modal-header">
                  <h3><i class="fas fa-cog"></i> Configuración de Nómina</h3>
                  <button class="axyra-modal-close" onclick="nominaManager.cerrarModal('modalConfiguracion')">×</button>
                </div>
                <div class="axyra-modal-body">
                  <div class="axyra-config-container">
                    <div class="axyra-config-section">
                      <h5><i class="fas fa-dollar-sign"></i> Configuración Salarial</h5>
                      <div class="axyra-form-group">
                        <label for="salMin">
                          <i class="fas fa-coins"></i> Salario Mínimo Legal
                        </label>
                        <input type="number" id="salMin" class="axyra-form-control" placeholder="Ingrese el salario mínimo" min="0" step="1000">
                        <small class="axyra-form-help">Salario mínimo establecido por la ley colombiana</small>
                      </div>
                    </div>
                    
                    <div class="axyra-config-section">
                      <h5><i class="fas fa-percentage"></i> Porcentajes de Descuentos</h5>
                      <div class="axyra-form-row">
                        <div class="axyra-form-group">
                          <label for="cesantias">
                            <i class="fas fa-piggy-bank"></i> % Cesantías
                          </label>
                          <input type="number" id="cesantias" class="axyra-form-control" value="8.33" step="0.01" min="0" max="100">
                          <small class="axyra-form-help">Porcentaje para fondos de cesantías</small>
                        </div>
                        
                        <div class="axyra-form-group">
                          <label for="salud">
                            <i class="fas fa-heartbeat"></i> % Salud
                          </label>
                          <input type="number" id="salud" class="axyra-form-control" value="4" step="0.01" min="0" max="100">
                          <small class="axyra-form-help">Porcentaje para salud</small>
                        </div>
                      </div>
                      
                      <div class="axyra-form-row">
                        <div class="axyra-form-group">
                          <label for="pension">
                            <i class="fas fa-user-graduate"></i> % Pensión
                          </label>
                          <input type="number" id="pension" class="axyra-form-control" value="4" step="0.01" min="0" max="100">
                          <small class="axyra-form-help">Porcentaje para pensión</small>
                        </div>
                        
                        <div class="axyra-form-group">
                          <label for="riesgo">
                            <i class="fas fa-shield-alt"></i> % Riesgo Laboral
                          </label>
                          <input type="number" id="riesgo" class="axyra-form-control" value="0.522" step="0.001" min="0" max="10">
                          <small class="axyra-form-help">Porcentaje según nivel de riesgo</small>
                        </div>
                      </div>
                    </div>
                    
                    <div class="axyra-config-section">
                      <h5><i class="fas fa-clock"></i> Configuración de Horas</h5>
                      <div class="axyra-form-row">
                        <div class="axyra-form-group">
                          <label for="horasMes">
                            <i class="fas fa-calendar-alt"></i> Horas por Mes
                          </label>
                          <input type="number" id="horasMes" class="axyra-form-control" value="240" min="160" max="300">
                          <small class="axyra-form-help">Horas laborales estándar por mes</small>
                        </div>
                        
                        <div class="axyra-form-group">
                          <label for="horasExtras">
                            <i class="fas fa-plus-circle"></i> Factor Horas Extras
                          </label>
                          <input type="number" id="horasExtras" class="axyra-form-control" value="1.5" step="0.1" min="1" max="3">
                          <small class="axyra-form-help">Multiplicador para horas extras</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="axyra-modal-footer">
                  <button class="axyra-btn axyra-btn-secondary" onclick="nominaManager.cerrarModal('modalConfiguracion')">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                  <button class="axyra-btn axyra-btn-success" onclick="nominaManager.guardarConfigSimple()">
                    <i class="fas fa-save"></i> Guardar Configuración
                  </button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);
            this.agregarEstilosModales();
            this.cargarConfiguracionActual();
          } catch (error) {
            console.error('Error mostrando configuración:', error);
            this.mostrarModalError('Error mostrando configuración', error.message);
          }
        }

        cargarConfiguracionActual() {
          try {
            const config = this.configuracion;
            if (config.salarioMinimo) document.getElementById('salMin').value = config.salarioMinimo;
            if (config.cesantias) document.getElementById('cesantias').value = config.cesantias;
            if (config.salud) document.getElementById('salud').value = config.salud;
            if (config.pension) document.getElementById('pension').value = config.pension;
            if (config.riesgo) document.getElementById('riesgo').value = config.riesgo;
            if (config.horasMes) document.getElementById('horasMes').value = config.horasMes;
            if (config.horasExtras) document.getElementById('horasExtras').value = config.horasExtras;
          } catch (error) {
            console.error('Error cargando configuración:', error);
          }
        }

        guardarConfigSimple() {
          try {
            const config = {
              salarioMinimo: document.getElementById('salMin').value,
              cesantias: document.getElementById('cesantias').value,
              salud: document.getElementById('salud').value,
              pension: document.getElementById('pension').value,
              riesgo: document.getElementById('riesgo').value,
              horasMes: document.getElementById('horasMes').value,
              horasExtras: document.getElementById('horasExtras').value,
            };

            // Validar campos obligatorios
            if (!config.salarioMinimo || !config.cesantias || !config.salud || !config.pension) {
              this.mostrarModalError('Campos Requeridos', 'Por favor complete todos los campos obligatorios.');
              return;
            }

            // Guardar en localStorage
            localStorage.setItem('axyra_config_simple', JSON.stringify(config));

            // Actualizar configuración local
            this.configuracion = config;

            // Mostrar confirmación
            this.mostrarModalExito(
              'Configuración Guardada',
              'La configuración se ha guardado correctamente y se aplicará a todas las nóminas futuras.'
            );

            // Cerrar modal
            this.cerrarModal('modalConfiguracion');
          } catch (error) {
            console.error('Error guardando configuración:', error);
            this.mostrarModalError('Error Guardando Configuración', error.message);
          }
        }

        cerrarNotificacion(boton) {
          const notificacion = boton.closest('.axyra-notificacion');
          if (notificacion) {
            notificacion.remove();
          }
        }

        // ========================================
        // FUNCIONES AUXILIARES PARA MODALES
        // ========================================

        cerrarModal(modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.remove();
          }
        }

        mostrarModalError(titulo, mensaje) {
          const modal = document.createElement('div');
          modal.className = 'axyra-modal-overlay';
          modal.id = 'modalError';

          modal.innerHTML = `
            <div class="axyra-modal-content axyra-modal-small">
              <div class="axyra-modal-header axyra-modal-error">
                <h3><i class="fas fa-exclamation-triangle"></i> ${titulo}</h3>
                <button class="axyra-modal-close" onclick="nominaManager.cerrarModal('modalError')">×</button>
              </div>
              <div class="axyra-modal-body">
                <p>${mensaje}</p>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-danger" onclick="nominaManager.cerrarModal('modalError')">
                  <i class="fas fa-times"></i> Cerrar
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          this.agregarEstilosModales();
        }

        mostrarModalExito(titulo, mensaje) {
          const modal = document.createElement('div');
          modal.className = 'axyra-modal-overlay';
          modal.id = 'modalExito';

          modal.innerHTML = `
            <div class="axyra-modal-content axyra-modal-small">
              <div class="axyra-modal-header axyra-modal-success">
                <h3><i class="fas fa-check-circle"></i> ${titulo}</h3>
                <button class="axyra-modal-close" onclick="nominaManager.cerrarModal('modalExito')">×</button>
              </div>
              <div class="axyra-modal-body">
                <p>${mensaje}</p>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-success" onclick="nominaManager.cerrarModal('modalExito')">
                  <i class="fas fa-check"></i> Aceptar
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          this.agregarEstilosModales();
        }

        agregarEstilosModales() {
          if (!document.getElementById('modalStylesAvanzados')) {
            const styles = document.createElement('style');
            styles.id = 'modalStylesAvanzados';
            styles.textContent = `
              /* Estilos para modales avanzados */
              .axyra-modal-large {
                max-width: 800px !important;
                width: 90% !important;
              }
              
              .axyra-modal-medium {
                max-width: 600px !important;
                width: 90% !important;
              }
              
              .axyra-modal-small {
                max-width: 400px !important;
                width: 90% !important;
              }
              
              /* Estilos para modal de configuración */
              .axyra-config-container {
                max-height: 70vh;
                overflow-y: auto;
              }
              
              .axyra-config-section {
                margin-bottom: 25px;
                padding: 20px;
                background: #f8fafc;
                border-radius: 12px;
                border: 1px solid #e2e8f0;
              }
              
              .axyra-config-section h5 {
                color: #1e3a8a;
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                font-weight: 600;
                border-bottom: 2px solid #cbd5e1;
                padding-bottom: 8px;
              }
              
              .axyra-form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-bottom: 15px;
              }
              
              .axyra-form-help {
                display: block;
                margin-top: 5px;
                font-size: 0.8rem;
                color: #64748b;
                font-style: italic;
              }
              
              /* Estilos para modal de PDF */
              .axyra-pdf-preview {
                background: #f8fafc;
                border-radius: 12px;
                padding: 20px;
                border: 1px solid #e2e8f0;
              }
              
              .axyra-pdf-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #cbd5e1;
              }
              
              .axyra-pdf-header h4 {
                color: #1e3a8a;
                margin: 0 0 10px 0;
                font-size: 1.2rem;
              }
              
              .axyra-pdf-table {
                margin: 20px 0;
                overflow-x: auto;
              }
              
              .axyra-pdf-table table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              }
              
              .axyra-pdf-table th {
                background: #1e3a8a;
                color: white;
                padding: 12px;
                text-align: left;
                font-weight: 600;
              }
              
              .axyra-pdf-table td {
                padding: 10px 12px;
                border-bottom: 1px solid #e2e8f0;
              }
              
              .axyra-pdf-table tr:hover {
                background: #f1f5f9;
              }
              
              .axyra-pdf-more {
                text-align: center;
                color: #64748b;
                font-style: italic;
                background: #f8fafc;
              }
              
              .axyra-pdf-summary {
                text-align: center;
                margin-top: 20px;
                padding: 15px;
                background: #1e3a8a;
                color: white;
                border-radius: 8px;
              }
              
              /* Estilos para modal de reporte */
              .axyra-reporte-container {
                max-height: 70vh;
                overflow-y: auto;
              }
              
              .axyra-reporte-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 12px;
              }
              
              .axyra-reporte-logo h4 {
                margin: 0;
                font-size: 1.3rem;
                font-weight: 700;
              }
              
              .axyra-reporte-fecha p {
                margin: 5px 0;
                font-size: 0.9rem;
              }
              
              .axyra-reporte-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 25px;
              }
              
              .axyra-stat-card {
                background: white;
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                border: 1px solid #e2e8f0;
              }
              
              .axyra-stat-icon {
                font-size: 2rem;
                color: #667eea;
                margin-bottom: 10px;
              }
              
              .axyra-stat-value {
                font-size: 1.5rem;
                font-weight: 700;
                color: #1e3a8a;
                margin-bottom: 5px;
              }
              
              .axyra-stat-label {
                font-size: 0.9rem;
                color: #64748b;
                font-weight: 500;
              }
              
              .axyra-reporte-detalle {
                background: white;
                border-radius: 12px;
                padding: 20px;
                border: 1px solid #e2e8f0;
              }
              
              .axyra-reporte-detalle h5 {
                color: #1e3a8a;
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                font-weight: 600;
                border-bottom: 2px solid #cbd5e1;
                padding-bottom: 8px;
              }
              
              .axyra-reporte-table {
                overflow-x: auto;
              }
              
              .axyra-reporte-table table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              }
              
              .axyra-reporte-table th {
                background: #f8fafc;
                color: #1e3a8a;
                padding: 12px;
                text-align: left;
                font-weight: 600;
                border-bottom: 2px solid #e2e8f0;
              }
              
              .axyra-reporte-table td {
                padding: 10px 12px;
                border-bottom: 1px solid #f1f5f9;
              }
              
              .axyra-reporte-table tr:hover {
                background: #f8fafc;
              }
              
              .axyra-reporte-more {
                text-align: center;
                color: #64748b;
                font-style: italic;
                background: #f8fafc;
              }
              
              /* Estilos para headers de modal con colores */
              .axyra-modal-error .axyra-modal-header {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              }
              
              .axyra-modal-success .axyra-modal-header {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
              }
              
              /* Responsive para modales */
              @media (max-width: 768px) {
                .axyra-form-row {
                  grid-template-columns: 1fr;
                }
                
                .axyra-reporte-stats {
                  grid-template-columns: 1fr;
                }
                
                .axyra-reporte-header {
                  flex-direction: column;
                  text-align: center;
                  gap: 15px;
                }
              }
            `;
            document.head.appendChild(styles);
          }
        }
      }

      // ========================================
      // INICIALIZACIÓN DEL SISTEMA
      // ========================================

      // Crear instancia global del manager
      let nominaManager;

      // Inicializar cuando el DOM esté listo
      document.addEventListener('DOMContentLoaded', function () {
        try {
          nominaManager = new NominaManager();

          // Hacer funciones globales para compatibilidad
          window.mostrarModalGenerarNomina = () => nominaManager.mostrarModalGenerarNomina();
          window.cerrarModalGenerarNomina = () => nominaManager.cerrarModalGenerarNomina();
          window.generarNominaEmpleado = () => nominaManager.generarNominaEmpleado();
          window.cargarEmpleadosEnSelect = () => nominaManager.cargarEmpleadosEnSelect();
          window.generarPDFSimple = () => nominaManager.generarPDFSimple();
          window.exportarNominaSimple = () => nominaManager.exportarNominaSimple();
          window.generarReporteSimple = () => nominaManager.generarReporteSimple();
          window.mostrarConfiguracionSimple = () => nominaManager.mostrarConfiguracionSimple();
          window.guardarConfigSimple = () => nominaManager.guardarConfigSimple();
          window.cerrarNotificacion = (boton) => nominaManager.cerrarNotificacion(boton);

          // Nuevas funciones para modales
          window.cerrarModal = (modalId) => nominaManager.cerrarModal(modalId);
          window.confirmarGenerarPDF = () => nominaManager.confirmarGenerarPDF();
          window.imprimirReporte = () => nominaManager.imprimirReporte();
          window.exportarReporte = () => nominaManager.exportarReporte();

          console.log('✅ Sistema de nómina AXYRA inicializado correctamente');
        } catch (error) {
          console.error('❌ Error inicializando sistema de nómina:', error);
        }
      });
    </script>
    
    <!-- Chat de IA AXYRA - Cargar al final -->
    <script src="../../static/axyra-ai-global.js"></script>
  </body>
</html>
