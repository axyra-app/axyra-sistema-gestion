<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gesti√≥n de N√≥mina</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>
    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
    <script src="../../static/excel-export.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="axyra-header">
      <div class="axyra-header-content">
        <div class="axyra-logo">
          <div class="axyra-logo-icon">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <div class="axyra-logo-text">
            <div class="axyra-logo-title">AXYRA</div>
            <div class="axyra-logo-subtitle">Gesti√≥n de N√≥mina</div>
          </div>
        </div>
        <nav class="axyra-nav">
          <a href="../../index.html" class="axyra-nav-link"> <i class="fas fa-home"></i> Inicio </a>
          <a href="../dashboard/dashboard.html" class="axyra-nav-link">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
          <a href="../empleados/empleados.html" class="axyra-nav-link"> <i class="fas fa-users"></i> Empleados </a>
          <a href="../horas/gestionar_horas.html" class="axyra-nav-link"> <i class="fas fa-clock"></i> Horas </a>
          <a href="gestionar_nomina.html" class="axyra-nav-link active">
            <i class="fas fa-file-invoice-dollar"></i> N√≥mina
          </a>
          <a href="../cuadre_caja/cuadre_caja.html" class="axyra-nav-link">
            <i class="fas fa-calculator"></i> Cuadre de Caja
          </a>
          <a href="../configuracion/configuracion.html" class="axyra-nav-link">
            <i class="fas fa-cog"></i> Configuraci√≥n
          </a>
          <button class="axyra-btn axyra-btn-ghost" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
          </button>
        </nav>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gesti√≥n de N√≥mina</h1>
          <p class="axyra-page-subtitle">Calcula n√≥minas, genera comprobantes y administra los pagos de tu empresa</p>
        </div>

        <!-- Per√≠odo de N√≥mina -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-calendar"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Per√≠odo de N√≥mina</h3>
              <p class="axyra-card-subtitle">Define el per√≠odo para generar comprobantes</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <form id="formPeriodoNomina" class="axyra-form">
              <div class="axyra-form-grid">
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Fecha de Inicio</label>
                  <input type="date" id="fechaInicio" class="axyra-form-input" required />
                </div>
                <div class="axyra-form-group">
                  <label class="axyra-form-label">Fecha de Fin</label>
                  <input type="date" id="fechaFin" class="axyra-form-input" required />
                </div>
              </div>
              <div class="axyra-form-actions">
                <button type="submit" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-calculator"></i> Generar Comprobantes
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Empleados para N√≥mina -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Empleados para N√≥mina</h3>
              <p class="axyra-card-subtitle">Selecciona los empleados a incluir en la n√≥mina</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-actions-bar">
              <button class="axyra-btn axyra-btn-success" onclick="seleccionarTodos()">
                <i class="fas fa-check-square"></i> Seleccionar Todos
              </button>
              <button class="axyra-btn axyra-btn-warning" onclick="deseleccionarTodos()">
                <i class="fas fa-square"></i> Deseleccionar Todos
              </button>
              <button class="axyra-btn axyra-btn-info" onclick="generarComprobantes()">
                <i class="fas fa-file-invoice-dollar"></i> Generar Comprobantes
              </button>
            </div>

            <div class="axyra-table-container">
              <table class="axyra-table" id="empleadosNominaTable">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()" /></th>
                    <th>Nombre</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Salario Base</th>
                    <th>Horas Trabajadas</th>
                    <th>Salario Neto</th>
                  </tr>
                </thead>
                <tbody id="empleadosNominaTableBody">
                  <!-- Los empleados se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Resumen de N√≥mina -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Resumen de N√≥mina</h3>
              <p class="axyra-card-subtitle">Totales y estad√≠sticas del per√≠odo</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <div class="axyra-stats-grid">
              <div class="axyra-stat-card">
                <div class="axyra-stat-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="axyra-stat-number" id="totalEmpleadosNomina">0</div>
                <div class="axyra-stat-label">Empleados</div>
              </div>
              <div class="axyra-stat-card">
                <div class="axyra-stat-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="axyra-stat-number" id="totalSalariosNomina">$0</div>
                <div class="axyra-stat-label">Total Salarios</div>
              </div>
              <div class="axyra-stat-card">
                <div class="axyra-stat-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="axyra-stat-number" id="totalHorasNomina">0</div>
                <div class="axyra-stat-label">Total Horas</div>
              </div>
              <div class="axyra-stat-card">
                <div class="axyra-stat-icon">
                  <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <div class="axyra-stat-number" id="totalComprobantes">0</div>
                <div class="axyra-stat-label">Comprobantes</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Historial de N√≥minas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-history"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Historial de N√≥minas</h3>
              <p class="axyra-card-subtitle">N√≥minas generadas anteriormente</p>
            </div>
          </div>

          <!-- Resumen de N√≥minas -->
          <div class="axyra-nomina-summary">
            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="totalNominasGeneradas">0</div>
                <div class="axyra-summary-label">Total N√≥minas</div>
              </div>
            </div>
            
            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="totalSalariosPagados">$0</div>
                <div class="axyra-summary-label">Total Salarios</div>
              </div>
            </div>
            
            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="empleadosPagados">0</div>
                <div class="axyra-summary-label">Empleados Pagados</div>
              </div>
            </div>
            
            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="ultimaNomina">-</div>
                <div class="axyra-summary-label">√öltima N√≥mina</div>
              </div>
            </div>
          </div>

          <!-- Filtros Mejorados -->
          <div class="axyra-filters-enhanced">
            <div class="axyra-search-box">
              <input type="text" id="searchNomina" class="axyra-form-input" placeholder="Buscar por per√≠odo o empleado..." />
              <i class="fas fa-search"></i>
            </div>
            <div class="axyra-filter-group">
              <select id="filterPeriodoNomina" class="axyra-form-select">
                <option value="">Todos los per√≠odos</option>
                <option value="enero">Enero 2025</option>
                <option value="febrero">Febrero 2025</option>
                <option value="marzo">Marzo 2025</option>
                <option value="abril">Abril 2025</option>
                <option value="mayo">Mayo 2025</option>
                <option value="junio">Junio 2025</option>
              </select>
              <select id="filterEstadoNomina" class="axyra-form-select">
                <option value="">Todos los estados</option>
                <option value="pagado">Pagado</option>
                <option value="pendiente">Pendiente</option>
                <option value="anulado">Anulado</option>
              </select>
              <select id="filterDepartamentoNomina" class="axyra-form-select">
                <option value="">Todos los departamentos</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
                <option value="Ventas">Ventas</option>
                <option value="Producci√≥n">Producci√≥n</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
              </select>
            </div>
            <button class="axyra-btn axyra-btn-primary" onclick="exportarNomina()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>

          <div class="axyra-card-content">
            <div class="axyra-actions-bar">
              <button class="axyra-btn axyra-btn-warning" onclick="limpiarHistorial()">
                <i class="fas fa-trash"></i> Limpiar Historial
              </button>
            </div>

            <div class="axyra-table-container">
              <table class="axyra-table" id="historialNominaTable">
                <thead>
                  <tr>
                    <th>Per√≠odo</th>
                    <th>Fecha de Pago</th>
                    <th>Empleados</th>
                    <th>Total Salarios</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="historialNominaTableBody">
                  <!-- El historial se cargar√° din√°micamente -->
                </tbody>
              </table>
            </div>

            <!-- Paginaci√≥n -->
            <div class="axyra-pagination">
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaNomina(-1)">
                <i class="fas fa-chevron-left"></i> Anterior
              </button>
              <span id="paginaNominaInfo">P√°gina 1 de 1</span>
              <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaNomina(1)">
                Siguiente <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal Detalle de N√≥mina -->
    <div id="modalDetalleNomina" class="axyra-modal">
      <div class="axyra-modal-content">
        <div class="axyra-modal-header">
          <h3 class="axyra-modal-title">
            <i class="fas fa-file-invoice-dollar"></i> Detalle de N√≥mina
          </h3>
          <button class="axyra-modal-close" onclick="cerrarModalDetalleNomina()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="axyra-modal-body">
          <div class="axyra-modal-text">
            <p>üìã Esta funcionalidad est√° en desarrollo y estar√° disponible pr√≥ximamente.</p>
            <p>Podr√°s ver el desglose completo de la n√≥mina, incluyendo:</p>
            <ul>
              <li>Horas trabajadas por d√≠a</li>
              <li>Recargos aplicados</li>
              <li>Deducciones y bonificaciones</li>
              <li>Desglose del salario neto</li>
            </ul>
          </div>
        </div>
        <div class="axyra-modal-footer">
          <button class="axyra-btn axyra-btn-primary" onclick="cerrarModalDetalleNomina()">
            Entendido
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="axyra-footer">
      <div class="axyra-container">
        <div class="axyra-footer-content">
          <p>&copy; 2025 AXYRA. Sistema de Gesti√≥n Empresarial.</p>
        </div>
      </div>
    </footer>

    <script>
      // Verificar autenticaci√≥n
      async function checkAuth() {
        try {
          console.log('üîê Verificando autenticaci√≥n en n√≥mina...');

          // Verificar sesi√≥n usando Firebase
          if (window.axyraFirebaseUserSystem && window.axyraFirebaseUserSystem.hasActiveSession()) {
            const currentUser = window.axyraFirebaseUserSystem.getCurrentUser();
            console.log('‚úÖ Usuario autenticado con Firebase en n√≥mina:', currentUser.email);
            return true;
          }

          // Verificar sesi√≥n usando localStorage como fallback
          const user = localStorage.getItem('axyra_isolated_user');
          if (user) {
            try {
              const userData = JSON.parse(user);
              if (userData && (userData.username || userData.email)) {
                console.log('‚úÖ Usuario autenticado con localStorage en n√≥mina:', userData.username || userData.email);
                return true;
              }
            } catch (error) {
              console.error('Error parseando sesi√≥n de localStorage:', error);
            }
          }

          // No hay sesi√≥n activa
          console.log('‚ö†Ô∏è No hay sesi√≥n activa en n√≥mina - mostrando mensaje');
          // NO redirigir autom√°ticamente
          return false;
        } catch (error) {
          console.error('‚ùå Error al verificar sesi√≥n en n√≥mina:', error);
          // NO redirigir autom√°ticamente
          return false;
        }
      }

      // Cerrar sesi√≥n - SISTEMA AISLADO
      function logout() {
        console.log('üîÑ Cerrando sesi√≥n desde gesti√≥n de n√≥mina...');
        
        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }
        
        console.log('‚úÖ Sesi√≥n cerrada desde gesti√≥n de n√≥mina');
        window.location.href = '../../login.html';
      }

      // Variables globales
      let empleados = [];
      let configuracion = {};
      let monedaActual = 'COP';
      let empleadosSeleccionados = new Set();

      // Inicializaci√≥n
      window.addEventListener('load', async () => {
        try {
          console.log('üöÄ AXYRA N√≥mina inicializando...');

          // Verificar autenticaci√≥n
          const isAuthenticated = await checkAuth();

          if (isAuthenticated) {
            console.log('‚úÖ Usuario autenticado, cargando n√≥mina...');

            // Cargar empleados
            await cargarEmpleados();

            // Cargar configuraci√≥n y historial
            cargarConfiguracion();
            cargarHistorial();
            establecerFechasPorDefecto();

            console.log('‚úÖ M√≥dulo de n√≥mina cargado correctamente');
          } else {
            console.log('‚ùå Usuario no autenticado, mostrando mensaje...');
            // NO redirigir autom√°ticamente
          }
        } catch (error) {
          console.error('‚ùå Error inicializando m√≥dulo de n√≥mina:', error);
          // NO redirigir autom√°ticamente
        }
      });

      // Cargar empleados
      async function cargarEmpleados() {
        try {
          console.log('üë• Cargando empleados para n√≥mina...');

          // Obtener usuario actual - SISTEMA AISLADO
          const userData = localStorage.getItem('axyra_isolated_user');
          if (!userData) {
            console.log('‚ö†Ô∏è No hay usuario autenticado en n√≥mina');
            empleados = [];
            mostrarEmpleadosNomina();
            actualizarResumen();
            return;
          }

          const currentUser = JSON.parse(userData);
          if (!currentUser || (!currentUser.username && !currentUser.email)) {
            console.log('‚ö†Ô∏è Usuario no v√°lido en n√≥mina');
            empleados = [];
            mostrarEmpleadosNomina();
            actualizarResumen();
            return;
          }

          console.log('‚úÖ Usuario actual en n√≥mina:', currentUser.username || currentUser.email);

          // Cargar empleados desde localStorage
          console.log('üíæ Cargando empleados desde localStorage para n√≥mina...');
          const empleadosGuardados = localStorage.getItem('axyra_empleados');

          if (!empleadosGuardados) {
            console.log('‚ÑπÔ∏è No hay empleados guardados en localStorage');
            empleados = [];
            mostrarEmpleadosNomina();
            actualizarResumen();
            return;
          }

          try {
            empleados = JSON.parse(empleadosGuardados);
            console.log('üë• Empleados totales en n√≥mina desde localStorage:', empleados.length);

            // Filtrar solo empleados activos
            const empleadosActivos = empleados.filter((emp) => emp.estado === 'Activo');
            console.log(
              `‚úÖ Empleados activos para n√≥mina: ${empleadosActivos.length}`
            );

            if (empleadosActivos.length > 0) {
              empleados = empleadosActivos;
            }
          } catch (error) {
            console.error('Error cargando empleados para n√≥mina:', error);
            empleados = [];
          }

          mostrarEmpleadosNomina();
          actualizarResumen();
        } catch (error) {
          console.error('‚ùå Error cargando empleados para n√≥mina:', error);
          empleados = [];
          mostrarEmpleadosNomina();
          actualizarResumen();
        }
      }

      // Mostrar empleados en tabla de n√≥mina
      function mostrarEmpleadosNomina() {
        const tbody = document.getElementById('empleadosNominaTableBody');
        if (empleados.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="axyra-text-center">No hay empleados registrados</td></tr>';
          return;
        }

        tbody.innerHTML = empleados
          .map((empleado) => {
            const horasTrabajadas = calcularHorasTrabajadas(empleado.id);
            const salarioNeto = calcularSalarioNeto(empleado.salario, horasTrabajadas);

            return `
            <tr>
              <td><input type="checkbox" value="${empleado.id}" onchange="toggleEmpleado('${empleado.id}')" /></td>
              <td>${empleado.nombre}</td>
              <td>${empleado.cargo}</td>
              <td>${empleado.departamento}</td>
              <td>${formatearMoneda(empleado.salario)}</td>
              <td>${horasTrabajadas}</td>
              <td>${formatearMoneda(salarioNeto)}</td>
            </tr>
          `;
          })
          .join('');
      }

      // Calcular horas trabajadas (real)
      function calcularHorasTrabajadas(empleadoId) {
        // Obtener horas registradas del empleado
        const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
        const horasEmpleado = horas.filter((h) => h.empleadoId === empleadoId);

        if (horasEmpleado.length === 0) {
          return 0; // Si no hay horas registradas, mostrar 0
        }

        // Calcular total de horas registradas
        let totalHoras = 0;
        horasEmpleado.forEach((registro) => {
          // Sumar todas las horas registradas
          totalHoras += parseFloat(registro.horasOrdinarias) || 0;
          totalHoras += parseFloat(registro.horasNocturnas) || 0;
          totalHoras += parseFloat(registro.horasExtraDiurnas) || 0;
          totalHoras += parseFloat(registro.horasExtraNocturnas) || 0;
          totalHoras += parseFloat(registro.horasDominicales) || 0;
          totalHoras += parseFloat(registro.horasFestivas) || 0;
          totalHoras += parseFloat(registro.horasDominicalesNocturnas) || 0;
          totalHoras += parseFloat(registro.horasFestivasNocturnas) || 0;
          totalHoras += parseFloat(registro.horasExtraDominicales) || 0;
          totalHoras += parseFloat(registro.horasExtraDominicalesNocturnas) || 0;
          totalHoras += parseFloat(registro.horasExtraFestivas) || 0;
          totalHoras += parseFloat(registro.horasExtraFestivasNocturnas) || 0;
        });

        return totalHoras;
      }

      // Calcular horas trabajadas en un per√≠odo espec√≠fico
      function calcularHorasTrabajadasPeriodo(empleadoId, fechaInicio, fechaFin) {
        // Obtener horas registradas del empleado en el per√≠odo
        const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
        const horasEmpleado = horas.filter(
          (h) => h.empleadoId === empleadoId && h.fecha >= fechaInicio && h.fecha <= fechaFin
        );

        if (horasEmpleado.length === 0) {
          // Si no hay horas registradas, mostrar 0
          return 0;
        }

        // Calcular total de horas del per√≠odo
        let totalHoras = 0;
        horasEmpleado.forEach((registro) => {
          const entrada = new Date(`2000-01-01T${registro.horaEntrada}`);
          const salida = new Date(`2000-01-01T${registro.horaSalida}`);

          if (salida <= entrada) {
            salida.setDate(salida.getDate() + 1);
          }

          const diferencia = salida - entrada;
          const horasDia = diferencia / (1000 * 60 * 60);
          totalHoras += horasDia;
        });

        return totalHoras;
      }

      // Calcular salario neto
      function calcularSalarioNeto(salarioBase, horasTrabajadas) {
        // Si no hay horas trabajadas, el salario neto es 0
        if (horasTrabajadas === 0) {
          return 0;
        }

        const horasEstandar = 160; // Horas est√°ndar por mes
        const salarioPorHora = salarioBase / horasEstandar;
        const salarioCalculado = salarioPorHora * horasTrabajadas;

        // Aplicar descuentos b√°sicos (simulado)
        const descuentos = salarioCalculado * 0.1; // 10% de descuentos

        return salarioCalculado - descuentos;
      }

      // Formatear moneda
      function formatearMoneda(monto) {
        const simbolos = { COP: '$', USD: '$', EUR: '‚Ç¨' };
        const simbolo = simbolos[monedaActual];
        return `${simbolo}${parseFloat(monto).toLocaleString('es-CO', {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1,
        })}`;
      }

      // Cambiar moneda
      function cambiarMoneda(moneda) {
        document.querySelectorAll('.axyra-currency-option').forEach((option) => {
          option.classList.remove('active');
        });

        // Encontrar la opci√≥n seleccionada y marcarla como activa
        const opcionSeleccionada = document.querySelector(`.axyra-currency-option[onclick*="${moneda}"]`);
        if (opcionSeleccionada) {
          opcionSeleccionada.classList.add('active');
        }

        monedaActual = moneda;
        localStorage.setItem('axyra_moneda', moneda);

        mostrarEmpleadosNomina();
        actualizarResumen();

        mostrarMensaje(`‚úÖ Moneda cambiada a ${moneda}`, 'success');
      }

      // Cargar configuraci√≥n
      function cargarConfiguracion() {
        configuracion = JSON.parse(localStorage.getItem('axyra_configuracion') || '{}');

        if (Object.keys(configuracion).length > 0) {
          document.getElementById('periodoNomina').value = configuracion.periodo || 'quincenal';
          document.getElementById('fechaInicio').value = configuracion.fechaInicio || '';
          document.getElementById('fechaFin').value = configuracion.fechaFin || '';
          document.getElementById('fechaPago').value = configuracion.fechaPago || '';
          document.getElementById('salarioMinimo').value = configuracion.salarioMinimo || '1300000';
          document.getElementById('auxilioTransporte').value = configuracion.auxilioTransporte || '162000';
        }
      }

      // Establecer fechas por defecto
      function establecerFechasPorDefecto() {
        const hoy = new Date();
        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
        const pago = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 15);

        if (!configuracion.fechaInicio) {
          document.getElementById('fechaInicio').value = inicioMes.toISOString().split('T')[0];
        }
        if (!configuracion.fechaFin) {
          document.getElementById('fechaFin').value = finMes.toISOString().split('T')[0];
        }
        if (!configuracion.fechaPago) {
          document.getElementById('fechaPago').value = pago.toISOString().split('T')[0];
        }
      }

      // Generar comprobantes por per√≠odo
      document.getElementById('formPeriodoNomina').addEventListener('submit', function (e) {
        e.preventDefault();

        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;

        if (!fechaInicio || !fechaFin) {
          mostrarMensaje('‚ùå Por favor completa ambas fechas', 'error');
          return;
        }

        if (new Date(fechaInicio) > new Date(fechaFin)) {
          mostrarMensaje('‚ùå La fecha de inicio no puede ser posterior a la fecha de fin', 'error');
          return;
        }

        // Generar comprobantes para el per√≠odo
        generarComprobantesPeriodo(fechaInicio, fechaFin);
      });

      // Validar salario m√≠nimo
      function validarSalarioMinimo(valor) {
        const salario = parseFloat(valor);
        if (isNaN(salario) || salario < 0) {
          mostrarMensaje('‚ùå El salario m√≠nimo debe ser un n√∫mero v√°lido mayor a 0', 'error');
          document.getElementById('salarioMinimo').value = '1300000';
          return false;
        }
        if (salario < 100000) {
          mostrarMensaje('‚ö†Ô∏è El salario m√≠nimo parece ser muy bajo para Colombia', 'warning');
        }
        return true;
      }

      // Formatear salario mientras se escribe
      function formatearSalario(input) {
        let valor = input.value.replace(/[^\d]/g, '');
        if (valor.length > 0) {
          valor = parseInt(valor).toLocaleString('es-CO');
          input.value = valor;
        }
      }

      // Calcular n√≥mina
      function calcularNomina() {
        if (empleadosSeleccionados.size === 0) {
          mostrarMensaje('‚ùå Selecciona al menos un empleado', 'warning');
          return;
        }

        mostrarMensaje('‚úÖ N√≥mina calculada correctamente', 'success');
        actualizarResumen();
      }

      // Seleccionar todos los empleados
      function seleccionarTodos() {
        empleados.forEach((empleado) => empleadosSeleccionados.add(empleado.id));
        document.getElementById('selectAll').checked = true;
        document.querySelectorAll('input[type="checkbox"]').forEach((cb) => (cb.checked = true));
        actualizarResumen();
      }

      // Deseleccionar todos los empleados
      function deseleccionarTodos() {
        empleadosSeleccionados.clear();
        document.getElementById('selectAll').checked = false;
        document.querySelectorAll('input[type="checkbox"]').forEach((cb) => (cb.checked = false));
        actualizarResumen();
      }

      // Toggle empleado individual
      function toggleEmpleado(empleadoId) {
        if (empleadosSeleccionados.has(empleadoId)) {
          empleadosSeleccionados.delete(empleadoId);
        } else {
          empleadosSeleccionados.add(empleadoId);
        }
        actualizarResumen();
      }

      // Toggle select all
      function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        if (selectAll.checked) {
          seleccionarTodos();
        } else {
          deseleccionarTodos();
        }
      }

      // Generar comprobantes por per√≠odo
      function generarComprobantesPeriodo(fechaInicio, fechaFin) {
        if (empleados.length === 0) {
          mostrarMensaje('‚ùå No hay empleados registrados', 'warning');
          return;
        }

        let comprobantesGenerados = 0;
        const periodo = {
          fechaInicio: fechaInicio,
          fechaFin: fechaFin,
          empleados: empleados.length,
          totalSalarios: 0,
          totalHoras: 0,
        };

        empleados.forEach((empleado) => {
          // Calcular horas trabajadas en el per√≠odo
          const horasTrabajadas = calcularHorasTrabajadasPeriodo(empleado.id, fechaInicio, fechaFin);
          const salarioNeto = calcularSalarioNeto(empleado.salario, horasTrabajadas);

          // Generar comprobante
          const comprobante = {
            id: Date.now() + Math.random(),
            empleado: empleado.nombre,
            fecha: new Date().toLocaleDateString(),
            salario: empleado.salario,
            departamento: empleado.departamento,
            cargo: empleado.cargo,
            moneda: monedaActual,
            periodo: periodo,
            horasTrabajadas: horasTrabajadas,
            salarioNeto: salarioNeto,
          };

          const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
          comprobantes.push(comprobante);
          localStorage.setItem('axyra_comprobantes', JSON.stringify(comprobantes));

          periodo.totalSalarios += salarioNeto;
          periodo.totalHoras += horasTrabajadas;
          comprobantesGenerados++;
        });

        // Guardar per√≠odo en historial
        const historial = JSON.parse(localStorage.getItem('axyra_historial') || '[]');
        historial.push({
          id: Date.now(),
          periodo: `${fechaInicio} - ${fechaFin}`,
          fechaPago: new Date().toISOString().split('T')[0],
          empleados: periodo.empleados,
          totalSalarios: periodo.totalSalarios,
          estado: 'Completada',
        });
        localStorage.setItem('axyra_historial', JSON.stringify(historial));

        mostrarMensaje(
          `‚úÖ ${comprobantesGenerados} comprobantes generados para el per√≠odo ${fechaInicio} - ${fechaFin}`,
          'success'
        );
        cargarHistorial();
        actualizarResumen();
      }

      // Generar comprobantes
      function generarComprobantes() {
        if (empleadosSeleccionados.size === 0) {
          mostrarMensaje('‚ùå Selecciona al menos un empleado', 'warning');
          return;
        }

        empleadosSeleccionados.forEach((empleadoId) => {
          const empleado = empleados.find((e) => e.id === empleadoId);
          if (empleado) {
            generarComprobante(empleado);
          }
        });

        mostrarMensaje(`‚úÖ Comprobantes generados para ${empleadosSeleccionados.size} empleados`, 'success');
        actualizarResumen();
      }

      // Generar comprobante individual
      function generarComprobante(empleado) {
        const comprobante = {
          id: Date.now() + Math.random(),
          empleado: empleado.nombre,
          fecha: new Date().toLocaleDateString(),
          salario: empleado.salario,
          departamento: empleado.departamento,
          cargo: empleado.cargo,
          moneda: monedaActual,
        };

        const comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
        comprobantes.push(comprobante);
        localStorage.setItem('axyra_comprobantes', JSON.stringify(comprobantes));
      }

      // Actualizar resumen
      function actualizarResumen() {
        // Mostrar total de empleados del usuario (no solo seleccionados)
        document.getElementById('totalEmpleadosNomina').textContent = empleados.length;

        let totalSalarios = 0;
        let totalHoras = 0;

        // Calcular totales de TODOS los empleados del usuario
        empleados.forEach((empleado) => {
          const horasEmpleado = calcularHorasTrabajadas(empleado.id);
          const salarioNeto = calcularSalarioNeto(empleado.salario, horasEmpleado);
          totalSalarios += salarioNeto;
          totalHoras += horasEmpleado;
        });

        document.getElementById('totalSalariosNomina').textContent = formatearMoneda(totalSalarios);
        document.getElementById('totalHorasNomina').textContent = totalHoras;

        // Filtrar comprobantes por usuario actual
        const currentUser = JSON.parse(localStorage.getItem('axyra_isolated_user') || '{}');
        let comprobantes = JSON.parse(localStorage.getItem('axyra_comprobantes') || '[]');
        if (currentUser.username) {
          comprobantes = comprobantes.filter((comp) => comp.userId === currentUser.username);
        }
        document.getElementById('totalComprobantes').textContent = comprobantes.length;
      }

      // Cargar historial
      function cargarHistorial() {
        const historial = JSON.parse(localStorage.getItem('axyra_historial') || '[]');
        mostrarHistorial(historial);
      }

      // Mostrar historial
      function mostrarHistorial(historial) {
        const tbody = document.getElementById('historialNominaTableBody');
        if (historial.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="axyra-text-center">No hay historial de n√≥minas</td></tr>';
          return;
        }

        tbody.innerHTML = historial
          .map(
            (nomina) => `
          <tr>
            <td>${nomina.periodo}</td>
            <td>${nomina.fechaPago}</td>
            <td>${nomina.empleados}</td>
            <td>${formatearMoneda(nomina.totalSalarios)}</td>
            <td><span class="axyra-badge axyra-badge-success">Completada</span></td>
            <td>
              <div class="axyra-action-buttons">
                <button class="axyra-btn axyra-btn-info axyra-btn-small" onclick="verDetalleNomina('${nomina.id}')" title="Ver Detalle">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="axyra-btn axyra-btn-danger axyra-btn-small" onclick="eliminarNomina('${nomina.id}')" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join('');
      }

      // Ver detalle de n√≥mina
      function verDetalleNomina(id) {
        mostrarModalDetalleNomina(id);
      }
      
      // Mostrar modal de detalle de n√≥mina
      function mostrarModalDetalleNomina(id) {
        const modal = document.getElementById('modalDetalleNomina');
        if (modal) {
          modal.style.display = 'flex';
          // Centrar el modal
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
        }
      }
      
      // Cerrar modal de detalle de n√≥mina
      function cerrarModalDetalleNomina() {
        const modal = document.getElementById('modalDetalleNomina');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // Eliminar n√≥mina
      function eliminarNomina(id) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar esta n√≥mina? Esta acci√≥n no se puede deshacer.')) {
          try {
            const historial = JSON.parse(localStorage.getItem('axyra_historial') || '[]');
            const historialFiltrado = historial.filter(n => n.id !== id);
            localStorage.setItem('axyra_historial', JSON.stringify(historialFiltrado));
            
            cargarHistorial();
            actualizarResumen();
            mostrarMensaje('‚úÖ N√≥mina eliminada correctamente', 'success');
          } catch (error) {
            console.error('‚ùå Error eliminando n√≥mina:', error);
            mostrarMensaje('‚ùå Error al eliminar la n√≥mina', 'error');
          }
        }
      }

      // Exportar n√≥mina a Excel profesional
      function exportarNomina() {
        if (empleadosSeleccionados.size === 0) {
          mostrarMensaje('‚ùå Selecciona al menos un empleado', 'warning');
          return;
        }

        try {
          // Preparar datos para exportaci√≥n
          const datosExportacion = [];
          empleadosSeleccionados.forEach((empleadoId) => {
            const empleado = empleados.find((e) => e.id === empleadoId);
            if (empleado) {
              const horas = calcularHorasTrabajadas(empleado.id);
              const salarioNeto = calcularSalarioNeto(empleado.salario, horas);
              datosExportacion.push({
                nombre: empleado.nombre,
                cargo: empleado.cargo,
                departamento: empleado.departamento,
                salarioBase: empleado.salario,
                horasTrabajadas: horas,
                salarioNeto: salarioNeto
              });
            }
          });

          // Crear nuevo workbook
          const workbook = XLSX.utils.book_new();
          
          // Preparar datos con formato profesional
          const excelContent = [];
          
          // T√≠tulo principal
          excelContent.push(['REPORTE DE N√ìMINA - AXYRA']);
          excelContent.push([]);
          
          // Informaci√≥n del per√≠odo
          excelContent.push(['PER√çODO:', document.getElementById('fechaInicio').value, 'a', document.getElementById('fechaFin').value]);
          excelContent.push(['FECHA DE EXPORTACI√ìN:', new Date().toLocaleDateString('es-ES')]);
          excelContent.push(['TOTAL EMPLEADOS:', datosExportacion.length]);
          excelContent.push([]);
          
          // Encabezados de la tabla
          excelContent.push(['Empleado', 'Cargo', 'Departamento', 'Salario Base', 'Horas Trabajadas', 'Salario Neto']);
          
          // Datos de empleados
          datosExportacion.forEach(emp => {
            excelContent.push([
              emp.nombre,
              emp.cargo,
              emp.departamento,
              emp.salarioBase,
              emp.horasTrabajadas,
              emp.salarioNeto
            ]);
          });
          
          // Resumen por departamento
          excelContent.push([]);
          excelContent.push(['RESUMEN POR DEPARTAMENTO']);
          excelContent.push(['Departamento', 'Cantidad', 'Total Salarios']);
          
          const resumenDepartamentos = {};
          datosExportacion.forEach(emp => {
            if (!resumenDepartamentos[emp.departamento]) {
              resumenDepartamentos[emp.departamento] = { cantidad: 0, totalSalarios: 0 };
            }
            resumenDepartamentos[emp.departamento].cantidad++;
            resumenDepartamentos[emp.departamento].totalSalarios += emp.salarioNeto;
          });
          
          Object.entries(resumenDepartamentos).forEach(([depto, datos]) => {
            excelContent.push([depto, datos.cantidad, `$${datos.totalSalarios.toLocaleString('es-CO')}`]);
          });
          
          // Totales finales
          excelContent.push([]);
          excelContent.push(['TOTALES FINALES']);
          excelContent.push(['Concepto', 'Valor']);
          excelContent.push(['Total Empleados', datosExportacion.length]);
          excelContent.push(['Total Salarios', `$${datosExportacion.reduce((sum, emp) => sum + emp.salarioNeto, 0).toLocaleString('es-CO')}`]);
          excelContent.push(['Promedio Salario', `$${(datosExportacion.reduce((sum, emp) => sum + emp.salarioNeto, 0) / datosExportacion.length).toLocaleString('es-CO')}`]);
          
          // Crear worksheet
          const worksheet = XLSX.utils.aoa_to_sheet(excelContent);
          
          // Agregar worksheet al workbook
          XLSX.utils.book_append_sheet(workbook, worksheet, 'N√≥mina');
          
          // Generar archivo
          const nombreArchivo = `NOMINA_${new Date().toISOString().split('T')[0]}.xlsx`;
          XLSX.writeFile(workbook, nombreArchivo);
          
          mostrarMensaje(`‚úÖ N√≥mina exportada a Excel correctamente: ${nombreArchivo}`, 'success');
        } catch (error) {
          console.error('‚ùå Error exportando n√≥mina:', error);
          mostrarMensaje(`‚ùå Error al exportar: ${error.message}`, 'error');
        }
      }

      // Limpiar historial
      function limpiarHistorial() {
        if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial? Esta acci√≥n no se puede deshacer.')) {
          localStorage.removeItem('axyra_historial');
          cargarHistorial();
          mostrarMensaje('‚úÖ Historial limpiado correctamente', 'success');
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        document.body.appendChild(mensajeDiv);

        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }
    </script>

    <style>
      .axyra-currency-info {
        text-align: center;
        padding: var(--spacing-lg);
      }

      .axyra-currency-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        font-size: 1.1rem;
      }

      .axyra-currency-flag {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .axyra-currency-description {
        color: var(--axyra-gray-600);
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
      }

      .axyra-btn-success {
        background: var(--axyra-green-600);
        color: white;
        border: 1px solid var(--axyra-green-600);
      }

      .axyra-btn-success:hover {
        background: var(--axyra-green-700);
        border-color: var(--axyra-green-700);
      }
    </style>
  </body>
</html>
