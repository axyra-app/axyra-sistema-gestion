<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gestión de Nómina</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="stylesheet" href="nomina-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>
    
    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>
    
    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>

    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>
    <script src="../../static/gmail-notifications.js"></script>
    
    <!-- Header Compartido AXYRA -->
    <script src="../../static/include-header.js"></script>

    <style>
      /* Estilos específicos para el módulo de nómina */
      .detalle-nomina-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .detalle-section {
        background: #f8fafc;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e2e8f0;
      }

      .detalle-section h4 {
        color: #1e3a8a;
        margin: 0 0 15px 0;
        font-size: 1.1rem;
        font-weight: 600;
        border-bottom: 2px solid #cbd5e1;
        padding-bottom: 8px;
      }

      .detalle-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .detalle-row:last-child {
        border-bottom: none;
      }

      .detalle-row.total {
        font-weight: 600;
        color: #1e3a8a;
        border-top: 2px solid #cbd5e1;
        padding-top: 12px;
        margin-top: 8px;
      }

      .detalle-label {
        color: #64748b;
        font-weight: 500;
      }

      .detalle-value {
        color: #1e293b;
        font-weight: 600;
      }

      .reportes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .reporte-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .reporte-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      }

      .reporte-icon {
        font-size: 2.5rem;
        color: #667eea;
        margin-bottom: 15px;
      }

      .reporte-content h4 {
        color: #1e3a8a;
        margin: 0 0 10px 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .reporte-content p {
        color: #64748b;
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .resumen-nomina {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
      }

      .resumen-nomina h4 {
        color: #1e3a8a;
        margin: 0 0 15px 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        color: #374151;
        font-weight: 500;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }

      .form-input, .form-select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }

      .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a67d8;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .btn-info {
        background: #3b82f6;
        color: white;
      }

      .btn-info:hover {
        background: #2563eb;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        z-index: 10;
      }

      .modal-close:hover {
        color: #374151;
      }

      .modal-header {
        padding: 25px 25px 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h3 {
        margin: 0 0 5px 0;
        color: #1f2937;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .modal-header p {
        margin: 0;
        color: #6b7280;
        font-size: 0.9rem;
      }

      .modal-body {
        padding: 20px 25px;
      }

      .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 15px 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border-left: 4px solid;
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.3s ease;
      }

      .notification.success {
        border-left-color: #10b981;
      }

      .notification.error {
        border-left-color: #ef4444;
      }

      .notification.warning {
        border-left-color: #f59e0b;
      }

      .notification.info {
        border-left-color: #3b82f6;
      }

      .notification-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .notification-message {
        color: #374151;
        font-size: 0.9rem;
        margin-right: 15px;
      }

      .notification-close {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification-close:hover {
        color: #6b7280;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .detalle-nomina-grid {
          grid-template-columns: 1fr;
        }
        
        .reportes-grid {
          grid-template-columns: 1fr;
        }
        
        .form-row {
          grid-template-columns: 1fr;
        }
        
        .modal-content {
          max-width: 95%;
          margin: 10px;
        }
        
        .modal-header, .modal-body, .modal-footer {
          padding: 15px;
        }
      }

      /* Estilos para botones pequeños */
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
        border-radius: 4px;
      }

      /* Estilos para badges */
      .badge {
        display: inline-block;
        padding: 4px 8px;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .badge-warning {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .badge-error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .badge-info {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      /* Estilos para botones de acción */
      .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
        align-items: center;
      }

      .action-buttons .btn {
        min-width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Estilos para métricas */
      .axyra-metrics-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 16px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        color: white;
        position: relative;
        overflow: hidden;
      }

      .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
      }

      .metric-card:hover::before {
        opacity: 1;
      }

      .metric-card:nth-child(1) {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .metric-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .metric-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .metric-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }

      .metric-card:nth-child(5) {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      .metric-icon {
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 15px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 800;
        color: white;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .metric-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Estilos para filtros */
      .axyra-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }

      .axyra-search-box {
        position: relative;
        flex: 1;
        min-width: 250px;
      }

      .axyra-search-box input {
        width: 100%;
        padding: 10px 40px 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .axyra-search-box i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
      }

      .axyra-form-select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 150px;
      }

      /* Estilos para tabla */
      .axyra-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
      }

      .axyra-table {
        width: 100%;
        border-collapse: collapse;
      }

      .axyra-table th {
        background: #f8fafc;
        color: #1e3a8a;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0;
        font-size: 0.9rem;
      }

      .axyra-table td {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
      }

      .axyra-table tr:hover {
        background: #f8fafc;
      }

      /* Estilos para paginación */
      .axyra-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
      }

      .axyra-pagination button {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .axyra-pagination button:hover:not(:disabled) {
        background: #f8fafc;
        border-color: #667eea;
      }

      .axyra-pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #paginaInfo {
        color: #64748b;
        font-weight: 500;
      }

      /* Estilos para notificaciones */
      .axyra-notificacion {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        border: 1px solid #e2e8f0;
        animation: slideInRight 0.3s ease-out;
        overflow: hidden;
      }

      .axyra-notificacion-contenido {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
      }

      .axyra-notificacion-mensaje {
        color: #1e293b;
        font-weight: 500;
        margin-right: 12px;
      }

      .axyra-notificacion-cerrar {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .axyra-notificacion-cerrar:hover {
        background: #f1f5f9;
        color: #64748b;
      }

      /* Tipos de notificación */
      .axyra-notificacion-success {
        border-left: 4px solid #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      }

      .axyra-notificacion-error {
        border-left: 4px solid #ef4444;
        background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
      }

      .axyra-notificacion-warning {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      }

      .axyra-notificacion-info {
        border-left: 4px solid #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      }

      /* Animaciones */
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Mejoras en el dashboard de métricas */
      .axyra-metrics-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .metric-card:hover::before {
        opacity: 1;
      }

      .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      }

      .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.9;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
      }

      /* Mejoras en los botones de acción */
      .axyra-actions-bar {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin: 30px 0;
        padding: 25px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        border: 1px solid #e2e8f0;
      }

      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: white;
        min-width: 140px;
        justify-content: center;
      }

      .axyra-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }

      .axyra-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .axyra-btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      .axyra-btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .axyra-btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      }

      .axyra-btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
      }

      /* Mejoras en las tablas */
      .axyra-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
      }

      .axyra-table th {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        font-weight: 600;
        padding: 16px 20px;
        text-align: left;
        border-bottom: 2px solid #cbd5e1;
      }

      .axyra-table td {
        padding: 16px 20px;
        border-bottom: 1px solid #f1f5f9;
        color: #475569;
      }

      .axyra-table tr:hover {
        background: #f8fafc;
      }

      /* Mejoras en los filtros */
      .axyra-filters {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin: 30px 0;
        padding: 25px;
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }

      .axyra-search-box {
        position: relative;
        flex: 1;
        min-width: 250px;
      }

      .axyra-search-box input {
        width: 100%;
        padding: 12px 20px 12px 45px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #f8fafc;
      }

      .axyra-search-box input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .axyra-search-box i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 1.1rem;
      }

      .axyra-form-select {
        padding: 12px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 0.95rem;
        background: #f8fafc;
        color: #475569;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
      }

      .axyra-form-select:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .axyra-actions-bar {
          flex-direction: column;
        }
        
        .axyra-btn {
          width: 100%;
        }
        
        .axyra-metrics-dashboard {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        
        .axyra-filters {
          flex-direction: column;
        }
        
        .axyra-search-box {
          min-width: 100%;
        }
      }

      /* Estilos para notificaciones */
      .axyra-notificacion {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        border: 1px solid #e2e8f0;
        animation: slideInRight 0.3s ease-out;
        overflow: hidden;
      }

      .axyra-notificacion-contenido {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
      }

      .axyra-notificacion-mensaje {
        color: #1e293b;
        font-weight: 500;
        margin-right: 12px;
      }

      .axyra-notificacion-cerrar {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .axyra-notificacion-cerrar:hover {
        background: #f1f5f9;
        color: #64748b;
      }

      /* Tipos de notificación */
      .axyra-notificacion-success {
        border-left: 4px solid #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      }

      .axyra-notificacion-error {
        border-left: 4px solid #ef4444;
        background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
      }

      .axyra-notificacion-warning {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      }

      .axyra-notificacion-info {
        border-left: 4px solid #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      }

      /* Animaciones */
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Mejoras en las tarjetas de métricas */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 32px 24px;
        text-align: center;
        color: white;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .metric-card:nth-child(1) {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .metric-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .metric-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .metric-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }

      .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
      }

      .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
      }

      .metric-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.9;
      }

      .metric-value {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .metric-label {
        font-size: 16px;
        font-weight: 500;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Mejoras en botones de acción */
      .action-buttons {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 32px;
      }

      .action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
      }

      .action-btn.secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        box-shadow: 0 4px 20px rgba(240, 147, 251, 0.3);
      }

      .action-btn.secondary:hover {
        box-shadow: 0 8px 30px rgba(240, 147, 251, 0.4);
      }

      .action-btn.success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        box-shadow: 0 4px 20px rgba(67, 233, 123, 0.3);
      }

      .action-btn.success:hover {
        box-shadow: 0 8px 30px rgba(67, 233, 123, 0.4);
      }

      /* Mejoras en la tabla */
      .table-container {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 40px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
      }

      .table-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 24px;
        border-bottom: 2px solid #cbd5e1;
      }

      .table-title {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
      }

      .table-subtitle {
        color: #64748b;
        margin: 8px 0 0 0;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .metrics-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .metric-card {
          padding: 24px 16px;
        }

        .metric-value {
          font-size: 28px;
        }

        .action-buttons {
          flex-direction: column;
        }

        .action-btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header Compartido AXYRA - Se insertará automáticamente -->

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gestión de Nómina</h1>
          <p class="axyra-page-subtitle">Genera y gestiona las nóminas de tus empleados</p>
        </div>

        <!-- Botones de Acción -->
        <div class="axyra-actions-bar">
          <button class="axyra-btn axyra-btn-primary" onclick="mostrarModal('modalGenerarNomina')">
            <i class="fas fa-plus"></i> Generar Nómina
          </button>
          <button class="axyra-btn axyra-btn-secondary" onclick="exportarNomina()">
            <i class="fas fa-download"></i> Exportar a Excel
          </button>
          <button class="axyra-btn axyra-btn-success" onclick="generarComprobantePDF()">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
          <button class="axyra-btn axyra-btn-warning" onclick="generarReportes()">
            <i class="fas fa-chart-bar"></i> Reportes
          </button>
          <button class="axyra-btn axyra-btn-info" onclick="configuracionNomina()">
            <i class="fas fa-cog"></i> Configuración
          </button>
        </div>

        <!-- Dashboard de Métricas -->
        <div class="axyra-metrics-dashboard">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalEmpleados">0</div>
              <div class="metric-label">Total Empleados</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalNominas">0</div>
              <div class="metric-label">Nóminas Generadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="costoTotalEmpresa">$0</div>
              <div class="metric-label">Costo Total Empresa</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalHorasTrabajadas">0 hrs</div>
              <div class="metric-label">Total Horas Trabajadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="promedioSalario">$0</div>
              <div class="metric-label">Promedio Salario</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="nominasEsteMes">0</div>
              <div class="metric-label">Nóminas Este Mes</div>
            </div>
          </div>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="axyra-filters">
          <div class="axyra-search-box">
            <input type="text" id="searchInput" class="axyra-form-input" placeholder="Buscar por empleado..." />
            <i class="fas fa-search"></i>
          </div>
          <select id="filterEmpleado" class="axyra-form-select">
            <option value="">Todos los empleados</option>
          </select>
          <select id="filterMes" class="axyra-form-select">
            <option value="">Todos los meses</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
          <select id="filterAnio" class="axyra-form-select">
            <option value="">Todos los años</option>
          </select>
        </div>

        <!-- Tabla de Nóminas -->
        <div class="axyra-table-container">
          <table class="axyra-table" id="nominasTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Empleado</th>
                <th>Período</th>
                <th>Horas Normales</th>
                <th>Horas Extras</th>
                <th>Horas Nocturnas</th>
                <th>Horas Dominicales</th>
                <th>Salario Base</th>
                <th>Bonificaciones</th>
                <th>Deducciones</th>
                <th>Salario Neto</th>
                <th>Costo Empresa</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="nominasTableBody">
              <!-- Las nóminas se cargarán aquí dinámicamente -->
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="axyra-pagination">
          <button class="axyra-btn axyra-btn-ghost" onclick="cambiarPagina(-1)">
            <i class="fas fa-chevron-left"></i> Anterior
          </button>
          <span id="paginaInfo">Página 1 de 1</span>
          <button class="axyra-btn axyra-btn-ghost" onclick="cambiarPagina(1)">
            Siguiente <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </main>

    <!-- Modal Generar Nómina -->
    <div id="modalGenerarNomina" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <button class="modal-close" onclick="cerrarModal('modalGenerarNomina')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>Generar Nómina</h3>
          <p>Selecciona los parámetros para generar la nómina</p>
        </div>
        <div class="modal-body">
          <form id="formNomina" onsubmit="generarNomina(event)">
            <div class="form-row">
              <div class="form-group">
                <label for="empleadoNomina">Empleado *</label>
                <select id="empleadoNomina" class="form-input" required>
                  <option value="">Seleccionar empleado</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mesNomina">Mes *</label>
                <select id="mesNomina" class="form-input" required>
                  <option value="">Seleccionar mes</option>
                  <option value="1">Enero</option>
                  <option value="2">Febrero</option>
                  <option value="3">Marzo</option>
                  <option value="4">Abril</option>
                  <option value="5">Mayo</option>
                  <option value="6">Junio</option>
                  <option value="7">Julio</option>
                  <option value="8">Agosto</option>
                  <option value="9">Septiembre</option>
                  <option value="10">Octubre</option>
                  <option value="11">Noviembre</option>
                  <option value="12">Diciembre</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="anioNomina">Año *</label>
                <select id="anioNomina" class="form-input" required>
                  <option value="">Seleccionar año</option>
                </select>
              </div>
              <div class="form-group">
                <label for="tipoNomina">Tipo de Nómina</label>
                <select id="tipoNomina" class="form-input">
                  <option value="mensual">Mensual</option>
                  <option value="quincenal">Quincenal</option>
                  <option value="semanal">Semanal</option>
                </select>
              </div>
            </div>

            <div id="resumenNomina" class="resumen-nomina" style="display: none">
              <h4>Resumen de la Nómina</h4>
              <div id="detallesNomina"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalGenerarNomina')">Cancelar</button>
          <button class="btn btn-primary" onclick="generarNomina()">Generar Nómina</button>
        </div>
      </div>
    </div>

    <!-- Modal Configuración de Nómina -->
    <div id="modalConfiguracionNomina" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <button class="modal-close" onclick="cerrarModal('modalConfiguracionNomina')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>Configuración de Nómina</h3>
          <p>Configura los parámetros del sistema de nómina</p>
        </div>
        <div class="modal-body">
          <form id="formConfiguracionNomina">
            <div class="form-group">
              <label for="salarioMinimo">Salario Mínimo Legal Vigente</label>
              <input type="number" id="salarioMinimo" class="form-input" min="0" step="1000" />
            </div>

            <div class="form-group">
              <label for="porcentajeCesantias">Porcentaje Cesantías (%)</label>
              <input type="number" id="porcentajeCesantias" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajePrima">Porcentaje Prima de Servicios (%)</label>
              <input type="number" id="porcentajePrima" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajeInteresesCesantias">Porcentaje Intereses sobre Cesantías (%)</label>
              <input type="number" id="porcentajeInteresesCesantias" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajeSalud">Porcentaje Salud (%)</label>
              <input type="number" id="porcentajeSalud" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label for="porcentajePension">Porcentaje Pensión (%)</label>
              <input type="number" id="porcentajePension" class="form-input" min="0" max="100" step="0.1" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalConfiguracionNomina')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarConfiguracionNomina()">Guardar Configuración</button>
        </div>
      </div>
    </div>

    <!-- Modal Reportes Avanzados -->
    <div id="modalReportesAvanzados" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-width: 800px">
        <button class="modal-close" onclick="cerrarModal('modalReportesAvanzados')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>Reportes Avanzados de Nómina</h3>
          <p>Genera reportes detallados y análisis de costos laborales</p>
        </div>
        <div class="modal-body">
          <div class="reportes-grid">
            <div class="reporte-card" onclick="generarReporte('costosLaborales')">
              <div class="reporte-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="reporte-content">
                <h4>Reporte de Costos Laborales</h4>
                <p>Análisis detallado de costos por empleado y período</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('prestacionesSociales')">
              <div class="reporte-icon">
                <i class="fas fa-hand-holding-usd"></i>
              </div>
              <div class="reporte-content">
                <h4>Prestaciones Sociales</h4>
                <p>Resumen de cesantías, prima de servicios e intereses</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('horasTrabajadas')">
              <div class="reporte-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="reporte-content">
                <h4>Análisis de Horas</h4>
                <p>Estadísticas de horas normales, extras y especiales</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('comparativoSalarios')">
              <div class="reporte-icon">
                <i class="fas fa-balance-scale"></i>
              </div>
              <div class="reporte-content">
                <h4>Comparativo de Salarios</h4>
                <p>Comparación de salarios por departamento y cargo</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('tendenciasSalariales')">
              <div class="reporte-icon">
                <i class="fas fa-trending-up"></i>
              </div>
              <div class="reporte-content">
                <h4>Tendencias Salariales</h4>
                <p>Evolución de salarios a lo largo del tiempo</p>
              </div>
            </div>

            <div class="reporte-card" onclick="generarReporte('resumenMensual')">
              <div class="reporte-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="reporte-content">
                <h4>Resumen Mensual</h4>
                <p>Resumen completo de nómina del mes</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalReportesAvanzados')">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="modalConfirmacion" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalConfirmacionTitulo">Confirmar Acción</h3>
          <p id="modalConfirmacionMensaje">¿Estás seguro de que quieres realizar esta acción?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalConfirmacion')">Cancelar</button>
          <button class="btn btn-danger" id="btnConfirmarAccion">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Modal Detalle de Nómina -->
    <div id="modalDetalleNomina" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-width: 800px">
        <button class="modal-close" onclick="cerrarModal('modalDetalleNomina')">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3 id="detalleNominaTitulo">Detalle de Nómina</h3>
          <p>Información completa de la nómina generada</p>
        </div>
        <div class="modal-body">
          <div class="detalle-nomina-grid">
            <div class="detalle-section">
              <h4>Información General</h4>
              <div class="detalle-row">
                <span class="detalle-label">Empleado:</span>
                <span class="detalle-value" id="detalleNominaEmpleado"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Período:</span>
                <span class="detalle-value" id="detalleNominaPeriodo"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Tipo:</span>
                <span class="detalle-value" id="detalleNominaTipo"></span>
              </div>
            </div>

            <div class="detalle-section">
              <h4>Horas Trabajadas</h4>
              <div class="detalle-row">
                <span class="detalle-label">Normales:</span>
                <span class="detalle-value" id="detalleHorasNormales"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Extras:</span>
                <span class="detalle-value" id="detalleHorasExtras"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Nocturnas:</span>
                <span class="detalle-value" id="detalleHorasNocturnas"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Dominicales:</span>
                <span class="detalle-value" id="detalleHorasDominicales"></span>
              </div>
            </div>

            <div class="detalle-section">
              <h4>Liquidación</h4>
              <div class="detalle-row">
                <span class="detalle-label">Salario Base:</span>
                <span class="detalle-value" id="detalleSalarioBase"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Subtotal:</span>
                <span class="detalle-value" id="detalleSubtotalSalario"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Bonificaciones:</span>
                <span class="detalle-value" id="detalleBonificaciones"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Deducciones:</span>
                <span class="detalle-value" id="detalleDeducciones"></span>
              </div>
              <div class="detalle-row total">
                <span class="detalle-label">Salario Neto:</span>
                <span class="detalle-value" id="detalleSalarioNeto"></span>
              </div>
            </div>

            <div class="detalle-section">
              <h4>Prestaciones Sociales</h4>
              <div class="detalle-row">
                <span class="detalle-label">Cesantías:</span>
                <span class="detalle-value" id="detalleCesantias"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Prima Servicios:</span>
                <span class="detalle-value" id="detallePrimaServicios"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Intereses:</span>
                <span class="detalle-value" id="detalleInteresesCesantias"></span>
              </div>
            </div>

            <div class="detalle-section">
              <h4>Costos del Empleador</h4>
              <div class="detalle-row">
                <span class="detalle-label">Salud:</span>
                <span class="detalle-value" id="detalleSaludEmpleador"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Pensión:</span>
                <span class="detalle-value" id="detallePensionEmpleador"></span>
              </div>
              <div class="detalle-row">
                <span class="detalle-label">Riesgos Laborales:</span>
                <span class="detalle-value" id="detalleRiesgosLaborales"></span>
              </div>
              <div class="detalle-row total">
                <span class="detalle-label">Costo Total:</span>
                <span class="detalle-value" id="detalleCostoTotalEmpresa"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modalDetalleNomina')">Cerrar</button>
          <button class="btn btn-primary" onclick="generarComprobantePDFIndividual()">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Sistema de Notificaciones -->
    <div id="notificationContainer"></div>

    <script>
      // Variables globales
      let nominas = [];
      let empleados = [];
      let horas = [];
      let paginaActual = 1;
      const nominasPorPagina = 10;
      let currentUser = null;

      // Inicialización cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        inicializarNomina();
        configurarEventos();
      });

      // Función para obtener nombre del mes
      function obtenerNombreMes(mes) {
        const meses = [
          'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        return meses[mes - 1] || 'Mes inválido';
      }

      // Función para formatear moneda
      function formatearMoneda(valor) {
        if (typeof valor !== 'number' || isNaN(valor)) {
          return '$0';
        }
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(valor);
      }

      // Función para cargar datos desde Firebase
      async function cargarDatosFirebase() {
        try {
          console.log('🔄 Cargando datos desde Firebase...');
          
          // Verificar si Firebase está disponible
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.warn('⚠️ Firebase no disponible, usando localStorage como fallback');
            await cargarDatosLocalStorage();
            return;
          }

          const db = firebase.firestore();
          const userId = currentUser?.id || currentUser?.username || currentUser?.email;

          if (!userId) {
            console.warn('⚠️ No se puede identificar usuario, usando localStorage');
            await cargarDatosLocalStorage();
            return;
          }

          // Cargar empleados desde Firebase
          try {
            const empleadosSnapshot = await db.collection('empleados')
              .where('userId', '==', userId)
              .get();
            
            empleados = empleadosSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`✅ ${empleados.length} empleados cargados desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando empleados desde Firebase:', error);
            empleados = [];
          }

          // Cargar horas desde Firebase
          try {
            const horasSnapshot = await db.collection('horas')
              .where('userId', '==', userId)
              .get();
            
            horas = horasSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`✅ ${horas.length} horas cargadas desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando horas desde Firebase:', error);
            horas = [];
          }

          // Cargar nóminas desde Firebase
          try {
            const nominasSnapshot = await db.collection('nominas')
              .where('userId', '==', userId)
              .get();
            
            nominas = nominasSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`✅ ${nominas.length} nóminas cargadas desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando nóminas desde Firebase:', error);
            nominas = [];
          }

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_horas', JSON.stringify(horas));
          localStorage.setItem('axyra_nominas', JSON.stringify(nominas));

        } catch (error) {
          console.error('❌ Error cargando datos desde Firebase:', error);
          // Fallback a localStorage
          await cargarDatosLocalStorage();
        }
      }

      // Función para cargar datos desde localStorage (fallback)
      async function cargarDatosLocalStorage() {
        try {
          console.log('🔄 Cargando datos desde localStorage...');
          
          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username;
            });
          }

          // Cargar horas
          const horasData = localStorage.getItem('axyra_horas');
          if (horasData) {
            horas = JSON.parse(horasData);
            // Filtrar por usuario actual
            horas = horas.filter((h) => {
              if (!h.userId) return true; // Datos globales
              return h.userId === currentUser?.username;
            });
          }

          // Cargar nóminas
          const nominasData = localStorage.getItem('axyra_nominas');
          if (nominasData) {
            nominas = JSON.parse(nominasData);
            // Filtrar por usuario actual
            nominas = nominas.filter((n) => {
              if (!n.userId) return true; // Datos globales
              return n.userId === currentUser?.username;
            });
          }

          console.log(
            `✅ Datos cargados desde localStorage: ${empleados.length} empleados, ${horas.length} horas, ${nominas.length} nóminas`
          );
          
        } catch (error) {
          console.error('❌ Error cargando datos desde localStorage:', error);
        }
      }

      // Función de inicialización mejorada
      async function inicializarNomina() {
        try {
          console.log('🚀 Inicializando módulo de nómina...');
          
          // Verificar autenticación
          await verificarAutenticacion();

          // Intentar cargar desde Firebase primero
          await cargarDatosFirebase();

          // Llenar selects
          llenarSelects();

          // Renderizar tabla
          renderizarTablaNominas();

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();

          console.log('✅ Módulo de nómina inicializado correctamente');
        } catch (error) {
          console.error('❌ Error inicializando nómina:', error);
          mostrarNotificacion('Error inicializando módulo de nómina', 'error');
        }
      }

      // Verificar autenticación
      async function verificarAutenticacion() {
        try {
          // Usar el sistema de autenticación si está disponible
          if (window.axyraAuth && window.axyraAuth.isAuthenticated) {
            currentUser = window.axyraAuth.currentUser;
            console.log('✅ Usuario autenticado con sistema AXYRA:', currentUser?.username);
            return;
          }

          // Fallback: verificar localStorage
          const userData = localStorage.getItem('axyra_isolated_user');
          if (!userData) {
            window.location.href = '../../login.html';
            return;
          }

          currentUser = JSON.parse(userData);
          console.log('✅ Usuario autenticado con localStorage:', currentUser.username);
        } catch (error) {
          console.error('❌ Error verificando autenticación:', error);
          window.location.href = '../../login.html';
        }
      }

      // Cargar datos desde localStorage
      async function cargarDatos() {
        try {
          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return e.userId === currentUser?.username;
            });
          }

          // Cargar horas
          const horasData = localStorage.getItem('axyra_horas');
          if (horasData) {
            horas = JSON.parse(horasData);
            // Filtrar por usuario actual
            horas = horas.filter((h) => {
              if (!h.userId) return true; // Datos globales
              return h.userId === currentUser?.username;
            });
          }

          // Cargar nóminas
          const nominasData = localStorage.getItem('axyra_nominas');
          if (nominasData) {
            nominas = JSON.parse(nominasData);
            // Filtrar por usuario actual
            nominas = nominas.filter((n) => {
              if (!n.userId) return true; // Datos globales
              return n.userId === currentUser?.username;
            });
          }

          console.log(
            `✅ Datos cargados: ${empleados.length} empleados, ${horas.length} horas, ${nominas.length} nóminas`
          );
          
          // Verificar si hay datos y mostrar notificación si no
          if (empleados.length === 0) {
            console.warn('⚠️ No hay empleados registrados para el usuario actual');
          }
          if (horas.length === 0) {
            console.warn('⚠️ No hay horas registradas para el usuario actual');
          }
          if (nominas.length === 0) {
            console.warn('⚠️ No hay nóminas generadas para el usuario actual');
          }
        } catch (error) {
          console.error('❌ Error cargando datos:', error);
        }
      }

      // Llenar selects
      function llenarSelects() {
        // Select de empleados
        const selectsEmpleados = ['empleadoNomina', 'filterEmpleado'];
        selectsEmpleados.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">Seleccionar empleado</option>';
            empleados.forEach((empleado) => {
              const option = document.createElement('option');
              option.value = empleado.id;
              option.textContent = `${empleado.nombre} (${empleado.cargo || 'Sin cargo'})`;
              select.appendChild(option);
            });
          }
        });

        // Select de años
        const anioActual = new Date().getFullYear();
        const selectAnio = document.getElementById('anioNomina');
        if (selectAnio) {
          selectAnio.innerHTML = '<option value="">Seleccionar año</option>';
          for (let anio = anioActual - 2; anio <= anioActual + 1; anio++) {
            const option = document.createElement('option');
            option.value = anio;
            option.textContent = anio;
            if (anio === anioActual) option.selected = true;
            selectAnio.appendChild(option);
          }
        }

        // Select de años para filtro
        const filterAnio = document.getElementById('filterAnio');
        if (filterAnio) {
          filterAnio.innerHTML = '<option value="">Todos los años</option>';
          for (let anio = anioActual - 2; anio <= anioActual + 1; anio++) {
            const option = document.createElement('option');
            option.value = anio;
            option.textContent = anio;
            filterAnio.appendChild(option);
          }
        }
      }

      // Configurar eventos
      function configurarEventos() {
        try {
          // Evento de búsqueda
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', () => {
              paginaActual = 1; // Resetear a primera página
              renderizarTablaNominas();
            });
        }

          // Eventos de filtros
        const filterEmpleado = document.getElementById('filterEmpleado');
        if (filterEmpleado) {
            filterEmpleado.addEventListener('change', () => {
              paginaActual = 1;
              renderizarTablaNominas();
            });
        }

        const filterMes = document.getElementById('filterMes');
        if (filterMes) {
            filterMes.addEventListener('change', () => {
              paginaActual = 1;
              renderizarTablaNominas();
            });
        }

        const filterAnio = document.getElementById('filterAnio');
        if (filterAnio) {
            filterAnio.addEventListener('change', () => {
              paginaActual = 1;
              renderizarTablaNominas();
            });
          }

          // Configurar eventos de modales
          configurarEventosModales();

          console.log('✅ Eventos configurados correctamente');
        } catch (error) {
          console.error('❌ Error configurando eventos:', error);
        }
      }

      // Función para formatear moneda
      function formatearMoneda(valor) {
        if (typeof valor !== 'number' || isNaN(valor)) {
          return '$0';
        }
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(valor);
      }

      // Función para renderizar tabla de nóminas
      function renderizarTablaNominas() {
        try {
        const tbody = document.getElementById('nominasTableBody');
        if (!tbody) return;

          tbody.innerHTML = '';

          if (nominas.length === 0) {
          tbody.innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 40px; color: #6b7280;">
                  <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block; color: #d1d5db;"></i>
                  <p>No hay nóminas generadas</p>
                  <p style="font-size: 0.9rem; margin-top: 5px;">Genera tu primera nómina usando el botón "Generar Nómina"</p>
              </td>
            </tr>
          `;
          return;
        }

          // Aplicar filtros si existen
          let nominasFiltradas = nominas;
          const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase();
          const filterEmpleado = document.getElementById('filterEmpleado')?.value;
          const filterMes = document.getElementById('filterMes')?.value;
          const filterAnio = document.getElementById('filterAnio')?.value;

          if (searchTerm || filterEmpleado || filterMes || filterAnio) {
            nominasFiltradas = nominas.filter((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
              if (!empleado) return false;

              // Filtro de búsqueda
              if (searchTerm && !empleado.nombre.toLowerCase().includes(searchTerm)) {
                return false;
              }

              // Filtro de empleado
              if (filterEmpleado && nomina.empleado_id != filterEmpleado) {
                return false;
              }

              // Filtro de mes
              if (filterMes && nomina.mes != filterMes) {
                return false;
              }

              // Filtro de año
              if (filterAnio && nomina.anio != filterAnio) {
                return false;
              }

              return true;
            });
          }

          // Aplicar paginación
          const inicio = (paginaActual - 1) * nominasPorPagina;
          const fin = inicio + nominasPorPagina;
          const nominasPaginadas = nominasFiltradas.slice(inicio, fin);

          // Renderizar filas
          nominasPaginadas.forEach((nomina) => {
            const empleado = empleados.find((e) => e.id === nomina.empleado_id);
            if (!empleado) return;

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${nomina.id}</td>
              <td>${empleado.nombre}</td>
              <td>${obtenerNombreMes(nomina.mes)} ${nomina.anio}</td>
              <td>${(nomina.horas_trabajadas || 0).toLocaleString('es-CO')}</td>
              <td>${(nomina.horas_extras || 0).toLocaleString('es-CO')}</td>
              <td>${(nomina.horas_nocturnas || 0).toLocaleString('es-CO')}</td>
              <td>${(nomina.horas_dominicales || 0).toLocaleString('es-CO')}</td>
              <td>${formatearMoneda(nomina.salario_base)}</td>
              <td>${formatearMoneda(nomina.bonificaciones || 0)}</td>
              <td>${formatearMoneda(nomina.deducciones || 0)}</td>
              <td>${formatearMoneda(nomina.salario_neto)}</td>
              <td>${formatearMoneda(nomina.costo_total_empresa)}</td>
              <td>
                <span class="badge badge-success">${nomina.estado || 'Generada'}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-sm btn-info" onclick="verNomina(${nomina.id})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-success" onclick="generarComprobantePDFIndividual()" title="Generar PDF">
                    <i class="fas fa-file-pdf"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="eliminarNomina(${nomina.id})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(row);
          });

          // Actualizar información de paginación
          actualizarPaginacion(nominasFiltradas.length);

          // Actualizar métricas
          actualizarMetricas();
        } catch (error) {
          console.error('❌ Error renderizando tabla de nóminas:', error);
        }
      }

      // Función para actualizar paginación
      function actualizarPaginacion(totalNominas) {
        const totalPaginas = Math.ceil(totalNominas / nominasPorPagina);
        const paginaInfo = document.getElementById('paginaInfo');
        
        if (paginaInfo) {
          paginaInfo.textContent = `Página ${paginaActual} de ${totalPaginas}`;
        }

        // Habilitar/deshabilitar botones de paginación
        const btnAnterior = document.querySelector('button[onclick="cambiarPagina(-1)"]');
        const btnSiguiente = document.querySelector('button[onclick="cambiarPagina(1)"]');
        
        if (btnAnterior) {
          btnAnterior.disabled = paginaActual <= 1;
        }
        
        if (btnSiguiente) {
          btnSiguiente.disabled = paginaActual >= totalPaginas;
        }
      }

      // Función para cambiar página
      window.cambiarPagina = function(direccion) {
        const totalPaginas = Math.ceil(nominas.length / nominasPorPagina);
        const nuevaPagina = paginaActual + direccion;
        
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
          paginaActual = nuevaPagina;
        renderizarTablaNominas();
        }
      }

      // Función para actualizar métricas
      function actualizarMetricas() {
        try {
          // Total empleados
          const totalEmpleadosElement = document.getElementById('totalEmpleados');
          if (totalEmpleadosElement) {
            totalEmpleadosElement.textContent = empleados.length;
          }

          // Total nóminas
          const totalNominasElement = document.getElementById('totalNominas');
          if (totalNominasElement) {
            totalNominasElement.textContent = nominas.length;
          }

          // Costo total empresa
          const costoTotalEmpresaElement = document.getElementById('costoTotalEmpresa');
          if (costoTotalEmpresaElement) {
            const costoTotal = nominas.reduce((sum, n) => sum + (n.costo_total_empresa || 0), 0);
            costoTotalEmpresaElement.textContent = formatearMoneda(costoTotal);
          }

          // Total horas trabajadas
          const totalHorasTrabajadasElement = document.getElementById('totalHorasTrabajadas');
          if (totalHorasTrabajadasElement) {
            const totalHoras = nominas.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0);
            totalHorasTrabajadasElement.textContent = `${totalHoras.toLocaleString('es-CO')} hrs`;
          }

          // Promedio salario
          const promedioSalarioElement = document.getElementById('promedioSalario');
          if (promedioSalarioElement) {
            const promedio = nominas.length > 0 ? 
              nominas.reduce((sum, n) => sum + (n.salario_neto || 0), 0) / nominas.length : 0;
            promedioSalarioElement.textContent = formatearMoneda(promedio);
          }

          // Nóminas este mes
          const nominasEsteMesElement = document.getElementById('nominasEsteMes');
          if (nominasEsteMesElement) {
            const mesActual = new Date().getMonth() + 1;
            const anioActual = new Date().getFullYear();
            const nominasMes = nominas.filter(n => n.mes === mesActual && n.anio === anioActual);
            nominasEsteMesElement.textContent = nominasMes.length;
          }
        } catch (error) {
          console.error('❌ Error actualizando métricas:', error);
        }
      }

      // Mostrar modal (función global)
      window.mostrarModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add('active');

          // Limpiar formulario si es el modal de nómina
          if (modalId === 'modalGenerarNomina') {
            limpiarFormularioNomina();
          }

          // Cargar configuración si es el modal de configuración
          if (modalId === 'modalConfiguracionNomina') {
            cargarConfiguracionGuardada();
          }

          // Verificar que el modal esté por encima del header
          if (modal.style.zIndex !== '9999') {
            modal.style.zIndex = '9999';
          }
        }
      }

      // Cerrar modal (función global)
      window.cerrarModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          modal.classList.remove('active');
        }
      }

      // Función para cerrar modal al hacer clic fuera
      window.cerrarModalClickOutside = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
          const modalId = event.target.id;
          cerrarModal(modalId);
        }
      }

      // Función para configurar event listeners de modales
      window.configurarEventosModales = function() {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          modal.addEventListener('click', cerrarModalClickOutside);
        });
        console.log('✅ Event listeners de modales configurados');
      }

      // Limpiar formulario de nómina
      function limpiarFormularioNomina() {
        const form = document.getElementById('formNomina');
        if (form) {
          form.reset();
        }

        // Ocultar resumen
        const resumen = document.getElementById('resumenNomina');
        if (resumen) {
          resumen.style.display = 'none';
        }
      }

      // Calcular resumen de la nómina
      function calcularResumenNomina() {
        const empleadoId = document.getElementById('empleadoNomina')?.value;
        const mes = document.getElementById('mesNomina')?.value;
        const anio = document.getElementById('anioNomina')?.value;

        if (!empleadoId || !mes || !anio) {
          document.getElementById('resumenNomina').style.display = 'none';
          return;
        }

        const empleado = empleados.find((e) => e.id == empleadoId);
        if (!empleado) return;

        // Filtrar horas del empleado para el mes y año especificados
        const horasEmpleado = horas.filter((h) => {
          if (h.empleado_id != empleadoId) return false;

          const fechaHora = new Date(h.fecha);
          return fechaHora.getMonth() + 1 == mes && fechaHora.getFullYear() == anio;
        });

        if (horasEmpleado.length === 0) {
          document.getElementById('detallesNomina').innerHTML =
            '<p class="error">No hay horas registradas para este empleado en el período seleccionado</p>';
          document.getElementById('resumenNomina').style.display = 'block';
          return;
        }

        // Calcular totales de horas
        const totalHoras = horasEmpleado.reduce((sum, h) => sum + (h.horas_trabajadas || 0), 0);
        const horasExtras = horasEmpleado.reduce((sum, h) => sum + (h.horas_extras || 0), 0);
        const horasNocturnas = horasEmpleado.reduce((sum, h) => sum + (h.horas_nocturnas || 0), 0);
        const horasDominicales = horasEmpleado.reduce((sum, h) => sum + (h.horas_dominicales || 0), 0);

        // Salario base y cálculos
        const salarioBase = empleado.salario || 0;
        const salarioPorHora = empleado.tipo_contrato === 'Por Horas' ? salarioBase / 160 : salarioBase / 160;
        const salarioMensual = empleado.tipo_contrato === 'Por Horas' ? totalHoras * salarioPorHora : salarioBase;

        // Cálculo de horas extras (25% adicional)
        const valorHorasExtras = horasExtras * salarioPorHora * 1.25;

        // Cálculo de horas nocturnas (35% adicional)
        const valorHorasNocturnas = horasNocturnas * salarioPorHora * 1.35;

        // Cálculo de horas dominicales (75% adicional)
        const valorHorasDominicales = horasDominicales * salarioPorHora * 1.75;

        // Subtotal de salario
        const subtotalSalario = salarioMensual + valorHorasExtras + valorHorasNocturnas + valorHorasDominicales;

        // Bonificaciones (10% del salario base)
        const bonificaciones = salarioMensual * 0.1;

        // Cálculo de prestaciones sociales
        const cesantias = subtotalSalario * 0.0833; // 8.33% mensual
        const primaServicios = subtotalSalario * 0.0833; // 8.33% mensual
        const interesesCesantias = cesantias * 0.12; // 12% anual, 1% mensual

        // Cálculo de aportes del empleado
        const saludEmpleado = subtotalSalario * 0.04; // 4% salud
        const pensionEmpleado = subtotalSalario * 0.04; // 4% pensión

        // Cálculo de aportes del empleador
        const saludEmpleador = subtotalSalario * 0.085; // 8.5% salud
        const pensionEmpleador = subtotalSalario * 0.12; // 12% pensión
        const riesgosLaborales = subtotalSalario * 0.00522; // 0.522% ARL (promedio)

        // Total deducciones del empleado
        const deduccionesEmpleado = saludEmpleado + pensionEmpleado;

        // Total costos del empleador
        const costosEmpleador =
          cesantias + primaServicios + interesesCesantias + saludEmpleador + pensionEmpleador + riesgosLaborales;

        // Salario neto (lo que recibe el empleado)
        const salarioNeto = subtotalSalario + bonificaciones - deduccionesEmpleado;

        // Costo total para la empresa
        const costoTotalEmpresa = subtotalSalario + bonificaciones + costosEmpleador;

        document.getElementById('detallesNomina').innerHTML = `
          <div class="detalle-item">
            <strong>Empleado:</strong> ${empleado.nombre}
          </div>
          <div class="detalle-item">
            <strong>Período:</strong> ${obtenerNombreMes(mes)} ${anio}
          </div>
          <div class="detalle-item">
            <strong>Total horas normales:</strong> ${totalHoras.toFixed(2)} hrs
          </div>
          <div class="detalle-item">
            <strong>Horas extras:</strong> ${horasExtras.toFixed(2)} hrs (${formatearMoneda(valorHorasExtras)})
          </div>
          <div class="detalle-item">
            <strong>Horas nocturnas:</strong> ${horasNocturnas.toFixed(2)} hrs (${formatearMoneda(valorHorasNocturnas)})
          </div>
          <div class="detalle-item">
            <strong>Horas dominicales:</strong> ${horasDominicales.toFixed(2)} hrs (${formatearMoneda(
          valorHorasDominicales
        )})
          </div>
          <div class="detalle-item">
            <strong>Salario base:</strong> ${formatearMoneda(salarioMensual)}
          </div>
          <div class="detalle-item">
            <strong>Subtotal salario:</strong> ${formatearMoneda(subtotalSalario)}
          </div>
          <div class="detalle-item">
            <strong>Bonificaciones:</strong> ${formatearMoneda(bonificaciones)}
          </div>
          <div class="detalle-item">
            <strong>Deducciones empleado:</strong> ${formatearMoneda(deduccionesEmpleado)}
          </div>
          <div class="detalle-item total">
            <strong>Salario neto empleado:</strong> ${formatearMoneda(salarioNeto)}
          </div>
          <hr style="margin: 10px 0; border: 1px solid #e2e8f0;">
          <div class="detalle-item">
            <strong>Cesantías:</strong> ${formatearMoneda(cesantias)}
          </div>
          <div class="detalle-item">
            <strong>Prima de servicios:</strong> ${formatearMoneda(primaServicios)}
          </div>
          <div class="detalle-item">
            <strong>Intereses cesantías:</strong> ${formatearMoneda(interesesCesantias)}
          </div>
          <div class="detalle-item">
            <strong>Aportes empleador:</strong> ${formatearMoneda(saludEmpleador + pensionEmpleador + riesgosLaborales)}
          </div>
          <div class="detalle-item total-empleador">
            <strong>Costo total empresa:</strong> ${formatearMoneda(costoTotalEmpresa)}
          </div>
        `;

        document.getElementById('resumenNomina').style.display = 'block';
      }

      // Generar nómina (función global)
      window.generarNomina = function(event) {
        if (event) {
          event.preventDefault();
        }

        try {
          // Validar campos requeridos
          const empleadoId = document.getElementById('empleadoNomina')?.value;
          const mes = document.getElementById('mesNomina')?.value;
          const anio = document.getElementById('anioNomina')?.value;

          if (!empleadoId || !mes || !anio) {
            mostrarNotificacion('Por favor completa todos los campos requeridos', 'error');
            return;
          }

          const empleado = empleados.find((e) => e.id == empleadoId);
          if (!empleado) {
            mostrarNotificacion('Empleado no encontrado', 'error');
            return;
          }

          // Filtrar horas del empleado para el mes y año especificados
          const horasEmpleado = horas.filter((h) => {
            if (h.empleado_id != empleadoId) return false;

            const fechaHora = new Date(h.fecha);
            return fechaHora.getMonth() + 1 == mes && fechaHora.getFullYear() == anio;
          });

          if (horasEmpleado.length === 0) {
            mostrarNotificacion('No hay horas registradas para este empleado en el período seleccionado', 'error');
            return;
          }

          // Calcular totales de horas
          const totalHoras = horasEmpleado.reduce((sum, h) => sum + (h.horas_trabajadas || 0), 0);
          const horasExtras = horasEmpleado.reduce((sum, h) => sum + (h.horas_extras || 0), 0);
          const horasNocturnas = horasEmpleado.reduce((sum, h) => sum + (h.horas_nocturnas || 0), 0);
          const horasDominicales = horasEmpleado.reduce((sum, h) => sum + (h.horas_dominicales || 0), 0);

          // Salario base y cálculos
          const salarioBase = empleado.salario || 0;
          const salarioPorHora = empleado.tipo_contrato === 'Por Horas' ? salarioBase / 160 : salarioBase / 160;
          const salarioMensual = empleado.tipo_contrato === 'Por Horas' ? totalHoras * salarioPorHora : salarioBase;

          // Cálculo de horas extras (25% adicional)
          const valorHorasExtras = horasExtras * salarioPorHora * 1.25;

          // Cálculo de horas nocturnas (35% adicional)
          const valorHorasNocturnas = horasNocturnas * salarioPorHora * 1.35;

          // Cálculo de horas dominicales (75% adicional)
          const valorHorasDominicales = horasDominicales * salarioPorHora * 1.75;

          // Subtotal de salario
          const subtotalSalario = salarioMensual + valorHorasExtras + valorHorasNocturnas + valorHorasDominicales;

          // Bonificaciones (10% del salario base)
          const bonificaciones = salarioMensual * 0.1;

          // Cálculo de prestaciones sociales
          const cesantias = subtotalSalario * 0.0833; // 8.33% mensual
          const primaServicios = subtotalSalario * 0.0833; // 8.33% mensual
          const interesesCesantias = cesantias * 0.12; // 12% anual, 1% mensual

          // Cálculo de aportes del empleado
          const saludEmpleado = subtotalSalario * 0.04; // 4% salud
          const pensionEmpleado = subtotalSalario * 0.04; // 4% pensión

          // Cálculo de aportes del empleador
          const saludEmpleador = subtotalSalario * 0.085; // 8.5% salud
          const pensionEmpleador = subtotalSalario * 0.12; // 12% pensión
          const riesgosLaborales = subtotalSalario * 0.00522; // 0.522% ARL (promedio)

          // Total deducciones del empleado
          const deduccionesEmpleado = saludEmpleado + pensionEmpleado;

          // Total costos del empleador
          const costosEmpleador =
            cesantias + primaServicios + interesesCesantias + saludEmpleador + pensionEmpleador + riesgosLaborales;

          // Salario neto (lo que recibe el empleado)
          const salarioNeto = subtotalSalario + bonificaciones - deduccionesEmpleado;

          // Costo total para la empresa
          const costoTotalEmpresa = subtotalSalario + bonificaciones + costosEmpleador;

          // Crear objeto nómina
          const nomina = {
            id: Date.now(),
            empleado_id: parseInt(empleadoId),
            mes: parseInt(mes),
            anio: parseInt(anio),
            tipo_nomina: document.getElementById('tipoNomina')?.value || 'mensual',
            horas_trabajadas: totalHoras,
            horas_extras: horasExtras,
            horas_nocturnas: horasNocturnas,
            horas_dominicales: horasDominicales,
            salario_base: salarioMensual,
            salario_por_hora: salarioPorHora,
            valor_horas_extras: valorHorasExtras,
            valor_horas_nocturnas: valorHorasNocturnas,
            valor_horas_dominicales: valorHorasDominicales,
            subtotal_salario: subtotalSalario,
            bonificaciones: bonificaciones,
            cesantias: cesantias,
            prima_servicios: primaServicios,
            intereses_cesantias: interesesCesantias,
            salud_empleado: saludEmpleado,
            pension_empleado: pensionEmpleado,
            deducciones: deduccionesEmpleado,
            salario_neto: salarioNeto,
            salud_empleador: saludEmpleador,
            pension_empleador: pensionEmpleador,
            riesgos_laborales: riesgosLaborales,
            costos_empleador: costosEmpleador,
            costo_total_empresa: costoTotalEmpresa,
            estado: 'Generada',
            fecha_generacion: new Date().toISOString(),
            userId: currentUser?.username || currentUser?.email || 'axyra',
          };

          // Agregar a la lista de nóminas
          nominas.push(nomina);

          // Guardar en localStorage
          localStorage.setItem('axyra_nominas', JSON.stringify(nominas));

          // Cerrar modal y actualizar tabla
          cerrarModal('modalGenerarNomina');
          renderizarTablaNominas();

          // Mostrar notificación de éxito
          mostrarNotificacion(
            `Nómina generada correctamente para ${empleado.nombre}. Salario neto: ${formatearMoneda(salarioNeto)}`,
            'success'
          );

          console.log('✅ Nómina generada:', nomina);
        } catch (error) {
          console.error('❌ Error generando nómina:', error);
          mostrarNotificacion('Error generando nómina: ' + error.message, 'error');
        }
      }

      // Ver nómina (función global)
      window.verNomina = function(id) {
        const nomina = nominas.find((n) => n.id === id);
        if (!nomina) {
          mostrarNotificacion('Nómina no encontrada', 'error');
          return;
        }

        const empleado = empleados.find((e) => e.id === nomina.empleado_id);

        // Mostrar información de la nómina en una notificación
        const info = `
          <strong>Nómina #${nomina.id}</strong><br>
          <strong>Empleado:</strong> ${empleado ? empleado.nombre : 'No encontrado'}<br>
          <strong>Período:</strong> ${obtenerNombreMes(nomina.mes)} ${nomina.anio}<br>
          <strong>Tipo:</strong> ${nomina.tipo_nomina || 'Mensual'}<br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>HORAS TRABAJADAS:</strong><br>
          • Normales: ${nomina.horas_trabajadas || 0} hrs<br>
          • Extras: ${nomina.horas_extras || 0} hrs (${formatearMoneda(nomina.valor_horas_extras || 0)})<br>
          • Nocturnas: ${nomina.horas_nocturnas || 0} hrs (${formatearMoneda(nomina.valor_horas_nocturnas || 0)})<br>
          • Dominicales: ${nomina.horas_dominicales || 0} hrs (${formatearMoneda(
          nomina.valor_horas_dominicales || 0
        )})<br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>LIQUIDACIÓN:</strong><br>
          • Salario base: ${formatearMoneda(nomina.salario_base)}<br>
          • Subtotal salario: ${formatearMoneda(nomina.subtotal_salario || nomina.salario_base)}<br>
          • Bonificaciones: ${formatearMoneda(nomina.bonificaciones)}<br>
          • Deducciones empleado: ${formatearMoneda(nomina.deducciones)}<br>
          <strong>• Salario neto: ${formatearMoneda(nomina.salario_neto)}</strong><br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>PRESTACIONES SOCIALES:</strong><br>
          • Cesantías: ${formatearMoneda(nomina.cesantias)}<br>
          • Prima servicios: ${formatearMoneda(nomina.prima_servicios)}<br>
          • Intereses cesantías: ${formatearMoneda(nomina.intereses_cesantias)}<br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>APORTES EMPLEADOR:</strong><br>
          • Salud: ${formatearMoneda(nomina.salud_empleador)}<br>
          • Pensión: ${formatearMoneda(nomina.pension_empleador)}<br>
          • Riesgos laborales: ${formatearMoneda(nomina.riesgos_laborales)}<br>
          <strong>• Costo total empresa: ${formatearMoneda(nomina.costo_total_empresa)}</strong><br>
          <hr style="margin: 5px 0; border: 1px solid #e2e8f0;">
          <strong>Fecha generación:</strong> ${new Date(nomina.fecha_generacion).toLocaleDateString('es-ES')}
        `;

        // Mostrar modal con información detallada
        mostrarModalDetalleNomina(nomina, empleado);
      }

      // Mostrar modal de detalle de nómina
      function mostrarModalDetalleNomina(nomina, empleado) {
        const modal = document.getElementById('modalDetalleNomina');
        if (modal) {
          // Llenar contenido del modal
          document.getElementById('detalleNominaTitulo').textContent = `Nómina #${nomina.id}`;
          document.getElementById('detalleNominaEmpleado').textContent = empleado ? empleado.nombre : 'No encontrado';
          document.getElementById('detalleNominaPeriodo').textContent = `${obtenerNombreMes(nomina.mes)} ${nomina.anio}`;
          document.getElementById('detalleNominaTipo').textContent = nomina.tipo_nomina || 'Mensual';
          
          // Llenar detalles de horas
          document.getElementById('detalleHorasNormales').textContent = `${nomina.horas_trabajadas || 0} hrs`;
          document.getElementById('detalleHorasExtras').textContent = `${nomina.horas_extras || 0} hrs`;
          document.getElementById('detalleHorasNocturnas').textContent = `${nomina.horas_nocturnas || 0} hrs`;
          document.getElementById('detalleHorasDominicales').textContent = `${nomina.horas_dominicales || 0} hrs`;
          
          // Llenar valores monetarios
          document.getElementById('detalleSalarioBase').textContent = formatearMoneda(nomina.salario_base);
          document.getElementById('detalleSubtotalSalario').textContent = formatearMoneda(nomina.subtotal_salario || nomina.salario_base);
          document.getElementById('detalleBonificaciones').textContent = formatearMoneda(nomina.bonificaciones);
          document.getElementById('detalleDeducciones').textContent = formatearMoneda(nomina.deducciones);
          document.getElementById('detalleSalarioNeto').textContent = formatearMoneda(nomina.salario_neto);
          
          // Llenar prestaciones sociales
          document.getElementById('detalleCesantias').textContent = formatearMoneda(nomina.cesantias);
          document.getElementById('detallePrimaServicios').textContent = formatearMoneda(nomina.prima_servicios);
          document.getElementById('detalleInteresesCesantias').textContent = formatearMoneda(nomina.intereses_cesantias);
          
          // Llenar costos del empleador
          document.getElementById('detalleSaludEmpleador').textContent = formatearMoneda(nomina.salud_empleador);
          document.getElementById('detallePensionEmpleador').textContent = formatearMoneda(nomina.pension_empleador);
          document.getElementById('detalleRiesgosLaborales').textContent = formatearMoneda(nomina.riesgos_laborales);
          document.getElementById('detalleCostoTotalEmpresa').textContent = formatearMoneda(nomina.costo_total_empresa);

        // Mostrar modal
          mostrarModal('modalDetalleNomina');
        }
      }

      // Eliminar nómina (función global)
      window.eliminarNomina = function(id) {
        try {
          const nomina = nominas.find((n) => n.id === id);
          if (!nomina) {
            mostrarNotificacion('Nómina no encontrada', 'error');
            return;
          }

          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          const nombreEmpleado = empleado ? empleado.nombre : 'Empleado no encontrado';

          // Mostrar modal de confirmación
          mostrarModalConfirmacion(
            'Eliminar Nómina',
            `¿Estás seguro de que quieres eliminar la nómina #${id} de ${nombreEmpleado}? Esta acción no se puede deshacer.`,
            () => {
              // Eliminar de la lista
          nominas = nominas.filter((n) => n.id !== id);

          // Guardar en localStorage
          localStorage.setItem('axyra_nominas', JSON.stringify(nominas));

              // Actualizar tabla
          renderizarTablaNominas();

              // Cerrar modal
              cerrarModal('modalConfirmacion');

              // Mostrar notificación
              mostrarNotificacion(`Nómina #${id} eliminada correctamente`, 'success');
            }
          );
        } catch (error) {
          console.error('❌ Error eliminando nómina:', error);
          mostrarNotificacion('Error eliminando nómina: ' + error.message, 'error');
        }
      }

      // Mostrar modal de confirmación (función global)
      window.mostrarModalConfirmacion = function(titulo, mensaje, accion) {
        document.getElementById('modalConfirmacionTitulo').textContent = titulo;
        document.getElementById('modalConfirmacionMensaje').textContent = mensaje;
        
        const btnConfirmar = document.getElementById('btnConfirmarAccion');
        btnConfirmar.onclick = accion;
        
        mostrarModal('modalConfirmacion');
      }

      // Guardar configuración de nómina (función global)
      window.guardarConfiguracionNomina = function() {
        try {
          const configuracion = {
            salarioMinimo: parseFloat(document.getElementById('salarioMinimo')?.value) || 0,
            porcentajeCesantias: parseFloat(document.getElementById('porcentajeCesantias')?.value) || 8.33,
            porcentajePrima: parseFloat(document.getElementById('porcentajePrima')?.value) || 8.33,
            porcentajeInteresesCesantias: parseFloat(document.getElementById('porcentajeInteresesCesantias')?.value) || 12,
            porcentajeSalud: parseFloat(document.getElementById('porcentajeSalud')?.value) || 4,
            porcentajePension: parseFloat(document.getElementById('porcentajePension')?.value) || 4,
            fechaActualizacion: new Date().toISOString(),
            userId: currentUser?.username || currentUser?.email || 'axyra'
          };

          // Guardar en localStorage
          localStorage.setItem('axyra_configuracion_nomina', JSON.stringify(configuracion));

          // Cerrar modal
          cerrarModal('modalConfiguracionNomina');

          // Mostrar notificación
          mostrarNotificacion('Configuración guardada correctamente', 'success');

          console.log('✅ Configuración guardada:', configuracion);
        } catch (error) {
          console.error('❌ Error guardando configuración:', error);
          mostrarNotificacion('Error guardando configuración: ' + error.message, 'error');
        }
      }

      // Generar reportes avanzados (función global)
      window.generarReporte = function(tipoReporte) {
        try {
          let contenido = '';
          let titulo = '';

          switch (tipoReporte) {
            case 'costosLaborales':
              contenido = generarReporteCostosLaborales();
              titulo = 'Reporte de Costos Laborales';
              break;
            case 'prestacionesSociales':
              contenido = generarReportePrestacionesSociales();
              titulo = 'Reporte de Prestaciones Sociales';
              break;
            case 'horasTrabajadas':
              contenido = generarReporteHorasTrabajadas();
              titulo = 'Análisis de Horas Trabajadas';
              break;
            case 'comparativoSalarios':
              contenido = generarReporteComparativoSalarios();
              titulo = 'Comparativo de Salarios';
              break;
            case 'tendenciasSalariales':
              contenido = generarReporteTendenciasSalariales();
              titulo = 'Tendencias Salariales';
              break;
            case 'resumenMensual':
              contenido = generarReporteResumenMensual();
              titulo = 'Resumen Mensual de Nómina';
              break;
            default:
              mostrarNotificacion('Tipo de reporte no válido', 'error');
              return;
          }

          // Mostrar reporte en nueva ventana
          mostrarReporte(titulo, contenido);
        } catch (error) {
          console.error('❌ Error generando reporte:', error);
          mostrarNotificacion('Error generando reporte: ' + error.message, 'error');
        }
      }

      // Exportar nómina (función global)
      window.exportarNomina = function() {
        try {
          if (nominas.length === 0) {
            mostrarNotificacion('No hay nóminas generadas para exportar', 'warning');
            return;
          }

          console.log('📊 Iniciando exportación de nóminas...');
          console.log('📋 Total de nóminas a exportar:', nominas.length);

          // Verificar si XLSX está disponible
          if (typeof XLSX === 'undefined') {
            mostrarNotificacion('Error: Librería XLSX no está disponible', 'error');
            return;
          }

          // Crear datos para exportar
            const data = [
              ['REPORTE DE NÓMINAS - Villa Venecia'],
              ['EMPRESA: Villa Venecia'],
              ['NIT: NIT Pendiente'],
              [`FECHA DE EXPORTACIÓN: ${new Date().toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}`],
              [],
              ['ID', 'Empleado', 'Cédula', 'Período', 'Horas Normales', 'Horas Extras', 'Horas Nocturnas', 'Horas Dominicales', 'Salario Base', 'Bonificaciones', 'Deducciones', 'Salario Neto', 'Costo Empresa', 'Estado', 'Fecha Generación']
            ];

          // Agregar datos de cada nómina
          nominas.forEach((n, index) => {
              const empleado = empleados.find((e) => e.id === n.empleado_id);
            console.log(`📝 Procesando nómina ${index + 1}:`, n.id, empleado?.nombre);
            
              data.push([
                n.id || 'N/A',
                empleado ? empleado.nombre : 'Empleado no encontrado',
                empleado ? empleado.cedula || 'N/A' : 'N/A',
                `${obtenerNombreMes(n.mes)} ${n.anio}`,
                (n.horas_trabajadas || 0).toLocaleString('es-CO'),
                (n.horas_extras || 0).toLocaleString('es-CO'),
                (n.horas_nocturnas || 0).toLocaleString('es-CO'),
                (n.horas_dominicales || 0).toLocaleString('es-CO'),
                formatearMoneda(n.salario_base),
                formatearMoneda(n.bonificaciones || 0),
                formatearMoneda(n.deducciones || 0),
                formatearMoneda(n.salario_neto),
                formatearMoneda(n.costo_total_empresa),
                n.estado || 'Generada',
                new Date(n.fecha_generacion).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })
              ]);
            });

            // Agregar totales
            data.push([]);
          const totales = [
            'TOTALES', '', '', '', 
              nominas.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0).toLocaleString('es-CO'),
              nominas.reduce((sum, n) => sum + (n.horas_extras || 0), 0).toLocaleString('es-CO'),
              nominas.reduce((sum, n) => sum + (n.horas_nocturnas || 0), 0).toLocaleString('es-CO'),
              nominas.reduce((sum, n) => sum + (n.horas_dominicales || 0), 0).toLocaleString('es-CO'),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.salario_base || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.bonificaciones || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.deducciones || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.salario_neto || 0), 0)),
              formatearMoneda(nominas.reduce((sum, n) => sum + (n.costo_total_empresa || 0), 0)),
              '', ''
          ];
          data.push(totales);

          console.log('📊 Datos preparados para exportación');

          // Crear hoja de trabajo
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Nóminas');

            // Ajustar ancho de columnas
            ws['!cols'] = [
              { width: 8 }, { width: 25 }, { width: 15 }, { width: 15 },
              { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 },
              { width: 18 }, { width: 18 }, { width: 18 }, { width: 18 },
              { width: 18 }, { width: 12 }, { width: 20 }
            ];

          // Generar nombre de archivo
            const now = new Date();
            const colombiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
            const fileName = `REPORTE_NOMINAS_Villa_Venecia_${colombiaTime.toISOString().split('T')[0]}_${colombiaTime.getHours().toString().padStart(2, '0')}-${colombiaTime.getMinutes().toString().padStart(2, '0')}.xlsx`;
            
          console.log('💾 Descargando archivo:', fileName);

          // Descargar archivo
            XLSX.writeFile(wb, fileName);
          
          console.log('✅ Exportación completada exitosamente');
            mostrarNotificacion('Nóminas exportadas correctamente con formato profesional', 'success');
          
        } catch (error) {
          console.error('❌ Error exportando nóminas:', error);
          mostrarNotificacion('Error exportando nóminas: ' + error.message, 'error');
        }
      }

      // Generar comprobante PDF (función global)
      window.generarComprobantePDF = function() {
        try {
          // Verificar si hay nóminas seleccionadas
          const nominasSeleccionadas = nominas.filter((n) => n.estado === 'Generada');

          if (nominasSeleccionadas.length === 0) {
            mostrarNotificacion('No hay nóminas generadas para crear comprobantes PDF', 'warning');
            return;
          }

          // Crear contenido del PDF
          const contenidoPDF = crearContenidoPDF(nominasSeleccionadas);

          // Generar PDF usando jsPDF
          if (typeof window.jspdf !== 'undefined') {
            generarPDFConJsPDF(contenidoPDF);
          } else {
            // Fallback: mostrar contenido en nueva ventana para imprimir
            mostrarContenidoParaImprimir(contenidoPDF);
          }

          mostrarNotificacion('Comprobantes PDF generados correctamente', 'success');
        } catch (error) {
          console.error('❌ Error generando PDF:', error);
          mostrarNotificacion('Error generando PDF: ' + error.message, 'error');
        }
      }

      // Crear contenido del PDF
      function crearContenidoPDF(nominas) {
        let contenido = '';

        nominas.forEach((nomina, index) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          contenido += `
            <div style="page-break-after: always; padding: 20px; font-family: Arial, sans-serif;">
              <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="color: #667eea; margin: 0;">COMPROBANTE DE PAGO DE NÓMINA</h1>
                <h2 style="color: #764ba2; margin: 10px 0;">AXYRA - Sistema de Gestión</h2>
                <p style="margin: 5px 0;">Período: ${obtenerNombreMes(nomina.mes)} ${nomina.anio}</p>
                <p style="margin: 5px 0;">Fecha de generación: ${new Date(nomina.fecha_generacion).toLocaleDateString(
                  'es-ES'
                )}</p>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">INFORMACIÓN DEL EMPLEADO</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 30%;">Nombre:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.nombre}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Cédula:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.cedula || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Cargo:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.cargo || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tipo Contrato:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${empleado.tipo_contrato || 'N/A'}</td>
                  </tr>
                </table>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">HORAS TRABAJADAS</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="background-color: #f8f9fa;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Tipo de Hora</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Cantidad</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Valor</th>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Normales</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_trabajadas || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.salario_base
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Extras</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_extras || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.valor_horas_extras || 0
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Nocturnas</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_nocturnas || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.valor_horas_nocturnas || 0
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Horas Dominicales</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                      nomina.horas_dominicales || 0
                    } hrs</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.valor_horas_dominicales || 0
                    )}</td>
                  </tr>
                </table>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">LIQUIDACIÓN DE NÓMINA</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="background-color: #f8f9fa;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Concepto</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Valor</th>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Subtotal Salario</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.subtotal_salario || nomina.salario_base
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Bonificaciones</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.bonificaciones
                    )}</td>
                  </tr>
                  <tr style="background-color: #f1f3f4;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">Total Devengado</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatearMoneda(
                      (nomina.subtotal_salario || nomina.salario_base) + nomina.bonificaciones
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Salud (4%)</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">-${formatearMoneda(
                      nomina.salud_empleado
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">Pensión (4%)</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">-${formatearMoneda(
                      nomina.pension_empleado
                    )}</td>
                  </tr>
                  <tr style="background-color: #f1f3f4;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">Total Deducciones</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">-${formatearMoneda(
                      nomina.deducciones
                    )}</td>
                  </tr>
                  <tr style="background-color: #e8f5e8; border: 2px solid #4caf50;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">SALARIO NETO A PAGAR</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 16px; color: #2e7d32;">${formatearMoneda(
                      nomina.salario_neto
                    )}</td>
                  </tr>
                </table>
              </div>
              
              <div style="margin-bottom: 30px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">PRESTACIONES SOCIALES</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 50%;">Cesantías (8.33%)</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.cesantias
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Prima de Servicios (8.33%)</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.prima_servicios
                    )}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Intereses sobre Cesantías (12%)</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                      nomina.intereses_cesantias
                    )}</td>
                  </tr>
                </table>
              </div>
              
              <div style="text-align: center; margin-top: 50px; padding-top: 30px; border-top: 2px solid #333;">
                <p style="margin: 5px 0; font-size: 14px;">Este documento es generado automáticamente por el sistema AXYRA</p>
                <p style="margin: 5px 0; font-size: 12px; color: #666;">ID de Nómina: ${nomina.id} | Fecha: ${new Date(
            nomina.fecha_generacion
          ).toLocaleDateString('es-ES')}</p>
              </div>
            </div>
          `;

          if (index < nominas.length - 1) {
            contenido += '<div style="page-break-after: always;"></div>';
          }
        });

        return contenido;
      }

      // Generar PDF con jsPDF
      function generarPDFConJsPDF(contenido) {
        // Esta función se implementaría si jsPDF estuviera disponible
        console.log('Generando PDF con jsPDF...');
        mostrarContenidoParaImprimir(contenido);
      }

      // Mostrar contenido para imprimir
      function mostrarContenidoParaImprimir(contenido) {
        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Comprobantes de Nómina - AXYRA</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                @media print {
                  body { padding: 0; }
                  .no-print { display: none; }
                }
              </style>
            </head>
            <body>
              <div class="no-print" style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h2>Comprobantes de Nómina - AXYRA</h2>
                <p>Presiona Ctrl+P para imprimir o guardar como PDF</p>
                <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  Imprimir / Guardar PDF
                </button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                  Cerrar
                </button>
              </div>
              ${contenido}
            </body>
          </html>
        `);
        ventanaImpresion.document.close();
      }

      // Funciones auxiliares
      function formatearMoneda(amount) {
        if (!amount || amount === 0) return '$0';
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
        }).format(amount);
      }

      // Formatear número con separadores de miles
      function formatearNumero(numero) {
        if (!numero || numero === 0) return '0';
        return numero.toLocaleString('es-CO', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      }

      function obtenerNombreMes(mes) {
        const meses = [
          'Enero',
          'Febrero',
          'Marzo',
          'Abril',
          'Mayo',
          'Junio',
          'Julio',
          'Agosto',
          'Septiembre',
          'Octubre',
          'Noviembre',
          'Diciembre',
        ];
        return meses[mes - 1] || 'Mes inválido';
      }

      // Función de logout (función global)
      window.logout = function() {
        try {
          // Limpiar datos de sesión
            localStorage.removeItem('axyra_isolated_user');
            localStorage.removeItem('axyra_firebase_user');
          
          // Redirigir al login
            window.location.href = '../../login.html';
        } catch (error) {
          console.error('❌ Error en logout:', error);
          window.location.href = '../../login.html';
        }
      }

      // Sistema de notificaciones
      function mostrarNotificacion(mensaje, tipo = 'info', duracion = 5000) {
        const container = document.getElementById('notificationContainer');
        if (!container) return;

        const notification = document.createElement('div');
        notification.className = `notification ${tipo}`;
        notification.innerHTML = `
          <div class="notification-content">
            <span class="notification-message">${mensaje}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;

        container.appendChild(notification);

        // Auto-remover después del tiempo especificado
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, duracion);
      }

      // Cerrar modales al hacer click fuera
      window.onclick = function (event) {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      };

      // Generar reportes (función global)
      window.generarReportes = function() {
        mostrarModal('modalReportesAvanzados');
      }

      // Configuración de nómina (función global)
      window.configuracionNomina = function() {
        mostrarModal('modalConfiguracionNomina');
      }

      // Generar reporte de costos laborales
      function generarReporteCostosLaborales() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">REPORTE DE COSTOS LABORALES</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Base</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Prestaciones</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Aportes Empleador</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Costo Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        let totalCostos = 0;
        nominas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          const prestaciones =
            (nomina.cesantias || 0) + (nomina.prima_servicios || 0) + (nomina.intereses_cesantias || 0);
          const aportesEmpleador =
            (nomina.salud_empleador || 0) + (nomina.pension_empleador || 0) + (nomina.riesgos_laborales || 0);
          const costoTotal = (nomina.salario_base || 0) + prestaciones + aportesEmpleador;
          totalCostos += costoTotal;

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.salario_base
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                prestaciones
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                aportesEmpleador
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatearMoneda(
                costoTotal
              )}</td>
            </tr>
          `;
        });

        contenido += `
            <tr style="background: #f8f9fa; font-weight: bold;">
              <td style="padding: 12px; border: 1px solid #ddd;">TOTAL</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nominas.reduce((sum, n) => sum + (n.salario_base || 0), 0)
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nominas.reduce(
                  (sum, n) => sum + (n.cesantias || 0) + (n.prima_servicios || 0) + (n.intereses_cesantias || 0),
                  0
                )
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nominas.reduce(
                  (sum, n) => sum + (n.salud_empleador || 0) + (n.pension_empleador || 0) + (n.riesgos_laborales || 0),
                  0
                )
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #dc2626; font-size: 16px;">${formatearMoneda(
                totalCostos
              )}</td>
            </tr>
          </tbody>
        </table>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px;">
          <h3 style="color: #333; margin-top: 0;">Resumen Ejecutivo</h3>
          <p><strong>Total empleados:</strong> ${empleados.length}</p>
          <p><strong>Total nóminas generadas:</strong> ${nominas.length}</p>
          <p><strong>Costo total para la empresa:</strong> ${formatearMoneda(totalCostos)}</p>
          <p><strong>Costo promedio por empleado:</strong> ${formatearMoneda(
            empleados.length > 0 ? totalCostos / empleados.length : 0
          )}</p>
        </div>
        `;

        return contenido;
      }

      // Generar reporte de prestaciones sociales
      function generarReportePrestacionesSociales() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">REPORTE DE PRESTACIONES SOCIALES</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h3 style="color: #2e7d32; margin-top: 0;">Cesantías</h3>
              <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${formatearMoneda(nominas.reduce((sum, n) => sum + (n.cesantias || 0), 0))}
              </p>
              <p style="margin: 0; color: #666;">8.33% del salario mensual</p>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h3 style="color: #e65100; margin-top: 0;">Prima de Servicios</h3>
              <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">
                ${formatearMoneda(nominas.reduce((sum, n) => sum + (n.prima_servicios || 0), 0))}
              </p>
              <p style="margin: 0; color: #666;">8.33% del salario mensual</p>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h3 style="color: #1565c0; margin-top: 0;">Intereses Cesantías</h3>
              <p style="font-size: 24px; font-weight: bold; color: #1565c0; margin: 10px 0;">
                ${formatearMoneda(nominas.reduce((sum, n) => sum + (n.intereses_cesantias || 0), 0))}
              </p>
              <p style="margin: 0; color: #666;">12% anual sobre cesantías</p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Cesantías</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Prima Servicios</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Intereses</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        nominas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          const total = (nomina.cesantias || 0) + (nomina.prima_servicios || 0) + (nomina.intereses_cesantias || 0);

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.cesantias
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.prima_servicios
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.intereses_cesantias
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${formatearMoneda(
                total
              )}</td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte de horas trabajadas
      function generarReporteHorasTrabajadas() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">ANÁLISIS DE HORAS TRABAJADAS</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h3 style="color: #2e7d32; margin-top: 0;">Horas Normales</h3>
              <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h3 style="color: #e65100; margin-top: 0;">Horas Extras</h3>
              <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_extras || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h3 style="color: #1565c0; margin-top: 0;">Horas Nocturnas</h3>
              <p style="font-size: 24px; font-weight: bold; color: #1565c0; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_nocturnas || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #fce4ec; padding: 20px; border-radius: 8px; border-left: 4px solid #e91e63;">
              <h3 style="color: #ad1457; margin-top: 0;">Horas Dominicales</h3>
              <p style="font-size: 24px; font-weight: bold; color: #ad1457; margin: 10px 0;">
                ${nominas.reduce((sum, n) => sum + (n.horas_dominicales || 0), 0).toFixed(2)} hrs
              </p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Normales</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Extras</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Nocturnas</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Dominicales</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        nominas.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          const total =
            (nomina.horas_trabajadas || 0) +
            (nomina.horas_extras || 0) +
            (nomina.horas_nocturnas || 0) +
            (nomina.horas_dominicales || 0);

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                nomina.horas_trabajadas || 0
              }</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${nomina.horas_extras || 0}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${nomina.horas_nocturnas || 0}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                nomina.horas_dominicales || 0
              }</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${total.toFixed(
                2
              )}</td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte comparativo de salarios
      function generarReporteComparativoSalarios() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">COMPARATIVO DE SALARIOS</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Cargo</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Base</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Neto</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Costo Empresa</th>
              </tr>
            </thead>
            <tbody>
        `;

        // Agrupar por cargo
        const empleadosPorCargo = {};
        empleados.forEach((empleado) => {
          const cargo = empleado.cargo || 'Sin cargo';
          if (!empleadosPorCargo[cargo]) {
            empleadosPorCargo[cargo] = [];
          }
          empleadosPorCargo[cargo].push(empleado);
        });

        Object.keys(empleadosPorCargo).forEach((cargo) => {
          const empleadosCargo = empleadosPorCargo[cargo];

          // Agregar fila de encabezado del cargo
          contenido += `
            <tr style="background: #f8f9fa;">
              <td colspan="5" style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">
                ${cargo} (${empleadosCargo.length} empleado${empleadosCargo.length > 1 ? 's' : ''})
              </td>
            </tr>
          `;

          empleadosCargo.forEach((empleado) => {
            const nomina = nominas.find((n) => n.empleado_id === empleado.id);
            if (nomina) {
              contenido += `
                <tr>
                  <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
                  <td style="padding: 12px; border: 1px solid #ddd;">${cargo}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                    empleado.salario
                  )}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                    nomina.salario_neto
                  )}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                    nomina.costo_total_empresa
                  )}</td>
                </tr>
              `;
            }
          });
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte de tendencias salariales
      function generarReporteTendenciasSalariales() {
        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">TENDENCIAS SALARIALES</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${new Date().toLocaleDateString(
            'es-ES'
          )}</p>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="color: #333; margin-top: 0;">Estadísticas Generales</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
              <div>
                <p style="margin: 5px 0;"><strong>Salario promedio:</strong> ${formatearMoneda(
                  empleados.length > 0 ? empleados.reduce((sum, e) => sum + (e.salario || 0), 0) / empleados.length : 0
                )}</p>
                <p style="margin: 5px 0;"><strong>Salario mínimo:</strong> ${formatearMoneda(
                  Math.min(...empleados.map((e) => e.salario || 0))
                )}</p>
                <p style="margin: 5px 0;"><strong>Salario máximo:</strong> ${formatearMoneda(
                  Math.max(...empleados.map((e) => e.salario || 0))
                )}</p>
              </div>
              <div>
                <p style="margin: 5px 0;"><strong>Total empleados:</strong> ${empleados.length}</p>
                <p style="margin: 5px 0;"><strong>Empleados con salario > $2M:</strong> ${
                  empleados.filter((e) => (e.salario || 0) > 2000000).length
                }</p>
                <p style="margin: 5px 0;"><strong>Empleados con salario < $1M:</strong> ${
                  empleados.filter((e) => (e.salario || 0) < 1000000).length
                }</p>
              </div>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Rango Salarial</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Cantidad Empleados</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Porcentaje</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Total Salarios</th>
              </tr>
            </thead>
            <tbody>
        `;

        const rangos = [
          { min: 0, max: 1000000, label: 'Menos de $1M' },
          { min: 1000000, max: 2000000, label: '$1M - $2M' },
          { min: 2000000, max: 3000000, label: '$2M - $3M' },
          { min: 3000000, max: 5000000, label: '$3M - $5M' },
          { min: 5000000, max: Infinity, label: 'Más de $5M' },
        ];

        rangos.forEach((rango) => {
          const empleadosEnRango = empleados.filter((e) => {
            const salario = e.salario || 0;
            return salario >= rango.min && salario < rango.max;
          });

          const totalSalarios = empleadosEnRango.reduce((sum, e) => sum + (e.salario || 0), 0);
          const porcentaje = empleados.length > 0 ? ((empleadosEnRango.length / empleados.length) * 100).toFixed(1) : 0;

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${rango.label}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${empleadosEnRango.length}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${porcentaje}%</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                totalSalarios
              )}</td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Generar reporte resumen mensual
      function generarReporteResumenMensual() {
        const mesActual = new Date().getMonth() + 1;
        const anioActual = new Date().getFullYear();
        const nominasMes = nominas.filter((n) => n.mes === mesActual && n.anio === anioActual);

        let contenido = `
          <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">RESUMEN MENSUAL DE NÓMINA</h2>
          <p style="text-align: center; color: #666; margin-bottom: 30px;">Período: ${obtenerNombreMes(
            mesActual
          )} ${anioActual}</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h3 style="color: #2e7d32; margin-top: 0;">Total Nóminas</h3>
              <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${nominasMes.length}
              </p>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h3 style="color: #e65100; margin-top: 0;">Total Horas</h3>
              <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">
                ${nominasMes.reduce((sum, n) => sum + (n.horas_trabajadas || 0), 0).toFixed(2)} hrs
              </p>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h3 style="color: #1565c0; margin-top: 0;">Total Salarios</h3>
              <p style="font-size: 24px; font-weight: bold; color: #1565c0; margin: 10px 0;">
                ${formatearMoneda(nominasMes.reduce((sum, n) => sum + (n.salario_neto || 0), 0))}
              </p>
            </div>
            
            <div style="background: #fce4ec; padding: 20px; border-radius: 8px; border-left: 4px solid #e91e63;">
              <h3 style="color: #ad1457; margin-top: 0;">Costo Empresa</h3>
              <p style="font-size: 24px; font-weight: bold; color: #ad1457; margin: 10px 0;">
                ${formatearMoneda(nominasMes.reduce((sum, n) => sum + (n.costo_total_empresa || 0), 0))}
              </p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Empleado</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Horas</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Salario Neto</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Costo Empresa</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Estado</th>
              </tr>
            </thead>
            <tbody>
        `;

        nominasMes.forEach((nomina) => {
          const empleado = empleados.find((e) => e.id === nomina.empleado_id);
          if (!empleado) return;

          contenido += `
            <tr>
              <td style="padding: 12px; border: 1px solid #ddd;">${empleado.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${
                nomina.horas_trabajadas || 0
              }</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.salario_neto
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${formatearMoneda(
                nomina.costo_total_empresa
              )}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                <span class="estado-badge estado-${nomina.estado?.toLowerCase() || 'generada'}">
                  ${nomina.estado || 'Generada'}
                </span>
              </td>
            </tr>
          `;
        });

        contenido += `
            </tbody>
          </table>
        `;

        return contenido;
      }

      // Mostrar reporte
      function mostrarReporte(titulo, contenido) {
        const ventanaReporte = window.open('', '_blank');
        ventanaReporte.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>${titulo} - AXYRA</title>
              <style>
                body { 
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                  margin: 0; 
                  padding: 20px; 
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                }
                .reporte-container { 
                  max-width: 1200px; 
                  margin: 0 auto; 
                  background: white; 
                  padding: 30px; 
                  border-radius: 16px; 
                  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                  position: relative;
                  overflow: hidden;
                }
                .reporte-container::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  height: 4px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                .no-print { 
                  text-align: center; 
                  margin-bottom: 30px; 
                  padding: 25px; 
                  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                  border-radius: 12px;
                  border: 1px solid #e2e8f0;
                }
                .no-print h2 {
                  color: #1e3a8a;
                  margin: 0 0 15px 0;
                  font-size: 1.8rem;
                  font-weight: 600;
                }
                .no-print p {
                  color: #64748b;
                  margin: 0 0 20px 0;
                  font-size: 1rem;
                }
                .btn { 
                  padding: 12px 24px; 
                  margin: 8px; 
                  border: none; 
                  border-radius: 8px; 
                  cursor: pointer; 
                  font-size: 14px; 
                  font-weight: 600;
                  transition: all 0.3s ease;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                }
                .btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                }
                .btn-primary { 
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                  color: white; 
                }
                .btn-secondary { 
                  background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
                  color: white; 
                }
                .btn-success {
                  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                  color: white;
                }
                .reporte-content {
                  background: white;
                  border-radius: 8px;
                  overflow: hidden;
                }
                .reporte-content h2 {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 20px;
                  margin: 0;
                  text-align: center;
                  font-size: 1.5rem;
                  font-weight: 600;
                }
                .reporte-content table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 20px 0;
                }
                .reporte-content th {
                  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                  color: #1e3a8a;
                  padding: 15px;
                  text-align: left;
                  font-weight: 600;
                  border-bottom: 2px solid #cbd5e1;
                }
                .reporte-content td {
                  padding: 12px 15px;
                  border-bottom: 1px solid #e2e8f0;
                }
                .reporte-content tr:nth-child(even) {
                  background: #f8fafc;
                }
                .reporte-content tr:hover {
                  background: #f1f5f9;
                }
                @media print {
                  body { 
                    background: white; 
                    padding: 0;
                  }
                  .no-print { display: none; }
                  .reporte-container { 
                    box-shadow: none; 
                    padding: 0; 
                    border-radius: 0;
                  }
                  .reporte-container::before {
                    display: none;
                  }
                }
                @media (max-width: 768px) {
                  body { padding: 10px; }
                  .reporte-container { padding: 20px; }
                  .no-print { padding: 20px; }
                  .btn { 
                    width: 100%; 
                    margin: 5px 0; 
                  }
                }
              </style>
            </head>
            <body>
              <div class="reporte-container">
                <div class="no-print">
                  <h2>${titulo}</h2>
                  <p>📊 Reporte generado automáticamente por el sistema AXYRA</p>
                  <p>💡 Presiona Ctrl+P para imprimir o guardar como PDF</p>
                  <button class="btn btn-primary" onclick="window.print()">
                    🖨️ Imprimir / Guardar PDF
                  </button>
                  <button class="btn btn-success" onclick="exportarReporteExcel()">
                    📊 Exportar a Excel
                  </button>
                  <button class="btn btn-secondary" onclick="window.close()">
                    ❌ Cerrar
                  </button>
                </div>
                <div class="reporte-content">
                  ${contenido}
                </div>
              </div>
              <script>
                function exportarReporteExcel() {
                  try {
                    // Obtener datos de nómina
                    const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
                    const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
                    
                    if (nominas.length === 0) {
                      alert('No hay datos de nómina para exportar');
                      return;
                    }

                    // Preparar datos para Excel
                    const datosExcel = [
                      ['ID', 'Empleado', 'Departamento', 'Salario Base', 'Horas Trabajadas', 'Total Horas', 'Valor por Hora', 'Total a Pagar', 'Fecha', 'Estado']
                    ];

                    nominas.forEach(nomina => {
                      const empleado = empleados.find(emp => emp.id === nomina.empleado_id);
                      datosExcel.push([
                        nomina.id || 'N/A',
                        empleado ? empleado.nombre : 'Empleado no encontrado',
                        empleado ? empleado.cargo : 'N/A',
                        `$${nomina.salario_base?.toLocaleString() || '0'}`,
                        nomina.horas_trabajadas || '0',
                        (nomina.horas_trabajadas + nomina.horas_extras + nomina.horas_nocturnas + nomina.horas_dominicales) || '0',
                        `$${nomina.salario_por_hora?.toLocaleString() || '0'}`,
                        `$${nomina.salario_neto?.toLocaleString() || '0'}`,
                        nomina.fecha_generacion ? new Date(nomina.fecha_generacion).toLocaleDateString() : 'N/A',
                        nomina.estado || 'N/A'
                      ]);
                    });

                    // Crear libro de Excel
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

                    // Aplicar estilos profesionales
                    worksheet['!cols'] = [
                      { width: 8 },   // ID
                      { width: 25 },  // Empleado
                      { width: 20 },  // Departamento
                      { width: 15 },  // Salario Base
                      { width: 18 },  // Horas Trabajadas
                      { width: 15 },  // Total Horas
                      { width: 18 },  // Valor por Hora
                      { width: 18 },  // Total a Pagar
                      { width: 15 },  // Fecha
                      { width: 12 }   // Estado
                    ];

                    // Agregar hoja al libro
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Nómina');

                    // Generar nombre de archivo con fecha
                    const fecha = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `Reporte_Nomina_Villa_Venecia_${fecha}.xlsx`;

                    // Descargar archivo
                    XLSX.writeFile(workbook, nombreArchivo);
                    
                    console.log('✅ Reporte de nómina exportado correctamente:', nombreArchivo);
                  } catch (error) {
                    console.error('❌ Error exportando reporte de nómina:', error);
                    alert('Error al exportar: ' + error.message);
                  }
                }
              </script>
            </body>
          </html>
        `);
        ventanaReporte.document.close();
      }

      // Cargar configuración guardada
      function cargarConfiguracionGuardada() {
        try {
          const configuracion = localStorage.getItem('axyra_configuracion_nomina');
          if (configuracion) {
            const config = JSON.parse(configuracion);

            // Llenar campos del formulario
            if (document.getElementById('salarioMinimo')) {
              document.getElementById('salarioMinimo').value = config.salarioMinimo || '';
            }
            if (document.getElementById('porcentajeCesantias')) {
              document.getElementById('porcentajeCesantias').value = config.porcentajeCesantias || '';
            }
            if (document.getElementById('porcentajePrima')) {
              document.getElementById('porcentajePrima').value = config.porcentajePrima || '';
            }
            if (document.getElementById('porcentajeInteresesCesantias')) {
              document.getElementById('porcentajeInteresesCesantias').value = config.porcentajeInteresesCesantias || '';
            }
            if (document.getElementById('porcentajeSalud')) {
              document.getElementById('porcentajeSalud').value = config.porcentajeSalud || '';
            }
            if (document.getElementById('porcentajePension')) {
              document.getElementById('porcentajePension').value = config.porcentajePension || '';
            }
          }
        } catch (error) {
          console.error('❌ Error cargando configuración:', error);
        }
      }

      // Configurar listener para cambios en empleados
      function configurarListenerCambiosEmpleados() {
        try {
          console.log('👂 Configurando listener para cambios en empleados...');
          
          // Escuchar eventos personalizados
          window.addEventListener('axyraEmpleadosCambiados', async (event) => {
            console.log('📢 Evento de cambio en empleados recibido:', event.detail);
            
            // Verificar que el cambio sea para el usuario actual
            if (currentUser && event.detail.userId === (currentUser.id || currentUser.username || currentUser.email)) {
              console.log('🔄 Refrescando nómina por cambio en empleados...');
              await cargarDatos();
              llenarSelects();
              renderizarTablaNominas();
            }
          });
          
          // También escuchar cambios en localStorage para compatibilidad
          window.addEventListener('storage', (event) => {
            if (event.key === 'axyra_last_employee_change') {
              try {
                const changeData = JSON.parse(event.newValue);
                console.log('📢 Cambio en empleados detectado vía localStorage:', changeData);
                
                // Verificar que el cambio sea para el usuario actual
                if (currentUser && changeData.userId === (currentUser.id || currentUser.username || currentUser.email)) {
                  console.log('🔄 Refrescando nómina por cambio en empleados (localStorage)...');
                  setTimeout(async () => {
                    await cargarDatos();
                    llenarSelects();
                    renderizarTablaNominas();
                  }, 100);
                }
              } catch (error) {
                console.error('❌ Error procesando cambio vía localStorage:', error);
              }
            }
          });
          
          console.log('✅ Listener configurado correctamente');
        } catch (error) {
          console.error('❌ Error configurando listener:', error);
        }
      }

      // Función para generar PDF individual (función global)
      window.generarComprobantePDFIndividual = function() {
        try {
          // Obtener la nómina actual del modal
          const modal = document.getElementById('modalDetalleNomina');
          if (!modal) {
            mostrarNotificacion('Error: Modal no encontrado', 'error');
            return;
          }

          // Obtener datos de la nómina
          const nominaId = modal.getAttribute('data-nomina-id');
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const nomina = nominas.find(n => n.id === nominaId);
          
          if (!nomina) {
            mostrarNotificacion('Error: Nómina no encontrada', 'error');
            return;
          }

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const empleado = empleados.find(emp => emp.id === nomina.empleado_id);
          
          if (!empleado) {
            mostrarNotificacion('Error: Empleado no encontrado', 'error');
            return;
          }

          // Generar contenido del PDF
          const contenido = generarContenidoComprobante(nomina, empleado);
          
          // Intentar usar jsPDF si está disponible
          if (typeof jsPDF !== 'undefined') {
            generarPDFConJsPDF(contenido, nomina, empleado);
          } else {
            // Fallback a impresión directa
            mostrarContenidoParaImprimirIndividual(contenido, nomina, empleado);
          }
        } catch (error) {
          console.error('❌ Error generando PDF individual:', error);
          mostrarNotificacion('Error al generar PDF: ' + error.message, 'error');
        }
      };

      // Función para exportar nómina a Excel
      window.exportarNomina = function() {
        try {
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          
          if (nominas.length === 0) {
            mostrarNotificacion('No hay nóminas para exportar', 'warning');
            return;
          }

          // Preparar datos para Excel
          const datosExcel = [
            ['ID', 'Empleado', 'Departamento', 'Salario Base', 'Horas Trabajadas', 'Total Horas', 'Valor por Hora', 'Total a Pagar', 'Fecha', 'Estado']
          ];

          nominas.forEach(nomina => {
            const empleado = empleados.find(emp => emp.id === nomina.empleado_id);
            datosExcel.push([
              nomina.id || 'N/A',
              empleado ? empleado.nombre : 'Empleado no encontrado',
              empleado ? empleado.cargo : 'N/A',
              `$${nomina.salario_base?.toLocaleString() || '0'}`,
              nomina.horas_trabajadas || '0',
              (nomina.horas_trabajadas + nomina.horas_extras + nomina.horas_nocturnas + nomina.horas_dominicales) || '0',
              `$${nomina.salario_por_hora?.toLocaleString() || '0'}`,
              `$${nomina.salario_neto?.toLocaleString() || '0'}`,
              nomina.fecha_generacion ? new Date(nomina.fecha_generacion).toLocaleDateString() : 'N/A',
              nomina.estado || 'N/A'
            ]);
          });

          // Crear libro de Excel
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 8 },   // ID
            { width: 25 },  // Empleado
            { width: 20 },  // Departamento
            { width: 15 },  // Salario Base
            { width: 18 },  // Horas Trabajadas
            { width: 15 },  // Total Horas
            { width: 18 },  // Valor por Hora
            { width: 18 },  // Total a Pagar
            { width: 15 },  // Fecha
            { width: 12 }   // Estado
          ];

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Nómina');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `Nómina_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);
          
          console.log('✅ Nómina exportada correctamente:', nombreArchivo);
          mostrarNotificacion('Nómina exportada correctamente', 'success');
        } catch (error) {
          console.error('❌ Error exportando nómina:', error);
          mostrarNotificacion('Error al exportar: ' + error.message, 'error');
        }
      };

      // Función para generar comprobante PDF
      window.generarComprobantePDF = function() {
        try {
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          
          if (nominas.length === 0) {
            mostrarNotificacion('No hay nóminas para generar comprobantes', 'warning');
            return;
          }

          // Mostrar modal de selección
          mostrarModal('modalGenerarComprobante');
          
          // Llenar select con empleados que tienen nómina
          const selectEmpleado = document.getElementById('selectEmpleadoComprobante');
          if (selectEmpleado) {
            selectEmpleado.innerHTML = '<option value="">Seleccionar empleado</option>';
            
            const empleadosConNomina = empleados.filter(emp => 
              nominas.some(nom => nom.empleado_id === emp.id)
            );
            
            empleadosConNomina.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.id;
              option.textContent = emp.nombre;
              selectEmpleado.appendChild(option);
            });
          }
        } catch (error) {
          console.error('❌ Error preparando generación de comprobante:', error);
          mostrarNotificacion('Error al preparar comprobante: ' + error.message, 'error');
        }
      };

      // Función para generar reportes
      window.generarReportes = function() {
        try {
          mostrarModal('modalReportesAvanzados');
        } catch (error) {
          console.error('❌ Error mostrando reportes:', error);
          mostrarNotificacion('Error al mostrar reportes: ' + error.message, 'error');
        }
      };

      // Función para configuración de nómina
      window.configuracionNomina = function() {
        try {
          mostrarModal('modalConfiguracionNomina');
          cargarConfiguracionGuardada();
        } catch (error) {
          console.error('❌ Error mostrando configuración:', error);
          mostrarNotificacion('Error al mostrar configuración: ' + error.message, 'error');
        }
      };

      // Función para mostrar notificaciones
      function mostrarNotificacion(mensaje, tipo = 'info') {
        try {
          // Crear elemento de notificación
          const notificacion = document.createElement('div');
          notificacion.className = `axyra-notificacion axyra-notificacion-${tipo}`;
          notificacion.innerHTML = `
            <div class="axyra-notificacion-icono">
              ${tipo === 'success' ? '✅' : tipo === 'error' ? '❌' : tipo === 'warning' ? '⚠️' : 'ℹ️'}
            </div>
            <div class="axyra-notificacion-contenido">
              <div class="axyra-notificacion-mensaje">${mensaje}</div>
            </div>
            <button class="axyra-notificacion-cerrar" onclick="this.closest('.axyra-notificacion').remove()">
              ×
            </button>
          `;
          
          // Agregar al DOM
          document.body.appendChild(notificacion);
          
          // Auto-remover después de 5 segundos
          setTimeout(() => {
            if (notificacion.parentElement) {
              notificacion.remove();
            }
          }, 5000);
        } catch (error) {
          console.error('❌ Error mostrando notificación:', error);
          // Fallback a alert
          alert(mensaje);
        }
      }

      // Hacer funciones globales para onclick
      window.mostrarModal = mostrarModal;
      window.cerrarModal = cerrarModal;
      window.exportarNomina = exportarNomina;
      window.generarComprobantePDF = generarComprobantePDF;
      window.generarReportes = generarReportes;
      window.configuracionNomina = configuracionNomina;
      window.mostrarNotificacion = mostrarNotificacion;

      // Función para mostrar modal
      function mostrarModal(modalId) {
        try {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.style.display = 'block';
            modal.classList.add('show');
          }
        } catch (error) {
          console.error('❌ Error mostrando modal:', error);
        }
      }

      // Función para cerrar modal
      function cerrarModal(modalId) {
        try {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
          }
        } catch (error) {
          console.error('❌ Error cerrando modal:', error);
        }
      }

      // Función para exportar nómina a Excel usando plantilla existente
      function exportarNomina() {
        try {
          const nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          
          if (nominas.length === 0) {
            mostrarNotificacion('No hay nóminas para exportar', 'warning');
            return;
          }

          // Crear libro de Excel usando la plantilla
          const workbook = XLSX.utils.book_new();
          
          // Crear hoja de trabajo con los datos siguiendo la estructura de nomina.xlsx
          const datosExcel = [
            ['VILLA VENECIA - NÓMINA DE EMPLEADOS'],
            [`Fecha de Generación: ${new Date().toLocaleDateString()}`],
            [''], // Línea en blanco
            ['ID', 'Empleado', 'Cédula', 'Cargo', 'Departamento', 'Tipo Contrato', 'Salario Base', 'Horas Ordinarias', 'Horas Extras', 'Horas Nocturnas', 'Horas Dominicales', 'Horas Festivas', 'Total Horas', 'Valor por Hora', 'Subtotal', 'Salud (4%)', 'Pensión (4%)', 'Total Descuentos', 'Neto a Pagar']
          ];

          let totalSalarios = 0;
          let totalDescuentos = 0;
          let totalNeto = 0;

          nominas.forEach(nomina => {
            const empleado = empleados.find(emp => emp.id === nomina.empleado_id);
            if (empleado) {
              const salarioBase = nomina.salario_base || 0;
              const horasOrdinarias = nomina.horas_trabajadas || 0;
              const horasExtras = nomina.horas_extras || 0;
              const horasNocturnas = nomina.horas_nocturnas || 0;
              const horasDominicales = nomina.horas_dominicales || 0;
              const horasFestivas = nomina.horas_festivas || 0;
              const totalHoras = horasOrdinarias + horasExtras + horasNocturnas + horasDominicales + horasFestivas;
              
              const valorHora = salarioBase / 240; // 240 horas mensuales
              const subtotal = totalHoras * valorHora;
              
              // Solo empleados fijos reciben salud y pensión
              const tipoContrato = empleado.tipoContrato || 'FIJO';
              const salud = tipoContrato === 'FIJO' ? subtotal * 0.04 : 0;
              const pension = tipoContrato === 'FIJO' ? subtotal * 0.04 : 0;
              const totalDescuentosEmpleado = salud + pension;
              const netoAPagar = subtotal - totalDescuentosEmpleado;

              totalSalarios += subtotal;
              totalDescuentos += totalDescuentosEmpleado;
              totalNeto += netoAPagar;

              datosExcel.push([
                nomina.id || 'N/A',
                empleado.nombre || 'N/A',
                empleado.cedula || 'N/A',
                empleado.cargo || 'N/A',
                empleado.departamento || 'N/A',
                tipoContrato,
                salarioBase,
                horasOrdinarias,
                horasExtras,
                horasNocturnas,
                horasDominicales,
                horasFestivas,
                totalHoras,
                valorHora,
                subtotal,
                salud,
                pension,
                totalDescuentosEmpleado,
                netoAPagar
              ]);
            }
          });

          // Agregar línea en blanco y totales
          datosExcel.push(['']);
          datosExcel.push(['TOTALES', '', '', '', '', '', '', '', '', '', '', '', '', '', totalSalarios, totalDescuentos * 0.5, totalDescuentos * 0.5, totalDescuentos, totalNeto]);

          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 8 },   // ID
            { width: 25 },  // Empleado
            { width: 15 },  // Cédula
            { width: 20 },  // Cargo
            { width: 20 },  // Departamento
            { width: 15 },  // Tipo Contrato
            { width: 15 },  // Salario Base
            { width: 18 },  // Horas Ordinarias
            { width: 18 },  // Horas Extras
            { width: 18 },  // Horas Nocturnas
            { width: 18 },  // Horas Dominicales
            { width: 18 },  // Horas Festivas
            { width: 15 },  // Total Horas
            { width: 18 },  // Valor por Hora
            { width: 18 },  // Subtotal
            { width: 18 },  // Salud
            { width: 18 },  // Pensión
            { width: 18 },  // Total Descuentos
            { width: 18 }   // Neto a Pagar
          ];

          // Aplicar estilos a las celdas
          const range = XLSX.utils.decode_range(worksheet['!ref']);
          
          for (let R = range.s.r; R <= range.e.r; R++) {
            for (let C = range.s.c; C <= range.e.c; C++) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!worksheet[cellAddress]) continue;

              // Estilo para título principal (primera fila)
              if (R === 0) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: "4F81BD" } }, // Azul profesional
                  font: { 
                    color: { rgb: "FFFFFF" }, 
                    bold: true, 
                    sz: 16 
                  },
                  alignment: { 
                    horizontal: "center", 
                    vertical: "center" 
                  }
                };
              }
              // Estilo para fecha (segunda fila)
              else if (R === 1) {
                worksheet[cellAddress].s = {
                  font: { 
                    color: { rgb: "000000" }, 
                    bold: true, 
                    sz: 12 
                  },
                  alignment: { 
                    horizontal: "center", 
                    vertical: "center" 
                  }
                };
              }
              // Estilo para encabezados de tabla (fila 3)
              else if (R === 3) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: "D9E1F2" } }, // Azul claro
                  font: { 
                    color: { rgb: "000000" }, 
                    bold: true, 
                    sz: 11 
                  },
                  alignment: { 
                    horizontal: "center", 
                    vertical: "center" 
                  },
                  border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                  }
                };
              }
              // Estilo para fila de totales (última fila)
              else if (R === range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: "C6EFCE" } }, // Verde claro
                  font: { 
                    color: { rgb: "000000" }, 
                    bold: true, 
                    sz: 12 
                  },
                  alignment: { 
                    horizontal: "center", 
                    vertical: "center" 
                  },
                  border: {
                    top: { style: "medium", color: { rgb: "000000" } },
                    bottom: { style: "medium", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                  }
                };
              }
              // Estilo para datos (filas intermedias)
              else if (R > 3 && R < range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: R % 2 === 0 ? "FFFFFF" : "F8F9FA" } }, // Filas alternadas
                  font: { 
                    color: { rgb: "000000" }, 
                    sz: 10 
                  },
                  alignment: { 
                    horizontal: "center", 
                    vertical: "center" 
                  },
                  border: {
                    top: { style: "thin", color: { rgb: "D0D0D0" } },
                    bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                    left: { style: "thin", color: { rgb: "D0D0D0" } },
                    right: { style: "thin", color: { rgb: "D0D0D0" } }
                  }
                };

                // Formato especial para columnas monetarias
                if (C >= 6 && C <= 18) { // Columnas de salarios y descuentos
                  worksheet[cellAddress].s.numberFormat = '"$"#,##0.00';
                }
                // Formato para horas
                else if (C >= 7 && C <= 12) { // Columnas de horas
                  worksheet[cellAddress].s.numberFormat = '#,##0.00';
                }
              }
            }
          }

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Nómina');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `Nómina_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);
          
          console.log('✅ Nómina exportada correctamente:', nombreArchivo);
          mostrarNotificacion('✅ Nómina exportada a Excel con formato profesional y fórmulas', 'success');
        } catch (error) {
          console.error('❌ Error exportando nómina:', error);
          mostrarNotificacion('Error al exportar: ' + error.message, 'error');
        }
      }

      // Función para generar comprobante PDF
      function generarComprobantePDF() {
        try {
          mostrarNotificacion('Función de generación de PDF en desarrollo', 'info');
        } catch (error) {
          console.error('❌ Error generando PDF:', error);
          mostrarNotificacion('Error al generar PDF: ' + error.message, 'error');
        }
      }

      // Función para generar reportes
      function generarReportes() {
        try {
          mostrarNotificacion('Función de reportes en desarrollo', 'info');
        } catch (error) {
          console.error('❌ Error generando reportes:', error);
          mostrarNotificacion('Error al generar reportes: ' + error.message, 'error');
        }
      }

      // Función para configuración de nómina
      function configuracionNomina() {
        try {
          mostrarNotificacion('Función de configuración en desarrollo', 'info');
        } catch (error) {
          console.error('❌ Error en configuración:', error);
          mostrarNotificacion('Error en configuración: ' + error.message, 'error');
        }
      }

      // Función para mostrar notificaciones
      function mostrarNotificacion(mensaje, tipo = 'info') {
        try {
          // Crear elemento de notificación
          const notificacion = document.createElement('div');
          notificacion.className = `axyra-notificacion axyra-notificacion-${tipo}`;
          notificacion.innerHTML = `
            <div class="axyra-notificacion-icono">
              ${tipo === 'success' ? '✅' : tipo === 'error' ? '❌' : tipo === 'warning' ? '⚠️' : 'ℹ️'}
            </div>
            <div class="axyra-notificacion-contenido">
              <div class="axyra-notificacion-mensaje">${mensaje}</div>
            </div>
            <button class="axyra-notificacion-cerrar" onclick="this.closest('.axyra-notificacion').remove()">
              ×
            </button>
          `;
          
          // Agregar al DOM
          document.body.appendChild(notificacion);
          
          // Auto-remover después de 5 segundos
          setTimeout(() => {
            if (notificacion.parentElement) {
              notificacion.remove();
            }
          }, 5000);
        } catch (error) {
          console.error('❌ Error mostrando notificación:', error);
          // Fallback a alert
          alert(mensaje);
        }
      }

      // Hacer funciones globales para onclick
      window.mostrarModal = mostrarModal;
      window.cerrarModal = cerrarModal;
      window.exportarNomina = exportarNomina;
      window.generarComprobantePDF = generarComprobantePDF;
      window.generarReportes = generarReportes;
      window.configuracionNomina = configuracionNomina;
      window.mostrarNotificacion = mostrarNotificacion;
    </script>
  </body>
</html>

