<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gesti√≥n de N√≥mina</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="stylesheet" href="nomina-styles.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>

    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>

    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>

    <!-- Sistema Unificado de Autenticaci√≥n AXYRA -->
    <script src="../../static/unified-auth-system.js"></script>

    <!-- Sistema Unificado de Reportes Avanzados AXYRA -->
    <script src="../../static/advanced-reports-unified.js"></script>

    <!-- Sistema Unificado de Backup AXYRA -->
    <script src="../../static/backup-system-unified.js"></script>

    <!-- Sistema Unificado de Auditor√≠a AXYRA -->
    <script src="../../static/audit-system-unified.js"></script>

    <script src="../../static/debug-auth.js"></script>
    <script src="../../static/gmail-notifications.js"></script>

    <!-- Header Compartido AXYRA -->
    <script src="../../static/include-header.js"></script>

    <!-- Verificaci√≥n del Header Compartido -->
    <script src="../../static/header-verification.js"></script>

    <style>
      /* Estilos espec√≠ficos para el m√≥dulo de n√≥mina */
      .axyra-metrics-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      }

      .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.9;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
      }

      .axyra-actions-bar {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin: 30px 0;
        padding: 25px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        border: 1px solid #e2e8f0;
      }

      .axyra-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: white;
        min-width: 140px;
        justify-content: center;
      }

      .axyra-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .axyra-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .axyra-btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      .axyra-btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .axyra-btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      }

      .axyra-btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
      }

      .axyra-analytics-dashboard {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        border: 1px solid #e2e8f0;
      }

      .axyra-analytics-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .axyra-analytics-header h3 {
        color: #1e3a8a;
        font-size: 1.8rem;
        margin: 0 0 10px 0;
        font-weight: 700;
      }

      .axyra-analytics-header p {
        color: #64748b;
        font-size: 1.1rem;
        margin: 0;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .axyra-actions-bar {
          flex-direction: column;
        }

        .axyra-btn {
          width: 100%;
        }

        .axyra-metrics-dashboard {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>

  <body>
    <!-- Header Compartido AXYRA - Se insertar√° autom√°ticamente -->

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gesti√≥n de N√≥mina</h1>
          <p class="axyra-page-subtitle">Genera y gestiona las n√≥minas de tus empleados</p>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="axyra-actions-bar">
          <button class="axyra-btn axyra-btn-primary" onclick="mostrarModalGenerarNomina()">
            <i class="fas fa-plus"></i> Generar N√≥mina
          </button>
          <button class="axyra-btn axyra-btn-secondary" onclick="exportarNominaSimple()">
            <i class="fas fa-download"></i> Exportar a Excel
          </button>
          <button class="axyra-btn axyra-btn-success" onclick="generarPDFSimple()">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
          <button class="axyra-btn axyra-btn-warning" onclick="generarReporteSimple()">
            <i class="fas fa-chart-bar"></i> Reportes
          </button>
          <button class="axyra-btn axyra-btn-info" onclick="mostrarConfiguracionSimple()">
            <i class="fas fa-cog"></i> Configuraci√≥n
          </button>
        </div>

        <!-- Dashboard de M√©tricas -->
        <div class="axyra-metrics-dashboard">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalEmpleados">0</div>
              <div class="metric-label">Total Empleados</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalNominas">0</div>
              <div class="metric-label">N√≥minas Generadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="costoTotalEmpresa">$0</div>
              <div class="metric-label">Costo Total Empresa</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="totalHorasTrabajadas">0 hrs</div>
              <div class="metric-label">Total Horas Trabajadas</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="promedioSalario">$0</div>
              <div class="metric-label">Promedio Salario</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="nominasEsteMes">0</div>
              <div class="metric-label">N√≥minas Este Mes</div>
            </div>
          </div>
        </div>

        <!-- Dashboard de Analytics Avanzado -->
        <div class="axyra-analytics-dashboard">
          <div class="axyra-analytics-header">
            <h3>üìä Analytics Avanzado de N√≥mina</h3>
            <p>An√°lisis detallado de costos laborales y tendencias</p>
          </div>
        </div>
      </div>
    </main>

    <script>
      // ========================================
      // SISTEMA ROBUSTO DE FUNCIONES PARA BOTONES
      // ========================================

      // Clase principal para gesti√≥n de n√≥mina
      class NominaManager {
        constructor() {
          this.empleados = [];
          this.nominas = [];
          this.configuracion = {};
          this.init();
        }

        async init() {
          try {
            await this.cargarDatos();
            this.configurarEventos();
            console.log('‚úÖ NominaManager inicializado correctamente');
          } catch (error) {
            console.error('‚ùå Error inicializando NominaManager:', error);
          }
        }

        async cargarDatos() {
          try {
            this.empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            this.nominas = JSON.parse(localStorage.getItem('axyra_nominas') || '[]');
            this.configuracion = JSON.parse(localStorage.getItem('axyra_config_simple') || '{}');
            console.log(`üìä Datos cargados: ${this.empleados.length} empleados, ${this.nominas.length} n√≥minas`);
          } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            this.empleados = [];
            this.nominas = [];
            this.configuracion = {};
          }
        }

        configurarEventos() {
          // Configurar eventos de los botones
          this.configurarBotones();
        }

        configurarBotones() {
          // Bot√≥n Generar N√≥mina
          const btnGenerar = document.querySelector('button[onclick="mostrarModalGenerarNomina()"]');
          if (btnGenerar) {
            btnGenerar.onclick = () => this.mostrarModalGenerarNomina();
          }

          // Bot√≥n Exportar Excel
          const btnExportar = document.querySelector('button[onclick="exportarNominaSimple()"]');
          if (btnExportar) {
            btnExportar.onclick = () => this.exportarNominaSimple();
          }

          // Bot√≥n Generar PDF
          const btnPDF = document.querySelector('button[onclick="generarPDFSimple()"]');
          if (btnPDF) {
            btnPDF.onclick = () => this.generarPDFSimple();
          }

          // Bot√≥n Reportes
          const btnReportes = document.querySelector('button[onclick="generarReporteSimple()"]');
          if (btnReportes) {
            btnReportes.onclick = () => this.generarReporteSimple();
          }

          // Bot√≥n Configuraci√≥n
          const btnConfig = document.querySelector('button[onclick="mostrarConfiguracionSimple()"]');
          if (btnConfig) {
            btnConfig.onclick = () => this.mostrarConfiguracionSimple();
          }
        }

        // ========================================
        // FUNCI√ìN: MOSTRAR MODAL GENERAR N√ìMINA
        // ========================================
        mostrarModalGenerarNomina() {
          try {
            // Crear modal con dise√±o moderno
            const modal = document.createElement('div');
            modal.className = 'axyra-modal-overlay';
            modal.id = 'modalGenerarNomina';

            modal.innerHTML = `
              <div class="axyra-modal-content">
                <div class="axyra-modal-header">
                  <h3>üìã Generar Nueva N√≥mina</h3>
                  <button class="axyra-modal-close" onclick="nominaManager.cerrarModalGenerarNomina()">√ó</button>
                </div>
                <div class="axyra-modal-body">
                  <div class="axyra-form-group">
                    <label for="empleadoSelect">üë§ Seleccionar Empleado:</label>
                    <select id="empleadoSelect" class="axyra-form-control">
                      <option value="">Seleccione un empleado...</option>
                    </select>
                  </div>
                  <div class="axyra-form-group">
                    <label for="mesNomina">üìÖ Mes de N√≥mina:</label>
                    <input type="month" id="mesNomina" class="axyra-form-control" value="${new Date()
                      .toISOString()
                      .slice(0, 7)}">
                  </div>
                  <div class="axyra-form-group">
                    <label for="horasTrabajadas">‚è∞ Horas Trabajadas:</label>
                    <input type="number" id="horasTrabajadas" class="axyra-form-control" placeholder="Horas trabajadas este mes" min="0" step="0.5">
                  </div>
                  <div class="axyra-form-group">
                    <label for="horasExtras">‚è∞ Horas Extras:</label>
                    <input type="number" id="horasExtras" class="axyra-form-control" placeholder="Horas extras (opcional)" value="0" min="0" step="0.5">
                  </div>
                </div>
                <div class="axyra-modal-footer">
                  <button class="axyra-btn axyra-btn-secondary" onclick="nominaManager.cerrarModalGenerarNomina()">‚ùå Cancelar</button>
                  <button class="axyra-btn axyra-btn-primary" onclick="nominaManager.generarNominaEmpleado()">‚úÖ Generar N√≥mina</button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);
            this.cargarEmpleadosEnSelect();

            // Agregar estilos para el modal
            if (!document.getElementById('modalStyles')) {
              const styles = document.createElement('style');
              styles.id = 'modalStyles';
              styles.textContent = `
                .axyra-modal-overlay {
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: rgba(0, 0, 0, 0.7);
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  z-index: 9999;
                }
                
                .axyra-modal-content {
                  background: white;
                  border-radius: 16px;
                  max-width: 500px;
                  width: 90%;
                  max-height: 90%;
                  overflow-y: auto;
                  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                }
                
                .axyra-modal-header {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 20px;
                  border-radius: 16px 16px 0 0;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                }
                
                .axyra-modal-header h3 {
                  margin: 0;
                  font-size: 1.25rem;
                }
                
                .axyra-modal-close {
                  background: none;
                  border: none;
                  color: white;
                  font-size: 24px;
                  cursor: pointer;
                  padding: 0;
                  width: 32px;
                  height: 32px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 50%;
                  transition: background-color 0.2s ease;
                }
                
                .axyra-modal-close:hover {
                  background: rgba(255, 255, 255, 0.2);
                }
                
                .axyra-modal-body {
                  padding: 20px;
                }
                
                .axyra-modal-footer {
                  padding: 20px;
                  border-top: 1px solid #e2e8f0;
                  display: flex;
                  justify-content: flex-end;
                  gap: 10px;
                }
                
                .axyra-form-group {
                  margin-bottom: 20px;
                }
                
                .axyra-form-group label {
                  display: block;
                  margin-bottom: 8px;
                  font-weight: 600;
                  color: #374151;
                }
                
                .axyra-form-control {
                  width: 100%;
                  padding: 12px 15px;
                  border: 2px solid #e9ecef;
                  border-radius: 8px;
                  font-size: 14px;
                  transition: border-color 0.2s ease;
                  box-sizing: border-box;
                }
                
                .axyra-form-control:focus {
                  outline: none;
                  border-color: #007bff;
                  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
                }
                
                .axyra-btn {
                  padding: 10px 20px;
                  border: none;
                  border-radius: 6px;
                  font-size: 14px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  text-decoration: none;
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                }
                
                .axyra-btn-primary {
                  background: linear-gradient(135deg, #007bff, #0056b3);
                  color: white;
                }
                
                .axyra-btn-primary:hover {
                  background: linear-gradient(135deg, #0056b3, #004085);
                  transform: translateY(-1px);
                  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
                }
                
                .axyra-btn-secondary {
                  background: #6c757d;
                  color: white;
                }
                
                .axyra-btn-secondary:hover {
                  background: #5a6268;
                  transform: translateY(-1px);
                }
              `;
              document.head.appendChild(styles);
            }
          } catch (error) {
            console.error('‚ùå Error mostrando modal:', error);
            alert('Error mostrando modal: ' + error.message);
          }
        }

        cerrarModalGenerarNomina() {
          const modal = document.getElementById('modalGenerarNomina');
          if (modal) {
            modal.remove();
          }
        }

        cargarEmpleadosEnSelect() {
          try {
            const select = document.getElementById('empleadoSelect');
            if (select) {
              select.innerHTML = '<option value="">Seleccione un empleado...</option>';
              this.empleados.forEach((emp) => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.nombre} - ${emp.cargo}`;
                select.appendChild(option);
              });
            }
          } catch (error) {
            console.error('‚ùå Error cargando empleados:', error);
          }
        }

        generarNominaEmpleado() {
          try {
            const empleadoId = document.getElementById('empleadoSelect').value;
            const mes = document.getElementById('mesNomina').value;
            const horasTrabajadas = parseFloat(document.getElementById('horasTrabajadas').value) || 0;
            const horasExtras = parseFloat(document.getElementById('horasExtras').value) || 0;

            if (!empleadoId) {
              alert('Por favor seleccione un empleado');
              return;
            }

            if (!mes) {
              alert('Por favor seleccione un mes');
              return;
            }

            if (horasTrabajadas <= 0) {
              alert('Por favor ingrese las horas trabajadas');
              return;
            }

            // Obtener empleado
            const empleado = this.empleados.find((emp) => emp.id === empleadoId);

            if (!empleado) {
              alert('Empleado no encontrado');
              return;
            }

            // Calcular n√≥mina
            const salarioBase = parseFloat(empleado.salario) || 0;
            const valorHora = salarioBase / 240; // 240 horas mensuales
            const subtotal = horasTrabajadas * valorHora;
            const horasExtrasValor = horasExtras * (valorHora * 1.5); // 1.5x por horas extras
            const totalBruto = subtotal + horasExtrasValor;

            // Descuentos (solo para empleados fijos)
            const tipoContrato = empleado.tipoContrato || 'FIJO';
            const salud = tipoContrato === 'FIJO' ? totalBruto * 0.04 : 0;
            const pension = tipoContrato === 'FIJO' ? totalBruto * 0.04 : 0;
            const totalDescuentos = salud + pension;
            const netoAPagar = totalBruto - totalDescuentos;

            // Crear n√≥mina
            const nomina = {
              id: Date.now().toString(),
              empleado_id: empleadoId,
              empleado_nombre: empleado.nombre,
              mes: mes,
              horas_trabajadas: horasTrabajadas,
              horas_extras: horasExtras,
              salario_base: salarioBase,
              valor_hora: valorHora,
              subtotal: subtotal,
              horas_extras_valor: horasExtrasValor,
              total_bruto: totalBruto,
              salud: salud,
              pension: pension,
              total_descuentos: totalDescuentos,
              salario_final: netoAPagar,
              estado: 'GENERADA',
              fecha_generacion: new Date().toISOString(),
            };

            // Guardar n√≥mina
            this.nominas.push(nomina);
            localStorage.setItem('axyra_nominas', JSON.stringify(this.nominas));

            alert(
              `‚úÖ N√≥mina generada correctamente\n\nEmpleado: ${
                empleado.nombre
              }\nTotal a Pagar: $${netoAPagar.toLocaleString()}`
            );
            this.cerrarModalGenerarNomina();

            // Recargar la p√°gina para mostrar la nueva n√≥mina
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            console.error('‚ùå Error generando n√≥mina:', error);
            alert('Error generando n√≥mina: ' + error.message);
          }
        }

        generarPDFSimple() {
          try {
            if (this.nominas.length === 0) {
              alert('No hay n√≥minas para generar PDF');
              return;
            }

            // Crear contenido del PDF
            const contenido = `
              <html>
                <head>
                  <title>N√≥mina Villa Venecia</title>
                  <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
                    .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    .table th { background-color: #f2f2f2; }
                    .total { font-weight: bold; margin-top: 20px; }
                  </style>
                </head>
                <body>
                  <div class="header">
                    <h1>VILLA VENECIA</h1>
                    <h2>Reporte de N√≥mina</h2>
                    <p>Fecha: ${new Date().toLocaleDateString()}</p>
                  </div>

                  <table class="table">
                    <thead>
                      <tr>
                        <th>Empleado</th>
                        <th>Cargo</th>
                        <th>Horas</th>
                        <th>Salario Base</th>
                        <th>Total a Pagar</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${this.nominas
                        .map((n) => {
                          const emp = this.empleados.find((e) => e.id === n.empleado_id);
                          return `
                          <tr>
                            <td>${emp ? emp.nombre : 'N/A'}</td>
                            <td>${emp ? emp.cargo : 'N/A'}</td>
                            <td>${n.horas_trabajadas}</td>
                            <td>$${n.salario_base?.toLocaleString() || '0'}</td>
                            <td>$${n.salario_final?.toLocaleString() || '0'}</td>
                          </tr>
                        `;
                        })
                        .join('')}
                    </tbody>
                  </table>

                  <div class="total">
                    <p>Total N√≥minas: ${this.nominas.length}</p>
                    <p>Total a Pagar: $${this.nominas
                      .reduce((sum, n) => sum + (n.salario_final || 0), 0)
                      .toLocaleString()}</p>
                  </div>
                </body>
              </html>
            `;

            // Abrir en nueva ventana para imprimir
            const ventana = window.open('', '_blank');
            ventana.document.write(contenido);
            ventana.document.close();

            // Auto-imprimir despu√©s de cargar
            setTimeout(() => {
              ventana.print();
            }, 500);
          } catch (error) {
            console.error('Error generando PDF:', error);
            alert('Error generando PDF: ' + error.message);
          }
        }

        exportarNominaSimple() {
          try {
            if (this.nominas.length === 0) {
              alert('No hay n√≥minas para exportar');
              return;
            }

            // Crear datos simples para Excel
            const datosExcel = [
              ['VILLA VENECIA - N√ìMINA'],
              [`Fecha: ${new Date().toLocaleDateString()}`],
              [''],
              ['Empleado', 'Cargo', 'Salario', 'Estado'],
            ];

            this.nominas.forEach((nomina) => {
              const empleado = this.empleados.find((emp) => emp.id === nomina.empleado_id);
              if (empleado) {
                datosExcel.push([
                  empleado.nombre || 'N/A',
                  empleado.cargo || 'N/A',
                  `$${(nomina.salario_final || 0).toLocaleString()}`,
                  nomina.estado || 'N/A',
                ]);
              }
            });

            // Crear y descargar Excel
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'N√≥mina');

            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `N√≥mina_${fecha}.xlsx`);

            alert('‚úÖ N√≥mina exportada correctamente');
          } catch (error) {
            console.error('Error exportando:', error);
            alert('Error al exportar: ' + error.message);
          }
        }

        generarReporteSimple() {
          try {
            if (this.nominas.length === 0) {
              alert('No hay datos para generar reporte');
              return;
            }

            // Crear reporte simple
            const reporte = `
              üìä REPORTE DE N√ìMINA - VILLA VENECIA

              üìÖ Fecha: ${new Date().toLocaleDateString()}
              üë• Total Empleados: ${this.empleados.length}
              üìã Total N√≥minas: ${this.nominas.length}
              üí∞ Total Salarios: $${this.nominas.reduce((sum, n) => sum + (n.salario_final || 0), 0).toLocaleString()}

              üìã DETALLE:
              ${this.nominas
                .map((n) => {
                  const emp = this.empleados.find((e) => e.id === n.empleado_id);
                  return `‚Ä¢ ${emp ? emp.nombre : 'N/A'}: $${(n.salario_final || 0).toLocaleString()}`;
                })
                .join('\n')}
            `;

            // Mostrar en nueva ventana
            const ventana = window.open('', '_blank');
            ventana.document.write(`
              <html>
                <head><title>Reporte N√≥mina</title></head>
                <body style="font-family: Arial; padding: 20px;">
                  <pre style="white-space: pre-wrap;">${reporte}</pre>
                  <br><button onclick="window.print()">üñ®Ô∏è Imprimir</button>
                  <button onclick="window.close()">‚ùå Cerrar</button>
                </body>
              </html>
            `);
          } catch (error) {
            console.error('Error generando reporte:', error);
            alert('Error generando reporte: ' + error.message);
          }
        }

        mostrarConfiguracionSimple() {
          try {
            const modal = document.createElement('div');
            modal.style.cssText = `
              position: fixed; top: 0; left: 0; width: 100%; height: 100%;
              background: rgba(0,0,0,0.7); z-index: 9999; display: flex;
              justify-content: center; align-items: center;
            `;

            modal.innerHTML = `
              <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px;">
                <h3>‚öôÔ∏è Configuraci√≥n de N√≥mina</h3>
                <div style="margin: 20px 0;">
                  <label>Salario M√≠nimo: <input type="number" id="salMin" placeholder="Salario m√≠nimo"></label><br><br>
                  <label>% Cesant√≠as: <input type="number" id="cesantias" value="8.33" step="0.01"></label><br><br>
                  <label>% Salud: <input type="number" id="salud" value="4" step="0.01"></label><br><br>
                  <label>% Pensi√≥n: <input type="number" id="pension" value="4" step="0.01"></label>
                </div>
                <div style="text-align: right;">
                  <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="margin-right: 10px;">Cancelar</button>
                  <button onclick="nominaManager.guardarConfigSimple()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px;">Guardar</button>
                </div>
              </div>
            `;

            document.body.appendChild(modal);
          } catch (error) {
            console.error('Error mostrando configuraci√≥n:', error);
            alert('Error mostrando configuraci√≥n: ' + error.message);
          }
        }

        guardarConfigSimple() {
          try {
            const config = {
              salarioMinimo: document.getElementById('salMin').value,
              cesantias: document.getElementById('cesantias').value,
              salud: document.getElementById('salud').value,
              pension: document.getElementById('pension').value,
            };

            localStorage.setItem('axyra_config_simple', JSON.stringify(config));
            alert('‚úÖ Configuraci√≥n guardada correctamente');

            // Cerrar modal
            document.querySelector('div[style*="position: fixed"]').remove();
          } catch (error) {
            console.error('Error guardando configuraci√≥n:', error);
            alert('Error guardando configuraci√≥n: ' + error.message);
          }
        }

        cerrarNotificacion(boton) {
          const notificacion = boton.closest('.axyra-notificacion');
          if (notificacion) {
            notificacion.remove();
          }
        }
      }

      // ========================================
      // INICIALIZACI√ìN DEL SISTEMA
      // ========================================

      // Crear instancia global del manager
      let nominaManager;

      // Inicializar cuando el DOM est√© listo
      document.addEventListener('DOMContentLoaded', function () {
        try {
          nominaManager = new NominaManager();

          // Hacer funciones globales para compatibilidad
          window.mostrarModalGenerarNomina = () => nominaManager.mostrarModalGenerarNomina();
          window.cerrarModalGenerarNomina = () => nominaManager.cerrarModalGenerarNomina();
          window.generarNominaEmpleado = () => nominaManager.generarNominaEmpleado();
          window.cargarEmpleadosEnSelect = () => nominaManager.cargarEmpleadosEnSelect();
          window.generarPDFSimple = () => nominaManager.generarPDFSimple();
          window.exportarNominaSimple = () => nominaManager.exportarNominaSimple();
          window.generarReporteSimple = () => nominaManager.generarReporteSimple();
          window.mostrarConfiguracionSimple = () => nominaManager.mostrarConfiguracionSimple();
          window.guardarConfigSimple = () => nominaManager.guardarConfigSimple();
          window.cerrarNotificacion = (boton) => nominaManager.cerrarNotificacion(boton);

          console.log('‚úÖ Sistema de n√≥mina AXYRA inicializado correctamente');
        } catch (error) {
          console.error('‚ùå Error inicializando sistema de n√≥mina:', error);
        }
      });
    </script>
  </body>
</html>
