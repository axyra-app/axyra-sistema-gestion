<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AXYRA - Gestión de Horas</title>
    <link rel="stylesheet" href="../../static/axyra-styles.css" />
    <link rel="stylesheet" href="../../static/modal-fixes.css" />
    <link rel="icon" href="../../nomina.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../../static/colombian-labor-law.js"></script>
    <script src="../../static/pdf-generator.js"></script>
    <script src="../../static/firebase-sync-manager.js"></script>
    <script src="../../static/comprobante-pdf-generator.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- AXYRA Firebase Scripts -->
    <script src="../../static/firebase-config.js"></script>

    <!-- Sistema de Roles y Permisos AXYRA -->
    <script src="../../static/roles-config.js"></script>

    <!-- Sistema de Notificaciones Push AXYRA -->
    <script src="../../static/notifications-system.js"></script>
    <!-- SISTEMA AISLADO - SIN FIREBASE -->
    <script src="../../static/isolated-auth.js"></script>
    <script src="../../static/debug-auth.js"></script>

    <!-- Header Compartido AXYRA -->
    <script src="../../static/include-header.js"></script>

    <!-- Verificación del Header Compartido -->
    <script src="../../static/header-verification.js"></script>

    <!-- Sistema Unificado de Autenticación AXYRA -->
    <script src="../../static/unified-auth-system.js"></script>

    <!-- Sistema Unificado de Reportes Avanzados AXYRA -->
    <script src="../../static/advanced-reports-unified.js"></script>

    <!-- Sistema Unificado de Backup AXYRA -->
    <script src="../../static/backup-system-unified.js"></script>

    <!-- Sistema Unificado de Auditoría AXYRA -->
    <script src="../../static/audit-system-unified.js"></script>

    <style>
      /* Estilos para notificaciones */
      .axyra-notificacion {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 16px;
        min-width: 300px;
        max-width: 400px;
        z-index: 10001;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid #4f81bd;
      }

      .axyra-notificacion-success {
        border-left-color: #10b981;
      }

      .axyra-notificacion-error {
        border-left-color: #ef4444;
      }

      .axyra-notificacion-warning {
        border-left-color: #f59e0b;
      }

      .axyra-notificacion-info {
        border-left-color: #3b82f6;
      }

      .axyra-notificacion-icono {
        font-size: 20px;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .axyra-notificacion-contenido {
        flex: 1;
      }

      .axyra-notificacion-mensaje {
        color: #1f2937;
        font-size: 14px;
        line-height: 1.5;
        margin: 0;
      }

      .axyra-notificacion-cerrar {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .axyra-notificacion-cerrar:hover {
        background: #f3f4f6;
        color: #6b7280;
      }

      /* Estilos para modales adicionales */
      .axyra-modal-preview .axyra-preview-grid {
        display: grid;
        gap: 16px;
        margin-bottom: 20px;
      }

      .axyra-preview-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #4f81bd;
      }

      .axyra-preview-item label {
        font-weight: 600;
        color: #374151;
      }

      .axyra-preview-item span {
        color: #1f2937;
        font-weight: 500;
      }

      .axyra-preview-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: #4f81bd;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        font-size: 16px;
      }

      .axyra-modal-detalle .axyra-detalle-grid {
        display: grid;
        gap: 16px;
        margin-bottom: 20px;
      }

      .axyra-detalle-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #4f81bd;
      }

      .axyra-detalle-item label {
        font-weight: 600;
        color: #374151;
      }

      .axyra-detalle-item span {
        color: #1f2937;
        font-weight: 500;
      }

      /* Estilos para botones adicionales */
      .axyra-btn-primary {
        background: linear-gradient(135deg, #4f81bd 0%, #3b82f6 100%);
        color: white;
        box-shadow: 0 4px 20px rgba(79, 129, 189, 0.3);
      }

      .axyra-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(79, 129, 189, 0.4);
      }

      /* Estilos para tabla del historial de pagos */
      .axyra-btn-accion {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        margin: 2px;
      }

      .axyra-btn-ver {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .axyra-btn-ver:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }

      .axyra-btn-generar {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
      }

      .axyra-btn-generar:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      }

      /* Animaciones adicionales */
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Mejoras en la tabla */
      .axyra-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
      }

      .axyra-table th {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        font-weight: 600;
        padding: 16px 20px;
        text-align: left;
        border-bottom: 2px solid #cbd5e1;
      }

      .axyra-table td {
        padding: 16px 20px;
        border-bottom: 1px solid #f1f5f9;
        color: #475569;
      }

      .axyra-table tr:hover {
        background: #f8fafc;
      }

      /* Badges para tipos de horas */
      .axyra-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
      }

      .axyra-badge-normal {
        background: #dbeafe;
        color: #1e40af;
      }

      .axyra-badge-extra {
        background: #fef3c7;
        color: #92400e;
      }

      .axyra-badge-festiva {
        background: #fce7f3;
        color: #be185d;
      }

      .axyra-badge-nocturna {
        background: #e0e7ff;
        color: #3730a3;
      }

      /* Estilos para mostrar valores de hora */
      .axyra-valor-hora {
        font-size: 12px;
        color: #667eea;
        font-weight: 600;
        margin-top: 4px;
        padding: 2px 6px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 4px;
        text-align: center;
      }

      /* Estilos para modales profesionales */
      .axyra-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
      }

      .axyra-modal {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        animation: slideInUp 0.3s ease-out;
      }

      .axyra-modal-header {
        padding: 24px 24px 16px 24px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: flex-start;
        gap: 16px;
      }

      .axyra-modal-header-danger {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-bottom-color: #fecaca;
      }

      .axyra-modal-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #ef4444;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
      }

      .axyra-modal-title h3 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 20px;
        font-weight: 700;
      }

      .axyra-modal-title p {
        margin: 0;
        color: #64748b;
        font-size: 14px;
        line-height: 1.5;
      }

      .axyra-modal-cerrar {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        margin-left: auto;
        flex-shrink: 0;
      }

      .axyra-modal-cerrar:hover {
        background: #f1f5f9;
        color: #64748b;
      }

      .axyra-modal-body {
        padding: 16px 24px;
      }

      .axyra-alert {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.5;
      }

      .axyra-alert-warning {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .axyra-alert i {
        font-size: 16px;
        margin-top: 2px;
        flex-shrink: 0;
      }

      .axyra-modal-footer {
        padding: 16px 24px 24px 24px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
      }

      .axyra-btn {
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      }

      .axyra-btn-outline {
        background: white;
        color: #64748b;
        border: 2px solid #e2e8f0;
      }

      .axyra-btn-outline:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
      }

      .axyra-btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
      }

      .axyra-btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4);
      }

      .axyra-btn-danger:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Animaciones para modales */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <!-- Header Compartido AXYRA - Se insertará automáticamente -->

    <!-- Contenido Principal -->
    <main class="axyra-section">
      <div class="axyra-container">
        <div class="axyra-page-header">
          <h1 class="axyra-page-title">Gestión de Horas</h1>
          <p class="axyra-page-subtitle">Registra y controla las horas trabajadas por cada empleado</p>
        </div>

        <!-- Registro de Horas -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Registro de Horas</h3>
              <p class="axyra-card-subtitle">Registra entrada y salida de empleados</p>
            </div>
          </div>

          <form id="registroHorasForm" class="axyra-form">
            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="empleadoHoras" class="axyra-form-label">Empleado</label>
                <select
                  id="empleadoHoras"
                  name="empleado"
                  class="axyra-form-select"
                  required
                  onchange="actualizarValoresHora()"
                >
                  <option value="">Seleccionar empleado</option>
                </select>
              </div>
              <div class="axyra-form-group">
                <label for="fechaHoras" class="axyra-form-label">Fecha</label>
                <input type="date" id="fechaHoras" name="fecha" class="axyra-form-input" required />
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasOrdinarias" class="axyra-form-label">Horas Ordinarias</label>
                <input
                  type="number"
                  id="horasOrdinarias"
                  name="horasOrdinarias"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas de 6:00 AM a 6:00 PM</small>
                <div class="axyra-valor-hora" id="valorHoraOrdinaria">Valor: $0</div>
              </div>
              <div class="axyra-form-group">
                <label for="horasNocturnas" class="axyra-form-label">Horas Nocturnas</label>
                <input
                  type="number"
                  id="horasNocturnas"
                  name="horasNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas de 6:00 PM a 6:00 AM</small>
                <div class="axyra-valor-hora" id="valorHoraNocturna">Valor: $0</div>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasExtraDiurnas" class="axyra-form-label">Horas Extra Diurnas</label>
                <input
                  type="number"
                  id="horasExtraDiurnas"
                  name="horasExtraDiurnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas de día</small>
                <div class="axyra-valor-hora" id="valorHoraExtraDiurna">Valor: $0</div>
              </div>
              <div class="axyra-form-group">
                <label for="horasExtraNocturnas" class="axyra-form-label">Horas Extra Nocturnas</label>
                <input
                  type="number"
                  id="horasExtraNocturnas"
                  name="horasExtraNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas de noche</small>
                <div class="axyra-valor-hora" id="valorHoraExtraNocturna">Valor: $0</div>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasDominicales" class="axyra-form-label">Horas Dominicales</label>
                <input
                  type="number"
                  id="horasDominicales"
                  name="horasDominicales"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas en domingo</small>
                <div class="axyra-valor-hora" id="valorHoraDominical">Valor: $0</div>
              </div>
              <div class="axyra-form-group">
                <label for="horasFestivas" class="axyra-form-label">Horas Festivas</label>
                <input
                  type="number"
                  id="horasFestivas"
                  name="horasFestivas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas trabajadas en festivos</small>
                <div class="axyra-valor-hora" id="valorHoraFestiva">Valor: $0</div>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasDominicalesNocturnas" class="axyra-form-label">Horas Dominicales Nocturnas</label>
                <input
                  type="number"
                  id="horasDominicalesNocturnas"
                  name="horasDominicalesNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas dominicales trabajadas de noche</small>
                <div class="axyra-valor-hora" id="valorHoraDominicalNocturna">Valor: $0</div>
              </div>
              <div class="axyra-form-group">
                <label for="horasFestivasNocturnas" class="axyra-form-label">Horas Festivas Nocturnas</label>
                <input
                  type="number"
                  id="horasFestivasNocturnas"
                  name="horasFestivasNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas festivas trabajadas de noche</small>
                <div class="axyra-valor-hora" id="valorHoraFestivaNocturna">Valor: $0</div>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasExtraDominicales" class="axyra-form-label">Horas Extra Dominicales</label>
                <input
                  type="number"
                  id="horasExtraDominicales"
                  name="horasExtraDominicales"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas en domingo</small>
                <div class="axyra-valor-hora" id="valorHoraExtraDominical">Valor: $0</div>
              </div>
              <div class="axyra-form-group">
                <label for="horasExtraDominicalesNocturnas" class="axyra-form-label"
                  >Horas Extra Dominicales Nocturnas</label
                >
                <input
                  type="number"
                  id="horasExtraDominicalesNocturnas"
                  name="horasExtraDominicalesNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra dominicales trabajadas de noche</small>
                <div class="axyra-valor-hora" id="valorHoraExtraDominicalNocturna">Valor: $0</div>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="horasExtraFestivas" class="axyra-form-label">Horas Extra Festivas</label>
                <input
                  type="number"
                  id="horasExtraFestivas"
                  name="horasExtraFestivas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra trabajadas en festivos</small>
                <div class="axyra-valor-hora" id="valorHoraExtraFestiva">Valor: $0</div>
              </div>
              <div class="axyra-form-group">
                <label for="horasExtraFestivasNocturnas" class="axyra-form-label">Horas Extra Festivas Nocturnas</label>
                <input
                  type="number"
                  id="horasExtraFestivasNocturnas"
                  name="horasExtraFestivasNocturnas"
                  class="axyra-form-input"
                  min="0"
                  step="0.5"
                  placeholder="0"
                  onchange="calcularHoras()"
                />
                <small class="axyra-form-help">Horas extra festivas trabajadas de noche</small>
                <div class="axyra-valor-hora" id="valorHoraExtraFestivaNocturna">Valor: $0</div>
              </div>
            </div>

            <div class="axyra-form-row">
              <div class="axyra-form-group">
                <label for="salarioMinimo" class="axyra-form-label">Salario Mínimo Legal</label>
                <input
                  type="text"
                  id="salarioMinimo"
                  name="salarioMinimo"
                  class="axyra-form-input"
                  value="1,423,500"
                  onchange="calcularHoras()"
                  oninput="formatearSalario(this)"
                />
                <small class="axyra-form-help">Salario mínimo legal vigente en Colombia (COP)</small>
              </div>
              <div class="axyra-form-group">
                <label for="observaciones" class="axyra-form-label">Observaciones</label>
                <textarea
                  id="observaciones"
                  name="observaciones"
                  class="axyra-form-textarea"
                  rows="3"
                  placeholder="Comentarios adicionales sobre las horas trabajadas"
                ></textarea>
              </div>
            </div>

            <div class="axyra-form-group">
              <button type="submit" class="axyra-btn axyra-btn-primary">
                <i class="fas fa-save"></i> Registrar Horas
              </button>
              <button type="button" class="axyra-btn axyra-btn-secondary" onclick="calcularHoras()">
                <i class="fas fa-calculator"></i> Calcular Horas
              </button>
            </div>
          </form>
        </div>

        <!-- Botones de Acción -->
        <div class="axyra-actions-bar"></div>

        <!-- Resumen de Horas -->
        <div class="axyra-card" id="resumenHoras" style="display: none">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Resumen de Horas</h3>
              <p class="axyra-card-subtitle">Totales calculados para el empleado</p>
            </div>
          </div>

          <div class="axyra-grid axyra-grid-4">
            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasNormales">0</div>
              <div class="axyra-stat-label">Horas Ordinarias</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-moon"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasNocturnas">0</div>
              <div class="axyra-stat-label">Horas Nocturnas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-plus-circle"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasExtraDiurnas">0</div>
              <div class="axyra-stat-label">Horas Extra Diurnas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-plus-circle"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasExtraNocturnas">0</div>
              <div class="axyra-stat-label">Horas Extra Nocturnas</div>
            </div>
          </div>

          <div class="axyra-grid axyra-grid-4">
            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasDominicales">0</div>
              <div class="axyra-stat-label">Horas Dominicales</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasDominicalesNocturnas">0</div>
              <div class="axyra-stat-label">Dominicales Nocturnas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-star"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasFestivas">0</div>
              <div class="axyra-stat-label">Horas Festivas</div>
            </div>

            <div class="axyra-stat-card">
              <div class="axyra-stat-icon">
                <i class="fas fa-star"></i>
              </div>
              <div class="axyra-stat-number" id="totalHorasFestivasNocturnas">0</div>
              <div class="axyra-stat-label">Festivas Nocturnas</div>
            </div>
          </div>

          <div class="axyra-card">
            <div class="axyra-card-header">
              <h4 class="axyra-card-title">Resumen de Valores</h4>
            </div>
            <div class="axyra-card-content">
              <div class="axyra-grid axyra-grid-2">
                <div class="axyra-summary-item">
                  <span class="axyra-summary-label">Total Horas Trabajadas:</span>
                  <span class="axyra-summary-value" id="totalHorasTrabajadas">0</span>
                </div>
                <div class="axyra-summary-item">
                  <span class="axyra-summary-label">Valor Total:</span>
                  <span class="axyra-summary-value" id="valorTotalHoras">$0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Generación de Comprobantes -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-file-pdf"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Generación de Comprobantes</h3>
              <p class="axyra-card-subtitle">Genera comprobantes de pago en PDF</p>
            </div>
          </div>
          <div class="axyra-card-content">
            <form id="formComprobante" class="axyra-form">
              <div class="axyra-form-row">
                <div class="axyra-form-group">
                  <label for="empleadoComprobante" class="axyra-form-label">Empleado</label>
                  <select id="empleadoComprobante" name="empleado" class="axyra-form-select" required>
                    <option value="">Seleccionar empleado</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label for="tipoContrato" class="axyra-form-label">Tipo de Contrato</label>
                  <select id="tipoContrato" name="tipoContrato" class="axyra-form-select" required>
                    <option value="FIJO">Empleado Fijo</option>
                    <option value="POR_HORAS">Por Horas</option>
                  </select>
                </div>
                <div class="axyra-form-group">
                  <label for="salarioBase" class="axyra-form-label">Salario Base</label>
                  <input
                    type="number"
                    id="salarioBase"
                    name="salarioBase"
                    class="axyra-form-input"
                    placeholder="1423500"
                    required
                  />
                </div>
              </div>

              <div class="axyra-form-row">
                <div class="axyra-form-group">
                  <label for="deudaComentario" class="axyra-form-label">Motivo de Deuda (opcional)</label>
                  <input
                    type="text"
                    id="deudaComentario"
                    name="deudaComentario"
                    class="axyra-form-input"
                    placeholder="Descripción de la deuda"
                  />
                </div>
                <div class="axyra-form-group">
                  <label for="deudaValor" class="axyra-form-label">Valor de Deuda (opcional)</label>
                  <input
                    type="number"
                    id="deudaValor"
                    name="deudaValor"
                    class="axyra-form-input"
                    placeholder="0"
                    min="0"
                  />
                </div>
              </div>

              <div class="axyra-form-actions">
                <button type="submit" class="axyra-btn axyra-btn-primary">
                  <i class="fas fa-file-pdf"></i> Generar Comprobante PDF
                </button>
                <button type="button" class="axyra-btn axyra-btn-info" onclick="previsualizarComprobante()">
                  <i class="fas fa-eye"></i> Previsualizar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Historial de Pagos -->
        <div class="axyra-card">
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div>
              <h3 class="axyra-card-title">Historial de Pagos</h3>
              <p class="axyra-card-subtitle">Registros de horas trabajadas y pagos por empleado</p>
            </div>
          </div>

          <!-- Resumen de Horas -->
          <div class="axyra-hours-summary">
            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="totalHorasMes">0</div>
                <div class="axyra-summary-label">Horas del Mes</div>
              </div>
            </div>

            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="totalPagosMes">$0</div>
                <div class="axyra-summary-label">Total Pagos</div>
              </div>
            </div>

            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="empleadosActivos">0</div>
                <div class="axyra-summary-label">Empleados Activos</div>
              </div>
            </div>

            <div class="axyra-summary-card">
              <div class="axyra-summary-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="axyra-summary-content">
                <div class="axyra-summary-number" id="diasTrabajados">0</div>
                <div class="axyra-summary-label">Días Trabajados</div>
              </div>
            </div>
          </div>

          <!-- Filtros Mejorados -->
          <div class="axyra-filters-enhanced">
            <div class="axyra-search-box">
              <input type="text" id="searchHoras" class="axyra-form-input" placeholder="Buscar por empleado..." />
              <i class="fas fa-search"></i>
            </div>
            <div class="axyra-filter-group">
              <select id="filterFechaHoras" class="axyra-form-select">
                <option value="">Todas las fechas</option>
                <option value="hoy">Hoy</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este mes</option>
                <option value="trimestre">Este trimestre</option>
              </select>
              <select id="filterTipoHoras" class="axyra-form-select">
                <option value="">Todos los tipos</option>
                <option value="normal">Horas Normales</option>
                <option value="extra">Horas Extras</option>
                <option value="nocturna">Horas Nocturnas</option>
                <option value="dominical">Horas Dominicales</option>
              </select>
              <select id="filterDepartamento" class="axyra-form-select">
                <option value="">Todos los departamentos</option>
                <option value="Administración">Administración</option>
                <option value="Ventas">Ventas</option>
                <option value="Producción">Producción</option>
                <option value="Tecnología">Tecnología</option>
              </select>
            </div>
            <button class="axyra-btn axyra-btn-primary" onclick="exportarHistorialHoras()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>

          <div class="axyra-table-container">
            <table class="axyra-table">
              <thead>
                <tr>
                  <th>Empleado</th>
                  <th>Departamento/Cargo</th>
                  <th>Fecha</th>
                  <th>Total Horas</th>
                  <th>Tipo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="historialHoras">
                <!-- El historial se cargará dinámicamente -->
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <div class="axyra-pagination">
            <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaHoras(-1)">
              <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="paginaHorasInfo">Página 1 de 1</span>
            <button class="axyra-btn axyra-btn-outline" onclick="cambiarPaginaHoras(1)">
              Siguiente <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal eliminado - convertido a cajón -->

    <script>
      // Variables globales
      let empleados = [];
      let horas = [];
      let currentUser = null;

      // Verificar autenticación
      function checkAuth() {
        try {
          const user = localStorage.getItem('axyra_isolated_user');
          if (!user) {
            // Para testing, crear un usuario de prueba
            const testUser = {
              username: 'admin',
              role: 'admin',
              loginTime: new Date().toISOString(),
            };
            localStorage.setItem('axyra_isolated_user', JSON.stringify(testUser));
          } else {
          }
        } catch (error) {
          console.error('❌ Error en checkAuth:', error);
          // Para testing, continuar sin autenticación
        }
      }

      // Verificar autenticación (alias para compatibilidad)
      async function verificarAutenticacion() {
        try {
          console.log('🔐 Verificando autenticación...');

          // Verificar sesión usando localStorage
          const user = localStorage.getItem('axyra_isolated_user');
          if (user) {
            try {
              const userData = JSON.parse(user);
              if (userData && (userData.username || userData.email)) {
                console.log('✅ Usuario autenticado con localStorage:', userData.username || userData.email);
                return true;
              }
            } catch (error) {
              console.error('Error parseando sesión de localStorage:', error);
            }
          }

          // No hay sesión activa
          console.log('⚠️ No hay sesión activa - redirigiendo al login');
          window.location.href = '../../login.html';
          return false;
        } catch (error) {
          console.error('❌ Error al verificar sesión:', error);
          window.location.href = '../../login.html';
          return false;
        }
      }

      // Cerrar sesión - SISTEMA AISLADO
      function logout() {
        console.log('🔄 Cerrando sesión desde gestión de horas...');

        // Usar el sistema aislado
        if (window.axyraIsolatedAuth) {
          window.axyraIsolatedAuth.logout();
        }

        console.log('✅ Sesión cerrada desde gestión de horas');
        window.location.href = '../../login.html';
      }

      // Función para actualizar valores de hora según empleado seleccionado
      async function actualizarValoresHora() {
        try {
          const empleadoSelect = document.getElementById('empleadoHoras');
          const salarioBaseInput = document.getElementById('salarioBase');

          if (!empleadoSelect || !salarioBaseInput) return;

          const empleadoId = empleadoSelect.value;
          if (!empleadoId) return;

          // Obtener empleado seleccionado usando firebaseSyncManager
          let empleados = [];
          if (window.firebaseSyncManager) {
            try {
              empleados = await window.firebaseSyncManager.getEmpleados() || [];
            } catch (error) {
              console.warn('⚠️ Error con firebaseSyncManager, usando localStorage:', error);
              empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            }
          } else {
            empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          }

          const empleado = empleados.find(emp => emp.id == empleadoId);

          if (!empleado) return;

          const salarioBase = empleado.salario || 0;
          const tipoContrato = empleado.tipoContrato || 'Por Horas';

          // Actualizar salario base en el formulario
          salarioBaseInput.value = salarioBase;

          // Calcular valores de hora usando la calculadora
          if (window.colombianLaborLawCalculator) {
            try {
              const valoresHoras = window.colombianLaborLawCalculator.calcularValoresHoras(salarioBase, tipoContrato);

              // Actualizar cada campo con su valor correspondiente usando el mapeo correcto
              const camposValores = {
                'valorHoraOrdinaria': valoresHoras.valores.ordinarias,
                'valorHoraNocturna': valoresHoras.valores.nocturnas,
                'valorHoraExtraDiurna': valoresHoras.valores.extraDiurnas,
                'valorHoraExtraNocturna': valoresHoras.valores.extraNocturnas,
                'valorHoraDominical': valoresHoras.valores.dominicales,
                'valorHoraFestiva': valoresHoras.valores.festivas,
                'valorHoraDominicalNocturna': valoresHoras.valores.dominicalesNocturnas,
                'valorHoraFestivaNocturna': valoresHoras.valores.festivasNocturnas,
                'valorHoraExtraDominical': valoresHoras.valores.extraDominicales,
                'valorHoraExtraDominicalNocturna': valoresHoras.valores.extraDominicalesNocturnas,
                'valorHoraExtraFestiva': valoresHoras.valores.extraFestivas,
                'valorHoraExtraFestivaNocturna': valoresHoras.valores.extraFestivasNocturnas
              };

              Object.entries(camposValores).forEach(([id, valor]) => {
                const elemento = document.getElementById(id);
                if (elemento && valor !== undefined) {
                  elemento.textContent = `Valor: $${valor.toFixed(0)}`;
                }
              });

              console.log('✅ Valores de hora actualizados:', valoresHoras);
              console.log('💰 Valor hora ordinaria:', valoresHoras.valorHoraBase);
              console.log('📊 Valores por tipo:', valoresHoras.valores);
            } catch (error) {
              console.warn('⚠️ Error calculando valores de hora:', error);
            }
          }
        } catch (error) {
          console.error('❌ Error actualizando valores de hora:', error);
        }
      }

      // Función para cargar empleados en los selects
      async function cargarEmpleados() {
        try {
          console.log('👥 Cargando empleados para selects...');

          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          if (!currentUser) {
            console.log('⚠️ No hay usuario autenticado');
            return;
          }

          // Usar el sistema de sincronización si está disponible
          if (window.firebaseSyncManager) {
            try {
              console.log('🔄 Usando sistema de sincronización para empleados...');
              const empleados = await window.firebaseSyncManager.getEmpleados() || [];

              if (empleados.length > 0) {
                console.log(`✅ Empleados cargados desde Firebase Sync Manager: ${empleados.length}`);

                // Guardar en localStorage para sincronización
                localStorage.setItem('axyra_empleados', JSON.stringify(empleados));

                // Cargar en los selects
                cargarEmpleadosEnSelects(empleados);
                return;
              }
            } catch (syncError) {
              console.warn('⚠️ Error con sistema de sincronización, usando método directo:', syncError);
            }
          }

          // Intentar cargar desde Firebase directamente si está disponible
          if (typeof firebase !== 'undefined' && firebase.firestore && currentUser.id) {
            try {
              console.log('🔥 Intentando cargar empleados desde Firebase directamente...');
              const empleadosSnapshot = await firebase
                .firestore()
                .collection('empleados')
                .where('userId', '==', currentUser.id)
                .get();

              if (!empleadosSnapshot.empty) {
                const empleadosFirebase = [];
                empleadosSnapshot.forEach((doc) => {
                  empleadosFirebase.push({
                    id: doc.id,
                    ...doc.data(),
                  });
                });

                console.log(`✅ Empleados cargados desde Firebase directamente: ${empleadosFirebase.length}`);

                // Guardar en localStorage para sincronización
                localStorage.setItem('axyra_empleados', JSON.stringify(empleadosFirebase));

                // Cargar en los selects
                cargarEmpleadosEnSelects(empleadosFirebase);
                return;
              } else {
                console.log('ℹ️ No hay empleados en Firebase para este usuario');
              }
            } catch (firebaseError) {
              console.log('ℹ️ Firebase no disponible, usando localStorage:', firebaseError.message);
            }
          }

          // Cargar empleados desde localStorage (fallback)
          const empleadosData = localStorage.getItem('axyra_empleados');
          console.log('🔍 Datos de empleados en localStorage:', empleadosData);

          if (empleadosData) {
            try {
              const empleados = JSON.parse(empleadosData);
              console.log(`📦 Empleados cargados desde localStorage: ${empleados.length}`);
              console.log('🔍 Todos los empleados:', empleados);

              // Filtrar por usuario actual - INCLUIR TODOS LOS EMPLEADOS PARA PRUEBAS
              const empleadosFiltrados = empleados.filter(
                (emp) =>
                  emp.userId === currentUser.username ||
                  emp.userId === currentUser.email ||
                  emp.userId === currentUser.id ||
                  !emp.userId || // Incluir empleados sin userId (datos globales)
                  emp.userId === undefined // Incluir empleados sin userId definido
              );

              console.log(`✅ Empleados filtrados para usuario actual: ${empleadosFiltrados.length}`);
              console.log('🔍 Empleados filtrados:', empleadosFiltrados);
              console.log('🔍 Usuario actual:', currentUser);

              // Verificar que no haya empleados duplicados
              const empleadosUnicos = [];
              const idsVistos = new Set();

              for (const empleado of empleadosFiltrados) {
                if (empleado.id && !idsVistos.has(empleado.id)) {
                  idsVistos.add(empleado.id);
                  empleadosUnicos.push(empleado);
                }
              }

              if (empleadosUnicos.length !== empleadosFiltrados.length) {
                console.log(
                  `⚠️ Se encontraron empleados duplicados. Limpiando de ${empleadosFiltrados.length} a ${empleadosUnicos.length}`
                );
              }

              // Cargar en los selects
              cargarEmpleadosEnSelects(empleadosUnicos);
            } catch (error) {
              console.error('❌ Error parseando empleados de localStorage:', error);
              cargarEmpleadosEnSelects([]);
            }
          } else {
            console.log('ℹ️ No hay empleados en localStorage');
            cargarEmpleadosEnSelects([]);
          }
        } catch (error) {
          console.error('❌ Error en cargarEmpleados:', error);
          mostrarMensaje('Error cargando empleados: ' + error.message, 'error');
        }
      }

      // Función auxiliar para cargar empleados en los selects
      function cargarEmpleadosEnSelects(empleados) {
        console.log('🔍 cargarEmpleadosEnSelects llamada con:', empleados);

        const selectEmpleado = document.getElementById('empleadoHoras');
        const selectComprobante = document.getElementById('empleadoComprobante');

        if (!selectEmpleado || !selectComprobante) {
          console.error('❌ No se encontraron los selects de empleados');
          console.log('🔍 Elementos buscados:', {
            empleadoHoras: selectEmpleado,
            empleadoComprobante: selectComprobante,
          });
          return;
        }

        // Limpiar selects
        selectEmpleado.innerHTML = '<option value="">Seleccionar empleado</option>';
        selectComprobante.innerHTML = '<option value="">Seleccionar empleado</option>';

        if (empleados.length === 0) {
          console.log('ℹ️ No hay empleados para mostrar');
          return;
        }

        // Agregar opciones
        empleados.forEach((empleado) => {
          console.log('👤 Agregando empleado:', empleado);

          const optionEmpleado = document.createElement('option');
          optionEmpleado.value = empleado.id;
          optionEmpleado.textContent = `${empleado.nombre} (${empleado.cargo || 'Sin cargo'})`;
          selectEmpleado.appendChild(optionEmpleado);

          const optionComprobante = document.createElement('option');
          optionComprobante.value = empleado.id;
          optionComprobante.textContent = `${empleado.nombre} (${empleado.cargo || 'Sin cargo'})`;
          selectComprobante.appendChild(optionComprobante);
        });

        console.log(`✅ ${empleados.length} empleados cargados en los selects`);
        console.log('🔍 Selects después de cargar:', {
          empleadoHoras: selectEmpleado.innerHTML,
          empleadoComprobante: selectComprobante.innerHTML,
        });
      }

      // Manejar formulario de registro masivo (comentado hasta que se implemente)
      // document.getElementById('formRegistroMasivo').addEventListener('submit', function (e) {
      //   e.preventDefault();
      //   registrarHorasMasivas();
      // });

      // Registrar horas masivas
      function registrarHorasMasivas() {
        const fecha = document.getElementById('fechaMasiva').value;
        const horaEntrada = document.getElementById('horaEntradaMasiva').value;
        const horaSalida = document.getElementById('horaSalidaMasiva').value;
        const tipo = document.getElementById('tipoMasivo').value;

        if (!fecha || !horaEntrada || !horaSalida || !tipo) {
          alert('Por favor completa todos los campos');
          return;
        }

        const empleadosSeleccionados = document.querySelectorAll('#empleadosMasivos input[type="checkbox"]:checked');
        if (empleadosSeleccionados.length === 0) {
          alert('Selecciona al menos un empleado');
          return;
        }

        let registrosExitosos = 0;
        empleadosSeleccionados.forEach((checkbox) => {
          const empleadoId = checkbox.value;
          const empleado = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').find(
            (emp) => emp.id === empleadoId
          );

          if (empleado) {
            const registro = {
              id: Date.now() + Math.random(),
              empleadoId: empleadoId,
              empleado: empleado.nombre,
              fecha: fecha,
              horaEntrada: horaEntrada,
              horaSalida: horaSalida,
              tipo: tipo,
              timestamp: new Date().toISOString(),
            };

            const registros = JSON.parse(localStorage.getItem('axyra_registros_horas') || '[]');
            registros.push(registro);
            localStorage.setItem('axyra_registros_horas', JSON.stringify(registros));
            registrosExitosos++;
          }
        });

        alert(`Se registraron ${registrosExitosos} empleados exitosamente`);

        // Limpiar formulario
        // document.getElementById('formRegistroMasivo').reset();
        document.querySelectorAll('#empleadosMasivos input[type="checkbox"]').forEach((cb) => (cb.checked = false));

        // Actualizar historial
        cargarHistorial();
      }

      // Función para calcular horas y mostrar modal
      function calcularHoras() {
        try {
          // Obtener elementos del DOM con validación
          const empleadoHoras = document.getElementById('empleadoHoras');
          const fechaHoras = document.getElementById('fechaHoras');
          const horasOrdinarias = document.getElementById('horasOrdinarias');
          const horasNocturnas = document.getElementById('horasNocturnas');
          const horasExtraDiurnas = document.getElementById('horasExtraDiurnas');
          const horasExtraNocturnas = document.getElementById('horasExtraNocturnas');
          const horasDominicales = document.getElementById('horasDominicales');
          const horasFestivas = document.getElementById('horasFestivas');
          const horasDominicalesNocturnas = document.getElementById('horasDominicalesNocturnas');
          const horasFestivasNocturnas = document.getElementById('horasFestivasNocturnas');
          const horasExtraDominicales = document.getElementById('horasExtraDominicales');
          const horasExtraDominicalesNocturnas = document.getElementById('horasExtraDominicalesNocturnas');
          const horasExtraFestivas = document.getElementById('horasExtraFestivas');
          const horasExtraFestivasNocturnas = document.getElementById('horasExtraFestivasNocturnas');
          const salarioBase = document.getElementById('salarioBase');

          // Validar que los elementos existan
          if (
            !empleadoHoras ||
            !fechaHoras ||
            !horasOrdinarias ||
            !horasNocturnas ||
            !horasExtraDiurnas ||
            !horasExtraNocturnas ||
            !horasDominicales ||
            !horasFestivas ||
            !horasDominicalesNocturnas ||
            !horasFestivasNocturnas ||
            !horasExtraDominicales ||
            !horasExtraDominicalesNocturnas ||
            !horasExtraFestivas ||
            !horasExtraFestivasNocturnas ||
            !salarioBase
          ) {
            console.error('❌ Campos faltantes:', {
              empleadoHoras: !!empleadoHoras,
              fechaHoras: !!fechaHoras,
              horasOrdinarias: !!horasOrdinarias,
              horasNocturnas: !!horasNocturnas,
              horasExtraDiurnas: !!horasExtraDiurnas,
              horasExtraNocturnas: !!horasExtraNocturnas,
              horasDominicales: !!horasDominicales,
              horasFestivas: !!horasFestivas,
              horasDominicalesNocturnas: !!horasDominicalesNocturnas,
              horasFestivasNocturnas: !!horasFestivasNocturnas,
              horasExtraDominicales: !!horasExtraDominicales,
              horasExtraDominicalesNocturnas: !!horasExtraDominicalesNocturnas,
              horasExtraFestivas: !!horasExtraFestivas,
              horasExtraFestivasNocturnas: !!horasExtraFestivasNocturnas,
              salarioBase: !!salarioBase
            });
            mostrarMensaje('❌ Error: No se pudieron cargar los campos del formulario', 'error');
            return;
          }

          // Obtener valores del formulario
          const empleadoId = empleadoHoras.value;
          const fecha = fechaHoras.value;
          const horasOrdinariasVal = parseFloat(horasOrdinarias.value) || 0;
          const horasNocturnasVal = parseFloat(horasNocturnas.value) || 0;
          const horasExtraDiurnasVal = parseFloat(horasExtraDiurnas.value) || 0;
          const horasExtraNocturnasVal = parseFloat(horasExtraNocturnas.value) || 0;
          const horasDominicalesVal = parseFloat(horasDominicales.value) || 0;
          const horasFestivasVal = parseFloat(horasFestivas.value) || 0;
          const horasDominicalesNocturnasVal = parseFloat(horasDominicalesNocturnas.value) || 0;
          const horasFestivasNocturnasVal = parseFloat(horasFestivasNocturnas.value) || 0;
          const horasExtraDominicalesVal = parseFloat(horasExtraDominicales.value) || 0;
          const horasExtraDominicalesNocturnasVal = parseFloat(horasExtraDominicalesNocturnas.value) || 0;
          const horasExtraFestivasVal = parseFloat(horasExtraFestivas.value) || 0;
          const horasExtraFestivasNocturnasVal = parseFloat(horasExtraFestivasNocturnas.value) || 0;
          const salarioBaseVal = parseFloat(salarioBase.value) || 0;

          // Validar datos
          if (!empleadoId) {
            mostrarMensaje('❌ Selecciona un empleado', 'error');
            return;
          }

          if (!fecha) {
            mostrarMensaje('❌ Selecciona una fecha', 'error');
            return;
          }

          // Validar que al menos un tipo de horas sea mayor a 0
          const totalHoras = horasOrdinariasVal + horasNocturnasVal + horasExtraDiurnasVal +
                           horasExtraNocturnasVal + horasDominicalesVal + horasFestivasVal +
                           horasDominicalesNocturnasVal + horasFestivasNocturnasVal +
                           horasExtraDominicalesVal + horasExtraDominicalesNocturnasVal +
                           horasExtraFestivasVal + horasExtraFestivasNocturnasVal;

          if (totalHoras === 0) {
            mostrarMensaje('❌ Ingresa al menos un tipo de horas', 'error');
            return;
          }

          // Obtener información del empleado
          const empleado = JSON.parse(localStorage.getItem('axyra_empleados') || '[]').find(
            (emp) => emp.id === parseInt(empleadoId)
          );

          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          // El totalHoras ya se calculó arriba

          // Calcular salarios según la ley colombiana usando la calculadora
          let calculoHoras;
          try {
            // Mapear campos del formulario a los tipos de horas correctos
            const horasData = {
              ordinarias: horasOrdinariasVal,
              nocturnas: horasNocturnasVal,
              extraDiurnas: horasExtraDiurnasVal,
              extraNocturnas: horasExtraNocturnasVal,
              dominicales: horasDominicalesVal,
              festivas: horasFestivasVal,
              dominicalesNocturnas: horasDominicalesNocturnasVal,
              festivasNocturnas: horasFestivasNocturnasVal,
              extraDominicales: horasExtraDominicalesVal,
              extraDominicalesNocturnas: horasExtraDominicalesNocturnasVal,
              extraFestivas: horasExtraFestivasVal,
              extraFestivasNocturnas: horasExtraFestivasNocturnasVal
            };

            const tipoContrato = empleado.tipoContrato || 'Por Horas';

            calculoHoras = window.colombianLaborLawCalculator.calcularSalariosCompletos(horasData, salarioBaseVal, tipoContrato);

            console.log('✅ Cálculo de horas realizado correctamente:', calculoHoras);
          } catch (error) {
            console.error('❌ Error en cálculo de horas:', error);
            // Fallback al cálculo anterior usando los tipos correctos
            const salarioHora = salarioBaseVal / 220; // Corregido a 220 según la ley colombiana
          const salarioOrdinario = horasOrdinariasVal * salarioHora;
            const salarioNocturnas = horasNocturnasVal * (salarioHora * 1.35); // 35% recargo
            const salarioExtraDiurnas = horasExtraDiurnasVal * (salarioHora * 1.25); // 25% recargo
            const salarioExtraNocturnas = horasExtraNocturnasVal * (salarioHora * 1.75); // 75% recargo
            const salarioDominicales = horasDominicalesVal * (salarioHora * 1.75); // 75% recargo
            const salarioFestivas = horasFestivasVal * (salarioHora * 1.80); // 80% recargo
            const salarioDominicalesNocturnas = horasDominicalesNocturnasVal * (salarioHora * 2.10); // 110% recargo
            const salarioFestivasNocturnas = horasFestivasNocturnasVal * (salarioHora * 2.10); // 110% recargo
            const salarioExtraDominicales = horasExtraDominicalesVal * (salarioHora * 2.05); // 105% recargo
            const salarioExtraDominicalesNocturnas = horasExtraDominicalesNocturnasVal * (salarioHora * 2.85); // 185% recargo
            const salarioExtraFestivas = horasExtraFestivasVal * (salarioHora * 2.05); // 105% recargo
            const salarioExtraFestivasNocturnas = horasExtraFestivasNocturnasVal * (salarioHora * 2.85); // 185% recargo

            calculoHoras = {
              valorHora: salarioHora,
              salarios: {
                ordinarias: salarioOrdinario,
                nocturnas: salarioNocturnas,
                extraDiurnas: salarioExtraDiurnas,
                extraNocturnas: salarioExtraNocturnas,
                dominicales: salarioDominicales,
                festivas: salarioFestivas,
                dominicalesNocturnas: salarioDominicalesNocturnas,
                festivasNocturnas: salarioFestivasNocturnas,
                extraDominicales: salarioExtraDominicales,
                extraDominicalesNocturnas: salarioExtraDominicalesNocturnas,
                extraFestivas: salarioExtraFestivas,
                extraFestivasNocturnas: salarioExtraFestivasNocturnas
              },
              totalHoras: totalHoras,
              totalSalario: salarioOrdinario + salarioNocturnas + salarioExtraDiurnas + salarioExtraNocturnas +
                           salarioDominicales + salarioFestivas + salarioDominicalesNocturnas + salarioFestivasNocturnas +
                           salarioExtraDominicales + salarioExtraDominicalesNocturnas + salarioExtraFestivas + salarioExtraFestivasNocturnas
            };
          }

          // Mostrar modal con cálculos
          mostrarModalCalculoHoras({
            empleado,
            fecha,
            horas: {
              ordinarias: horasOrdinariasVal,
              nocturnas: horasNocturnasVal,
              extraDiurnas: horasExtraDiurnasVal,
              extraNocturnas: horasExtraNocturnasVal,
              dominicales: horasDominicalesVal,
              festivas: horasFestivasVal,
              dominicalesNocturnas: horasDominicalesNocturnasVal,
              festivasNocturnas: horasFestivasNocturnasVal,
              extraDominicales: horasExtraDominicalesVal,
              extraDominicalesNocturnas: horasExtraDominicalesNocturnasVal,
              extraFestivas: horasExtraFestivasVal,
              extraFestivasNocturnas: horasExtraFestivasNocturnasVal,
              total: calculoHoras.totalHoras,
            },
            salarios: {
              base: salarioBaseVal,
              ordinarias: calculoHoras.salarios.ordinarias,
              nocturnas: calculoHoras.salarios.nocturnas,
              extraDiurnas: calculoHoras.salarios.extraDiurnas,
              extraNocturnas: calculoHoras.salarios.extraNocturnas,
              dominicales: calculoHoras.salarios.dominicales,
              festivas: calculoHoras.salarios.festivas,
              dominicalesNocturnas: calculoHoras.salarios.dominicalesNocturnas,
              festivasNocturnas: calculoHoras.salarios.festivasNocturnas,
              extraDominicales: calculoHoras.salarios.extraDominicales,
              extraDominicalesNocturnas: calculoHoras.salarios.extraDominicalesNocturnas,
              extraFestivas: calculoHoras.salarios.extraFestivas,
              extraFestivasNocturnas: calculoHoras.salarios.extraFestivasNocturnas,
              total: calculoHoras.totalSalario,
            },
            salarioHora: calculoHoras.valorHora,
            calculoCompleto: calculoHoras
          });
        } catch (error) {
          console.error('❌ Error calculando horas:', error);
          mostrarMensaje('Error calculando horas: ' + error.message, 'error');
        }
      }

      // Función para mostrar modal de cálculo de horas
      function mostrarModalCalculoHoras(datos) {
        const modalHTML = `
          <div id="modalCalculoHoras" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content axyra-modal-large">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-calculator"></i> Cálculo de Horas - ${datos.empleado.nombre}
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalCalculoHoras()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-calculo-container">
                  <!-- Información del empleado -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-user"></i> Información del Empleado</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Nombre:</span>
                        <span class="axyra-calculo-value">${datos.empleado.nombre || 'N/A'}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Cargo:</span>
                        <span class="axyra-calculo-value">${datos.empleado.cargo || 'N/A'}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Departamento:</span>
                        <span class="axyra-calculo-value">${datos.empleado.departamento || 'N/A'}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Fecha:</span>
                        <span class="axyra-calculo-value">${new Date(datos.fecha).toLocaleDateString('es-CO')}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Base:</span>
                        <span class="axyra-calculo-value">$${datos.salarios.base.toLocaleString('es-CO')}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Resumen de Ley Laboral Colombiana -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-gavel"></i> Ley Laboral Colombiana</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Valor Hora Ordinaria:</span>
                        <span class="axyra-calculo-value">$${datos.salarioHora.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Mensuales:</span>
                        <span class="axyra-calculo-value">220 horas</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Base de Cálculo:</span>
                        <span class="axyra-calculo-value">Salario ÷ 220</span>
                      </div>
                    </div>
                  </div>

                  <!-- Desglose de horas -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-clock"></i> Desglose de Horas</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Ordinarias (6:00 AM - 6:00 PM):</span>
                        <span class="axyra-calculo-value">${datos.horas.ordinarias} hrs - $${datos.salarios.ordinarias.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Nocturnas (35% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.nocturnas} hrs - $${datos.salarios.nocturnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Diurnas (25% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extraDiurnas} hrs - $${datos.salarios.extraDiurnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Nocturnas (75% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extraNocturnas} hrs - $${datos.salarios.extraNocturnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Dominicales (75% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.dominicales} hrs - $${datos.salarios.dominicales.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Festivas (80% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.festivas} hrs - $${datos.salarios.festivas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Dominicales Nocturnas (110% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.dominicalesNocturnas} hrs - $${datos.salarios.dominicalesNocturnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Festivas Nocturnas (110% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.festivasNocturnas} hrs - $${datos.salarios.festivasNocturnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Dominicales (105% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extraDominicales} hrs - $${datos.salarios.extraDominicales.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Dominicales Nocturnas (185% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extraDominicalesNocturnas} hrs - $${datos.salarios.extraDominicalesNocturnas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Festivas (105% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extraFestivas} hrs - $${datos.salarios.extraFestivas.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Festivas Nocturnas (185% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extraFestivasNocturnas} hrs - $${datos.salarios.extraFestivasNocturnas.toFixed(2)}</span>
                      </div>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Horas Extra Festivas Nocturnas (150% recargo):</span>
                        <span class="axyra-calculo-value">${datos.horas.extrasFestivasNocturnas} hrs</span>
                      </div>
                      <div class="axyra-calculo-item axyra-calculo-total">
                        <span class="axyra-calculo-label">Total Horas:</span>
                        <span class="axyra-calculo-value">${datos.horas.total} hrs</span>
                      </div>
                    </div>
                  </div>

                  <!-- Cálculo de salarios -->
                  <div class="axyra-calculo-section">
                    <h4><i class="fas fa-dollar-sign"></i> Cálculo de Salarios</h4>
                    <div class="axyra-calculo-grid">
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Valor Hora Ordinaria:</span>
                        <span class="axyra-calculo-value">$${datos.salarioHora.toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Ordinario (0% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.ordinarias || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Nocturno (35% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.nocturnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extra Diurno (25% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.extraDiurnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extra Nocturno (75% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.extraNocturnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Dominical (75% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.dominicales || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Festivo (80% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.festivas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Dominical Nocturno (110% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.dominicalesNocturnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Festivo Nocturno (110% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.festivasNocturnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extra Dominical (105% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.extraDominicales || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extra Dominical Nocturno (185% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.extraDominicalesNocturnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extra Festivo (105% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.extraFestivas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item">
                        <span class="axyra-calculo-label">Salario Extra Festivo Nocturno (185% recargo):</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.extraFestivasNocturnas || 0).toFixed(2)}</span>
                      </div>
                      <div class="axyra-calculo-item axyra-calculo-total">
                        <span class="axyra-calculo-label">Total a Pagar:</span>
                        <span class="axyra-calculo-value">$${(datos.salarios.total || 0).toFixed(2)}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Resumen final -->
                  <div class="axyra-calculo-resumen">
                    <div class="axyra-calculo-resumen-item">
                      <span class="axyra-calculo-resumen-label">Total Horas Trabajadas:</span>
                      <span class="axyra-calculo-resumen-value">${datos.horas.total} horas</span>
                    </div>
                    <div class="axyra-calculo-resumen-item">
                      <span class="axyra-calculo-resumen-label">Total a Pagar:</span>
                      <span class="axyra-calculo-resumen-value">$${datos.salarios.total.toLocaleString('es-CO')}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button type="button" class="axyra-btn axyra-btn-secondary" onclick="cerrarModalCalculoHoras()">
                  <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="axyra-btn axyra-btn-primary" onclick="confirmarRegistroHoras()">
                  <i class="fas fa-save"></i> Confirmar y Registrar
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      // Función para cerrar modal de cálculo
      function cerrarModalCalculoHoras() {
        try {
        const modal = document.getElementById('modalCalculoHoras');
        if (modal) {
          modal.remove();
          }
        } catch (error) {
          console.error('❌ Error cerrando modal:', error);
        }
      }

      // Función para confirmar registro de horas
      function confirmarRegistroHoras() {
        try {
        cerrarModalCalculoHoras();

          // Obtener los datos del modal y registrar las horas
          const empleadoHoras = document.getElementById('empleadoHoras');
          const fechaHoras = document.getElementById('fechaHoras');
          const observaciones = document.getElementById('observaciones');

          if (empleadoHoras && fechaHoras) {
            // Llamar a la función de registro
            registrarHoras();
        mostrarMensaje('✅ Horas registradas correctamente', 'success');
          } else {
            mostrarMensaje('❌ Error: No se pudo obtener la información del formulario', 'error');
          }
        } catch (error) {
          console.error('❌ Error confirmando registro:', error);
          mostrarMensaje('Error confirmando registro: ' + error.message, 'error');
        }
      }

      // Previsualizar comprobante
      async function previsualizarComprobante() {
        try {
          const empleadoId = document.getElementById('empleadoComprobante').value;
          const tipoContrato = document.getElementById('tipoContrato').value;
          const salarioBase = document.getElementById('salarioBase').value;
          const deudaComentario = document.getElementById('deudaComentario').value;
          const deudaValor = document.getElementById('deudaValor').value;

          if (!empleadoId || !salarioBase) {
            mostrarMensaje('❌ Por favor completa todos los campos obligatorios', 'warning');
            return;
          }

          // Mostrar indicador de carga
          mostrarMensaje('⏳ Preparando previsualización...', 'info');

          // Usar el nuevo generador de PDFs si está disponible
          if (window.comprobantePDFGenerator) {
            try {
              const resultado = await window.comprobantePDFGenerator.previsualizarComprobante(
                empleadoId,
                tipoContrato,
                salarioBase,
                deudaComentario,
                deudaValor
              );

              if (resultado.success) {
                mostrarMensaje('✅ Previsualización generada correctamente', 'success');
              } else {
                throw new Error(resultado.message || 'Error desconocido');
              }
            } catch (error) {
              console.warn('⚠️ Error con nuevo generador, usando fallback:', error);
              // Continuar con el método fallback
            }
          }

          // Método fallback - obtener información del empleado
          let empleados = [];
          if (window.firebaseSyncManager) {
            empleados = await window.firebaseSyncManager.getEmpleados();
          } else {
            empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          }

          // Mejorar la búsqueda del empleado - considerar diferentes tipos de ID
          console.log('🔍 [FALLBACK] Buscando empleado con ID:', empleadoId, 'Tipo:', typeof empleadoId);
          console.log(
            '📋 [FALLBACK] Empleados disponibles:',
            empleados.map((emp) => ({ id: emp.id, nombre: emp.nombre, tipoId: typeof emp.id }))
          );

          const empleado = empleados.find((emp) => {
            if (!emp || !emp.id) return false;

            // Comparar como string
            if (emp.id.toString() === empleadoId.toString()) return true;

            // Comparar como número
            if (parseInt(emp.id) === parseInt(empleadoId)) return true;

            return false;
          });

          console.log('✅ [FALLBACK] Empleado encontrado:', empleado);

          if (!empleado) {
            mostrarMensaje(
              '❌ Empleado no encontrado. Verifica que el empleado esté seleccionado correctamente.',
              'error'
            );
            return;
          }

          // Crear modal de previsualización
          const modalHTML = `
          <div id="modalPrevisualizacion" class="axyra-modal" style="display: flex;">
            <div class="axyra-modal-content" style="max-width: 800px;">
              <div class="axyra-modal-header">
                <h3 class="axyra-modal-title">
                  <i class="fas fa-eye"></i> Previsualización del Comprobante
                </h3>
                <button class="axyra-modal-close" onclick="cerrarModalPrevisualizacion()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-comprobante-preview">
                  <div class="axyra-preview-header">
                    <h4>Información del Empleado</h4>
                    <p><strong>Nombre:</strong> ${empleado.nombre}</p>
                    <p><strong>Cargo:</strong> ${empleado.cargo || 'N/A'}</p>
                    <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                    <p><strong>Tipo de Contrato:</strong> ${tipoContrato === 'FIJO' ? 'Empleado Fijo' : 'Por Horas'}</p>
                    <p><strong>Salario Base:</strong> $${parseFloat(salarioBase).toLocaleString()}</p>
                    ${deudaComentario ? `<p><strong>Motivo de Deuda:</strong> ${deudaComentario}</p>` : ''}
                    ${
                      deudaValor
                        ? `<p><strong>Valor de Deuda:</strong> $${parseFloat(deudaValor).toLocaleString()}</p>`
                        : ''
                    }
                  </div>
                  <div class="axyra-preview-note">
                    <p><em>Esta es una previsualización del comprobante. Para generar el PDF final, haz clic en "Generar Comprobante PDF".</em></p>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-secondary" onclick="cerrarModalPrevisualizacion()">
                  Cerrar
                </button>
                <button class="axyra-btn axyra-btn-primary" onclick="generarComprobantePDF()">
                  <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
              </div>
            </div>
          </div>
        `;

          document.body.insertAdjacentHTML('beforeend', modalHTML);
        } catch (error) {
          console.error('❌ Error previsualizando comprobante:', error);
          mostrarMensaje('❌ Error al previsualizar el comprobante: ' + error.message, 'error');
        }
      }

      // Cerrar modal de previsualización
      function cerrarModalPrevisualizacion() {
        const modal = document.getElementById('modalPrevisualizacion');
        if (modal) {
          modal.remove();
        }
      }

      // Generar comprobante PDF
      async function generarComprobantePDF() {
        try {
          const empleadoId = document.getElementById('empleadoComprobante').value;
          const tipoContrato = document.getElementById('tipoContrato').value;
          const salarioBase = document.getElementById('salarioBase').value;
          const deudaComentario = document.getElementById('deudaComentario').value;
          const deudaValor = document.getElementById('deudaValor').value;

          if (!empleadoId || !salarioBase) {
            mostrarMensaje('❌ Por favor completa todos los campos obligatorios', 'warning');
            return;
          }

          // Verificar si el empleado tiene horas registradas
          let horas = [];
          if (window.firebaseSyncManager) {
            try {
              horas = await window.firebaseSyncManager.getHoras() || [];
            } catch (error) {
              console.warn('⚠️ Error obteniendo horas desde Firebase Sync Manager:', error);
              horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
            }
          } else {
            horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          }

          // Buscar horas del empleado con compatibilidad de tipos de ID
          const horasEmpleado = horas.filter((h) => {
            if (!h || !h.empleadoId) return false;
            return h.empleadoId.toString() === empleadoId.toString() || parseInt(h.empleadoId) === parseInt(empleadoId);
          });

          if (horasEmpleado.length === 0) {
            mostrarMensaje('ℹ️ Este empleado no tiene horas registradas. Debes registrar horas trabajadas primero para generar un comprobante.', 'info');
            return;
          }

          // Mostrar indicador de carga
          mostrarMensaje('⏳ Generando comprobante PDF...', 'info');

          // Usar el nuevo generador de PDFs
          if (window.comprobantePDFGenerator) {
            const resultado = await window.comprobantePDFGenerator.generarComprobante(
              empleadoId,
              tipoContrato,
              salarioBase,
              deudaComentario,
              deudaValor
            );

            if (resultado.success) {
              mostrarMensaje('✅ ' + resultado.message, 'success');
              cerrarModalPrevisualizacion();
            } else {
              throw new Error(resultado.message || 'Error desconocido');
            }
          } else {
            // Fallback al método anterior
            await generarComprobantePDFFallback(empleadoId, tipoContrato, salarioBase, deudaComentario, deudaValor);
          }
        } catch (error) {
          console.error('❌ Error generando comprobante:', error);
          mostrarMensaje('❌ Error al generar el comprobante: ' + error.message, 'error');
        }
      }

      // Función fallback para compatibilidad
      async function generarComprobantePDFFallback(empleadoId, tipoContrato, salarioBase, deudaComentario, deudaValor) {
        try {
          // Obtener información del empleado usando el sistema de sincronización
          let empleados = [];
          if (window.firebaseSyncManager) {
            empleados = await window.firebaseSyncManager.getEmpleados();
          } else {
            empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          }

          // Mejorar la búsqueda del empleado - considerar diferentes tipos de ID
          console.log('🔍 Buscando empleado con ID:', empleadoId, 'Tipo:', typeof empleadoId);
          console.log(
            '📋 Empleados disponibles:',
            empleados.map((emp) => ({ id: emp.id, nombre: emp.nombre, tipoId: typeof emp.id }))
          );

          const empleado = empleados.find((emp) => {
            if (!emp || !emp.id) return false;

            // Comparar como string
            if (emp.id.toString() === empleadoId.toString()) return true;

            // Comparar como número
            if (parseInt(emp.id) === parseInt(empleadoId)) return true;

            return false;
          });

          console.log('✅ Empleado encontrado:', empleado);

          if (!empleado) {
            throw new Error('Empleado no encontrado');
          }

          // Crear datos del comprobante
          const comprobante = {
            empleado: empleado.nombre,
            cargo: empleado.cargo || 'N/A',
            departamento: empleado.departamento || 'N/A',
            tipoContrato: tipoContrato,
            salarioBase: parseFloat(salarioBase),
            deudaComentario: deudaComentario || '',
            deudaValor: parseFloat(deudaValor) || 0,
            fecha: new Date().toISOString().split('T')[0],
            cedula: empleado.cedula || 'N/A',
            email: empleado.email || 'N/A',
          };

          // Generar PDF usando jsPDF
          if (typeof jsPDF !== 'undefined') {
            generarPDFComprobante(comprobante);
            mostrarMensaje('✅ Comprobante PDF generado correctamente', 'success');
          } else {
            // Fallback: descargar como JSON
            const blob = new Blob([JSON.stringify(comprobante, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `COMPROBANTE_${empleado.nombre.replace(/\s+/g, '_')}_${
              new Date().toISOString().split('T')[0]
            }.json`;
            a.click();
            URL.revokeObjectURL(url);
            mostrarMensaje('✅ Comprobante descargado como JSON (PDF no disponible)', 'info');
          }

          cerrarModalPrevisualizacion();
        } catch (error) {
          console.error('❌ Error en fallback:', error);
          throw error;
        }
      }

      // Función para generar PDF del comprobante
      function generarPDFComprobante(comprobante) {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Configurar fuente y estilos
          doc.setFont('helvetica');
          doc.setFontSize(20);

          // Título
          doc.text('COMPROBANTE DE PAGO', 105, 20, { align: 'center' });

          // Información del empleado
          doc.setFontSize(12);
          doc.text('Empleado:', 20, 40);
          doc.text(comprobante.empleado, 80, 40);

          doc.text('Cargo:', 20, 50);
          doc.text(comprobante.cargo, 80, 50);

          doc.text('Departamento:', 20, 60);
          doc.text(comprobante.departamento, 80, 60);

          doc.text('Cédula:', 20, 70);
          doc.text(comprobante.cedula, 80, 70);

          // Información del pago
          doc.text('Tipo de Contrato:', 20, 90);
          doc.text(comprobante.tipoContrato, 80, 90);

          doc.text('Salario Base:', 20, 100);
          doc.text(`$${comprobante.salarioBase.toLocaleString()}`, 80, 100);

          if (comprobante.deudaValor > 0) {
            doc.text('Deuda:', 20, 110);
            doc.text(`$${comprobante.deudaValor.toLocaleString()}`, 80, 110);
            doc.text('Motivo:', 20, 120);
            doc.text(comprobante.deudaComentario, 80, 120);
          }

          // Fecha
          doc.text('Fecha:', 20, 140);
          doc.text(comprobante.fecha, 80, 140);

          // Guardar PDF
          const nombreArchivo = `COMPROBANTE_${comprobante.empleado.replace(/\s+/g, '_')}_${comprobante.fecha}.pdf`;
          doc.save(nombreArchivo);
        } catch (error) {
          console.error('❌ Error generando PDF:', error);
          throw new Error('No se pudo generar el PDF');
        }
      }

      // Mostrar información del día
      function mostrarInfoDia(infoDia) {
        // Crear o actualizar el elemento de información del día
        let infoDiaElement = document.getElementById('infoDia');
        if (!infoDiaElement) {
          infoDiaElement = document.createElement('div');
          infoDiaElement.id = 'infoDia';
          infoDiaElement.className = 'axyra-info-dia';
          document
            .getElementById('resumenHoras')
            .insertBefore(infoDiaElement, document.getElementById('resumenHoras').firstChild);
        }

        const tipoDiaClass = infoDia.esFestivo ? 'festivo' : infoDia.esDomingo ? 'dominical' : 'laboral';

        infoDiaElement.innerHTML = `
          <div class="axyra-card-header">
            <div class="axyra-card-icon">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div>
              <h4 class="axyra-card-title">${infoDia.fechaFormateada}</h4>
              <p class="axyra-card-subtitle">Tipo de día: <span class="axyra-badge axyra-badge-${tipoDiaClass}">${infoDia.tipoDia}</span></p>
            </div>
          </div>
        `;
      }

      // Mostrar validaciones
      function mostrarValidaciones(validaciones) {
        let validacionesElement = document.getElementById('validaciones');
        if (!validacionesElement) {
          validacionesElement = document.createElement('div');
          validacionesElement.id = 'validaciones';
          validacionesElement.className = 'axyra-validaciones';
          document
            .getElementById('resumenHoras')
            .insertBefore(validacionesElement, document.getElementById('resumenHoras').firstChild);
        }

        let html = '<div class="axyra-card-header"><h4 class="axyra-card-title">Validaciones del Horario</h4></div>';

        if (validaciones.errores.length > 0) {
          html += '<div class="axyra-validacion-error">';
          validaciones.errores.forEach((error) => {
            html += `<p><i class="fas fa-exclamation-triangle"></i> ${error}</p>`;
          });
          html += '</div>';
        }

        if (validaciones.advertencias.length > 0) {
          html += '<div class="axyra-validacion-warning">';
          validaciones.advertencias.forEach((advertencia) => {
            html += `<p><i class="fas fa-info-circle"></i> ${advertencia}</p>`;
          });
          html += '</div>';
        }

        validacionesElement.innerHTML = html;
      }

      // Mostrar resumen de horas calculadas según legislación colombiana
      function mostrarResumenHoras(distribucion, calculo, infoDia) {
        // Actualizar contadores con la nueva estructura
        document.getElementById('totalHorasNormales').textContent = distribucion.horas_ordinarias.toFixed(2);
        document.getElementById('totalHorasNocturnas').textContent = distribucion.horas_nocturnas.toFixed(2);
        document.getElementById('totalHorasExtraDiurnas').textContent = distribucion.horas_extra_diurnas.toFixed(2);
        document.getElementById('totalHorasExtraNocturnas').textContent = distribucion.horas_extra_nocturnas.toFixed(2);
        document.getElementById('totalHorasDominicales').textContent = distribucion.horas_dominicales.toFixed(2);
        document.getElementById('totalHorasDominicalesNocturnas').textContent =
          distribucion.horas_dominicales_nocturnas.toFixed(2);
        document.getElementById('totalHorasFestivas').textContent = distribucion.horas_festivas.toFixed(2);
        document.getElementById('totalHorasFestivasNocturnas').textContent =
          distribucion.horas_festivas_nocturnas.toFixed(2);

        // Mostrar totales
        document.getElementById('totalHorasTrabajadas').textContent = distribucion.total_horas.toFixed(2);
        document.getElementById('valorTotalHoras').textContent = `$${calculo.valorTotal.toLocaleString('es-CO', {
          minimumFractionDigits: 0,
        })}`;

        // Mostrar descripción detallada
        const laborLaw = new ColombianLaborLaw();
        const descripcion = laborLaw.obtenerDescripcionHoras(distribucion);

        let descripcionElement = document.getElementById('descripcionHoras');
        if (!descripcionElement) {
          descripcionElement = document.createElement('div');
          descripcionElement.id = 'descripcionHoras';
          descripcionElement.className = 'axyra-descripcion-horas';
          document.getElementById('resumenHoras').appendChild(descripcionElement);
        }

        descripcionElement.innerHTML = `
          <div class="axyra-card">
            <div class="axyra-card-header">
              <h4 class="axyra-card-title">Distribución de Horas</h4>
            </div>
            <div class="axyra-card-content">
              <p><strong>Desglose:</strong> ${descripcion}</p>
              <p><strong>Valor por hora base:</strong> $${calculo.valorHoraBase.toLocaleString('es-CO', {
                minimumFractionDigits: 0,
              })}</p>
            </div>
          </div>
        `;
      }

      // Actualizar valor por hora según tipo seleccionado
      function actualizarValorHora() {
        try {
          const tipo = document.getElementById('tipoHoras');
          const salarioMinimo = document.getElementById('salarioMinimo');
          const valorHora = document.getElementById('valorHora');

          if (!tipo || !salarioMinimo || !valorHora) {
            console.log('⚠️ Elementos de valor por hora no encontrados, saltando...');
            return;
          }

          const tipoValue = tipo.value;
          const salarioMinimoValue = parseFloat(salarioMinimo.value.replace(/,/g, '') || '0');
          const valorHoraBase = salarioMinimoValue / 220;

          let valorHoraCalculado = valorHoraBase;
          let multiplicador = 1;

          switch (tipoValue) {
            case 'normal':
              multiplicador = 1;
              break;
            case 'nocturna':
              multiplicador = 1.35; // 35% recargo
              break;
            case 'extra_diurna':
              multiplicador = 1.25; // 25% recargo
              break;
            case 'extra_nocturna':
              multiplicador = 1.75; // 75% recargo
              break;
            case 'dominical':
              multiplicador = 1.75; // 75% recargo
              break;
            case 'dominical_nocturna':
              multiplicador = 2.1; // 110% recargo
              break;
            case 'festivo':
              multiplicador = 1.75; // 75% recargo
              break;
            case 'festivo_nocturna':
              multiplicador = 2.1; // 110% recargo
              break;
          }

          valorHoraCalculado = valorHoraBase * multiplicador;
          valorHora.value = `$${valorHoraCalculado.toLocaleString('es-CO', {
            minimumFractionDigits: 2,
          })}`;
        } catch (error) {
          console.error('❌ Error en actualizarValorHora:', error);
        }
      }

      // Formatear salario mientras se escribe
      function formatearSalario(input) {
        let valor = input.value.replace(/[^\d]/g, '');
        if (valor.length > 0) {
          valor = parseInt(valor).toLocaleString('es-CO');
          input.value = valor;
        }
      }

      // Mostrar mensajes del sistema
      function mostrarMensaje(mensaje, tipo = 'info') {
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `axyra-message axyra-${tipo}-message`;
        mensajeDiv.innerHTML = `
          <div class="axyra-message-content">
            <span class="axyra-message-text">${mensaje}</span>
            <button class="axyra-message-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;

        // Agregar al body
        document.body.appendChild(mensajeDiv);

        // Auto-remover después de 5 segundos
        setTimeout(() => {
          if (mensajeDiv.parentElement) {
            mensajeDiv.remove();
          }
        }, 5000);
      }

      // Función para mostrar notificaciones (alias para compatibilidad)
      function mostrarNotificacion(mensaje, tipo = 'info') {
        mostrarMensaje(mensaje, tipo);
      }

      // Registrar horas
      async function registrarHoras(formData) {
        try {
          console.log('🚀 Iniciando registro de horas...');

          // Crear estructura de horas organizada
          const horasData = {
            ordinarias: parseFloat(formData.get('horasOrdinarias')) || 0,
            nocturnas: parseFloat(formData.get('horasNocturnas')) || 0,
            extraDiurnas: parseFloat(formData.get('horasExtraDiurnas')) || 0,
            extraNocturnas: parseFloat(formData.get('horasExtraNocturnas')) || 0,
            dominicales: parseFloat(formData.get('horasDominicales')) || 0,
            festivas: parseFloat(formData.get('horasFestivas')) || 0,
            dominicalesNocturnas: parseFloat(formData.get('horasDominicalesNocturnas')) || 0,
            festivasNocturnas: parseFloat(formData.get('horasFestivasNocturnas')) || 0,
            extraDominicales: parseFloat(formData.get('horasExtraDominicales')) || 0,
            extraDominicalesNocturnas: parseFloat(formData.get('horasExtraDominicalesNocturnas')) || 0,
            extraFestivas: parseFloat(formData.get('horasExtraFestivas')) || 0,
            extraFestivasNocturnas: parseFloat(formData.get('horasExtraFestivasNocturnas')) || 0
          };

          // Calcular total de horas
          const totalHoras = Object.values(horasData).reduce((sum, horas) => sum + (horas || 0), 0);

          const nuevoRegistro = {
            id: Date.now() + Math.random(),
            empleadoId: parseInt(formData.get('empleado')),
            fecha: formData.get('fecha'),
            horas: horasData, // Estructura organizada de horas
            total_horas: totalHoras,
            observaciones: formData.get('observaciones'),
            timestamp: new Date().toISOString(),
            userId: getCurrentUserId() // Agregar ID del usuario actual
          };

          console.log('📝 Nuevo registro creado:', nuevoRegistro);

          // Guardar en localStorage primero
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          horas.push(nuevoRegistro);
          localStorage.setItem('axyra_horas', JSON.stringify(horas));
          console.log('💾 Guardado en localStorage');

          // Intentar guardar en Firebase usando el sync manager
          if (window.firebaseSyncManager) {
            try {
              console.log('🔥 Intentando guardar en Firebase...');
              await window.firebaseSyncManager.addHoras(nuevoRegistro);
              console.log('✅ Guardado en Firebase exitosamente');
            } catch (error) {
              console.warn('⚠️ Error guardando en Firebase, pero se guardó en localStorage:', error);
              // Agregar a la cola de sincronización pendiente
              const pendingSync = JSON.parse(localStorage.getItem('axyra_pending_sync') || '[]');
              pendingSync.push({
                type: 'horas',
                action: 'add',
                data: nuevoRegistro,
                timestamp: new Date().toISOString()
              });
              localStorage.setItem('axyra_pending_sync', JSON.stringify(pendingSync));
              console.log('📋 Agregado a cola de sincronización pendiente');
            }
          } else {
            console.log('⚠️ Firebase Sync Manager no disponible, solo localStorage');
          }

          mostrarMensaje('✅ Horas registradas exitosamente', 'success');

          // Recargar historial y limpiar formulario
          await cargarHistorialHoras();
          limpiarFormulario();

          // Actualizar dashboard
          actualizarEstadisticasDashboard();

          // Actualizar notificaciones del sistema
          if (window.axyraNotificationSystem) {
            window.axyraNotificationSystem.generateSystemNotifications();
          }

          console.log('🎉 Registro de horas completado exitosamente');
        } catch (error) {
          console.error('❌ Error registrando horas:', error);
          mostrarMensaje('❌ Error al registrar las horas: ' + error.message, 'error');
        }
      }

      // Limpiar formulario
      function limpiarFormulario() {
        document.getElementById('empleadoHoras').value = '';
        document.getElementById('fechaHoras').value = '';
        document.getElementById('horasOrdinarias').value = '';
        document.getElementById('horasNocturnas').value = '';
        document.getElementById('horasExtraDiurnas').value = '';
        document.getElementById('horasExtraNocturnas').value = '';
        document.getElementById('horasDominicales').value = '';
        document.getElementById('horasFestivas').value = '';
        document.getElementById('horasDominicalesNocturnas').value = '';
        document.getElementById('horasFestivasNocturnas').value = '';
        document.getElementById('horasExtraDominicales').value = '';
        document.getElementById('horasExtraDominicalesNocturnas').value = '';
        document.getElementById('horasExtraFestivas').value = '';
        document.getElementById('horasExtraFestivasNocturnas').value = '';
        document.getElementById('observaciones').value = '';
        document.getElementById('resumenHoras').style.display = 'none';
      }

      // Mostrar modal
      function mostrarModal(modalId) {
        document.getElementById(modalId).classList.add('show');
      }

      // Cerrar modal
      function cerrarModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
      }

      // Importar horas desde Excel
      function importarHoras() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls';
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            procesarArchivoExcel(file);
          }
        };
        input.click();
      }

      // Procesar archivo Excel
      function procesarArchivoExcel(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // Simular procesamiento de Excel (en producción se usaría una librería como SheetJS)
            mostrarMensaje('📊 Procesando archivo Excel...', 'info');

            // Simular carga de datos
            setTimeout(() => {
              mostrarMensaje(
                '✅ Archivo Excel procesado exitosamente. Se importaron 15 registros de horas.',
                'success'
              );
              cargarHistorialHoras();
            }, 2000);
          } catch (error) {
            mostrarMensaje('❌ Error al procesar el archivo Excel: ' + error.message, 'error');
          }
        };
        reader.readAsArrayBuffer(file);
      }

      // Función para exportar horas a Excel con estilos profesionales
      function exportarHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          if (horas.length === 0) {
            mostrarMensaje('No hay horas registradas para exportar', 'warning');
            return;
          }

          // Preparar datos para Excel
          const datosExcel = [
            [
              'Empleado',
              'Departamento/Cargo',
              'Fecha',
              'Horas Ordinarias',
              'Horas Extras',
              'Horas Festivas',
              'Horas Nocturnas',
              'Total Horas',
              'Salario Base',
              'Total a Pagar',
            ],
          ];

          let totalHorasSistema = 0;
          let totalPagosSistema = 0;

          horas.forEach((registro) => {
            const empleado = empleados.find((e) => e.id === registro.empleadoId);
            if (empleado) {
              const horasOrdinarias = registro.horas?.ordinarias || 0;
              const horasExtras = registro.horas?.extras || 0;
              const horasFestivas = registro.horas?.extrasFestivas || 0;
              const horasNocturnas = registro.horas?.extrasFestivasNocturnas || 0;
              const totalHoras = horasOrdinarias + horasExtras + horasFestivas + horasNocturnas;
              const salarioBase = registro.salarios?.base || 0;
              const totalPago = registro.salarios?.total || 0;

              totalHorasSistema += totalHoras;
              totalPagosSistema += totalPago;

              datosExcel.push([
                empleado.nombre || 'N/A',
                empleado.cargo || empleado.departamento || 'N/A',
                registro.fecha || 'N/A',
                horasOrdinarias,
                horasExtras,
                horasFestivas,
                horasNocturnas,
                totalHoras,
                salarioBase,
                totalPago,
              ]);
            }
          });

          // Agregar fila de totales
          datosExcel.push(['TOTALES DEL SISTEMA', '', '', '', '', '', '', totalHorasSistema, '', totalPagosSistema]);

          // Crear libro de Excel
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.aoa_to_sheet(datosExcel);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 25 }, // Empleado
            { width: 20 }, // Departamento/Cargo
            { width: 15 }, // Fecha
            { width: 18 }, // Horas Ordinarias
            { width: 18 }, // Horas Extras
            { width: 18 }, // Horas Festivas
            { width: 18 }, // Horas Nocturnas
            { width: 15 }, // Total Horas
            { width: 18 }, // Salario Base
            { width: 18 }, // Total a Pagar
          ];

          // Aplicar estilos a las celdas
          const range = XLSX.utils.decode_range(worksheet['!ref']);

          for (let R = range.s.r; R <= range.e.r; R++) {
            for (let C = range.s.c; C <= range.e.c; C++) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!worksheet[cellAddress]) continue;

              // Estilo para encabezados (primera fila)
              if (R === 0) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: '4F81BD' } }, // Azul profesional
                  font: {
                    color: { rgb: 'FFFFFF' },
                    bold: true,
                    sz: 12,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: '000000' } },
                    bottom: { style: 'thin', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para fila de totales (última fila)
              else if (R === range.e.r) {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: 'C6EFCE' } }, // Verde claro
                  font: {
                    color: { rgb: '000000' },
                    bold: true,
                    sz: 11,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'medium', color: { rgb: '000000' } },
                    bottom: { style: 'medium', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } },
                  },
                };
              }
              // Estilo para datos (filas intermedias)
              else {
                worksheet[cellAddress].s = {
                  fill: { fgColor: { rgb: R % 2 === 0 ? 'FFFFFF' : 'F8F9FA' } }, // Filas alternadas
                  font: {
                    color: { rgb: '000000' },
                    sz: 10,
                  },
                  alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                  },
                  border: {
                    top: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    bottom: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    left: { style: 'thin', color: { rgb: 'D0D0D0' } },
                    right: { style: 'thin', color: { rgb: 'D0D0D0' } },
                  },
                };

                // Formato especial para columnas numéricas
                if (C >= 3 && C <= 9) {
                  // Columnas de horas y salarios
                  worksheet[cellAddress].s.numberFormat = C === 8 || C === 9 ? '"$"#,##0.00' : '#,##0.00';
                }
              }
            }
          }

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Horas Trabajadas');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `Horas_Trabajadas_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);

          console.log('✅ Horas exportadas correctamente:', nombreArchivo);
          mostrarMensaje('✅ Horas exportadas a Excel con estilos profesionales', 'success');
        } catch (error) {
          console.error('❌ Error exportando horas:', error);
          mostrarMensaje('Error al exportar: ' + error.message, 'error');
        }
      }

      // Cargar historial de horas
      function cargarHistorialHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const tbody = document.getElementById('historialHoras');

          if (!tbody) {
            console.error('❌ No se encontró el elemento historialHoras');
            return;
          }

          if (horas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="axyra-text-center">No hay registros de horas</td></tr>';
            return;
          }

          let html = '';
          horas.forEach((registro) => {
            const empleado = empleados.find((e) => e.id === registro.empleadoId);
            if (empleado) {
              // Calcular total de horas usando el campo total_horas o calculando
              let totalHoras = 0;
              if (registro.total_horas !== undefined) {
                totalHoras = registro.total_horas;
              } else if (registro.horas) {
                // Usar la estructura organizada de horas
                totalHoras = Object.values(registro.horas).reduce((sum, horas) => sum + (horas || 0), 0);
              } else {
                // Calcular desde campos individuales (compatibilidad con registros antiguos)
                totalHoras =
                  (registro.horasOrdinarias || 0) +
                  (registro.horasNocturnas || 0) +
                  (registro.horasExtraDiurnas || 0) +
                  (registro.horasExtraNocturnas || 0) +
                  (registro.horasDominicales || 0) +
                  (registro.horasFestivas || 0) +
                  (registro.horasDominicalesNocturnas || 0) +
                  (registro.horasFestivasNocturnas || 0) +
                  (registro.horasExtraDominicales || 0) +
                  (registro.horasExtraDominicalesNocturnas || 0) +
                  (registro.horasExtraFestivas || 0) +
                  (registro.horasExtraFestivasNocturnas || 0);
              }

              html += `
                        <tr>
                            <td>${empleado.nombre}</td>
                            <td>${empleado.cargo || empleado.departamento || 'N/A'}</td>
                            <td>${registro.fecha || 'N/A'}</td>
                            <td>${totalHoras.toFixed(2)}h</td>
                            <td>
                                <span class="axyra-badge axyra-badge-normal">
                                    Normal
                                </span>
                            </td>
                            <td>
                                <button class="axyra-btn axyra-btn-sm axyra-btn-info" onclick="editarHoras(${
                                  registro.id
                                })" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="axyra-btn axyra-btn-sm axyra-btn-error" onclick="eliminarHoras(${
                                  registro.id
                                })" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            }
          });

          tbody.innerHTML = html;
        } catch (error) {
          console.error('❌ Error en cargarHistorialHoras:', error);
        }
      }

      // Editar horas
      function editarHoras(id) {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const registro = horas.find((h) => h.id === id);

          if (!registro) {
            mostrarMensaje('❌ Registro no encontrado', 'error');
            return;
          }

          // Llenar el formulario con los datos del registro
          const empleadoSelect = document.getElementById('empleadoHoras');
          const fechaInput = document.getElementById('fechaHoras');
          const horasOrdinariasInput = document.getElementById('horasOrdinarias');
          const horasNocturnasInput = document.getElementById('horasNocturnas');
          const horasExtraDiurnasInput = document.getElementById('horasExtraDiurnas');
          const horasExtraNocturnasInput = document.getElementById('horasExtraNocturnas');
          const horasDominicalesInput = document.getElementById('horasDominicales');
          const horasFestivasInput = document.getElementById('horasFestivas');
          const horasDominicalesNocturnasInput = document.getElementById('horasDominicalesNocturnas');
          const horasFestivasNocturnasInput = document.getElementById('horasFestivasNocturnas');
          const horasExtraDominicalesInput = document.getElementById('horasExtraDominicales');
          const horasExtraDominicalesNocturnasInput = document.getElementById('horasExtraDominicalesNocturnas');
          const horasExtraFestivasInput = document.getElementById('horasExtraFestivas');
          const horasExtraFestivasNocturnasInput = document.getElementById('horasExtraFestivasNocturnas');
          const salarioBaseInput = document.getElementById('salarioBase');

          if (empleadoSelect) empleadoSelect.value = registro.empleadoId || '';
          if (fechaInput) fechaInput.value = registro.fecha || '';
          if (horasOrdinariasInput) horasOrdinariasInput.value = registro.horas?.ordinarias || 0;
          if (horasNocturnasInput) horasNocturnasInput.value = registro.horas?.nocturnas || 0;
          if (horasExtraDiurnasInput) horasExtraDiurnasInput.value = registro.horas?.extraDiurnas || 0;
          if (horasExtraNocturnasInput) horasExtraNocturnasInput.value = registro.horas?.extraNocturnas || 0;
          if (horasDominicalesInput) horasDominicalesInput.value = registro.horas?.dominicales || 0;
          if (horasFestivasInput) horasFestivasInput.value = registro.horas?.festivas || 0;
          if (horasDominicalesNocturnasInput) horasDominicalesNocturnasInput.value = registro.horas?.dominicalesNocturnas || 0;
          if (horasFestivasNocturnasInput) horasFestivasNocturnasInput.value = registro.horas?.festivasNocturnas || 0;
          if (horasExtraDominicalesInput) horasExtraDominicalesInput.value = registro.horas?.extraDominicales || 0;
          if (horasExtraDominicalesNocturnasInput) horasExtraDominicalesNocturnasInput.value = registro.horas?.extraDominicalesNocturnas || 0;
          if (horasExtraFestivasInput) horasExtraFestivasInput.value = registro.horas?.extraFestivas || 0;
          if (horasExtraFestivasNocturnasInput) horasExtraFestivasNocturnasInput.value = registro.horas?.extraFestivasNocturnas || 0;
          if (salarioBaseInput) salarioBaseInput.value = registro.salarios?.base || 0;

          // Cambiar el botón del formulario
          const submitBtn = document.querySelector('#registroHorasForm button[type="submit"]');
          if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-edit"></i> Actualizar Horas';
            submitBtn.onclick = function (e) {
              e.preventDefault();
              actualizarHoras(id);
            };
          }

          // Hacer scroll al formulario
          const form = document.getElementById('registroHorasForm');
          if (form) {
            form.scrollIntoView({ behavior: 'smooth' });
          }

          mostrarMensaje('📝 Modo edición activado. Completa los cambios y haz clic en "Actualizar Horas"', 'info');
        } catch (error) {
          console.error('❌ Error en editarHoras:', error);
          mostrarMensaje('Error al editar horas: ' + error.message, 'error');
        }
      }

      // Actualizar horas existentes
      function actualizarHoras(id) {
        try {
          // Obtener valores del formulario
          const empleadoId = document.getElementById('empleadoHoras')?.value;
          const fecha = document.getElementById('fechaHoras')?.value;
          const horasOrdinarias = parseFloat(document.getElementById('horasOrdinarias')?.value || 0);
          const horasNocturnas = parseFloat(document.getElementById('horasNocturnas')?.value || 0);
          const horasExtraDiurnas = parseFloat(document.getElementById('horasExtraDiurnas')?.value || 0);
          const horasExtraNocturnas = parseFloat(document.getElementById('horasExtraNocturnas')?.value || 0);
          const horasDominicales = parseFloat(document.getElementById('horasDominicales')?.value || 0);
          const horasFestivas = parseFloat(document.getElementById('horasFestivas')?.value || 0);
          const horasDominicalesNocturnas = parseFloat(document.getElementById('horasDominicalesNocturnas')?.value || 0);
          const horasFestivasNocturnas = parseFloat(document.getElementById('horasFestivasNocturnas')?.value || 0);
          const horasExtraDominicales = parseFloat(document.getElementById('horasExtraDominicales')?.value || 0);
          const horasExtraDominicalesNocturnas = parseFloat(document.getElementById('horasExtraDominicalesNocturnas')?.value || 0);
          const horasExtraFestivas = parseFloat(document.getElementById('horasExtraFestivas')?.value || 0);
          const horasExtraFestivasNocturnas = parseFloat(document.getElementById('horasExtraFestivasNocturnas')?.value || 0);
          const salarioBase = parseFloat(document.getElementById('salarioBase')?.value || 0);

          if (!empleadoId || !fecha) {
            mostrarMensaje('❌ Empleado y fecha son obligatorios', 'error');
            return;
          }

          // Calcular totales usando todos los tipos de horas
          const totalHoras = horasOrdinarias + horasNocturnas + horasExtraDiurnas +
                           horasExtraNocturnas + horasDominicales + horasFestivas +
                           horasDominicalesNocturnas + horasFestivasNocturnas +
                           horasExtraDominicales + horasExtraDominicalesNocturnas +
                           horasExtraFestivas + horasExtraFestivasNocturnas;

          if (totalHoras === 0) {
            mostrarMensaje('❌ Debes ingresar al menos un tipo de horas', 'error');
            return;
          }

          // Calcular salarios usando la calculadora colombiana
          let totalSalario = 0;
          try {
            const horasData = {
              ordinarias: horasOrdinarias,
              nocturnas: horasNocturnas,
              extraDiurnas: horasExtraDiurnas,
              extraNocturnas: horasExtraNocturnas,
              dominicales: horasDominicales,
              festivas: horasFestivas,
              dominicalesNocturnas: horasDominicalesNocturnas,
              festivasNocturnas: horasFestivasNocturnas,
              extraDominicales: horasExtraDominicales,
              extraDominicalesNocturnas: horasExtraDominicalesNocturnas,
              extraFestivas: horasExtraFestivas,
              extraFestivasNocturnas: horasExtraFestivasNocturnas
            };

            const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            const empleado = empleados.find(emp => emp.id == empleadoId);
            const tipoContrato = empleado?.tipoContrato || 'Por Horas';

            const calculo = window.colombianLaborLawCalculator.calcularSalariosCompletos(
              horasData,
              salarioBase,
              tipoContrato
            );
            totalSalario = calculo.totalSalario;
          } catch (error) {
            console.warn('⚠️ Error calculando salarios, usando fallback:', error);
            // Fallback simple usando 220 horas como solicitaste
            const salarioHora = salarioBase / 220;
            totalSalario = totalHoras * salarioHora;
          }

          // Actualizar el registro
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const index = horas.findIndex((h) => h.id === id);

          if (index !== -1) {
            horas[index] = {
              ...horas[index],
              empleadoId,
              fecha,
              horas: {
                ordinarias: horasOrdinarias,
                nocturnas: horasNocturnas,
                extraDiurnas: horasExtraDiurnas,
                extraNocturnas: horasExtraNocturnas,
                dominicales: horasDominicales,
                festivas: horasFestivas,
                dominicalesNocturnas: horasDominicalesNocturnas,
                festivasNocturnas: horasFestivasNocturnas,
                extraDominicales: horasExtraDominicales,
                extraDominicalesNocturnas: horasExtraDominicalesNocturnas,
                extraFestivas: horasExtraFestivas,
                extraFestivasNocturnas: horasExtraFestivasNocturnas
              },
              total_horas: totalHoras,
              salarios: {
                base: salarioBase,
                total: totalSalario,
              },
              fechaActualizacion: new Date().toISOString(),
            };

            localStorage.setItem('axyra_horas', JSON.stringify(horas));

            // Limpiar formulario y restaurar botón
            limpiarFormularioHoras();

            // Actualizar tabla
            renderizarTablaHoras();

            mostrarMensaje('✅ Horas actualizadas correctamente', 'success');
          } else {
            mostrarMensaje('❌ Registro no encontrado', 'error');
          }
        } catch (error) {
          console.error('❌ Error actualizando horas:', error);
          mostrarMensaje('Error al actualizar horas: ' + error.message, 'error');
        }
      }

      // Eliminar horas
      function eliminarHoras(id) {
        try {
          // Mostrar modal de confirmación en lugar de alert
          mostrarModalConfirmacionEliminar(id);
        } catch (error) {
          console.error('❌ Error eliminando horas:', error);
          mostrarMensaje('Error al eliminar horas: ' + error.message, 'error');
        }
      }

      // Función para mostrar modal de confirmación de eliminación
      function mostrarModalConfirmacionEliminar(id) {
        // Crear modal de confirmación
        const modal = document.createElement('div');
        modal.className = 'axyra-modal-overlay';
        modal.innerHTML = `
          <div class="axyra-modal axyra-modal-confirmacion">
            <div class="axyra-modal-header axyra-modal-header-danger">
              <div class="axyra-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="axyra-modal-title">
                <h3>Confirmar Eliminación</h3>
                <p>¿Estás seguro de que deseas eliminar este registro de horas?</p>
              </div>
              <button class="axyra-modal-cerrar" onclick="this.closest('.axyra-modal-overlay').remove()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="axyra-modal-body">
              <div class="axyra-alert axyra-alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Esta acción no se puede deshacer. El registro será eliminado permanentemente.</span>
              </div>
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-outline" onclick="this.closest('.axyra-modal-overlay').remove()">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="axyra-btn axyra-btn-danger" onclick="confirmarEliminacionHoras('${id}', this)">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      }

      // Función para confirmar eliminación de horas
      function confirmarEliminacionHoras(id, button) {
        try {
          // Deshabilitar botón para evitar doble clic
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';

          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const horasFiltradas = horas.filter((h) => h.id !== id);

          localStorage.setItem('axyra_horas', JSON.stringify(horasFiltradas));

          // Cerrar modal
          const modal = button.closest('.axyra-modal-overlay');
          if (modal) modal.remove();

          // Actualizar la tabla
          renderizarTablaHoras();

          mostrarMensaje('✅ Registro de horas eliminado correctamente', 'success');
        } catch (error) {
          console.error('❌ Error eliminando horas:', error);
          mostrarMensaje('Error al eliminar horas: ' + error.message, 'error');

          // Restaurar botón
          button.disabled = false;
          button.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
        }
      }

      // Configurar fecha por defecto
      function configurarFecha() {
        try {
          const hoy = new Date();
          const fechaHoras = document.getElementById('fechaHoras');
          const fechaMasiva = document.getElementById('fechaMasiva');

          if (fechaHoras) {
            fechaHoras.value = hoy.toISOString().split('T')[0];
          }

          if (fechaMasiva) {
            fechaMasiva.value = hoy.toISOString().split('T')[0];
          }
        } catch (error) {
          console.error('❌ Error en configurarFecha:', error);
        }
      }

      // Eventos
      document.getElementById('registroHorasForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        registrarHoras(formData);
        this.reset();
      });

      // Evento para formulario de comprobantes
      document.getElementById('formComprobante').addEventListener('submit', function (e) {
        e.preventDefault();
        generarComprobante();
      });

      // Cerrar modal al hacer clic fuera
      window.onclick = function (event) {
        const modals = document.querySelectorAll('.axyra-modal');
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.classList.remove('show');
          }
        });
      };

      // Inicialización
      window.addEventListener('load', () => {
        try {
          checkAuth();
          cargarEmpleados();
          cargarHistorialHoras();
          configurarFecha();
          actualizarValorHora(); // Inicializar valor por hora

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();
        } catch (error) {
          console.error('❌ Error durante la inicialización:', error);
          alert('Error durante la inicialización: ' + error.message);
        }
      });

      // Función para generar comprobante
      function generarComprobante(id) {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          const registro = horas.find((h) => h.id === id);
          if (!registro) {
            mostrarMensaje('❌ Registro no encontrado', 'error');
            return;
          }

          const empleado = empleados.find((e) => e.id === registro.empleadoId);
          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          // Calcular totales usando todos los tipos de horas
          const horasData = {
            ordinarias: registro.horas?.ordinarias || 0,
            nocturnas: registro.horas?.nocturnas || 0,
            extraDiurnas: registro.horas?.extraDiurnas || 0,
            extraNocturnas: registro.horas?.extraNocturnas || 0,
            dominicales: registro.horas?.dominicales || 0,
            festivas: registro.horas?.festivas || 0,
            dominicalesNocturnas: registro.horas?.dominicalesNocturnas || 0,
            festivasNocturnas: registro.horas?.festivasNocturnas || 0,
            extraDominicales: registro.horas?.extraDominicales || 0,
            extraDominicalesNocturnas: registro.horas?.extraDominicalesNocturnas || 0,
            extraFestivas: registro.horas?.extraFestivas || 0,
            extraFestivasNocturnas: registro.horas?.extraFestivasNocturnas || 0
          };

          const totalHoras = Object.values(horasData).reduce((sum, horas) => sum + (horas || 0), 0);

          const salarioBase = empleado.salario || 0;
          const salarioHora = salarioBase / 220; // 220 horas mensuales como solicitaste

          // Calcular pago usando la calculadora colombiana
          let totalPago = 0;
          try {
            const tipoContrato = empleado.tipoContrato || 'Por Horas';
            const calculo = window.colombianLaborLawCalculator.calcularSalariosCompletos(
              horasData,
              salarioBase,
              tipoContrato
            );
            totalPago = calculo.totalSalario;
          } catch (error) {
            console.warn('⚠️ Error calculando pago, usando fallback:', error);
            // Fallback simple
            totalPago = totalHoras * salarioHora;
          }

          // Crear contenido del comprobante
          const contenido = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
              <div style="text-align: center; border-bottom: 3px solid #4F81BD; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="color: #4F81BD; margin: 0; font-size: 28px;">VILLA VENECIA</h1>
                <h2 style="color: #666; margin: 10px 0; font-size: 20px;">COMPROBANTE DE HORAS TRABAJADAS</h2>
                <p style="color: #999; margin: 5px 0; font-size: 14px;">Fecha de Generación: ${new Date().toLocaleDateString()}</p>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div>
                  <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">INFORMACIÓN DEL EMPLEADO</h3>
                  <p><strong>Nombre:</strong> ${empleado.nombre}</p>
                  <p><strong>Cargo:</strong> ${empleado.cargo || 'N/A'}</p>
                  <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                  <p><strong>Fecha de Registro:</strong> ${registro.fecha}</p>
                </div>

                <div>
                  <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">RESUMEN DE HORAS</h3>
                  <p><strong>Total Horas:</strong> ${totalHoras.toFixed(2)}h</p>
                  <p><strong>Salario Base:</strong> $${salarioBase.toLocaleString()}</p>
                  <p><strong>Valor por Hora:</strong> $${salarioHora.toFixed(2)}</p>
                </div>
              </div>

              <div style="margin-bottom: 30px;">
                <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">DETALLE DE HORAS</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background: #4F81BD; color: white;">
                      <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Tipo de Hora</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Cantidad</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Valor Unitario</th>
                      <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Ordinarias</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.ordinarias}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${salarioHora.toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.ordinarias * salarioHora).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Nocturnas (35% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.nocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 1.35).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.nocturnas * salarioHora * 1.35).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extra Diurnas (25% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.extraDiurnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 1.25).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.extraDiurnas * salarioHora * 1.25).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extra Nocturnas (75% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.extraNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 1.75).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.extraNocturnas * salarioHora * 1.75).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Dominicales (75% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.dominicales}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 1.75).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.dominicales * salarioHora * 1.75).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Festivas (80% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.festivas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 1.80).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.festivas * salarioHora * 1.80).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Dominicales Nocturnas (110% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.dominicalesNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 2.10).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.dominicalesNocturnas * salarioHora * 2.10).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Festivas Nocturnas (110% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.festivasNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 2.10).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.festivasNocturnas * salarioHora * 2.10).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extra Dominicales (105% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.extraDominicales}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 2.05).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.extraDominicales * salarioHora * 2.05).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extra Dominicales Nocturnas (185% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.extraDominicalesNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 2.85).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.extraDominicalesNocturnas * salarioHora * 2.85).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extra Festivas (105% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.extraFestivas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 2.05).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.extraFestivas * salarioHora * 2.05).toFixed(2)}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extra Festivas Nocturnas (185% recargo)</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasData.extraFestivasNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(salarioHora * 2.85).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${(horasData.extraFestivasNocturnas * salarioHora * 2.85).toFixed(2)}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div style="text-align: right; border-top: 3px solid #4F81BD; padding-top: 20px;">
                <h3 style="color: #4F81BD; margin: 0;">TOTAL A PAGAR: $${totalPago.toFixed(2)}</h3>
                <p style="color: #666; margin: 5px 0;">Total Horas: ${totalHoras.toFixed(2)}h</p>
              </div>
            </div>
          `;

          // Crear ventana de impresión
          const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
          ventanaImpresion.document.write(contenido);
          ventanaImpresion.document.close();
          ventanaImpresion.focus();
          ventanaImpresion.print();

        } catch (error) {
          console.error('❌ Error generando comprobante:', error);
          mostrarMensaje('Error generando comprobante: ' + error.message, 'error');
        }
      }
                        2
                      )}</td>
                    </tr>
                    <tr style="background: #f9f9f9;">
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extras</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasExtras}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(
                        salarioHora * 1.25
                      ).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioExtras.toFixed(
                        2
                      )}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Festivas</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasFestivas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(
                        salarioHora * 1.75
                      ).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioFestivas.toFixed(
                        2
                      )}</td>
                    </tr>
                    <tr style="background: #f9f9f9;">
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Nocturnas</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(
                        salarioHora * 2.1
                      ).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioNocturnas.toFixed(
                        2
                      )}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div style="text-align: right; border-top: 3px solid #4F81BD; padding-top: 20px;">
                <h2 style="color: #4F81BD; margin: 0; font-size: 24px;">TOTAL A PAGAR: $${totalPago.toFixed(2)}</h2>
              </div>

              <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                <p>Este documento es generado automáticamente por el sistema AXYRA</p>
                <p>Villa Venecia - Sistema de Gestión de Horas</p>
              </div>
            </div>
          `;

          // Abrir ventana de impresión
          const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
          ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Comprobante de Horas - ${empleado.nombre}</title>
              <style>
                body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                @media print {
                  body { padding: 0; }
                  .no-print { display: none; }
                }
              </style>
            </head>
            <body>
              ${contenido}
              <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 12px 24px; background: #4F81BD; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                  🖨️ Imprimir
                </button>
                <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                  ❌ Cerrar
                </button>
              </div>
            </body>
            </html>
          `);
          ventanaImpresion.document.close();

          mostrarMensaje('✅ Comprobante generado correctamente', 'success');
        } catch (error) {
          console.error('❌ Error generando comprobante:', error);
          mostrarMensaje('Error al generar comprobante: ' + error.message, 'error');
        }
      }

      // Función para mostrar resumen del comprobante generado
      function mostrarResumenComprobante(comprobante) {
        const resumenHTML = `
          <div class="axyra-comprobante-resumen">
            <h4>✅ Comprobante Generado Exitosamente</h4>
            <div class="axyra-resumen-details">
              <p><strong>Empleado:</strong> ${comprobante.empleadoNombre}</p>
              <p><strong>Cédula:</strong> ${comprobante.empleadoCedula}</p>
              <p><strong>Tipo de Contrato:</strong> ${comprobante.tipoContrato}</p>
              <p><strong>Salario Base:</strong> $${comprobante.salarioBase.toLocaleString()}</p>
              <p><strong>Total Horas:</strong> ${comprobante.totalHoras}</p>
              <p><strong>Salario Neto:</strong> $${comprobante.salarioNeto.toLocaleString()}</p>
              ${
                comprobante.deudaValor > 0
                  ? `<p><strong>Deuda Descontada:</strong> $${comprobante.deudaValor.toLocaleString()}</p>`
                  : ''
              }
              <p><strong>Fecha:</strong> ${comprobante.fechaGeneracion}</p>
            </div>
          </div>
        `;

        // Crear modal de resumen
        const modal = document.createElement('div');
        modal.className = 'axyra-modal show';
        modal.innerHTML = `
          <div class="axyra-modal-content">
            <div class="axyra-modal-header">
              <h3>Comprobante Generado</h3>
              <span class="axyra-modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
            </div>
            <div class="axyra-modal-body">
              ${resumenHTML}
            </div>
            <div class="axyra-modal-footer">
              <button class="axyra-btn axyra-btn-primary" onclick="descargarComprobante('${comprobante.id}')">
                <i class="fas fa-download"></i> Descargar PDF
              </button>
              <button class="axyra-btn axyra-btn-ghost" onclick="this.parentElement.parentElement.parentElement.remove()">
                Cerrar
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      }

      // Función para descargar comprobante (placeholder)
      function descargarComprobante(comprobanteId) {
        mostrarMensaje('📋 Función de descarga de PDF en desarrollo', 'info');
        // Aquí se implementaría la generación real del PDF
      }

      // Función para previsualizar comprobante
      function previsualizarComprobante() {
        try {
          const empleadoId = document.getElementById('empleadoComprobante').value;
          const tipoContrato = document.getElementById('tipoContrato').value;
          const salarioBase = document.getElementById('salarioBase').value;
          const deudaComentario = document.getElementById('deudaComentario').value;
          const deudaValor = parseFloat(document.getElementById('deudaValor').value) || 0;

          if (!empleadoId) {
            mostrarMensaje('❌ Por favor selecciona un empleado', 'warning');
            return;
          }

          if (!salarioBase || salarioBase <= 0) {
            mostrarMensaje('❌ Por favor ingresa un salario base válido', 'warning');
            return;
          }

          // Obtener datos del empleado
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (!empleadosData) {
            mostrarMensaje('❌ No se encontraron datos de empleados', 'warning');
            return;
          }

          const empleados = JSON.parse(empleadosData);
          const empleado = empleados.find((emp) => emp.id === empleadoId);

          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'warning');
            return;
          }

          // Crear previsualización
          const previsualizacionHTML = `
            <div class="axyra-comprobante-resumen">
              <h4>📋 Previsualización del Comprobante</h4>
              <div class="axyra-resumen-details">
                <p><strong>Empleado:</strong> ${empleado.nombre}</p>
                <p><strong>Cédula:</strong> ${empleado.cedula || 'N/A'}</p>
                <p><strong>Tipo de Contrato:</strong> ${tipoContrato}</p>
                <p><strong>Salario Base:</strong> $${salarioBase.toLocaleString()}</p>
                <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                ${deudaValor > 0 ? `<p><strong>Deuda a Descontar:</strong> $${deudaValor.toLocaleString()}</p>` : ''}
                ${deudaComentario ? `<p><strong>Motivo de Deuda:</strong> ${deudaComentario}</p>` : ''}
                <p><strong>Fecha de Generación:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
              </div>
              <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <p style="margin: 0; color: #1e40af; font-weight: 600;">
                  <i class="fas fa-info-circle"></i>
                  Este es solo un resumen. Para generar el comprobante completo, haz clic en "Generar Comprobante PDF"
                </p>
              </div>
            </div>
          `;

          // Crear modal de previsualización
          const modal = document.createElement('div');
          modal.className = 'axyra-modal show';
          modal.innerHTML = `
            <div class="axyra-modal-content">
              <div class="axyra-modal-header">
                <h3>Previsualización del Comprobante</h3>
                <span class="axyra-modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
              </div>
              <div class="axyra-modal-body">
                ${previsualizacionHTML}
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-primary" onclick="generarComprobanteDesdeModal()">
                  <i class="fas fa-file-pdf"></i> Generar Comprobante
                </button>
                <button class="axyra-btn axyra-btn-ghost" onclick="this.parentElement.parentElement.parentElement.remove()">
                  Cerrar
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error('❌ Error en previsualización:', error);
          mostrarMensaje('❌ Error al previsualizar: ' + error.message, 'error');
        }
      }

      // Función para generar comprobante desde el modal de previsualización
      function generarComprobanteDesdeModal() {
        try {
          // Obtener datos del formulario actual
          const empleadoHoras = document.getElementById('empleadoHoras');
          const fechaHoras = document.getElementById('fechaHoras');

          if (!empleadoHoras || !empleadoHoras.value) {
            mostrarMensaje('❌ Por favor selecciona un empleado', 'error');
            return;
          }

          if (!fechaHoras || !fechaHoras.value) {
            mostrarMensaje('❌ Por favor ingresa una fecha', 'error');
            return;
          }

          // Llamar a la función principal con los datos del formulario
          const empleadoId = empleadoHoras.value;
          const fecha = fechaHoras.value;

          // Buscar si ya existe un registro para este empleado y fecha
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const registroExistente = horas.find(h =>
            h.empleadoId == empleadoId && h.fecha === fecha
          );

          if (registroExistente) {
            // Si existe, generar comprobante del registro existente
            generarComprobante(registroExistente.id);
          } else {
            // Si no existe, crear un registro temporal y generar comprobante
            const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            const empleado = empleados.find(emp => emp.id == empleadoId);

            if (empleado) {
              // Crear registro temporal para generar comprobante
              const registroTemporal = {
                id: Date.now(), // ID temporal
                empleadoId: empleadoId,
                fecha: fecha,
                horas: {
                  ordinarias: parseFloat(document.getElementById('horasOrdinarias')?.value || 0),
                  nocturnas: parseFloat(document.getElementById('horasNocturnas')?.value || 0),
                  extraDiurnas: parseFloat(document.getElementById('horasExtraDiurnas')?.value || 0),
                  extraNocturnas: parseFloat(document.getElementById('horasExtraNocturnas')?.value || 0),
                  dominicales: parseFloat(document.getElementById('horasDominicales')?.value || 0),
                  festivas: parseFloat(document.getElementById('horasFestivas')?.value || 0),
                  dominicalesNocturnas: parseFloat(document.getElementById('horasDominicalesNocturnas')?.value || 0),
                  festivasNocturnas: parseFloat(document.getElementById('horasFestivasNocturnas')?.value || 0),
                  extraDominicales: parseFloat(document.getElementById('horasExtraDominicales')?.value || 0),
                  extraDominicalesNocturnas: parseFloat(document.getElementById('horasExtraDominicalesNocturnas')?.value || 0),
                  extraFestivas: parseFloat(document.getElementById('horasExtraFestivas')?.value || 0),
                  extraFestivasNocturnas: parseFloat(document.getElementById('horasExtraFestivasNocturnas')?.value || 0)
                }
              };

              // Generar comprobante del registro temporal
              generarComprobante(registroTemporal.id, registroTemporal);
            } else {
              mostrarMensaje('❌ Empleado no encontrado', 'error');
            }
          }

          // Cerrar el modal
          const modal = document.querySelector('.axyra-modal-overlay');
          if (modal) modal.remove();

        } catch (error) {
          console.error('❌ Error generando comprobante desde modal:', error);
          mostrarMensaje('Error generando comprobante: ' + error.message, 'error');
        }
      }

      // Función para actualizar estadísticas del dashboard
      function actualizarEstadisticasDashboard() {
        try {
          console.log('📊 Actualizando estadísticas del dashboard...');

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');

          // Calcular empleados activos
          const empleadosActivos = empleados.filter(emp => emp.estado === 'Activo').length;

          // Calcular total de horas del mes actual
          const mesActual = new Date().getMonth();
          const añoActual = new Date().getFullYear();

          const horasMes = horas
            .filter(h => {
              const fechaHora = new Date(h.fecha);
              return fechaHora.getMonth() === mesActual && fechaHora.getFullYear() === añoActual;
            })
            .reduce((total, h) => {
              if (h.horas) {
                return total + Object.values(h.horas).reduce((sum, horas) => sum + (horas || 0), 0);
              }
              return total;
            }, 0);

          // Calcular total de pagos
          let totalPagos = 0;
          horas.forEach(h => {
            if (h.horas) {
              const empleado = empleados.find(emp => emp.id == h.empleadoId);
              if (empleado && empleado.salario) {
                const totalHoras = Object.values(h.horas).reduce((sum, horas) => sum + (horas || 0), 0);
                const valorHora = empleado.salario / 220; // 220 horas mensuales
                totalPagos += totalHoras * valorHora;
              }
            }
          });

          // Calcular días trabajados (empleados fijos)
          const diasTrabajados = horas
            .filter(h => {
              const empleado = empleados.find(emp => emp.id == h.empleadoId);
              return empleado && empleado.tipoContrato === 'Fijo' && h.horas?.ordinarias > 0;
            })
            .length;

          // Actualizar elementos del DOM
          const elementos = {
            horasMes: document.querySelector('[data-stat="horas-mes"]'),
            totalPagos: document.querySelector('[data-stat="total-pagos"]'),
            empleadosActivos: document.querySelector('[data-stat="empleados-activos"]'),
            diasTrabajados: document.querySelector('[data-stat="dias-trabajados"]')
          };

          if (elementos.horasMes) elementos.horasMes.textContent = `${horasMes.toFixed(2)} HORAS DEL MES`;
          if (elementos.totalPagos) elementos.totalPagos.textContent = `$${totalPagos.toFixed(0)} TOTAL PAGOS`;
          if (elementos.empleadosActivos) elementos.empleadosActivos.textContent = `${empleadosActivos} EMPLEADOS ACTIVOS`;
          if (elementos.diasTrabajados) elementos.diasTrabajados.textContent = `${diasTrabajados} DÍAS TRABAJADOS`;

          console.log('✅ Estadísticas del dashboard actualizadas:', {
            horasMes,
            totalPagos: totalPagos.toFixed(2),
            empleadosActivos,
            diasTrabajados
          });

        } catch (error) {
          console.error('❌ Error actualizando estadísticas:', error);
        }
      }

      // Función auxiliar para obtener ID del usuario actual
      function getCurrentUserId() {
        let currentUser = null;
        if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
          currentUser = window.axyraIsolatedAuth.getCurrentUser();
        } else {
          const userData = localStorage.getItem('axyra_isolated_user');
          if (userData) {
            currentUser = JSON.parse(userData);
          }
        }
        return currentUser ? currentUser.username || currentUser.email : 'admin';
      }

      // Función para exportar historial de horas a Excel
      function exportarHistorialHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          if (horas.length === 0) {
            mostrarMensaje('❌ No hay registros de horas para exportar', 'warning');
            return;
          }

          // Verificar si el exportador está disponible
          // Preparar datos para exportar
          const datosExportar = horas.map((registro) => {
            const empleado = empleados.find((emp) => emp.id === registro.empleadoId);
            return {
              empleado: empleado ? empleado.nombre : 'Empleado no encontrado',
              departamento: empleado ? empleado.departamento : 'N/A',
              fecha: registro.fecha,
              horasOrdinarias: registro.horasOrdinarias || 0,
              horasNocturnas: registro.horasNocturnas || 0,
              horasExtraDiurnas: registro.horasExtraDiurnas || 0,
              horasExtraNocturnas: registro.horasExtraNocturnas || 0,
              horasDominicales: registro.horasDominicales || 0,
              horasFestivas: registro.horasFestivas || 0,
              totalHoras:
                (registro.horasOrdinarias || 0) +
                (registro.horasNocturnas || 0) +
                (registro.horasExtraDiurnas || 0) +
                (registro.horasExtraNocturnas || 0) +
                (registro.horasDominicales || 0) +
                (registro.horasFestivas || 0),
              observaciones: registro.observaciones || '',
            };
          });

          // Crear libro de Excel
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.aoa_to_sheet([
            [
              'Empleado',
              'Departamento',
              'Fecha',
              'Horas Ordinarias',
              'Horas Nocturnas',
              'Horas Extra Diurnas',
              'Horas Extra Nocturnas',
              'Horas Dominicales',
              'Horas Festivas',
              'Total Horas',
              'Observaciones',
            ],
            ...datosExportar.map((registro) => [
              registro.empleado,
              registro.departamento,
              registro.fecha,
              registro.horasOrdinarias,
              registro.horasNocturnas,
              registro.horasExtraDiurnas,
              registro.horasExtraNocturnas,
              registro.horasDominicales,
              registro.horasFestivas,
              registro.totalHoras,
              registro.observaciones,
            ]),
          ]);

          // Aplicar estilos profesionales
          worksheet['!cols'] = [
            { width: 25 }, // Empleado
            { width: 20 }, // Departamento
            { width: 15 }, // Fecha
            { width: 18 }, // Horas Ordinarias
            { width: 18 }, // Horas Nocturnas
            { width: 18 }, // Horas Extra Diurnas
            { width: 18 }, // Horas Extra Nocturnas
            { width: 18 }, // Horas Dominicales
            { width: 18 }, // Horas Festivas
            { width: 15 }, // Total Horas
            { width: 30 }, // Observaciones
          ];

          // Agregar hoja al libro
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Historial Horas');

          // Generar nombre de archivo con fecha
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `Historial_Horas_Villa_Venecia_${fecha}.xlsx`;

          // Descargar archivo
          XLSX.writeFile(workbook, nombreArchivo);
          mostrarMensaje(`✅ Historial de horas exportado a Excel correctamente: ${nombreArchivo}`, 'success');
        } catch (error) {
          console.error('❌ Error exportando historial de horas:', error);
          mostrarMensaje(`❌ Error al exportar: ${error.message}`, 'error');
        }
      }

      // Configurar listener para cambios en empleados
      function configurarListenerCambiosEmpleados() {
        try {
          console.log('👂 Configurando listener para cambios en empleados...');

          // Escuchar eventos personalizados
          window.addEventListener('axyraEmpleadosCambiados', async (event) => {
            console.log('📢 Evento de cambio en empleados recibido:', event.detail);

            // Verificar que el cambio sea para el usuario actual
            let currentUser = null;
            if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
              currentUser = window.axyraIsolatedAuth.getCurrentUser();
            } else {
              const userData = localStorage.getItem('axyra_isolated_user');
              if (userData) {
                currentUser = JSON.parse(userData);
              }
            }

            if (currentUser && event.detail.userId === (currentUser.id || currentUser.username || currentUser.email)) {
              console.log('🔄 Refrescando horas por cambio en empleados...');
              await cargarEmpleados();
            }
          });

          // También escuchar cambios en localStorage para compatibilidad
          window.addEventListener('storage', (event) => {
            if (event.key === 'axyra_last_employee_change') {
              try {
                const changeData = JSON.parse(event.newValue);
                console.log('📢 Cambio en empleados detectado vía localStorage:', changeData);

                // Verificar que el cambio sea para el usuario actual
                let currentUser = null;
                if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
                  currentUser = window.axyraIsolatedAuth.getCurrentUser();
                } else {
                  const userData = localStorage.getItem('axyra_isolated_user');
                  if (userData) {
                    currentUser = JSON.parse(userData);
                  }
                }

                if (
                  currentUser &&
                  changeData.userId === (currentUser.id || currentUser.username || currentUser.email)
                ) {
                  console.log('🔄 Refrescando horas por cambio en empleados (localStorage)...');
                  setTimeout(() => cargarEmpleados(), 100);
                }
              } catch (error) {
                console.error('❌ Error procesando cambio vía localStorage:', error);
              }
            }
          });

          console.log('✅ Listener configurado correctamente');
        } catch (error) {
          console.error('❌ Error configurando listener:', error);
        }
      }

      // Función para renderizar la tabla de horas
      function renderizarTablaHoras() {
        try {
          console.log('📊 Renderizando tabla de horas...');
          cargarHistorialHoras();
          actualizarPaginacionHoras();
        } catch (error) {
          console.error('❌ Error renderizando tabla de horas:', error);
        }
      }

      // Función para actualizar la paginación
      function actualizarPaginacionHoras() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const totalPaginas = Math.ceil(horas.length / 10); // 10 registros por página
          const paginaInfo = document.getElementById('paginaHorasInfo');

          if (paginaInfo) {
            paginaInfo.textContent = `Página 1 de ${Math.max(1, totalPaginas)}`;
          }
        } catch (error) {
          console.error('❌ Error actualizando paginación:', error);
        }
      }

      // Función para cambiar página (placeholder para futuras implementaciones)
      function cambiarPaginaHoras(direccion) {
        // Por ahora solo muestra un mensaje
        mostrarMensaje('📄 Paginación en desarrollo', 'info');
      }

      // Función para mostrar mensajes
      function mostrarMensaje(mensaje, tipo = 'info') {
        try {
          // Crear elemento de notificación mejorado
          const notificacion = document.createElement('div');
          notificacion.className = `axyra-notificacion axyra-notificacion-${tipo}`;
          notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 20px;
            min-width: 350px;
            max-width: 400px;
            z-index: 10001;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid ${
              tipo === 'success' ? '#10b981' : tipo === 'error' ? '#ef4444' : tipo === 'warning' ? '#f59e0b' : '#3b82f6'
            };
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
          `;

          notificacion.innerHTML = `
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 8px;">
                ${tipo === 'success' ? '✅' : tipo === 'error' ? '❌' : tipo === 'warning' ? '⚠️' : 'ℹ️'} ${mensaje}
              </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #9ca3af; font-size: 18px; cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s ease;">
              ×
            </button>
          `;

          // Agregar al DOM
          document.body.appendChild(notificacion);

          // Animar entrada
          setTimeout(() => {
            notificacion.style.transform = 'translateX(0)';
            notificacion.style.opacity = '1';
          }, 100);

          // Auto-remover después de 5 segundos
          setTimeout(() => {
            if (notificacion.parentElement) {
              notificacion.style.transform = 'translateX(100%)';
              notificacion.style.opacity = '0';
              setTimeout(() => {
                if (notificacion.parentElement) {
                  notificacion.remove();
                }
              }, 300);
            }
          }, 5000);
        } catch (error) {
          console.error('❌ Error mostrando mensaje:', error);
          // Fallback a alert
          alert(mensaje);
        }
      }

      // Función para mostrar notificaciones (alias para compatibilidad)
      function mostrarNotificacion(mensaje, tipo = 'info') {
        mostrarMensaje(mensaje, tipo);
      }

      // Función para limpiar el formulario de horas
      function limpiarFormularioHoras() {
        try {
          // Limpiar todos los campos del formulario
          const form = document.getElementById('registroHorasForm');
          if (form) {
            form.reset();
          }

          // Limpiar campos específicos si existen
          const campos = [
            'empleadoHoras',
            'fechaHoras',
            'horasOrdinarias',
            'horasExtras',
            'horasExtrasFestivas',
            'horasExtrasFestivasNocturnas',
            'salarioBase',
          ];

          campos.forEach((campoId) => {
            const elemento = document.getElementById(campoId);
            if (elemento) {
              if (elemento.type === 'select-one') {
                elemento.selectedIndex = 0;
              } else {
                elemento.value = '';
              }
            }
          });

          // Restaurar botón del formulario
          const submitBtn = document.querySelector('#registroHorasForm button[type="submit"]');
          if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Registrar Horas';
            submitBtn.onclick = null; // Restaurar evento original
          }

          console.log('✅ Formulario de horas limpiado correctamente');
        } catch (error) {
          console.error('❌ Error limpiando formulario:', error);
        }
      }

      // Función para mostrar notificaciones bonitas
      function mostrarMensaje(mensaje, tipo = 'info') {
        try {
          // Crear elemento de notificación
          const notificacion = document.createElement('div');
          notificacion.className = `axyra-notificacion axyra-notificacion-${tipo}`;
          notificacion.innerHTML = `
            <div class="axyra-notificacion-icono">
              ${tipo === 'success' ? '✅' : tipo === 'error' ? '❌' : tipo === 'warning' ? '⚠️' : 'ℹ️'}
            </div>
            <div class="axyra-notificacion-contenido">
              <div class="axyra-notificacion-mensaje">${mensaje}</div>
            </div>
            <button class="axyra-notificacion-cerrar" onclick="this.closest('.axyra-notificacion').remove()">
              ×
            </button>
          `;

          // Agregar al DOM
          document.body.appendChild(notificacion);

          // Auto-remover después de 5 segundos
          setTimeout(() => {
            if (notificacion.parentElement) {
              notificacion.remove();
            }
          }, 5000);
        } catch (error) {
          console.error('❌ Error mostrando notificación:', error);
          // Fallback a alert
          alert(mensaje);
        }
      }

      // Función para previsualizar horas
      function previsualizarHoras() {
        try {
          const empleadoId = document.getElementById('empleado').value;
          const fecha = document.getElementById('fecha').value;
          const horasOrdinarias = parseFloat(document.getElementById('horasOrdinarias').value) || 0;
          const horasExtras = parseFloat(document.getElementById('horasExtras').value) || 0;
          const horasFestivas = parseFloat(document.getElementById('horasFestivas').value) || 0;
          const horasNocturnas = parseFloat(document.getElementById('horasNocturnas').value) || 0;

          if (!empleadoId) {
            mostrarMensaje('❌ Por favor selecciona un empleado', 'error');
            return;
          }

          if (!fecha) {
            mostrarMensaje('❌ Por favor ingresa una fecha', 'error');
            return;
          }

          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const empleado = empleados.find((emp) => emp.id === empleadoId);

          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          const totalHoras = horasOrdinarias + horasExtras + horasFestivas + horasNocturnas;
          const salarioBase = empleado.salario || 0;
          const valorHora = salarioBase / 240; // 240 horas mensuales

          const salarioOrdinario = horasOrdinarias * valorHora;
          const salarioExtras = horasExtras * (valorHora * 1.25);
          const salarioFestivas = horasFestivas * (valorHora * 1.75);
          const salarioNocturnas = horasNocturnas * (valorHora * 2.1);
          const totalPago = salarioOrdinario + salarioExtras + salarioFestivas + salarioNocturnas;

          // Mostrar modal de previsualización
          const modal = document.createElement('div');
          modal.className = 'axyra-modal-overlay';
          modal.innerHTML = `
            <div class="axyra-modal axyra-modal-preview">
              <div class="axyra-modal-header">
                <h3>📋 Previsualización de Horas</h3>
                <button class="axyra-modal-cerrar" onclick="this.closest('.axyra-modal-overlay').remove()">×</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-preview-grid">
                  <div class="axyra-preview-item">
                    <label>Empleado:</label>
                    <span>${empleado.nombre}</span>
                  </div>
                  <div class="axyra-preview-item">
                    <label>Fecha:</label>
                    <span>${fecha}</span>
                  </div>
                  <div class="axyra-preview-item">
                    <label>Horas Ordinarias:</label>
                    <span>${horasOrdinarias}h - $${salarioOrdinario.toFixed(2)}</span>
                  </div>
                  <div class="axyra-preview-item">
                    <label>Horas Extras:</label>
                    <span>${horasExtras}h - $${salarioExtras.toFixed(2)}</span>
                  </div>
                  <div class="axyra-preview-item">
                    <label>Horas Festivas:</label>
                    <span>${horasFestivas}h - $${salarioFestivas.toFixed(2)}</span>
                  </div>
                  <div class="axyra-preview-item">
                    <label>Horas Nocturnas:</label>
                    <span>${horasNocturnas}h - $${salarioNocturnas.toFixed(2)}</span>
                  </div>
                  <div class="axyra-preview-total">
                    <label>Total Horas:</label>
                    <span>${totalHoras}h</span>
                  </div>
                  <div class="axyra-preview-total">
                    <label>Total a Pagar:</label>
                    <span>$${totalPago.toFixed(2)}</span>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-outline" onclick="this.closest('.axyra-modal-overlay').remove()">
                  Cancelar
                </button>
                <button class="axyra-btn axyra-btn-primary" onclick="registrarHoras()">
                  ✅ Registrar Horas
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error('❌ Error en previsualización:', error);
          mostrarMensaje('Error en previsualización: ' + error.message, 'error');
        }
      }

      // Función para generar comprobante
      function generarComprobante(id) {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          const registro = horas.find((h) => h.id === id);
          if (!registro) {
            mostrarMensaje('❌ Registro no encontrado', 'error');
            return;
          }

          const empleado = empleados.find((e) => e.id === registro.empleadoId);
          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          // Calcular totales
          const horasOrdinarias = registro.horas?.ordinarias || 0;
          const horasExtras = registro.horas?.extras || 0;
          const horasFestivas = registro.horas?.extrasFestivas || 0;
          const horasNocturnas = registro.horas?.extrasFestivasNocturnas || 0;
          const totalHoras = horasOrdinarias + horasExtras + horasFestivas + horasNocturnas;

          const salarioBase = empleado.salario || 0;
          const salarioHora = salarioBase / 240; // 240 horas mensuales

          const salarioOrdinario = horasOrdinarias * salarioHora;
          const salarioExtras = horasExtras * (salarioHora * 1.25);
          const salarioFestivas = horasFestivas * (salarioHora * 1.75);
          const salarioNocturnas = horasNocturnas * (salarioHora * 2.1);
          const totalPago = salarioOrdinario + salarioExtras + salarioFestivas + salarioNocturnas;

          // Crear contenido del comprobante
          const contenido = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
              <div style="text-align: center; border-bottom: 3px solid #4F81BD; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="color: #4F81BD; margin: 0; font-size: 28px;">VILLA VENECIA</h1>
                <h2 style="color: #666; margin: 10px 0; font-size: 20px;">COMPROBANTE DE HORAS TRABAJADAS</h2>
                <p style="color: #999; margin: 5px 0; font-size: 14px;">Fecha de Generación: ${new Date().toLocaleDateString()}</p>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div>
                  <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">INFORMACIÓN DEL EMPLEADO</h3>
                  <p><strong>Nombre:</strong> ${empleado.nombre}</p>
                  <p><strong>Cargo:</strong> ${empleado.cargo || 'N/A'}</p>
                  <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                  <p><strong>Fecha de Registro:</strong> ${registro.fecha}</p>
                </div>

                <div>
                  <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">RESUMEN DE HORAS</h3>
                  <p><strong>Total Horas:</strong> ${totalHoras.toFixed(2)}h</p>
                  <p><strong>Salario Base:</strong> $${salarioBase.toLocaleString()}</p>
                  <p><strong>Valor por Hora:</strong> $${salarioHora.toFixed(2)}</p>
                </div>
              </div>

              <div style="margin-bottom: 30px;">
                <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">DETALLE DE HORAS</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background: #4F81BD; color: white;">
                      <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Tipo de Hora</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Cantidad</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Valor Unitario</th>
                      <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Ordinarias</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasOrdinarias}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${salarioHora.toFixed(
                        2
                      )}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioOrdinario.toFixed(
                        2
                      )}</td>
                    </tr>
                    <tr style="background: #f9f9f9;">
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Extras</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasExtras}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(
                        salarioHora * 1.25
                      ).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioExtras.toFixed(
                        2
                      )}</td>
                    </tr>
                    <tr>
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Festivas</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasFestivas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(
                        salarioHora * 1.75
                      ).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioFestivas.toFixed(
                        2
                      )}</td>
                    </tr>
                    <tr style="background: #f9f9f9;">
                      <td style="padding: 12px; border: 1px solid #ddd;">Horas Nocturnas</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasNocturnas}h</td>
                      <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">$${(
                        salarioHora * 2.1
                      ).toFixed(2)}</td>
                      <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${salarioNocturnas.toFixed(
                        2
                      )}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div style="text-align: right; border-top: 3px solid #4F81BD; padding-top: 20px;">
                <h2 style="color: #4F81BD; margin: 0; font-size: 24px;">TOTAL A PAGAR: $${totalPago.toFixed(2)}</h2>
              </div>

              <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                <p>Este documento es generado automáticamente por el sistema AXYRA</p>
                <p>Villa Venecia - Sistema de Gestión de Horas</p>
              </div>
            </div>
          `;

          // Abrir ventana de impresión
          const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
          ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Comprobante de Horas - ${empleado.nombre}</title>
              <style>
                body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                @media print {
                  body { padding: 0; }
                  .no-print { display: none; }
                }
              </style>
            </head>
            <body>
              ${contenido}
              <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 12px 24px; background: #4F81BD; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                  🖨️ Imprimir
                </button>
                <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                  ❌ Cerrar
                </button>
              </div>
            </body>
            </html>
          `);
          ventanaImpresion.document.close();

          mostrarMensaje('✅ Comprobante generado correctamente', 'success');
        } catch (error) {
          console.error('❌ Error generando comprobante:', error);
          mostrarMensaje('Error al generar comprobante: ' + error.message, 'error');
        }
      }

      // Función para actualizar estadísticas del historial de pagos
      function actualizarEstadisticasHistorial() {
        try {
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');

          // Calcular totales
          let totalHorasMes = 0;
          let totalPagos = 0;
          let empleadosActivos = empleados.filter((emp) => emp.estado === 'ACTIVO').length;

          // Agrupar horas por empleado
          const horasPorEmpleado = {};

          horas.forEach((registro) => {
            if (!horasPorEmpleado[registro.empleadoId]) {
              horasPorEmpleado[registro.empleadoId] = {
                totalHoras: 0,
                totalPago: 0,
              };
            }

            const empleado = empleados.find((emp) => emp.id === registro.empleadoId);
            if (empleado) {
              const horasOrdinarias = registro.horas?.ordinarias || 0;
              const horasExtras = registro.horas?.extras || 0;
              const horasFestivas = registro.horas?.extrasFestivas || 0;
              const horasNocturnas = registro.horas?.extrasFestivasNocturnas || 0;

              const totalHoras = horasOrdinarias + horasExtras + horasFestivas + horasNocturnas;
              const salarioBase = empleado.salario || 0;
              const valorHora = salarioBase / 240;

              const salarioOrdinario = horasOrdinarias * valorHora;
              const salarioExtras = horasExtras * (valorHora * 1.25);
              const salarioFestivas = horasFestivas * (valorHora * 1.75);
              const salarioNocturnas = horasNocturnas * (valorHora * 2.1);
              const totalPago = salarioOrdinario + salarioExtras + salarioFestivas + salarioNocturnas;

              horasPorEmpleado[registro.empleadoId].totalHoras += totalHoras;
              horasPorEmpleado[registro.empleadoId].totalPago += totalPago;

              totalHorasMes += totalHoras;
              totalPagos += totalPago;
            }
          });

          // Actualizar tarjetas de estadísticas
          const horasMesElement = document.getElementById('horasMes');
          const totalPagosElement = document.getElementById('totalPagos');
          const empleadosActivosElement = document.getElementById('empleadosActivos');

          if (horasMesElement) horasMesElement.textContent = `${totalHorasMes.toFixed(2)} HORAS DEL MES`;
          if (totalPagosElement) totalPagosElement.textContent = `$${totalPagos.toFixed(2)} TOTAL PAGOS`;
          if (empleadosActivosElement) empleadosActivosElement.textContent = `${empleadosActivos} EMPLEADOS ACTIVOS`;

          // Actualizar tabla con totales por empleado
          actualizarTablaHistorialPagos(horasPorEmpleado);
        } catch (error) {
          console.error('❌ Error actualizando estadísticas:', error);
        }
      }

      // Función para actualizar tabla del historial de pagos
      function actualizarTablaHistorialPagos(horasPorEmpleado) {
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const tablaBody = document.querySelector('#tablaHistorialPagos tbody');

          if (!tablaBody) return;

          tablaBody.innerHTML = '';

          empleados.forEach((empleado) => {
            if (empleado.estado === 'ACTIVO') {
              const horasEmpleado = horasPorEmpleado[empleado.id] || { totalHoras: 0, totalPago: 0 };

              const fila = document.createElement('tr');
              fila.innerHTML = `
                <td>${empleado.nombre}</td>
                <td>${empleado.departamento || 'N/A'}</td>
                <td>${empleado.cargo || 'N/A'}</td>
                <td>${horasEmpleado.totalHoras.toFixed(2)}h</td>
                <td>$${horasEmpleado.totalPago.toFixed(2)}</td>
                <td>
                  <button class="axyra-btn-accion axyra-btn-ver" onclick="verDetalleEmpleado('${
                    empleado.id
                  }')" title="Ver detalle">
                    👁️
                  </button>
                  <button class="axyra-btn-accion axyra-btn-generar" onclick="generarComprobanteEmpleado('${
                    empleado.id
                  }')" title="Generar comprobante">
                    📄
                  </button>
                </td>
              `;

              tablaBody.appendChild(fila);
            }
          });
        } catch (error) {
          console.error('❌ Error actualizando tabla historial:', error);
        }
      }

      // Función para ver detalle de empleado
      function verDetalleEmpleado(empleadoId) {
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');

          const empleado = empleados.find((emp) => emp.id === empleadoId);
          if (!empleado) {
            mostrarMensaje('❌ Empleado no encontrado', 'error');
            return;
          }

          const horasEmpleado = horas.filter((h) => h.empleadoId === empleadoId);

          // Mostrar modal con detalle
          const modal = document.createElement('div');
          modal.className = 'axyra-modal-overlay';
          modal.innerHTML = `
            <div class="axyra-modal axyra-modal-detalle">
              <div class="axyra-modal-header">
                <h3>👤 Detalle de ${empleado.nombre}</h3>
                <button class="axyra-modal-cerrar" onclick="this.closest('.axyra-modal-overlay').remove()">×</button>
              </div>
              <div class="axyra-modal-body">
                <div class="axyra-detalle-grid">
                  <div class="axyra-detalle-item">
                    <label>Nombre:</label>
                    <span>${empleado.nombre}</span>
                  </div>
                  <div class="axyra-detalle-item">
                    <label>Cargo:</label>
                    <span>${empleado.cargo || 'N/A'}</span>
                  </div>
                  <div class="axyra-detalle-item">
                    <label>Departamento:</label>
                    <span>${empleado.departamento || 'N/A'}</span>
                  </div>
                  <div class="axyra-detalle-item">
                    <label>Salario Base:</label>
                    <span>$${empleado.salario?.toLocaleString() || '0'}</span>
                  </div>
                  <div class="axyra-detalle-item">
                    <label>Total Horas:</label>
                    <span>${horasEmpleado
                      .reduce((sum, h) => {
                        const horasOrdinarias = h.horas?.ordinarias || 0;
                        const horasExtras = h.horas?.extras || 0;
                        const horasFestivas = h.horas?.extrasFestivas || 0;
                        const horasNocturnas = h.horas?.extrasFestivasNocturnas || 0;
                        return sum + horasOrdinarias + horasExtras + horasFestivas + horasNocturnas;
                      }, 0)
                      .toFixed(2)}h</span>
                  </div>
                  <div class="axyra-detalle-item">
                    <label>Total Pago:</label>
                    <span>$${horasEmpleado
                      .reduce((sum, h) => {
                        const empleado = empleados.find((emp) => emp.id === h.empleadoId);
                        if (!empleado) return sum;

                        const horasOrdinarias = h.horas?.ordinarias || 0;
                        const horasExtras = h.horas?.extras || 0;
                        const horasFestivas = h.horas?.extrasFestivas || 0;
                        const horasNocturnas = h.horas?.extrasFestivasNocturnas || 0;

                        const valorHora = empleado.salario / 240;
                        const salarioOrdinario = horasOrdinarias * valorHora;
                        const salarioExtras = horasExtras * (valorHora * 1.25);
                        const salarioFestivas = horasFestivas * (valorHora * 1.75);
                        const salarioNocturnas = horasNocturnas * (valorHora * 2.1);

                        return sum + salarioOrdinario + salarioExtras + salarioFestivas + salarioNocturnas;
                      }, 0)
                      .toFixed(2)}</span>
                  </div>
                </div>
              </div>
              <div class="axyra-modal-footer">
                <button class="axyra-btn axyra-btn-primary" onclick="this.closest('.axyra-modal-overlay').remove()">
                  Cerrar
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error('❌ Error mostrando detalle:', error);
          mostrarMensaje('Error mostrando detalle: ' + error.message, 'error');
        }
      }

      // Función para generar comprobante de empleado
      async function generarComprobanteEmpleado(empleadoId) {
        try {
          console.log('🔍 Generando comprobante para empleado ID:', empleadoId);

          // Convertir empleadoId a número si es string
          const empleadoIdNum = parseInt(empleadoId) || empleadoId;
          console.log('🔍 Empleado ID convertido:', empleadoIdNum);

          let empleados = [];
          let horas = [];

          // Intentar obtener datos desde Firebase Sync Manager primero
          if (window.firebaseSyncManager) {
            try {
              empleados = await window.firebaseSyncManager.getEmpleados() || [];
              horas = await window.firebaseSyncManager.getHoras() || [];
              console.log('✅ Datos obtenidos desde Firebase Sync Manager');
            } catch (error) {
              console.warn('⚠️ Error con Firebase Sync Manager, usando localStorage:', error);
            }
          }

          // Fallback a localStorage si no hay datos del sync manager
          if (empleados.length === 0 || horas.length === 0) {
            empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
            horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');
            console.log('💾 Usando datos de localStorage como fallback');
          }

          console.log('📋 Empleados disponibles:', empleados.length);
          console.log('⏰ Horas disponibles:', horas.length);

          // Buscar empleado con compatibilidad de tipos de ID
          const empleado = empleados.find((emp) => {
            if (!emp || !emp.id) return false;
            // Comparar como string y número para mayor compatibilidad
            return emp.id.toString() === empleadoId.toString() || parseInt(emp.id) === parseInt(empleadoId);
          });

          if (!empleado) {
            console.error('❌ Empleado no encontrado. Empleados disponibles:', empleados);
            mostrarMensaje('❌ Empleado no encontrado en el sistema', 'error');
            return;
          }

          console.log('✅ Empleado encontrado:', empleado.nombre);

          // Buscar horas del empleado con compatibilidad de tipos de ID
          const horasEmpleado = horas.filter((h) => {
            if (!h || !h.empleadoId) return false;
            // Comparar como string y número para mayor compatibilidad
            return h.empleadoId.toString() === empleadoId.toString() || parseInt(h.empleadoId) === parseInt(empleadoId);
          });

          console.log('📊 Horas encontradas para el empleado:', horasEmpleado.length);

          if (horasEmpleado.length === 0) {
            console.log('ℹ️ No hay horas registradas para este empleado');
            mostrarMensaje('ℹ️ Este empleado no tiene horas registradas. Debes registrar horas trabajadas primero para generar un comprobante.', 'info');
            return;
          }

          // Calcular totales acumulados usando la calculadora colombiana
          let totalHoras = 0;
          let totalPago = 0;

          horasEmpleado.forEach((registro) => {
            // Usar todos los tipos de horas disponibles
            const horasData = {
              ordinarias: registro.horas?.ordinarias || 0,
              nocturnas: registro.horas?.nocturnas || 0,
              extraDiurnas: registro.horas?.extraDiurnas || 0,
              extraNocturnas: registro.horas?.extraNocturnas || 0,
              dominicales: registro.horas?.dominicales || 0,
              festivas: registro.horas?.festivas || 0,
              dominicalesNocturnas: registro.horas?.dominicalesNocturnas || 0,
              festivasNocturnas: registro.horas?.festivasNocturnas || 0,
              extraDominicales: registro.horas?.extraDominicales || 0,
              extraDominicalesNocturnas: registro.horas?.extraDominicalesNocturnas || 0,
              extraFestivas: registro.horas?.extraFestivas || 0,
              extraFestivasNocturnas: registro.horas?.extraFestivasNocturnas || 0
            };

            // Sumar todas las horas
            totalHoras += Object.values(horasData).reduce((sum, horas) => sum + (horas || 0), 0);

            // Calcular pago usando la calculadora colombiana
            try {
              const tipoContrato = empleado.tipoContrato || 'Por Horas';
              const calculo = window.colombianLaborLawCalculator.calcularSalariosCompletos(
                horasData,
                empleado.salario || 0,
                tipoContrato
              );
              totalPago += calculo.totalSalario;
            } catch (error) {
              console.warn('⚠️ Error calculando pago para registro:', error);
              // Fallback simple si falla la calculadora
              const valorHora = empleado.salario / 220; // Usar 220 como solicitaste
              totalPago += totalHoras * valorHora;
            }
          });

          // Generar comprobante acumulado
          const contenido = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
              <div style="text-align: center; border-bottom: 3px solid #4F81BD; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="color: #4F81BD; margin: 0; font-size: 28px;">VILLA VENECIA</h1>
                <h2 style="color: #666; margin: 10px 0; font-size: 20px;">COMPROBANTE ACUMULADO DE HORAS</h2>
                <p style="color: #999; margin: 5px 0; font-size: 14px;">Fecha de Generación: ${new Date().toLocaleDateString()}</p>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div>
                  <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">INFORMACIÓN DEL EMPLEADO</h3>
                  <p><strong>Nombre:</strong> ${empleado.nombre}</p>
                  <p><strong>Cargo:</strong> ${empleado.cargo || 'N/A'}</p>
                  <p><strong>Departamento:</strong> ${empleado.departamento || 'N/A'}</p>
                  <p><strong>Salario Base:</strong> $${empleado.salario?.toLocaleString() || '0'}</p>
                </div>

                <div>
                  <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">RESUMEN ACUMULADO</h3>
                  <p><strong>Total Horas:</strong> ${totalHoras.toFixed(2)}h</p>
                  <p><strong>Total a Pagar:</strong> $${totalPago.toFixed(2)}</p>
                  <p><strong>Período:</strong> ${horasEmpleado.length} registros</p>
                </div>
              </div>

              <div style="margin-bottom: 30px;">
                <h3 style="color: #4F81BD; border-bottom: 2px solid #4F81BD; padding-bottom: 10px;">DETALLE DE REGISTROS</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                  <thead>
                    <tr style="background: #4F81BD; color: white;">
                      <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Fecha</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Horas Ordinarias</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Horas Extras</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Horas Festivas</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Horas Nocturnas</th>
                      <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${horasEmpleado
                      .map((registro) => {
                        const horasOrdinarias = registro.horas?.ordinarias || 0;
                        const horasExtras = registro.horas?.extras || 0;
                        const horasFestivas = registro.horas?.extrasFestivas || 0;
                        const horasNocturnas = registro.horas?.extrasFestivasNocturnas || 0;
                        const total = horasOrdinarias + horasExtras + horasFestivas + horasNocturnas;

                        return `
                        <tr>
                          <td style="padding: 12px; border: 1px solid #ddd;">${registro.fecha}</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasOrdinarias}h</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasExtras}h</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasFestivas}h</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${horasNocturnas}h</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${total}h</td>
                        </tr>
                      `;
                      })
                      .join('')}
                  </tbody>
                </table>
              </div>

              <div style="text-align: right; border-top: 3px solid #4F81BD; padding-top: 20px;">
                <h2 style="color: #4F81BD; margin: 0; font-size: 24px;">TOTAL ACUMULADO: $${totalPago.toFixed(2)}</h2>
              </div>

              <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                <p>Este documento es generado automáticamente por el sistema AXYRA</p>
                <p>Villa Venecia - Sistema de Gestión de Horas</p>
              </div>
            </div>
          `;

          // Abrir ventana de impresión
          const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
          ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Comprobante Acumulado - ${empleado.nombre}</title>
              <style>
                body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                @media print {
                  body { padding: 0; }
                  .no-print { display: none; }
                }
              </style>
            </head>
            <body>
              ${contenido}
              <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 12px 24px; background: #4F81BD; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                  🖨️ Imprimir
                </button>
                <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                  ❌ Cerrar
                </button>
              </div>
            </body>
            </html>
          `);
          ventanaImpresion.document.close();

          mostrarMensaje('✅ Comprobante acumulado generado correctamente', 'success');
        } catch (error) {
          console.error('❌ Error generando comprobante acumulado:', error);
          mostrarMensaje('Error al generar comprobante: ' + error.message, 'error');
        }
      }

      // Función para verificar empleados sin horas
      function verificarEmpleadosSinHoras() {
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');

          const empleadosSinHoras = empleados.filter((emp) => {
            const tieneHorasPorId = horas.some((h) => h.empleadoId === emp.id);
            const tieneHorasPorCedula = horas.some((h) => h.cedula === emp.cedula);
            return !tieneHorasPorId && !tieneHorasPorCedula;
          });

          if (empleadosSinHoras.length > 0) {
            mostrarMensaje(
              `${empleadosSinHoras.length} empleado(s) no tienen horas registradas en el sistema`,
              'warning'
            );
          }
        } catch (error) {
          console.error('❌ Error verificando empleados sin horas:', error);
        }
      }

      // Función de prueba para cargar empleados manualmente
      function cargarEmpleadosManual() {
        try {
          console.log('🧪 Cargando empleados manualmente...');

          // Obtener empleados del localStorage
          const empleadosData = localStorage.getItem('axyra_empleados');
          console.log('🔍 Datos de empleados en localStorage:', empleadosData);

          if (empleadosData) {
            const empleados = JSON.parse(empleadosData);
            console.log(`📦 Empleados encontrados: ${empleados.length}`);
            console.log('🔍 Empleados:', empleados);

            // Cargar en los selects
            cargarEmpleadosEnSelects(empleados);
          } else {
            console.log('⚠️ No hay empleados en localStorage');
            // Intentar cargar desde Firebase
            if (typeof firebase !== 'undefined' && firebase.firestore) {
              console.log('🔥 Intentando cargar desde Firebase...');
              firebase
                .firestore()
                .collection('empleados')
                .get()
                .then((snapshot) => {
                  if (!snapshot.empty) {
                    const empleadosFirebase = [];
                    snapshot.forEach((doc) => {
                      empleadosFirebase.push({
                        id: doc.id,
                        ...doc.data(),
                      });
                    });
                    console.log(`✅ Empleados cargados desde Firebase: ${empleadosFirebase.length}`);
                    localStorage.setItem('axyra_empleados', JSON.stringify(empleadosFirebase));
                    cargarEmpleadosEnSelects(empleadosFirebase);
                  } else {
                    console.log('ℹ️ No hay empleados en Firebase');
                  }
                })
                .catch((error) => {
                  console.error('❌ Error cargando desde Firebase:', error);
                });
            }
          }
        } catch (error) {
          console.error('❌ Error en cargarEmpleadosManual:', error);
        }
      }
    </script>

    <style>
      /* NOTIFICACIÓN MEJORADA */
      .axyra-notification-improved {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f59e0b, #f97316);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-width: 350px;
        border: 2px solid #ea580c;
        animation: slideInRight 0.5s ease;
      }

      .axyra-notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .axyra-notification-title {
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .axyra-notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }

      .axyra-notification-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .axyra-notification-content {
        font-size: 0.875rem;
        line-height: 1.4;
        margin-bottom: 16px;
      }

      .axyra-notification-action {
        background: #ea580c;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .axyra-notification-action:hover {
        background: #dc2626;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .axyra-info-dia {
        margin-bottom: var(--spacing-lg);
        border: 2px solid var(--axyra-blue-200);
        border-radius: var(--border-radius-md);
        background: var(--axyra-blue-50);
      }

      .axyra-validaciones {
        margin-bottom: var(--spacing-lg);
        border: 2px solid var(--axyra-orange-200);
        border-radius: var(--border-radius-md);
        background: var(--axyra-orange-50);
      }

      .axyra-validacion-error {
        background: var(--axyra-red-100);
        border: 1px solid var(--axyra-red-300);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm);
        margin: var(--spacing-sm) 0;
      }

      .axyra-validacion-error p {
        color: var(--axyra-red-700);
        margin: 0.25rem 0;
        font-size: 0.875rem;
      }

      .axyra-validacion-warning {
        background: var(--axyra-orange-100);
        border: 1px solid var(--axyra-orange-300);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-sm);
        margin: var(--spacing-sm) 0;
      }

      .axyra-validacion-warning p {
        color: var(--axyra-orange-700);
        margin: 0.25rem 0;
        font-size: 0.875rem;
      }

      .axyra-descripcion-horas {
        margin-top: var(--spacing-lg);
      }

      .axyra-badge-festivo {
        background: var(--axyra-purple-100);
        color: var(--axyra-purple-700);
        border: 1px solid var(--axyra-purple-300);
      }

      .axyra-badge-dominical {
        background: var(--axyra-blue-100);
        color: var(--axyra-blue-700);
        border: 1px solid var(--axyra-blue-300);
      }

      .axyra-badge-laboral {
        background: var(--axyra-green-100);
        color: var(--axyra-green-700);
        border: 1px solid var(--axyra-green-300);
      }

      /* Estilos específicos para gestión de horas */
      .axyra-calculo-container {
        max-width: 100%;
        overflow-x: auto;
      }

      .axyra-calculo-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
      }

      .axyra-calculo-section h4 {
        color: #1e40af;
        margin-bottom: 15px;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .axyra-calculo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .axyra-calculo-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
      }

      .axyra-calculo-item:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      }

      .axyra-calculo-total {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        font-weight: 600;
        border: none;
      }

      .axyra-calculo-label {
        font-weight: 500;
        color: #374151;
      }

      .axyra-calculo-value {
        font-weight: 600;
        color: #1f2937;
      }

      .axyra-calculo-total .axyra-calculo-label,
      .axyra-calculo-total .axyra-calculo-value {
        color: white;
      }

      .axyra-calculo-resumen {
        margin-top: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        border-radius: 12px;
        color: white;
      }

      .axyra-calculo-resumen-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .axyra-calculo-resumen-item:last-child {
        border-bottom: none;
        font-size: 18px;
        font-weight: 700;
      }

      .axyra-calculo-resumen-label {
        font-weight: 500;
      }

      .axyra-calculo-resumen-value {
        font-weight: 700;
        font-size: 18px;
      }

      /* Modal grande para cálculos */
      .axyra-modal-large {
        max-width: 800px;
        max-height: 90vh;
      }

      /* Estilos para resumen de comprobante */
      .axyra-comprobante-resumen {
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .axyra-comprobante-resumen h4 {
        color: #059669;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.2rem;
      }

      .axyra-resumen-details {
        display: grid;
        gap: 12px;
      }

      .axyra-resumen-details p {
        margin: 0;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .axyra-resumen-details p:last-child {
        border-bottom: none;
      }

      .axyra-resumen-details strong {
        color: #374151;
        font-weight: 600;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .axyra-calculo-grid {
          grid-template-columns: 1fr;
        }

        .axyra-calculo-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }
    </style>

    <!-- Inicialización automática del módulo de horas -->
    <script>
      // Inicializar módulo de horas cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Módulo de horas cargado, verificando autenticación...');

        // Esperar un poco para que se carguen todos los scripts
        setTimeout(async () => {
          await inicializarHoras();
        }, 500);
      });

      // Función para cargar datos desde Firebase
      async function cargarDatosFirebase() {
        try {
          console.log('🔄 Cargando datos desde Firebase...');

          // Verificar si Firebase está disponible
          if (typeof firebase === 'undefined' || !firebase.firestore) {
            console.warn('⚠️ Firebase no disponible, usando localStorage como fallback');
            await cargarDatosLocalStorage();
            return;
          }

          const db = firebase.firestore();

          // Obtener userId del usuario autenticado en Firebase
          let userId = null;
          let empleados = [];
          let horas = [];

          // Intentar obtener el usuario actual de Firebase Auth
          if (firebase.auth().currentUser) {
            userId = firebase.auth().currentUser.uid;
            console.log('✅ Usuario autenticado en Firebase:', userId);
          } else {
            // Fallback: buscar en localStorage o usar el usuario aislado
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              const user = JSON.parse(userData);
              userId = user.username || user.email;
            }

            if (!userId) {
              console.warn('⚠️ No se puede identificar usuario, usando localStorage');
              await cargarDatosLocalStorage();
              return;
            }
          }

          console.log('🔍 Buscando datos para userId:', userId);

          // Cargar empleados desde Firebase - buscar por userId
          try {
            const empleadosSnapshot = await db.collection('empleados').where('userId', '==', userId).get();

            empleados = empleadosSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${empleados.length} empleados cargados desde Firebase para userId: ${userId}`);

            // Si no hay empleados con ese userId, intentar buscar sin filtro
            if (empleados.length === 0) {
              console.log('🔍 No se encontraron empleados con userId específico, buscando todos...');
              const allEmpleadosSnapshot = await db.collection('empleados').get();
              empleados = allEmpleadosSnapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              console.log(`✅ ${empleados.length} empleados totales encontrados en Firebase`);
            }
          } catch (error) {
            console.warn('⚠️ Error cargando empleados desde Firebase:', error);
            empleados = [];
          }

          // Cargar horas desde Firebase
          try {
            const horasSnapshot = await db.collection('horas').where('userId', '==', userId).get();

            horas = horasSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log(`✅ ${horas.length} horas cargadas desde Firebase`);
          } catch (error) {
            console.warn('⚠️ Error cargando horas desde Firebase:', error);
            horas = [];
          }

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_horas', JSON.stringify(horas));
        } catch (error) {
          console.error('❌ Error cargando datos desde Firebase:', error);
          // Fallback a localStorage
          await cargarDatosLocalStorage();
        }
      }

      // Función para cargar datos desde localStorage (fallback)
      async function cargarDatosLocalStorage() {
        try {
          console.log('🔄 Cargando datos desde localStorage...');

          let empleados = [];
          let horas = [];

          // Obtener usuario actual
          let currentUser = null;
          if (window.axyraIsolatedAuth && window.axyraIsolatedAuth.isUserAuthenticated()) {
            currentUser = window.axyraIsolatedAuth.getCurrentUser();
          } else {
            const userData = localStorage.getItem('axyra_isolated_user');
            if (userData) {
              currentUser = JSON.parse(userData);
            }
          }

          // Cargar empleados
          const empleadosData = localStorage.getItem('axyra_empleados');
          if (empleadosData) {
            empleados = JSON.parse(empleadosData);
            // Filtrar por usuario actual
            empleados = empleados.filter((e) => {
              if (!e.userId) return true; // Datos globales
              return (
                e.userId === currentUser?.username || e.userId === currentUser?.email || e.userId === currentUser?.id
              );
            });
          }

          // Cargar horas
          const horasData = localStorage.getItem('axyra_horas');
          if (horasData) {
            horas = JSON.parse(horasData);
            // Filtrar por usuario actual
            horas = horas.filter((h) => {
              if (!h.userId) return true; // Datos globales
              return (
                h.userId === currentUser?.username || h.userId === currentUser?.email || h.userId === currentUser?.id
              );
            });
          }

          console.log(`✅ Datos cargados desde localStorage: ${empleados.length} empleados, ${horas.length} horas`);

          // Guardar en localStorage como backup
          localStorage.setItem('axyra_empleados', JSON.stringify(empleados));
          localStorage.setItem('axyra_horas', JSON.stringify(horas));
        } catch (error) {
          console.error('❌ Error cargando datos desde localStorage:', error);
        }
      }

      // Función para resetear todo el formulario
      function resetearTodo() {
        try {
          // Limpiar todos los campos de horas
          const camposHoras = [
            'horasExtraDiurnas',
            'horasExtraNocturnas',
            'horasDominicales',
            'horasDominicalesNocturnas',
            'horasExtraDominicales',
            'horasExtraDominicalesNocturnas',
            'horasFestivas',
            'horasFestivasNocturnas',
            'horasExtraFestivas',
            'horasExtraFestivasNocturnas',
          ];

          camposHoras.forEach((campo) => {
            const elemento = document.getElementById(campo);
            if (elemento) {
              elemento.value = '0';
            }
          });

          // Limpiar otros campos
          const empleadoSelect = document.getElementById('empleadoHoras');
          if (empleadoSelect) {
            empleadoSelect.selectedIndex = 0;
          }

          const fechaInput = document.getElementById('fechaHoras');
          if (fechaInput) {
            fechaInput.value = '';
          }

          // Limpiar tabla de horas
          const tbody = document.getElementById('cuerpoTablaHoras');
          if (tbody) {
            tbody.innerHTML = '';
          }

          mostrarNotificacion('✅ Formulario reseteado correctamente', 'success');
          console.log('✅ Formulario de horas reseteado');
        } catch (error) {
          console.error('❌ Error reseteando formulario:', error);
          mostrarNotificacion('Error reseteando formulario', 'error');
        }
      }

      // Función de inicialización mejorada
      async function inicializarHoras() {
        try {
          console.log('🚀 Inicializando módulo de horas...');

          // Verificar autenticación
          await verificarAutenticacion();

          // Intentar cargar desde Firebase primero
          await cargarDatosFirebase();

          // Cargar empleados en los selects
          await cargarEmpleados();

          // Renderizar tabla
          renderizarTablaHoras();

          // Configurar listener para cambios en empleados
          configurarListenerCambiosEmpleados();

          // Verificar si hay empleados sin horas y mostrar notificación
          verificarEmpleadosSinHoras();

          // Cargar empleados manualmente como respaldo
          setTimeout(() => {
            cargarEmpleadosManual();
          }, 1000);

          console.log('✅ Módulo de horas inicializado correctamente');
        } catch (error) {
          console.error('❌ Error inicializando horas:', error);
          mostrarNotificacion('Error inicializando módulo de horas', 'error');
        }
      }

      // Función para verificar empleados sin horas - MEJORADA
      function verificarEmpleadosSinHoras() {
        try {
          const empleados = JSON.parse(localStorage.getItem('axyra_empleados') || '[]');
          const horas = JSON.parse(localStorage.getItem('axyra_horas') || '[]');

          const empleadosSinHoras = empleados.filter((emp) => {
            const tieneHorasPorId = horas.some((h) => h.empleadoId === emp.id);
            const tieneHorasPorCedula = horas.some((h) => h.cedula === emp.cedula);
            return !tieneHorasPorId && !tieneHorasPorCedula;
          });

          if (empleadosSinHoras.length > 0) {
            mostrarNotificacionMejorada(empleadosSinHoras);
          }
        } catch (error) {
          console.error('❌ Error verificando empleados sin horas:', error);
        }
      }

      // Función para mostrar notificación mejorada y estructurada
      function mostrarNotificacionMejorada(empleadosSinHoras) {
        // Remover notificación existente si la hay
        const notificacionExistente = document.querySelector('.axyra-notification-improved');
        if (notificacionExistente) {
          notificacionExistente.remove();
        }

        const notificacion = document.createElement('div');
        notificacion.className = 'axyra-notification-improved';
        notificacion.innerHTML = `
          <div class="axyra-notification-header">
            <div class="axyra-notification-title">
              <span>⚠️</span>
              <span>Empleados sin horas registradas</span>
            </div>
            <button class="axyra-notification-close" onclick="this.closest('.axyra-notification-improved').remove()">×</button>
          </div>
          <div class="axyra-notification-content">
            ${empleadosSinHoras.length} empleado(s) no tienen horas registradas en el sistema.
            <br><br>
            <strong>Empleados afectados:</strong><br>
            ${empleadosSinHoras
              .slice(0, 3)
              .map((emp) => `• ${emp.nombre} (${emp.cedula})`)
              .join('<br>')}
            ${empleadosSinHoras.length > 3 ? `<br><em>... y ${empleadosSinHoras.length - 3} más</em>` : ''}
          </div>
          <button class="axyra-notification-action" onclick="navegarAEmpleados()">
            Ver empleados
          </button>
        `;

        document.body.appendChild(notificacion);

        // Auto-remover después de 10 segundos
        setTimeout(() => {
          if (notificacion.parentElement) {
            notificacion.remove();
          }
        }, 10000);
      }

      // Función para navegar a empleados
      function navegarAEmpleados() {
        try {
          window.location.href = '../empleados/empleados.html';
        } catch (error) {
          console.error('❌ Error navegando a empleados:', error);
        }
      }

      // Función para limpiar datos del formulario
      function limpiarDatos() {
        try {
          // Limpiar todos los campos de horas
          const camposHoras = [
            'horasOrdinarias',
            'horasNocturnas',
            'horasExtraDiurnas',
            'horasExtraNocturnas',
            'horasDominicales',
            'horasFestivas',
            'horasDominicalesNocturnas',
            'horasFestivasNocturnas',
            'horasExtraDominicales',
            'horasExtraDominicalesNocturnas',
            'horasExtraFestivas',
            'horasExtraFestivasNocturnas',
          ];

          camposHoras.forEach((campo) => {
            const elemento = document.getElementById(campo);
            if (elemento) {
              elemento.value = '0';
            }
          });

          // Limpiar fecha
          const fechaHoras = document.getElementById('fechaHoras');
          if (fechaHoras) {
            fechaHoras.value = '';
          }

          // Limpiar empleado
          const empleadoHoras = document.getElementById('empleadoHoras');
          if (empleadoHoras) {
            empleadoHoras.value = '';
          }

          // Limpiar salario base
          const salarioBase = document.getElementById('salarioBase');
          if (salarioBase) {
            salarioBase.value = '';
          }

          // Limpiar observaciones
          const observaciones = document.getElementById('observaciones');
          if (observaciones) {
            observaciones.value = '';
          }

          // Limpiar valores de hora
          const valoresHora = document.querySelectorAll('.axyra-valor-hora');
          valoresHora.forEach((valor) => {
            valor.textContent = 'Valor: $0';
          });

          console.log('✅ Formulario limpiado correctamente');
          mostrarMensaje('Formulario limpiado correctamente', 'success');
        } catch (error) {
          console.error('❌ Error limpiando formulario:', error);
          mostrarMensaje('Error limpiando formulario', 'error');
        }
      }

      // Función para cerrar modal de cálculo de horas
      function cerrarModalCalculoHoras() {
        try {
          const modal = document.getElementById('modalCalculoHoras');
          if (modal) {
            modal.remove();
          }
        } catch (error) {
          console.error('❌ Error cerrando modal:', error);
        }
      }

      // Hacer funciones globales para onclick
      window.calcularHoras = calcularHoras;
      window.exportarHoras = exportarHoras;
      window.eliminarHoras = eliminarHoras;
      window.editarHoras = editarHoras;
      window.actualizarHoras = actualizarHoras;
      window.registrarHoras = registrarHoras;
      window.limpiarFormularioHoras = limpiarFormularioHoras;
      window.resetearTodo = resetearTodo;
      window.limpiarDatos = limpiarDatos;
      window.generarComprobante = generarComprobante;
      window.verificarAutenticacion = verificarAutenticacion;
      window.mostrarNotificacion = mostrarNotificacion;
      window.mostrarMensaje = mostrarMensaje;
      window.cerrarModalCalculoHoras = cerrarModalCalculoHoras;
      window.inicializarHoras = inicializarHoras;
      window.cargarEmpleadosManual = cargarEmpleadosManual;
    </script>
    <!-- Sistema de Validaciones Avanzadas AXYRA -->
    <script src="../../static/advanced-validation-system.js"></script>

    <!-- Sistema Completo de Gestión de Horas AXYRA -->
    <script src="gestionar_horas_complete.js"></script>
  </body>
</html>
